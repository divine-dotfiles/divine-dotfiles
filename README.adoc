= Divine.dotfiles
:author: Grove Pyree
:email: grayarea@protonmail.ch
:revdate: 2019.12.12
:revremark: Update README and release notes
:doctype: article
// Visual
:toc: macro
// Subs:
:hs: #
:dhs: ##
:us: _
:dus: __
:as: *
:das: **
:lsb: [
:rsb: ]

++++
<p align="center">
<em>The Bash framework for dotfiles and everything Bash</em>
</p>
++++

++++
<p align="center">
  <img id="divine-dotfiles-plaque" width="640" src="lib/img/divine-dotfiles-plaque.png" alt="Divine.dotfiles">
</p>
++++

New machine or new OS?
Set it up with a single `*di install --yes*`.

[.note]
[%noheader,cols="<.<a"]
|===
| `di` stands for **d**ivine **i**ntervention.
|===

toc::[]

[[fmwk-main]]
== In a nutshell

[.note]
[%noheader,cols="<.<a"]
|===
| First-time users are very welcome to take a <<fmwk-joy-ride,*joy ride*>>.
|===

_Divine.dotfiles_ leverages *deployments*.

A deployment is a Bash script with three specially named functions: one to *check*, another to *install*, third to *remove*.
No assumptions are made about what a deployment does for a living.
The return codes are used to communicate status back to the framework.
As such, authoring a deployment is akin to implementing an interface.

The goals of _Divine.dotfiles_ are:

* The *automation* of setting-up any system that runs Bash.
+
The <<iutil-main,intervention utility>> `di` is a practical tool for handling any number of deployments.
* The *cross-platformness* within the Unix-like airspace.
+
The built-in OS detection mechanism facilitates writing portable deployments.
* The promotion of *standards* and *best practices*.
+
The deployment ecosystem is designed with distribution and pluggability in mind.

The <<divine-bundles,*Divine bundles*>> of deployments (distributed separately) strive to exemplify what a good deployment should look like.

=== Example deployment

Say, there is a need to maintain a certain command line utility on every machine.
Below is a sample deployment that does a scaled down version of that:

[source,bash,subs="verbatim,attributes"]
----
# ~/.grail/dpls/example.dpl.sh

d_dpl_check() {
  [ -e ~/bin/cmd ] && return 1 {vbar}{vbar} return 2
}

d_dpl_install() {
  cat >~/bin/cmd <<<'echo Divine.dotfiles rocks' && chmod +x ~/bin/cmd
}

d_dpl_remove() {
  rm -f ~/bin/cmd
}
----

And here is what working with it looks like:

++++
<p align="center">
  <img id="divine-dotfiles-example-1" width="640" src="lib/img/divine-dotfiles-example-1.gif" alt="Divine.dotfiles example 1">
</p>
++++

Dead simple.
One wouldn't need a framework for that.
But there's more.

[[fmwk-features]]
=== Framework features

.Framework features
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++<<fmwk-grail,*The Grail directory*>>+++</p>+++

The Grail directory at `~/*.grail*/` is the one stop for configs, assets, and other dotfiles.
The Grail contents are carried across OS's and installed/removed via <<dpls-main,deployments>>.

| +++<p align="center">+++<<dfls-main,*Divinefiles*>>+++</p>+++

A special kind of deployments, the <<dfls-main,*Divinefiles*>> maintain a set of system packages across machines and OS's.

| +++<p align="center">+++<<mtdt-priority,*Priorities*>>+++</p>+++

The deployments are ordered by their numerical priority, and the order is automatically reversed for the removal.

| +++<p align="center">+++<<mtdt-groups,*Groups*>>+++</p>+++

The deployments support basic grouping via <<mtdt-flags,flags>>.

| +++<p align="center">+++<<indct-os,*Cross-platformness*>>+++</p>+++

The built-in OS detection mechanism allows to adapt to the growing <<fmwk-os-support,list>> of supported OS distributions.

| +++<p align="center">+++<<bdl-main,*Bundles (third-party deployments)*>>+++</p>+++

The Github repositories containing deployments are called bundles that can be attached with one <<rtn-attach,command>>. One example is the associated <<divine-bundles,Divine bundle>> https://github.com/divine-bundles/essentials[`essentials`].

| +++<p align="center">+++<<stash-main,*Stash*>>+++</p>+++

The deployments have access to a persistent key-value store, which can be used to track status between invocations.

| +++<p align="center">+++<<assets-main,*Assets*>>+++</p>+++

The assets provide a way to separate the installation/removal logic from the content such as the configuration files.

| +++<p align="center">+++*<<queue-main,Queues>> and <<mltsk-main,multitasking>>*+++</p>+++

Helper functions assist in implementing series of <<queue-main,similar>> or <<mltsk-main,dissimilar>> tasks.

| +++<p align="center">+++*Smart <<cpqe-main,copying>> and <<lnqe-main,symlinking>>*+++</p>+++

Specialized queues insert provided assets into target locations, while backing up pre-existing files and logging steps for future reversal.

| +++<p align="center">+++*Automated <<ghqe-main,retrieval>> of Github repositories*+++</p>+++

A specialized queue either clones or downloads public repositories, depending on the available tools.

|===

[[fmwk-design]]
=== Framework design

The _Divine.dotfiles_ framework is written in Bash.
No attempt is made at https://en.wikipedia.org/wiki/POSIX[POSIX] compliancy, nor at cross-shell portability.
Bash is chosen as the least common denominator across the _modern_ operating systems.

At its very core, this framework is a sequential launcher of user-defined Bash code.

[[fmwk-security]]
Since the deployments are essentially unrestricted Bash scripts, *absolutely no illusion of security should be assumed*.
The framework creates a subshell for every sourced deployment, but security-wise that is pretty much it.
Guarantees described in this section cover only the built-in mechanisms of the framework and the associated <<divine-bundles,Divine bundles>> of deployments.

[[fmwk-interactivity]]
==== Interactivity

_Divine.dotfiles_ is intended for interactive use, and no guarantee of unattended access is offered.
The framework tends to prompt for user's confirmation before major junctions in logic.

[[fmwk-upmt]]
The <<opt-yes,`--yes`>> option is provided to auto-accept the more trivial framework prompts.
The so-called *urgent prompts* — saved for potentially messy situations — ignore the `--yes` option and always interject.

[[fmwk-zero-data-loss]]
==== Zero data loss

All framework components avoid deleting or clobbering any data that is not proven as recoverable.
Instead, whenever files need to be replaced or removed, they are pushed to a backup location.

The deployment-specific backups are sent into the <<fmwk-state,state directory>>.
Other backups are created in place, by appending the `.bak` suffix.
Whenever multiple backups stack up, an incrementing counter is added, e.g., `_<name>_.bak-17`.

The <<opt-obliterate,`--obliterate`>> option is available to suppress this behavior.

[[fmwk-non-interference]]
==== Non-interference

The framework does its best to *not*:

* re-install something that appears already installed;
* remove something that appears already not installed;
* remove something that appears installed by means other than this framework;
* touch anything that appears to have been manually tinkered with.

Alerts are printed whenever such cases are encountered.

The <<opt-force,`--force`>> option opens a path to overcome these restrictions.
However, even when the `--force` is applied:

* an <<fmwk-upmt,urgent prompt>> is issued for every instance of forced behavior;
* the zero data loss <<fmwk-zero-data-loss,policy>> still applies.

[[fmwk-reversibility]]
==== Reversibility

Where feasible, the built-in mechanisms that introduce changes to the system are paired with the reversal counterparts.

To give an example, any backups created when installing a <<cpqe-main,copy-queue>> are restored to their original locations when that queue is removed.
Another example is the introductory <<fmwk-joy-ride,joy ride>>: if taken reasonably, it will leave the system in largely the same state as before installing the framework.

A glaring exception to this principle is the upgrading of the local package repositories through the system package manager (e.g., `sudo dnf upgrade -y`), which is deemed safe enough to overlook.

[[fmwk-race-war]]
==== Race conditions

The framework mechanisms do _not_ preclude race conditions, such as when the framework and another program operate on a file at the same time.
For most applications, the risk of this approach becoming an issue is negligible.

[[fmwk-structure]]
=== Framework structure

_Divine.dotfiles_ is installed, by default, into the `~/.divine/` directory, and is contained entirely in that directory, *except*:

* A symlink to the framework's <<fmwk-script,main script>>, `intervene.sh`, is created somewhere on `$PATH`.
* The <<fmwk-grail,Grail>> directory — home to user's assets and deployments — is located, by default, at `~/.grail/`.
* Deployments may affect the system pretty much <<fmwk-security,anywhere>>.

The installed framework consists of the following main parts:

.Framework structure
[%noheader,cols="<.<a",stripes=none]
|===

| [[fmwk-grail]]+++<p align="center">+++#`~/*.grail*/`#+++</p>+++

*The Grail directory* (or simply, *the Grail*) houses the user's deployments, assets, and persistent settings.

The Grail is designed to contain just enough data to replicate the current set of deployments, bundles, and assets on any system that runs _Divine.dotfiles_.
Naturally, it is recommended to take the Grail under version control and sync it, e.g., via a cloud service or Github.

The Grail is sub-structured as follows:

* `*assets*/` — The directory for user's assets, such as config files.
* `*dpls*/` — The directory for user's custom deployments.
* `*.stash.cfg*` — _The Grail-level <<stash-main,stash>> container, maintained by the framework._
* `*.stash.cfg.md5*` — _The stash integrity checksum, maintained by the framework._

The location of the Grail directory can be permanently overridden by creating a file named `.grail-dir-path` in the root of the <<fmwk-state,state>> directory.
This file should contain the overriding path as its first line.

| [[fmwk-state]]+++<p align="center">+++#`~/.divine/*state*/`#+++</p>+++

*The state directory* stores the current state of deployment installations on current system.
_(The entire state directory is maintained by the framework.)_

As this directory is automated and is specific to the machine it is maintained on, it is normally not needed to dive into it manually or version-control it.
Still, this directory might come in handy in some emergency situations.

The state directory is sub-structured as follows:

* `*backups*/` — The directory for the deployment-level <<fmwk-zero-data-loss,backups>>.
* `*bundles*/` — The directory for the copies of <<rtn-attach,attached>> bundles of deployments.
* `*stash*/` — The directory for the key-value containers of the root-level and deployment-level <<stash-main,stashing>> system.

| [[fmwk-lib]]+++<p align="center">+++#`~/.divine/*lib*/`#+++</p>+++

This directory holds the guts of the framework.
_(The entire directory is, naturally, maintained by the framework.)_

| [[fmwk-script]]+++<p align="center">+++#`~/.divine/*intervene.sh*`#+++</p>+++

The <<iutil-main,*Divine intervention utility*>>.
This script is the command line interface to the framework.
_(The script file is, of course, maintained by the framework.)_

| [[fmwk-shortcut]]+++<p align="center">+++#`_A{us}DIR{us}ON{us}$PATH_/*di*`#+++</p>+++

The shortcut command: a symlink to the framework's <<fmwk-script,main script>>, `intervene.sh`.
This symlink is normally created automatically, during the framework installation.

|===

== Installing and uninstalling the framework

=== System requirements

[[fmwk-os-support]]
* A https://en.wikipedia.org/wiki/Unix-like[Unix-like OS].
The following OS distributions are openly supported:
+
--
** *Debian*
** *Fedora*
** *FreeBSD*
** *macOS*
** *Ubuntu*
--
+
[.note]
[%noheader,cols="<.<a"]
|===
| This list is incomplete; you can help by <<cntrb-os-support,expanding it>>.
|===
+
The framework will work on other operating systems too, but without the support for packages (e.g., the <<dfls-main,Divinefiles>> will not work).

* Bash 3.2+ and either `curl` or `wget`.
+
[.note]
[%noheader,cols="<.<a"]
|===
| Git is not a hard requirement, but it is not a flaccid one either.
_Divine.dotfiles_ can be installed without Git.
However, the framework will then proceed to vex the user with suggestions to auto-install it, until some day the `y` key is finally pressed.
|===

[[fmwk-install]]
=== Installing the framework

The following single shell command installs the _Divine.dotfiles_ framework:

[%noheader,cols="<.<a"]
|===
| `bash -c 'TMP=$(mktemp); URL=https://raw.github.com/divine-dotfiles/divine-dotfiles/main/lib/install/install.sh; if curl --version &>/dev/null; then curl -fsSL $URL >$TMP; elif wget --version &>/dev/null; then wget -O $TMP $URL; else printf >&2 "\n==> Error: failed to detect neither curl nor wget\n"; rm -f $TMP; exit 1; fi {vbar}{vbar} { printf >&2 "\n==> Error: failed to download installation script\n"; rm -f $TMP; exit 2; }; mv -n $TMP ~ && TMP=$HOME/$(basename $TMP) && chmod +x $TMP && $TMP "$@"; RC=$?; rm -f $TMP; \((RC)) && exit 3 {vbar}{vbar} exit 0' bash`
|===

Equivalently, the framework can be installed from a local copy of this repository (located _not_ at the installation path) by running this command:

[source,bash]
----
./intervene.sh fmwk-install
----

[.note]
[%noheader,cols="<.<a"]
|===
| The framework installation does nothing too spectacular:

* Optional dependencies — such as Git — will be offered, unless installed already.
* This repository will be cloned/downloaded.
* Optionally, the symlink (<<fmwk-shortcut,`di`>>) to the framework's main script will be created on `$PATH`.
* The zero data loss <<fmwk-zero-data-loss,policy>> will be in effect, as normal.

The script will <<fmwk-interactivity,prompt>> for every major life decision.
|===

The documentation assumes that the framework has been installed with the optional shortcut command <<fmwk-shortcut,`di`>>.
Still, all invocations of the `di` command are equivalent to executing the `./intervene.sh` script in the root of the installation directory.

[[fmwk-install-opts]]
==== Installation options and overrides

.Framework installation options and overrides
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Prepend on the left

| `*D_DIR*=_DIRPATH_`

By default, the framework is installed into the `~/.divine/` directory.
This directs to instead install it into the `_DIRPATH_` directory.

| `*D_SHCT_NAME*=_CMD_`

By default, the <<fmwk-shortcut,shortcut command>> for the framework is named `di`.
This directs to name it `_CMD_` instead.

| `*D_SHCT_DIR*=_DIRPATH_`

By default, the <<fmwk-shortcut,shortcut command>> for the framework is installed into one of the usual `/{das}/bin/` directories on `$PATH`.
This directs to instead install it into the `_DIRPATH_` directory.

^.^h| Append on the right

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the prompts about installing the framework and all optional parts.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
*Framework prompt options*
+++<br>+++
`*-d*`, `*--fmwk-yes*`
+++<br>+++
`*-D*`, `*--fmwk-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about installing the framework.

Other options notwithstanding, *the* `*--fmwk-no*` *option guarantees a 'dry run'*, because no optional parts are installed without the framework itself.

| +++<p align="center">+++
*Shortcut prompt options*
+++<br>+++
`*-s*`, `*--shct-yes*`
+++<br>+++
`*-S*`, `*--shct-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about installing the <<fmwk-shortcut,shortcut command>>.

| +++<p align="center">+++
`*-f*`, `*--force*`
+++</p>+++

The framework adheres to the non-interference <<fmwk-non-interference,policy>>.

If the destination path for the framework already exists and is not an empty directory, the installation unconditionally backs off with an alert.

The `--force` option directs to instead <<fmwk-upmt,urgently>> prompt the user and, if given permission, to displace the pre-existing destination to a backup location.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of installation output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

Note, that no combination of options guarantees an unattended installation of the framework.
For example, when installing the optional Git dependency, the underlying package manager may interact with the user in ways that are outside of the script's control.
As established before, _Divine.dotfiles_ is intended as an <<fmwk-interactivity,interactive>> tool.

[[fmwk-uninstall]]
=== Uninstalling the framework

The following single shell command uninstalls the _Divine.dotfiles_ framework:

[%noheader,cols="<.<a"]
|===
| `bash -c 'TMP=$(mktemp); URL=https://raw.github.com/divine-dotfiles/divine-dotfiles/main/lib/uninstall/uninstall.sh; if curl --version &>/dev/null; then curl -fsSL $URL >$TMP; elif wget --version &>/dev/null; then wget -O $TMP $URL; else printf >&2 "\n==> Error: failed to detect neither curl nor wget\n"; rm -f $TMP; exit 1; fi {vbar}{vbar} { printf >&2 "\n==> Error: failed to download uninstallation script\n"; rm -f $TMP; exit 2; }; mv -n $TMP ~ && TMP=$HOME/$(basename $TMP) && chmod +x $TMP && $TMP "$@"; RC=$?;rm -f $TMP; \((RC)) && exit 3 {vbar}{vbar} exit 0' bash`
|===

Equivalently, the framework can be uninstalled from a local copy of this repository (located anywhere) by running this command:

[source,bash]
----
./intervene.sh fmwk-uninstall
----

Also, an existing installation of _Divine.dotfiles_ may be directed to uninstall itself:

[source,bash]
----
di fmwk-uninstall
----

[.note]
[%noheader,cols="<.<a"]
|===
| The framework uninstallation plays out like this:

* Optional dependencies that have been installed will be offered for removal.
* The installation directory will be displaced (backed up) according to the zero data loss <<fmwk-zero-data-loss,policy>>.
* The <<fmwk-grail,Grail>> directory will remain untouched.
* The optional symlink (<<iutil-main,`di`>>) will be erased.

The script will <<fmwk-interactivity,prompt>> for every major life decision.
|===

One thing that framework uninstallation does *_not_* do is uninstall deployments.
If not needed, any deployments that might have been installed *_must be removed manually_* before uninstalling Divine.dotfiles. 

[[fmwk-uninstall-opts]]
==== Uninstallation options and overrides

.Framework uninstallation options and overrides
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Prepend on the left

| `*D_DIR*=_DIRPATH_`

By default, the framework is uninstalled from the `~/.divine/` directory.
This directs to instead uninstall it from the `_DIRPATH_` directory.

^.^h| Append on the right

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the prompts about uninstalling the framework and all optional parts.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
*Framework prompt options*
+++<br>+++
`*-d*`, `*--fmwk-yes*`
+++<br>+++
`*-D*`, `*--fmwk-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about uninstalling the framework.

Other options notwithstanding, *the* `*--fmwk-no*` *option guarantees a 'dry run'*, because no optional parts are uninstalled without the framework itself.

| +++<p align="center">+++
*Optional dependency prompt options*
+++<br>+++
`*-u*`, `*--util-yes*`
+++<br>+++
`*-U*`, `*--util-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about uninstalling the optional dependencies that might have been installed.

| +++<p align="center">+++
`*-f*`, `*--force*`
+++</p>+++

The framework adheres to the reversibility <<fmwk-reversibility,policy>>.

If the script fails to uninstall any of the optional dependencies, the installation unconditionally backs off with an alert.

The `--force` option directs to instead <<fmwk-upmt,urgently>> prompt the user and, if given permission, to ignore the debacle and uninstall the framework anyway.

| +++<p align="center">+++
`*-o*`, `*--obliterate*`
+++</p>+++

The framework adheres to the zero data loss <<fmwk-zero-data-loss,policy>>.

Accordingly, during the uninstallation of the framework, its directory is displaced into a backup location, and the <<fmwk-grail,Grail>> directory is untouched.

The `--obliterate` option directs to instead erase both the framework directory and the Grail without any backups.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of uninstallation output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

Note, that no combination of options guarantees an unattended uninstallation of the framework.
As established before, _Divine.dotfiles_ is intended as an <<fmwk-interactivity,interactive>> tool.

[[fmwk-joy-ride]]
=== Joy ride

The following single shell command provides the <<fmwk-joy-ride-sum,introductory experience>> of the framework and deployments:

* <<fmwk-install,installs>> the framework;
* <<rtn-attach,attaches>> the https://github.com/divine-bundles/essentials[`*essentials*`] bundle of Divine deployments (distributed separately);
* <<rtn-install,installs>> the attached deployments.

All three sub-commands *skip* the trivial <<fmwk-interactivity,prompts>> (e.g., 'Are you sure?').

[%noheader,cols="<.<a"]
|===
| `bash -c 'TMP=$(mktemp); URL=https://raw.github.com/divine-dotfiles/divine-dotfiles/main/lib/install/install.sh; if curl --version &>/dev/null; then curl -fsSL $URL >$TMP; elif wget --version &>/dev/null; then wget -O $TMP $URL; else printf >&2 "\n==> Error: failed to detect neither curl nor wget\n"; rm -f $TMP; exit 1; fi {vbar}{vbar} { printf >&2 "\n==> Error: failed to download installation script\n"; rm -f $TMP; exit 2; }; mv -n $TMP ~ && TMP=$HOME/$(basename $TMP) && chmod +x $TMP && $TMP "$@"; RC=$?; rm -f $TMP; \((RC)) && exit 3 {vbar}{vbar} exit 0' bash --yes && ~/.divine/intervene.sh attach essentials --yes && ~/.divine/intervene.sh install --yes`
|===

(The *undo* command is provided in the <<fmwk-joy-ride-undo,following section>>.)

Both the framework and deployments <<fmwk-zero-data-loss,do not overwrite>> pre-existing files on the system without backing them up.
Everything that is backed up is <<fmwk-reversibility,automatically restored>> upon removal.

After all installations are successful, it might be necessary to *reload the shell* (or even re-log into the system on macOS).
This depends on whether the default shell has been changed.

[[fmwk-joy-ride-sum]]
==== What it does

Once the bundle is fully installed, and the shell reloaded, _voilà_:

* https://sourceforge.net/projects/zsh[Zsh] is the default shell.
* Zsh is augmented with https://github.com/zsh-users/zsh-completions[completions], https://github.com/zsh-users/zsh-syntax-highlighting[syntax highlighting], and https://github.com/zsh-users/zsh-autosuggestions[auto-suggestions].
* Basic necessities, such as https://git-scm.com[Git], https://www.vim.org[Vim], and https://gnupg.org[GnuPG] are available.
* Both https://ohmyz.sh[oh-my-zsh] and https://github.com/Bash-it/bash-it[Bash-it] frameworks are installed and loaded.
* A minimalistic theme for both shell frameworks is active.
* Opinionated configs are plugged in for Git, Vim, Bash, and Zsh.
* Any pre-existing files that have gotten in the way are safely backed up or re-used.

All of the above is controlled and customized through the key configuration files, which are located at `~/<<fmwk-grail,.grail>>/assets/`.

.Overview of asset directories for the bundle `essentials`
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*bash-it*/` *&dagger;*
+++</p>+++

Custom assets for the https://github.com/Bash-it/bash-it[Bash-it] shell framework.

| +++<p align="center">+++
`*brewfile*/` *&dagger;*
+++</p>+++

The https://github.com/Homebrew/homebrew-bundle[Brewfile], maintained on macOS.

| +++<p align="center">+++
`*config-git*/`
+++</p>+++

The global configuration for Git.

| +++<p align="center">+++
`*config-shell*/`
+++</p>+++

The startup scripts (https://en.wikipedia.org/wiki/Run_commands[runcoms]) for Bash and Zsh.

| +++<p align="center">+++
`*config-vim*/`
+++</p>+++

The global configuration for Vim.

| +++<p align="center">+++
`*home-dirs*/` *&dagger;*
+++</p>+++

The file `*home-dirs.cfg*` defines a sub-directory tree to be maintained under the home directory.

| +++<p align="center">+++
`*oh-my-zsh*/` *&dagger;*
+++</p>+++

Custom assets for the https://ohmyz.sh[oh-my-zsh] shell framework.

| +++<p align="center">+++
`*portable-bin*/`
+++</p>+++

The container for the personal executables (this directory is maintained on the `$PATH`).

|===

[.note]
[%noheader,cols="<.<a"]
|===
| The dagger mark (*&dagger;*) meaning: in order for the modifications in that asset directory to take effect, the deployment must be (re-)installed.
|===

[[fmwk-joy-ride-undo]]
==== Undoing the joy ride

The following single shell command methodically undoes the <<fmwk-joy-ride,joy ride>> installation:

* <<rtn-remove,removes>> (uninstalls) the attached deployments;
* <<rtn-detach,detaches>> the https://github.com/divine-bundles/essentials[`*essentials*`] bundle;
* <<fmwk-uninstall,uninstalls>> the framework.

All three sub-commands *skip* the trivial <<fmwk-interactivity,prompts>> (e.g., 'Are you sure?').

The original state of the system (before the installation) is <<fmwk-reversibility,restored>>.
However, <<opt-obliterate,no copies>> of the framework's assets are kept.

[%noheader,cols="<.<a"]
|===
| `~/.divine/intervene.sh remove --yes --obliterate && ~/.divine/intervene.sh detach essentials --yes && bash -c 'TMP=$(mktemp); URL=https://raw.github.com/divine-dotfiles/divine-dotfiles/main/lib/uninstall/uninstall.sh; if curl --version &>/dev/null; then curl -fsSL $URL >$TMP; elif wget --version &>/dev/null; then wget -O $TMP $URL; else printf >&2 "\n==> Error: failed to detect neither curl nor wget\n"; rm -f $TMP; exit 1; fi {vbar}{vbar} { printf >&2 "\n==> Error: failed to download uninstallation script\n"; rm -f $TMP; exit 2; }; mv -n $TMP ~ && TMP=$HOME/$(basename $TMP) && chmod +x $TMP && $TMP "$@"; RC=$?;rm -f $TMP; \((RC)) && exit 3 {vbar}{vbar} exit 0' bash --yes --obliterate`
|===

After the undo steps have successfully run, there is no trace of _Divine.dotfiles_ on the system.
_(Sigh.)_

== Usage

[[iutil-main]]
=== Divine intervention utility `di`

_Divine.dotfiles_ provides a command line interface via *Divine intervention utility `di`*.
(Invoking the shortcut <<fmwk-shortcut,`di`>> is equivalent to executing the framework's <<fmwk-script,main script>>, `intervene.sh`.)

[source,subs="verbatim,quotes,attributes"]
----
*di* [-efhlnoqvwy]… [--version] [-b *_BUNDLE_*]… [--] *_ROUTINE_* [*_ARG_*]…
----

The first non-option argument, `*_ROUTINE_*`, can be any of the following:

.List of the intervention utility's routines
[%noheader,cols="<.<a",stripes=none]
|===

| The <<rtn-primaries,*primary routines*>>, operating on deployments:

* `*c*{vbar}<<rtn-check,*check*>>` — checks whether deployments are installed or not;
* `*i*{vbar}<<rtn-install,*install*>>` — checks, then, if not installed, installs;
* `*r*{vbar}<<rtn-remove,*remove*>>` — checks, then, if installed, removes.

| The <<rtn-bundles,*bundle routines*>>, operating on Github repositories:

* `*a*{vbar}<<rtn-attach,*attach*>>` — imports Github repositories that contain deployments.
* `*d*{vbar}<<rtn-detach,*detach*>>` — erases previously attached Github repositories.

| The routine that wrangles the <<fmwk-grail,Grail directory>>:

* `*p*{vbar}<<rtn-plug,*plug*>>` — replaces the current Grail directory with the one provided.

| The routine that brings what it can up to date:

* `*u*{vbar}<<rtn-update,*update*>>` — updates the framework itself, the Grail directory (if it is a cloned repository), and the attached bundles.

|===

[.note]
[%noheader,cols="<.<a"]
|===
| The term '<<dpls-main,deployments>>' includes <<dfls-main,Divinefiles>> as a special kind.
|===

[[iutil-arg-parsing]]
=== Options and arguments

The intervention routines, and the _Divine.dotfiles_ overall, use a familiar set of rules for parsing <<rtn-primaries-opts,options>> and <<rtn-primaries-args,arguments>>:

* The options and arguments are read left-to-right, word by word, separated by any unescaped whitespace.
+
Whenever options override each other, the last option given wins.
In the documentation, the overriding options have their descriptions grouped.
* Most options have single-character and long versions, which are equivalent.
* The single-character options can be combined (`-_CHARS_`).
+
Words that start with one hyphen are interpreted as combined options.
* Words that start with two hyphens (`--_WORD_`) are interpreted as long options.
* The arguments and options can be freely mixed; all words after the optional separator (`*--*`) are interpreted as arguments.
* The two special options take priority over all other arguments/options:
** `*-h*`, `*--help*` — outputs the help summary for the intervention utility.
** `*--version*` — prints the version of the framework.

[[rtn-primaries]]
=== Primary routines (`check`, `install`, `remove`)

The three primary routines somewhat correspond to the three fundamental actions (functions) that the framework recognizes for any deployment:

* checking whether something is installed;
* installing it;
* and removing it.

The correspondence is not strictly one-to-one because all three primary routines do the checking part.
The <<rtn-check,`check`>> routine stops there, but the <<rtn-install,`install`>> and <<rtn-remove,`remove`>> routines proceed based on the `check` result.

[[rtn-check]]
==== `check` routine

The `check` routine iterates over deployments (and Divinefile packages), ordered by *ascending* <<dpls-metadata,priority>> (smaller numbers first).
The routine checks whether each item is installed or not, then prints the appropriate plaque.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-efhnoqvwy] [-b *_BUNDLE_*]… [--] *c*|*check* [*_NAME_*]…
----

The meaning of the optional `*_NAME_*` <<rtn-primaries-args,arguments>> and the <<rtn-primaries-opts,options>> is near identical for all three primary routines.
Their description is grouped below.

For each deployment, the `check` routine calls the <<func-dpl-check,`d_dpl_check`>> primary function, and deduces the current status from the return code.

[[rtn-install]]
==== `install` routine

The `install` routine iterates over deployments (and Divinefile packages), ordered by *ascending* <<dpls-metadata,priority>> (smaller numbers first).
The routine checks whether each item is installed or not.
If the item is not (fully) installed, the routine installs it, and prints the appropriate plaque.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-efhnoqvwy] [-b *_BUNDLE_*]… [--] *i*|*install* [*_NAME_*]…
----

The meaning of the optional `*_NAME_*` <<rtn-primaries-args,arguments>> and the <<rtn-primaries-opts,options>> is near identical for all three primary routines.
Their description is grouped below.

For each deployment, the `install` routine calls the <<func-dpl-check,`d_dpl_check`>> primary function, and deduces the current status from the return code.
Depending on that, the routine either returns immediately, or calls the <<func-dpl-install,`d_dpl_install`>> primary function.
The return code of the latter is taken to indicate whether the installation succeeded.

[[rtn-remove]]
==== `remove` routine

The `remove` routine iterates over deployments (and Divinefile packages), ordered by *descending* <<dpls-metadata,priority>> (larger numbers first).
The routine checks whether each item is installed or not.
If the item is (at least in some part) previously installed, the routine removes it, and prints the appropriate plaque.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-efhnoqvwy] [-b *_BUNDLE_*]… [--] *r*|*remove* [*_NAME_*]…
----

The meaning of the optional `*_NAME_*` <<rtn-primaries-args,arguments>> and the <<rtn-primaries-opts,options>> is near identical for all three primary routines.
Their description is grouped below.

For each deployment, the `remove` routine calls the <<func-dpl-check,`d_dpl_check`>> primary function, and deduces the current status from the return code.
Depending on that, the routine either returns immediately, or calls the <<func-dpl-remove,`d_dpl_remove`>> primary function.
The return code of the latter is taken to indicate whether the removal succeeded.

[[rtn-primaries-args]]
==== Specifying deployments

For the optional `*_NAME_*` arguments, the following (case-insensitive) values are accepted:

* <<dpls-metadata,Names>> of <<dpls-main,deployments>>.
* Reserved synonyms for <<dfls-main,Divinefiles>>: `divinefile`, `dfile`, `df`.
* Single-digit names of <<mtdt-groups,deployment groups>>: `0`, `1`, `2`, `3`, `4`, `5`, `6`, `7`, `8`, `9`.

The primary routines filter the deployments according to these rules:

* Without any `*_NAME_*` arguments, all deployments are processed.
* With at least one `*_NAME_*` argument, some form of filtering is applied:
** In the *normal filtering*, a deployment is processed if and only if it is requested by name or by name of its <<mtdt-groups,single-digit group>>.
** The <<opt-except,`--except`>> option makes the filtering *inverted*: all deployments are processed, *unless* requested by name or by name of its <<mtdt-groups,single-digit group>>.
+
Note, that without any `*_NAME_*` arguments, the <<opt-except,`--except`>> option is a no-opt.

<<mtdt-exclam,Dangerous>> deployments are treated specially:

* A dangerous deployment is ignored by both filtering modes, *unless* it is requested by name in the normal filtering.
+
Note, that requesting by name of the <<mtdt-groups,single-digit group>> does not work for dangerous deployments.
* The <<opt-with-exclam,`--with-!`>> option prevents any special treatment of dangerous deployments.

Deployments are retrieved from two directories (at any depth):

* The directory for user's deployments: `~/<<fmwk-grail,.grail>>/dpls/`.
* The directory for attached bundles of deployments: `<<fmwk-state,state>>/bundles/`.

The search can be narrowed down to particular bundles of deployments by including any number of the <<opt-bundle,`--bundle`>> options.

[[rtn-primaries-opts]]
==== Primary routine options

The run-time state of all options can be inspected within the deployment code through their corresponding read-only global variables.

The Divine <<divine-bundles,bundles>> of deployments follow the given interpretation of the options, as well as the framework's <<fmwk-design,design>> in general.
A 'good' deployment is expected to follow suit.

.Primary routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[opt-answers]][[opt-yes]][[opt-no]]*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before sourcing (reading and interpreting) each deployment script.
* A confirmation before installing an optional framework dependency.

Examples of the <<fmwk-upmt,urgent>> prompts, which are *not* affected by the prompt options:

* A confirmation before undertaking a <<opt-force,forced>> action.
* Any prompt in the user-defined deployment code, unless it is specifically made to honor this option.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no user code will be sourced, and no changes to the system will be introduced.

The status of the prompt options is reflected in the value of the `$*D__OPT_ANSWER*` variable:

* `true` — the `--yes` option is active;
* `false` — the `--no` option is active;
* _empty_ — none of the prompt options have been given.

| +++<p align="center">+++
[[opt-obliterate]]`*-o*`, `*--obliterate*`
+++</p>+++

The framework adheres to the zero data loss <<fmwk-zero-data-loss,policy>>.

Whenever a built-in framework mechanism is not sure whether a particular piece of data is recoverable, it chooses to displace it to a backup location instead of deleting it.

The `--obliterate` option directs to instead erase such data.

The presence of the `--obliterate` option is reflected in the value of the `$*D__OPT_OBLITERATE*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-force]]`*-f*`, `*--force*`
+++</p>+++

The framework adheres to the non-interference <<fmwk-non-interference,policy>>.

During the <<rtn-install,`install`>> and <<rtn-remove,`remove`>> routines, if the `check` <<rtc-check,code>> speaks to a clash with something done by the user or the operating system (e.g., a previously installed file is nowhere to be found), the framework unconditionally backs off with an alert.

The `--force` option directs to instead <<fmwk-upmt,urgently>> prompt the user and, if given permission, carry out the installation/removal anyway.

The presence of the `--force` option is reflected in the value of the `$*D__OPT_FORCE*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-bundle]]`*-b* _BUNDLE_`, `*--bundle* _BUNDLE_` _(repeatable)_
+++</p>+++

If at least one such option is included, the search for deployments will be limited to the given <<rtn-attach,attached>> bundles of deployments.

The same values are accepted for the `_BUNDLE_` arguments as are for the <<rtn-bundles-args,`_REPO_`>> arguments during the <<rtn-bundles,bundle routines>>.

The list of requested bundles (if any) is reflected in the items of the `${*D__REQ_BUNDLES*[@]}` array.

| +++<p align="center">+++
[[opt-except]]`*-e*`, `*--except*`
+++</p>+++

The primary routines <<rtn-primaries-args,interpret>> the optional `*_NAME_*` arguments as a list of deployments to process.
The `--except` option directs to instead interpret the arguments as the list of deployments to exclude from processing.

The presence of the `--except` option is reflected in the value of the `$*D__OPT_INVERSE*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-with-exclam]]`*-w*`, `*--with-!*`
+++</p>+++

The primary routines <<rtn-primaries-args,interpret>> the <<mtdt-exclam,dangerous>> deployments (marked with the `!` flag) specially by making them harder to accidentally process.
The `--with-!` option directs to instead give them no special treatment at all.

The presence of the `--with-!` option is reflected in the value of the `$*D__OPT_EXCLAM*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-verbosity]][[opt-verbose]][[opt-quiet]]*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.

Every instance of the `--verbose` option increments by one the *global verbosity level* of the framework.
On the other hand, the framework's printing functions have the comparable *quiet level*.
For a message to be printed, the global verbosity level must be greater than or equal to that message's quiet level.

The `--quiet` option reverts the global verbosity level to its default value of zero.

The amount of output per the verbosity level can be described as such:

* `-q` — prints just the essentials and the critical alerts;
* `-v` — allows some non-critical alerts here and there;
* `-vv` — also, announces the internal context switches;
* `-vvv` — enters into the serious debugging mode;
* `-vvvv` — just floods the user with everything it has.
+
Further verbosity levels are yet unused by the framework.

The global verbosity level is reflected in the value of the `$*D__OPT_VERBOSITY*` variable, which is a non-negative integer.

|===

[[rtn-bundles]]
=== Bundle routines (`attach`, `detach`)

The framework treats any Github repository containing <<dpls-main,deployments>> as *bundles* of deployments.

When a bundle is *attached* to the particular <<fmwk-grail,Grail directory>>, its address is stored in the Grail <<stash-main,stash>>, while a copy of the repository is pulled into the <<fmwk-state,state directory>>.
This way, the attached deployments are treated as if they are in the Grail, but the directory itself is not unnecessarily bloated.

On every invocation, the <<iutil-main, intervention utility>> synchronizes the stashed list of attached bundles with the copies in the state directory.
Thus, transfering the Grail directory alone to another machine is enough to fully re-create the set of deployments.

The two bundle routines do what one might expect:

* <<rtn-attach,attaching>> a bundle;
* <<rtn-detach,detaching>> the previously attached bundle.

[[rtn-attach]]
==== `attach` routine

The `attach` routine takes any number of repository handles, ensures that they correspond to existing Github repositories containing deployments, and attaches each that does.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-yn]… [--] *a*|*attach* [*_REPO_*]…
----

The meaning of the optional `*_REPO_*` <<rtn-bundles-args,arguments>> and the <<rtn-bundles-opts,options>> is identical for both bundle routines.
Their description is grouped below.

[[rtn-detach]]
==== `detach` routine

The `detach` routine takes any number of repository handles, ensures that they are currently attached to the Grail directory, and detaches those that are.
Both the 

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-yn]… [--] *d*|*detach* [*_REPO_*]…
----

The meaning of the optional `*_REPO_*` <<rtn-bundles-args,arguments>> and the <<rtn-bundles-opts,options>> is identical for both bundle routines.
Their description is grouped below.

Detaching a bundle deletes the copy of its repository, as well as the stash record.
However, it is left to the user to:

* Uninstall the deployments.
+
(If a lapse occurred, re-attaching and uninstalling should work fine.)
* Remove any assets that might have been copied into the <<fmwk-grail,Grail>>'s asset directory.

[[rtn-bundles-args]]
==== Specifying bundles

For the optional `*_REPO_*` arguments, the following (case-insensitive) values are accepted:

* A Github repository in the form: `username/repository`.
* Specifically for the <<divine-bundles,Divine bundles>>, a shorthand is accepted:
+
[source,subs="verbatim,quotes,attributes"]
----
*_REPO_*  =>  divine-bundles/*_REPO_*
----
+
(`*_REPO_*` must match the RegEx pattern `^[0-9A-Za-z_.-]+$`.)

[[rtn-bundles-opts]]
==== Bundle routine options

.Bundle routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before attaching or detaching a bundle.
* A confirmation before installing an optional framework dependency.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

[[rtn-plug]]
=== `plug` routine

The <<fmwk-grail,Grail directory>> is the central hub for all user content.
As such, it is the obvious target for version controlling and syncing.

The `plug` routine, unsurprisingly, imports an externally saved Grail directory, replacing the currently existing one.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-ynl] [--] *p*|*plug* *_ADDRESS_*
----

For the `*_ADDRESS_*` argument, the following (case-insensitive) values are accepted:

* A Github repository in the form: `username/repository`.
* A path to a Git repository.
* A path to a local directory.

The framework iterates over possible interpretations of the argument and prompts the user for confirmation.

The repositories are cloned, the directories are copied.
The pre-existing Grail directory is backed up in-place by appending the `.bak` suffix.

==== `plug` routine options

.`plug` routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before interpreting the `*_ADDRESS_*` argument in a particular way.
* A confirmation before installing an optional framework dependency.

With the `--yes` option active, the first viable interpretation of the `*_ADDRESS_*` argument will be silently settled upon.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
`*-o*`, `*--obliterate*`
+++</p>+++

The framework adheres to the zero data loss <<fmwk-zero-data-loss,policy>>.

Accordingly, during the `plug` routine the pre-existing Grail directory is displaced into a backup location.

The `--obliterate` option directs to instead erase the pre-existing Grail.

| +++<p align="center">+++
`*-l*`, `*--link*`
+++</p>+++

Normally, the `plug` routine retrieves a copy of the Grail at the given `*_ADDRESS_*`.

The `--link` option directs to instead create a symlink to it.
Consequently, when the `--link` option is active, the `*_ADDRESS_*` is interpreted only as a local directory.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

[[rtn-update]]
=== `update` routine

There are three parts of a _Divine.dotfiles_ installation that are potentially cloned Git repositories:

* The framework https://github.com/divine-dotfiles/divine-dotfiles[itself].
* The Grail directory (if <<rtn-plug,plugged>> from a repository).
* The <<rtn-bundles,attached>> bundles of deployments.

The update routine is a convenient tool that pulls the latest updates from the remote `master` branches of such repositories.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-yn] [--] *u*|*update* [*f*|*framework*] [*g*|*grail*] [*b*|*bundles*]
----

The `update` routine is three-pronged, and the user is free to choose which prongs to engage by providing or not providing arguments:

* `*f*|*framework*` updates the framework.
* `*g*|*grail*` — updates the cloned <<fmwk-grail,Grail directory>>.
* `*b*|*bundles*` — updates all <<rtn-bundles,attached>> bundles of deployments.
* Without any arguments, all three types of updates are performed.

==== `update` routine options

.`update` routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before pulling from a remote repository.
* A confirmation before installing an optional framework dependency.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
`*-b* _BUNDLE_`, `*--bundle* _BUNDLE_` _(repeatable)_
+++</p>+++

If at least one such option is included:

* the presence of `*bundles*` argument is implicitly assumed;
* only the given bundles (if currently <<rtn-attach,attached>>) are updated.

The same values are accepted for the `_BUNDLE_` arguments as are for the <<rtn-bundles-args,`_REPO_`>> arguments during the <<rtn-bundles,bundle routines>>.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

[[dpls-main]]
== Deployments

A _Divine.dotfiles_ *deployment* is a Bash script with the file name consisting of a non-empty name and the `.dpl.sh` suffix.
No other parts of a deployment are mandatory.

To be picked up by the framework, the deployments must be located at any depth under the two recognized deployment locations:

* `~/<<fmwk-grail,.grail>>/dpls/` — the user's deployments;
* `<<fmwk-state,state>>/bundles/` — the <<rtn-bundles,attached>> bundles of deployments.

=== Deployment structure

The minimal valid deployment is an empty file.
As such, it does nothing but appear in the framework output.

Deployments are written in Bash syntax, with some syntax limitations on the <<dpls-metadata,metadata>>.
Each deployment is sourced by the Bash interpreter no more than once per <<rtn-primaries,primary routine>>.

To be useful, a deployment may contain:

* Implementations of any or all of the <<func-primaries,*primary functions*>>.
* Assignments to the special pseudo-variables — the <<dpls-metadata,*metadata*>>.

It is highly recommended to *not* include any non-trivial Bash code outside of functions.
Nothing will prevent things from going off the rails.
There are <<fmwk-security,*no*>> safety nets.
Unless the intention is very well thought-out, _Divine.dotfiles_ is only useful while the guidelines are followed.

[[func-primaries]]
=== Primary functions (`d_dpl_check`, `d_dpl_install`, `d_dpl_remove`)

The *primary functions*, or *primaries*, correspond to the three fundamental actions performed by a deployment:

* `<<func-dpl-check,*d_dpl_check*>>` — checks whether the deployment is installed or not.
* `<<func-dpl-install,*d_dpl_install*>>` — installs the deployment.
* `<<func-dpl-remove,*d_dpl_remove*>>` — removes (reverses the previous installation of) the deployment.

The primary functions have the following ways of interacting with the framework:

* To 'talk' to the framework:
** The *return* <<rtc-main,*codes*>> are the main vehicles of indicating status.
** The <<addst-main,*add-statuses*>> (specially named global variables) are available to tweak the behavior in some places.
* To 'hear' from the framework:
** The <<indct-main,*indicator*>> *variables* are populated by the framework with the relevant run-time data.

[[func-dpl-check]]
==== Primary function `d_dpl_check`

If this function is implemented, it will be called:

* During the <<rtn-check,`check`>> routine — to determine the status and to show the relevant output.
* During the <<rtn-install,`install`>> routine — to determine whether the installation is warranted.
* During the <<rtn-remove,`remove`>> routine — to determine whether the removal is warranted.

The return code of the `d_dpl_check` function determines the current status of the deployment.
(The following summary of the recognized codes is expanded upon in the relevant <<rtc-check,section>>.)

* Basic codes:
** `*0*` — _'Truly unknown'_
+
This code is assumed if the `d_dpl_check` function is not implemented.
** `*1*` — _'Fully installed'_.
** `*2*` — _'Fully not installed'_.
** `*3*` — _'Irrelevant or invalid'_.
* Extended codes:
** `*4*` — _'Partly installed'_.
** `*5*` — _'Likely installed (unknown)'_.
** `*6*` — _'Manually removed (tinkered with)'_.
** `*7*` — _'Fully installed (by user or OS)'_.
** `*8*` — _'Partly installed (by user or OS)'_.
** `*9*` — _'Likely not installed (unknown)'_.

Some additional instructions can be passed to the framework via the <<addst-main,add-status>> variables and the deployment <<dpls-metadata,metadata>>.

[[func-dpl-install]]
==== Primary function `d_dpl_install`

If this function is implemented, it will be called:

* During the <<rtn-install,`install`>> routine — to install the deployment.

The return code of the `d_dpl_install` function describes the outcome of the installation.
(The following summary of the recognized codes is expanded upon in the relevant <<rtc-install,section>>.)

* `*0*` — _'Successfully installed'_
+
This code is assumed if the `d_dpl_install` function is not implemented.
* `*1*` — _'Failed to install'_.
* `*2*` — _'Refused to install'_.
* `*3*` — _'Partly installed'_.

Some additional instructions can be passed to the framework via the <<addst-main,add-status>> variables and the deployment <<dpls-metadata,metadata>>.

[[func-dpl-remove]]
==== Primary function `d_dpl_remove`

If this function is implemented, it will be called:

* During the <<rtn-remove,`remove`>> routine — to remove the deployment.

The return code of the `d_dpl_remove` function describes the outcome of the removal.
(The following summary of the recognized codes is expanded upon in the relevant <<rtc-remove,section>>.)

* `*0*` — _'Successfully removed'_
+
This code is assumed if the `d_dpl_remove` function is not implemented.
* `*1*` — _'Failed to remove'_.
* `*2*` — _'Refused to remove'_.
* `*3*` — _'Partly removed'_.

Some additional instructions can be passed to the framework via the <<addst-main,add-status>> variables and the deployment <<dpls-metadata,metadata>>.

[[dpls-metadata]]
=== Deployment metadata

*Deployment metadata* pose as definitions of Bash global variables and alter deployment's appearance and behavior.
In reality, the metadata 'assignments' are read from the file _before_ the Bash interpreter sources it.
The metadata are all optional; they may be given in any order and disjointly.
However, *the metadata must precede all other _code_ of the deployment script*.

* `<<mtdt-name-and-desc,*D_DPL_NAME*>>=_NAME_`
+
The explicit name for the deployment.
The implicit fallback name is the name of the deployment file sans the `.dpl.sh` suffix.
* `<<mtdt-name-and-desc,*D_DPL_DESC*>>="_DESCRIPTION TEXT_"`
+
The one-line description of the deployment.
For the user's eyes only.
* `<<mtdt-priority,*D_DPL_PRIORITY*>>=_PRIORITY_`
+
The priority of the deployment (a non-negative integer).
* `<<mtdt-flags,*D_DPL_FLAGS*>>=_FLAGS_`
+
The single-character flags that cause special treatment.
* `<<mtdt-warning,*D_DPL_WARNING*>>='_WARNING TEXT_'`
+
The one-line cautionary message about this deployment.
This message is printed to the user if and only if the <<mtdt-aa,always-prompt>> flag causes the appearance of an <<fmwk-upmt,urgent>> prompt.
* `<<mtdt-os,*D_DPL_OS*>>=( _OS LIST_ )`
+
The value of this pseudo-variable defines the list of operating systems that the deployment supports.
On non-supported OS's, the deployment is ignored completely.

Below is an example of metadata in the head of a deployment script:

[source,subs="verbatim,quotes,attributes"]
----
D_DPL_NAME=example
D_DPL_DESC='An example deployment'
D_DPL_PRIORITY=777
D_DPL_FLAGS=ci!89
D_DPL_WARNING="A warning message"
----

[[dpls-metadata-syntax]]
The following syntax limitations are imposed upon metadata:

* As mentioned above, the metadata must precede all other non-whitespace, non-commented lines of the deployment script.
* No more than one 'assignment' must be written per line, without line continuation.
* No Bash substitutions or comments are allowed.
* In keeping with the Bash syntax, no whitespace is allowed around the `=`.
* A pair of matching quotes around the value is allowed.
Such pair of quotes is stripped in processing.

[[mtdt-name-and-desc]]
==== Deployment name and description

[source,bash]
----
D_DPL_NAME=example
D_DPL_DESC='An example deployment'
----

While the *description* is mostly cosmetic, the *name* of a deployment is very important.
The name is the single unique identifier of every deployment.
If the deployment name is not provided explicitly, the name of the script file is used instead, sans the `.dpl.sh` suffix.

Deployment names are case insensitive.

The following restrictions are imposed upon the deployment names:

* A deployment may not be named `divinefile`, `dfile`, or `df`.
* A deployment name may not be a single digit or a single `!` symbol.
* No two deployments across the deployment directories may share a name.

If any of the naming rules is broken, the framework halts with an alert, even before a <<rtn-primaries,primary routine>> starts.

[[mtdt-priority]]
==== Deployment priority

[source,bash]
----
D_DPL_PRIORITY=777
----

The priority is the way to order the deployments for processing:

* The <<rtn-check,`check`>> and <<rtn-install,`install`>> routines order the deployments by *ascending* priority (smaller numbers first).
* The <<rtn-remove,`remove`>> routine orders the deployments by *descending* <<dpls-metadata,priority>> (larger numbers first).
* The order of deployments with the same priority is undefined.

The priority must be a non-negative integer, otherwise it falls back to *the default value of* `*4096*`.

[[mtdt-flags]]
==== Deployment flags

[source,bash]
----
D_DPL_FLAGS=ci!89
----

The flags alter some of the framework's behavior toward the deployment.

* A flag is a single non-whitespace character.
* Any number of flags can be combined in any order.
* Repeating a flag does not bear any additional significance.
* There is no way to unset a flag, apart from not setting it.
* Unsupported flags are silently ignored.

Below is the exhaustive rundown of supported flags and their effects.

.List of supported deployment flags
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[mtdt-groups]]`*[0-9]*` _(any single digit)_
+++</p>+++

Assigns the deployment to one of the ten single-digit *groups*.
When invoking a <<rtn-primaries,primary routine>>, a group of deployments may be <<rtn-primaries-args,referred>> to by that group's digit, instead of listing the deployment names.

| +++<p align="center">+++
[[mtdt-exclam]]`*!*` _(an exclamation mark)_
+++</p>+++

Marks the deployment as *dangerous*.
The framework ignores dangerous deployments, unless explicitly <<rtn-primaries-args,told>> not to.

| +++<p align="center">+++
[[mtdt-aa]]`*[cira]*` _(any of the four lowercase letters)_
+++</p>+++

These flags engage the *always-prompt* mode for particular <<rtn-primaries,primary routines>>.
An <<fmwk-upmt,urgent>> prompt will appear on the chosen routines, before the deployment script is sourced.

* `*c*` — always prompt during the <<rtn-check,`**c**heck`>> routine.
* `*i*` — always prompt during the <<rtn-install,`**i**nstall`>> routine.
* `*r*` — always prompt during the <<rtn-remove,`**r**emove`>> routine.
* `*a*` — **a**ll of the avove.

|===

[[mtdt-warning]]
==== Deployment warning

[source,bash]
----
D_DPL_WARNING="Warning for 'urgent' prompts forced by a flag"
----

If a deployment has a warning, and the <<mtdt-aa,always-prompt>> mode is engaged, then the warning is printed alongside the <<fmwk-upmt,urgent>> prompt.

[[mtdt-os]]
==== Deployment OS's

[source,bash]
----
# The deployment supports only the listed OS's:
  D_DPL_OS=( bsd macos )
  # or
  D_DPL_OS='debian fedora ubuntu'

# or

# The deployment supports all OS's except those listed:
  D_DPL_OS=( ! "linux" 'wsl' )
  # or
  D_DPL_OS="! cygwin msys solaris"
----

There are two equivalent syntaxes acceptable for the `D_DPL_OS` pseudo-variable: array and string.
The operating systems are given as a whitespace-separated list.
In the array syntax, the individual OS names may be quoted.

The entire list is negated by including the `!` symbol as the first non-whitespace character.
An empty list, negated or not, greenlights all OS's.
The equivalent keywords `any` and `all` are also reserved to denote any OS.

The names of the OS's are matched against the values of the <<indct-os-family,`D__OS_FAMILY`>> and <<indct-os-distro,`D__OS_DISTRO`>> indicators.
A match against any of the two is sufficient.

[[rtc-main]]
=== Return codes

The return codes are the main vehicle for communicating to the framework the result of running a <<func-primaries,primary function>>.

The supported return codes have semantic meanings, which affect the human-readable output.
In the case of the <<func-dpl-check,`d_dpl_check`>> function, the `check` code also determines whether the <<rtn-install,`install`>> and <<rtn-remove,`remove`>> routines proceed with their task.
Guidelines are provided for how to interpret the various `check` codes in the user-defined deployment code.

Finally, most of the extended `check` codes represent an unusual situation which causes the framework to unconditionally back off from the deployment, with an alert.
This is in keeping with the framework's non-interference <<fmwk-non-interference,policy>>.
The <<opt-force,`--force`>> option may be used to compel the framework.

[[rtc-check]]
==== `check` codes

The four <<rtc-check-basic,basic>> `check` codes are the bread & butter that can satisfy most deployment needs.
A set of <<rtc-check-extended,`extended`>> `check` codes is provided for those deployments that use the <<stash-main,stashing>> system to 'remember' the status of the installation between interventions.

.Supported return codes of the `d_dpl_check` function
[%noheader.stretch,cols="5*^.^,4*<.^",stripes=none]
|===

1.3+^.^h| `check` code
1.3+^.^h| Meaning
3.1+^.^h| Sub-statuses
4.1+^.^h| Actions during the <<rtn-primaries,primary routines>>
1.2+^.^h| Relevant?
1.2+^.^h| <<stash-main,Stash>> record?
1.2+^.^h| Appears installed?
2.1+^.^h| <<rtn-install,`*install*`>>
2.1+^.^h| <<rtn-remove,`*remove*`>>
^.^h| Regular
^.^h| <<opt-force,Forced>>
^.^h| Regular
^.^h| <<opt-force,Forced>>

9.1+h| [[rtc-check-basic]]Basic codes

| `*0*`
| 'Truly unknown'
| *Yes*
| _unused_
| _unknown_
2.1+| Push backup; install
2.1+| Uninstall; pop backup

| `*1*`
| 'Fully installed'
| *Yes*
| *Yes*
/
_unused_
| *Yes*
^.^h| _blocked_
| Push backup; install anew

—or—

Bring up to date
2.1+| Uninstall; pop backup; clear stash

| `*2*`
| 'Fully not installed'
| *Yes*
| No
/
_unused_
| No
2.1+| Push backup; install; set stash
^.^h| _blocked_
| Pop backup

| `*3*`
| 'Irrelevant or invalid'
| No
2.1+^.^h| _n/a_
4.1+^.^h| _blocked_

9.1+h| [[rtc-check-extended]]Extended codes

| `*4*`
| 'Partly installed'
| *Yes*
| *Yes*
/
_unused_
| **Par**tly
| Make us whole
| Push backup; install anew
2.1+| Uninstall; pop backup; clear stash

| `*5*`
| 'Likely installed (unknown)'
| *Yes*
| *Yes*
| _unknown_
^.^h| _blocked_
| Push backup; install anew

—or—

Bring up to date
^.^h| _blocked_
| Uninstall; pop backup; clear stash

| `*6*`
| 'Manually removed (tinkered with)'
| *Yes*
| *Yes*
| No
^.^h| _blocked_
| Push backup; install anew
^.^h| _blocked_
| Clear stash

| `*7*`
| 'Fully installed (by user or OS)'
| *Yes*
| No
| *Yes*
^.^h| _blocked_
| Push backup; install anew; set stash
^.^h| _blocked_
| Uninstall; pop backup

| `*8*`
| 'Partly installed (by user or OS)'
| *Yes*
| No
| **Par**tly
| Make whole; set stash
| Push backup; install anew; set stash
^.^h| _blocked_
| Uninstall; pop backup

| `*9*`
| 'Likely not installed (unknown)'
| *Yes*
| No
| _unknown_
^.^h| _blocked_
| Push backup; install; set stash
^.^h| _blocked_
| Pop backup

|===

[[rtc-install]]
==== `install` codes

The `install` codes are much less diversified than the <<rtc-check,`check` codes>> because no major internal decisions are made based on the result of the installation.

.Supported return codes of the `d_dpl_install` function
[%noheader.stretch,cols="2*^.^,1*<.^",stripes=none]
|===

^.^h| `install` code
^.^h| Meaning
^.^h| Elaboration

| `*0*`
| 'Successfully installed'
| The function has run without any errors.

| `*1*`
| 'Failed to install'
| There has been at least one error, which potentially created an inconsistent state.

| `*2*`
| 'Refused to install'
| The function has returned before proceeding to the installation proper.

| `*3*`
| 'Partly installed'
| The function has returned midway (because of an error), but has avoided creating an inconsistent state.

|===

[[rtc-remove]]
==== `remove` codes

The `remove` codes are much less diversified than the <<rtc-check,`check` codes>> because no major internal decisions are made based on the result of the removal.

.Supported return codes of the `d_dpl_remove` function
[%noheader.stretch,cols="2*^.^,1*<.^",stripes=none]
|===

^.^h| `remove` code
^.^h| Meaning
^.^h| Elaboration

| `*0*`
| 'Successfully removed'
| The function has run without any errors.

| `*1*`
| 'Failed to remove'
| There has been at least one error, which potentially created an inconsistent state.

| `*2*`
| 'Refused to remove'
| The function has returned before proceeding to the removeation proper.

| `*3*`
| 'Partly removed'
| The function has returned midway (because of an error), but has avoided creating an inconsistent state.

|===

[[addst-main]]
=== Add-statuses

The *add-statuses* are the specially named global variables.
The framework clears the add-statuses before running a <<func-primaries,primary function>>, and after running it — checks if the add-statuses contain (supported) values.
The value assigned to an add-status changes the behavior of the framework.

.Supported add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Add-statuses in <<func-primaries,primary functions>>

| +++<p align="center">+++
`*D_ADDST_PROMPT*`
+++</p>+++

If set to `true`, forces an <<fmwk-upmt,urgent>> prompt before installation/removal.

Naturally, this add-status only makes sense when set in the <<func-dpl-check,`d_dpl_check`>> function during the <<rtn-install,`install`>> or <<rtn-remove,`remove`>> routines.

| +++<p align="center">+++
`*D_ADDST_HALT*`
+++</p>+++

If set to `true`, forces halting of the current <<rtn-primaries,primary routine>>.
No further deployments will be processed.

| +++<p align="center">+++
*Output add-statuses*
+++<br>+++
`*D_ADDST_ATTENTION*`, `*D_ADDST_HELP*`,
+++<br>+++
`*D_ADDST_WARNING*`, `*D_ADDST_CRITICAL*`
+++</p>+++

The following output add-statuses may be set to a string or array thereof.
If set, their messages will be printed to the user with appropriate styling.

* `*D_ADDST_ATTENTION*` — non-critical alerts to the user.
* `*D_ADDST_HELP*` — calls for user's involvement (e.g., requests to reboot the machine).
* `*D_ADDST_WARNING*` — grave warnings to the user.
* `*D_ADDST_CRITICAL*` — critical failures.

Other than printing the styled message, these add-statuses do nothing.

|===

[[indct-main]]
=== Indicator variables

An *indicator variable* (or simply an *indicator*) is a global variable that is populated by the framework at run-time with the intention of providing potentially useful information to the deployment code.

The indicator variables are read-only in spirit.
However, due to practical limitations, they are not always protected from writing using the Bash's `readonly` mechanism.
Please, enjoy responsibly.

.List of indicator variables
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[indct-dpl-check-code]]*Deployment check code indicator*
+++<br>+++
`*D{dus}DPL_CHECK_CODE*`
+++</p>+++

This indicator contains the integer check <<rtc-check,code>> returned by the <<func-dpl-check,`d_dpl_check`>> primary function.
Naturally, this indicator is only available to the <<func-dpl-install,`d_dpl_install`>> and <<func-dpl-remove,`d_dpl_remove`>> primary functions.

| +++<p align="center">+++
[[indct-dpl-is-forced]]`*D{dus}DPL_IS_FORCED*`
+++</p>+++

In the <<func-dpl-install,`install`>> and <<func-dpl-remove,`remove`>> primary functions, this indicator reflects whether the current deployment is being <<opt-force,forced>>.
If set to `true`, this indicator tells that the installation/removal would not have been run if the `--force` option weren't provided.

Possible values: `true` / `false`.

| +++<p align="center">+++
[[indct-os]][[indct-os-family]][[indct-os-distro]][[indct-os-pkgmgr]]*Current OS indicators*
+++<br>+++
`*D{dus}OS_FAMILY*`
+++<br>+++
`*D{dus}OS_DISTRO*`
+++<br>+++
`*D{dus}OS_PKGMGR*`
+++</p>+++

These indicators describe the current operating system as detected by the built-in framework mechanisms.
All are declared `readonly`.

* `*D__OS_FAMILY*` — the broad description of the current OS family.
+
The framework does not start up unless it detects one of the following OS families:
+
--
** `bsd` — https://en.wikipedia.org/wiki/List_of_BSD_operating_systems[BSD descendants]
** `cygwin` — https://en.wikipedia.org/wiki/Cygwin[Cygwin]
** `linux` — https://en.wikipedia.org/wiki/Linux[Linux]
** `macos` — https://en.wikipedia.org/wiki/MacOS[macOS]
** `msys` — https://en.wikipedia.org/wiki/MinGW[Minimalist GNU for Windows]
** `solaris` — https://en.wikipedia.org/wiki/Solaris_(operating_system)[Oracle Solaris]
** `wsl` — https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux[Windows Subsystem for Linux]
--
+
It should be noted, that `linux` and `wsl` are separate entries.
* `*D__OS_DISTRO*` — the best guess on the name of the current OS distribution:
+
--
** `debian`
** `fedora`
** `freebsd`
** `macos`
** `ubuntu`
** _empty_ — failed to reliably detect a supported distribution
--
+
The <<fmwk-os-support,system requirements>> always show the list of supported operating systems and ways to <<cntrb-os-support,expand it>>.
* `*D__OS_PKGMGR*` — the name of the supported package manager on the current OS:
+
--
** `apt-get`
** `brew`
** `dnf`
** `pkg`
** `yum`
** _empty_ — failed to reliably detect a supported package manager
--
+
Whenever this variable is not empty, the built-in package manager wrapper, <<func-os-pkgmgr,`d__os_pkgmgr`>>, is available.

| +++<p align="center">+++
[[indct-dpl-dir]][[indct-dpl-asset-dir]][[indct-dpl-backup-dir]]*Special directory indicators*
+++<br>+++
`*D{dus}DPL_DIR*`
+++<br>+++
`*D{dus}DPL_ASSET_DIR*`
+++<br>+++
`*D{dus}DPL_BACKUP_DIR*`
+++</p>+++

These indicators contain the absolute paths to the deployment's special directories.
All are declared `readonly`.

* `*D__DPL_DIR*` — the directory containing the deployment file.
* `*D__DPL_ASSET_DIR*` — the directory generated for the deployment's assets.
+
Located at: `~/<<fmwk-grail,.grail>>/assets/<<mtdt-name-and-desc,_DPL-NAME_>>/`
* `*D__DPL_BACKUP_DIR*` — the directory generated for the deployment's backups.
+
Located at: `<<fmwk-state,state>>/backups/<<mtdt-name-and-desc,_DPL-NAME_>>/`

| +++<p align="center">+++
[[indct-dpl-path]][[indct-dpl-mnf-path]][[indct-dpl-que-dir]]*Special path indicators*
+++<br>+++
`*D{dus}DPL_SH_PATH*`
+++<br>+++
`*D{dus}DPL_MNF_PATH*`
+++<br>+++
`*D{dus}DPL_QUE_PATH*`
+++</p>+++

These indicators contain the absolute paths to the deployment's special files.
All are declared `readonly`.

* `*D__DPL_SH_PATH*` — the deployment file itself.
* `*D__DPL_MNF_PATH*` — the path where the deployment's <<assets-mnf,asset manifest>> will be looked up.
+
The same as the deployment's filepath, with the `.dpl.sh` suffix changed to `.dpl.mnf`.
* `*D__DPL_QUE_PATH*` — the path where the deployment's <<queue-mnf,queue manifest>> will be looked up.
+
The same as the deployment's filepath, with the `.dpl.sh` suffix changed to `.dpl.que`.
+
This path in particular can be overridden with an <<addst-queue-mnf,add-status>>.
However, the override will _not_ be reflected in the indicator.

| +++<p align="center">+++
*Deployment <<dpls-metadata,metadata>> indicators*
+++<br>+++
`*D{dus}DPL_NAME*`, `*D{dus}DPL_DESC*`, `*D{dus}DPL_PRIORITY*`, 
+++<br>+++
`*D{dus}DPL_FLAGS*`, `*D{dus}DPL_WARNING*`
+++</p>+++

Since the deployment <<dpls-metadata,metadata>> 'assignments' are technically Bash assignments too, they are available to the deployment code.

| +++<p align="center">+++
*Option indicators*
+++<br>+++
`*D{dus}OPT_ANSWER*`, `*D{dus}OPT_OBLITERATE*`, `*D{dus}OPT_FORCE*`, 
+++<br>+++
`*D{dus}OPT_INVERSE*`, `*D{dus}OPT_EXCLAM*`, `*D{dus}OPT_VERBOSITY*`
+++</p>+++

The *option indicators* reflect the run-time state of the <<rtn-primaries-opts,options>>, provided to the <<rtn-primaries,primary routine>>.

The option indicators are declared `readonly` with the following possible values:

* `*D__OPT_ANSWER*` — `true` / `false` / _empty_.
* `*D__OPT_OBLITERATE*` — `true` / `false`.
* `*D__OPT_FORCE*` — `true` / `false`.
* `*D__OPT_INVERSE*` — `true` / `false`.
* `*D__OPT_EXCLAM*` — `true` / `false`.
* `*D__OPT_VERBOSITY*` — _non-negative integer_.

| +++<p align="center">+++
*Request indicators*
+++<br>+++
`*D{dus}REQ_ROUTINE*`, `*D{dus}REQ_ARGS*`, `*D{dus}REQ_GROUPS*`, 
+++<br>+++
`*D{dus}REQ_BUNDLES*`, `*D{dus}REQ_PKGS*`
+++</p>+++

The *request indicators* reflect the parameters of the current request to the <<rtn-primaries,primary routine>>.

The request indicators are declared `readonly` with the following possible values:

* `*D__REQ_ROUTINE*` — `check` / `install` / `remove`.
* `*D__REQ_ARGS*` — _array of non-<<rtn-primaries-opts,option>> non-<<mtdt-groups,group>> arguments_.
* `*D__REQ_GROUPS*` — _array of <<mtdt-groups,group>> arguments_.
* `*D__REQ_BUNDLES*` — _array of <<opt-bundle,bundles>> requested_.
* `*D__REQ_PKGS*` — `true` / `false` (whether the <<dfls-main,Divinefiles>> are requested).

|===

[[mnf-main]]
== Manifests

_Divine.dotfiles_ introduces a simple markup language for special files called *manifests*.

There are three types of special files that are manifests:

* <<dfls-main, Divinefiles>>.
* <<assets-mnf, Asset manifests>>.
* <<queue-mnf, Queue manifests>>.

While they differ in purpose and supported features, all types of manifests share basic syntax and are internally parsed by the same engine.

[[mnf-syntax]]
=== Manifest syntax

Manifests are processed in terms of lines.
A simplest line represents an *entry* of some kind.

The whitespace rules are fairly permissive.
Any amount of leading and trailing whitespace is allowed and ignored.
Within an entry, the whitespace is preserved.

.Example of manifest with four entries
[source]
----
entry1
entry2
entry with whitespace
  indented entry will not include indentation
----

[[mnf-kv]]
=== Key-values

Whenever a line starts with an opening parenthesis `(` and contains a closing one `)`, what's between them is interpreted as a *key-value* pair.
There may be more than one key-value per line.
The key-values are used to qualify entries and provide additional information.

A key-value is separated into key and value by the first occurrence of the `:` symbol (colon).

Key-values may:

* occupy their own line;
* precede an entry.

Key-values that occupy their own line come into effect for the rest of the document, or until overridden.
Key-values that precede an entry affect only that entry.

.Example of key-values in manifest
[source,bash]
----
entry1                  # Regular entry
(color: red) entry2     # Set color to red for this entry only

(color: blue)           # Set color to blue henceforth

entry3                  # Color is blue
(color: green) entry4   # Color is green (overridden)
entry5                  # Color is blue

(color:)                # Unset color henceforth

entry6                  # No color
entry7                  # No color
----

The two keys — <<mnf-kv-os,`os`>> and <<mnf-kv-flags,`flags`>> — are universal to all types of manifests, and are described below.
Particular kinds of manifests support additional keys.

[[mnf-kv-os]]
==== Key-value `os`

The key `os` makes entries specific to particular operating systems.
Multiple OS names may be given by separating them with whitespace.
The entire list of OS's may be negated by prepending it with the `!` symbol.

.Example of `os` key-values in manifest
[source]
----
(os: debian)          entry1    # Relevant only on Debian

(os: macos bsd)       entry2    # Relevant only on macOS or BSD

(os: ! linux wsl)     entry3    # Relevant everywhere except Linux or WSL

(os: all)             entry4    ## Keywords 'all'/'any' are reserved to denote 
                                #. any OS. This is synonymous to empty list.
----

The OS names are matched against the <<indct-os-family,`$D\__OS_FAMILY`>> and <<indct-os-distro,`$D__OS_DISTRO`>> variables.
A match against any of the two is sufficient.

[[mnf-kv-flags]]
==== Key-value `flags`

The key `flags` adds a string of single-character flags to an entry.

A *shorthand* is provided: whenever a <<mnf-kv,key-value>> does not contain the `:` separator (i.e., there is no key), the `flags` key is assumed.

Flags may be appended to those currently in effect (instead of replacing them) by prepending the value with the `+` symbol.

.Example of `flags` key-values in manifest
[source,bash]
----
(flags: i!0)  entry1    # Flags: i, !, 0

(flags: a)
              entry2    # Flags: a
(+b)
(flags: +c)   entry3    # Flags: a, b, c
              entry4    # Flags: a, b
(flags: d)    entry5    # Flags: d
              entry6    # Flags: a, b
----

[[mnf-misc]]
=== Comments, line continuation, and escaping

The hash/pound symbol (`#`) comments out the rest of the line.

A line may be 'glued' to the next by terminating it with a backslash (`\`).
Whitespace and comments are allowed to follow the backslash.

.Example of line continuation in manifests
[source,bash]
----
(os: fedora)  \   ## This is a single logical line
lengthy entry \   #. spanning three physical lines
text              #. (yes, even with comments attached like this)
----

The escaping rules are as follows:

* To start an entry with a literal opening parenthesis `(`, prepend it with a backslash `\`.
+
_One and only one backslash is always removed from the left edge of an entry._
* To use a literal closing parenthesis `)` within a key-value, prepend it with a backslash.
* To use a literal hash/pound symbol `#` anywhere, prepend it with a backslash.
* To end a line with a literal backslash `\`, double every literal backslash at the line's right edge.
+
_An odd number of backslashes at the right edge of a line will be reduced to a single backslash and will result in line continuation._

[[assets-main]]
== Assets

Deployment *assets* are any files that are associated with the deployment, but are not part of its deployment script.
_Divine.dotfiles_ provides a way to separate the static deployment logic from the dynamic deployment assets.

[[assets-dir]]
Every deployment is alotted a designated <<indct-dpl-asset-dir,*asset directory*>> at `~/<<fmwk-grail,.grail>>/assets/*_DPL-NAME_*/`.
Keeping the deployment assets in their separate directory within the <<fmwk-grail,Grail>> provides the following advantages:

* The assets — e.g., symlinked configuration files — are in one place, for the user to inspect and modify.
* The assets can be version-controlled and synchronized independently from their deployment scripts.

[[assets-mnf]]
=== Asset manifests

The *asset* <<mnf-main,*manifests*>> are used to:

* Catalog the deployment's assets.
* Copy the provided initial versions of assets into the <<assets-dir,asset directory>>.
* <<queue-auto,Automatically>> assemble <<queue-main,queues>> from the asset paths.

The asset manifest is <<indct-dpl-mnf-dir,looked up>> at the path of the deployment file, with the `.dpl.sh` suffix exchanged for `.dpl.mnf`.

An asset manifest entry is a relative path to a file.
(In regards to assets, the term 'file' includes directories.)
Two kinds of relative paths are accepted: *concrete paths* and *RegEx patterns*.
Leading and trailing slashes are always disregarded.
The relative path is resolved from:

* the <<indct-dpl-dir,deployment directory>> (to locate the initial versions possibly provided with the deployment);
* the deployment's <<indct-dpl-asset-dir,asset directory>> (to locate the user's current versions).

[[assets-mnf-usage]]
=== Asset manifest usage

Processing of the asset manifests occurs:

* During the <<rtn-primaries,primary routines>>, immediately before sourcing the deployment script.
* After <<rtn-attach,attaching>> a bundle.

The asset manifests follow the general <<mnf-syntax,manifest syntax>>, which provides the <<mnf-kv-os,OS>> recognition and the <<mnf-kv-flags,`flags`>>.

What is being done for the catalogued assets is largely determined by their <<mnf-kv-flags,flags>>:

.List of asset manifest flags
[%header,cols="<.<4,^.<1,<.<4",stripes=none]
|===

^.^| Behavior _without_ the flag (default)
^.^| Asset flag
^.^| Behavior _with_ the flag

| The entry is interpreted as a concrete path to a single asset.
| [[assets-mnf-flag-r]]+++<p align="center">+++
`*r*`
+++<br>+++
+++<br>+++
_**R**egEx_
+++</p>+++
| The entry is interpreted as a **R**egEx pattern (see <<assets-mnf-regex-note,note>> below) that can match any number of assets.

| Some version of the asset must be provided by the deployment's author in the <<indct-dpl-dir,deployment directory>>.
If the entry is a RegEx pattern, it must have at least one matching asset.
Failing that, the entire deployment is not processed at all.
| [[assets-mnf-flag-o]]+++<p align="center">+++
`*o*`
+++<br>+++
+++<br>+++
_**o**ptional_
+++</p>+++
| The asset entry is considered **o**ptional: its provision by the author is not enforced.

| The matching asset(s) within the <<indct-dpl-dir,deployment directory>> are copied into the <<indct-dpl-asset-dir,asset directory>>.
| [[assets-mnf-flag-d]]+++<p align="center">+++
`*d*`
+++<br>+++
+++<br>+++
_**d**pl-dir-only_
+++</p>+++
| This asset entry does not leave the <<indct-dpl-dir,**d**eployment directory>>.
Matching asset(s) are not copied anywhere, and are pushed onto the <<assets-arrays,asset arrays>> from their original locations.
This provides a way to conceal assets from user's view.

| The assets already in the user's <<fmwk-grail,Grail>> are *not* overwritten under any circumstances.
| [[assets-mnf-flag-f]]+++<p align="center">+++
`*f*`
+++<br>+++
+++<br>+++
_**f**orce-copy_
+++</p>+++
| The framework ensures that an exact copy of the provided version of an asset is present in the user's <<fmwk-grail,Grail>>.
If a differing version is found there, it is <<fmwk-zero-data-loss,backed up>>, and overwritten.

This flag is useful for supplying and updating READMEs.
Whenever a file matches the RegEx pattern `README(\.[a-z]+)?` (case-sensitive), the framework does not create a backup.

*This flag should be used sparingly!*

| Paths to matching assets are pushed onto the <<assets-arrays,asset arrays>> for further usage.
| [[assets-mnf-flag-n]]+++<p align="center">+++
`*n*`
+++<br>+++
+++<br>+++
_**n**o-queue_
+++</p>+++
| Paths to matching assets are **n**ot pushed onto the <<assets-arrays,asset arrays>>.

_Together with the <<assets-mnf-flag-d,`d` flag>>, this will cause the asset to be completely ignored._

| All matching assets in the <<indct-dpl-asset-dir,asset directory>> are pushed onto the <<assets-arrays,asset arrays>>.
This will include any matching assets added by the user manually.

_Irrelevant when the <<assets-mnf-flag-d,`d` flag>> is in effect._
| [[assets-mnf-flag-p]]+++<p align="center">+++
`*p*`
+++<br>+++
+++<br>+++
_**p**rovided-only_
+++</p>+++
| The asset entry is considered limited to those matching assets, for which the author has **p**rovided the initial versions.

_Irrelevant when the <<assets-mnf-flag-d,`d` flag>> is in effect._

|===

On top of the flags, the following <<mnf-kv,key-values>> are recognized in asset manifests:

.List of asset manifest key-values
[%noheader,cols="<.<a",stripes=none]
|===

| [[assets-mnf-pfx]]`(*prefix*: _SUBPATH_)`

The `SUBPATH` is implicitly prepended to the asset entries when looking up the assets in the <<indct-dpl-dir,deployment directory>>, but not in the <<indct-dpl-asset-dir,asset directory>>.
Leading and trailing slashes are ignored.

| [[assets-mnf-split]]`(*queue*: *split*)`

This key-value does not affect the actual asset entries, nor does it support any values other than the pre-defined word `split`.

The `(queue: split)` key-value <<queue-split,splits>> the <<queue-main,queue>>, which is auto-generated from the asset paths.
Such splits occur at the exact positions where the key-value is encountered.

|===

[[assets-mnf-regex-note]]
The RegEx patterns are interpreted by the http://man7.org/linux/man-pages/man1/find.1.html[`find`] utility using the https://en.wikibooks.org/wiki/Regular_Expressions/POSIX-Extended_Regular_Expressions[POSIX Extended Regular Expressions] dialect.
The provided pattern is inserted into a larger one, e.g.:

[source,bash]
----
find -E . -regex "^\./${PATTERN}$"
----

Consequently, the patterns should not include the `^` and `$` meta-characters.

The order of entries in the asset manifest is guaranteed to correspond to the order of elements in the resulting <<assets-arrays,asset arrays>>.
However, the order of assets that match a single RegEx entry is not guaranteed.

The relative paths from a manifest are simply appended to their respective parent directories, so the paths like `.` or `..` or `../..` will work.

.Example of asset manifest
[source]
----
file1.txt           ## These files will be copied from the deployment directory
file2.txt           #. into the root of the asset directory.

(r) configs/\       ## The matching '*.cfg' files will be copied with their 
[a-z]+\.cfg         #. parent 'configs/' directory preserved on both ends.

(prefix: images)
img1.jpg            ## These files will be copied from the 'images/' directory
img2.jpg            #. into the root of the asset directory.

(prefix:)
(d) sys.f           ## These files will not be copied, but their paths will be 
(d) sys.d           #. pushed onto the asset arrays
----

[[assets-arrays]]
=== Asset arrays

Whenever the framework processes an _existing_ asset manifest, it automatically _clears_ and then populates two global arrays:

* `*D_QUEUE_ASSETS*` — absolute paths to the assets within the deployment's <<indct-dpl-asset-dir,asset directory>>.
* `*D_QUEUE_MAIN*` — for each absolute path in the previous array, this one will contain its relative version.

These arrays coincide with the arrays used by the <<queue-main,queues>>, especially the <<lnqe-main,link-queue>> and <<cpqe-main,copy-queue>> variants.
It makes sense, because the assets are the perfect candidates for sequential processing.
The deployment is, of course, free to override these automatically populated arrays.

[[dfls-main]]
== Divinefiles

A *Divinefile* is a special kind of <<dpls-main,deployment>>.
Its purpose is akin to that of the https://github.com/Homebrew/homebrew-bundle[Brewfile] or the https://bundler.io/gemfile.html[Gemfile].
Quite simply, a Divinefile is a <<mnf-main,manifest>> of packages to be maintained using the supported system package manager.

* A Divinefile must be named, well, `Divinefile`.
* There can absolutely be more than one — their contents are effectively merged.
* The framework picks up every Divinefile located at any depth under two recognized deployment directories:
** `~/<<fmwk-grail,.grail>>/dpls/` — the user's Divinefiles.
** `<<fmwk-state,state>>/bundles/` — the <<rtn-bundles,attached>> third-party Divinefiles.
* The Divinefiles collectively act as a deployment.

[[dfls-usage]]
=== Divinefile usage

The Divinefiles are automatically picked up by the framework along with the other deployments.
Divinefiles are processed in their merged entirety or not processed at all.

The Divinefiles are referred to with synonyms: `divinefile`, `dfile`, or `df`.
As with all deployment names, these are case insensitive.

The deployment-style <<mtdt-priority,*priorities*>> and <<mtdt-flags,*flags*>> can be assigned to the individual packages within the Divinefiles.
The packages are then intertwined with the regular deployments in a shared workflow.

The Divinefiles do *not* support the advanced features of the system package managers.
For the more complex package installations — e.g., involving particular versions or special package manager options — the regular <<dpls-main,deployments>> should be used instead.

[[dfls-syntax]]
=== Divinefile syntax

The Divinefiles follow the general <<mnf-main,manifest>> syntax.

Every Divinefile entry is a *list* of whitespace-separated package names.
The keys `flags` and `priority` set the respective attributes for the packages.
The priority works for packages in the same way as it does for the <<mtdt-priority,deployments>>.

The following flags are supported for packages.

.List of supported package flags in Divinefiles
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*m*`
+++</p>+++

By default, if the package is not found to be installed via the system package manager, but is nevertheless available on `$PATH`, the framework will mark it down as 'Fully installed (by user or OS)' and be done with it.
The `*m*` flag specifies that the package should be installed exclusively via the system package manager.

| +++<p align="center">+++
`*[ir]*` _(any of the two lowercase letters)_
+++</p>+++

These flags engage the *always-prompt* mode for particular <<rtn-primaries,primary routines>>.
An <<fmwk-upmt,urgent>> prompt will appear on the chosen routines, before the package is processed.

* `*i*` — always prompt during the <<rtn-install,`**i**nstall`>> routine.
* `*r*` — always prompt during the <<rtn-remove,`**r**emove`>> routine.

|===

Within a line, each vertical bar `|` starts an *alt-list*, which fully overrides the original list for a particular package manager.
Within an alt-list, everything to the left of the first `:` symbol (colon) is read as the package manager's name; everything to the right — as the alt-list of packages.
The package manager's name is matched against the <<indct-os-pkgmgr,`$D__OS_PKGMGR`>> variable.

.Example of Divinefile
[source]
----
git vim                 # Maintain git and vim with default priority (4096)


(priority:300)          # Set priority to 300 henceforth


(priority:500)  \       # Set priority to 500 for this line only
(r)             \       # Set flag 'prompt before removing' for this line only
node            \       # Maintain node
| apt-get: nodejs npm   # On apt-get, maintain nodejs and npm instead


(os:fedora) \           # Make this line exclusive to Fedora
util-linux-user         # Maintain util-linux-user with priority 300
----

[[mltsk-main]]
== Multitask deployments

The *multitask helpers* are a set of partly pre-implemented <<func-primaries,primary functions>> for deployments that carry out a series of _dissimilar_ tasks.
(For deployments that deal with a series of _similar_ tasks, the <<queues,queue helpers>> should be used.)

The multitask helpers provide a way to cram any number of *sub-deployments* (called *tasks*) into a multitask deployment.
Each task can have its own set of *mini-primaries*, which are near-identical in behavior to the <<func-primaries,regular>> primaries.
In particular, the same <<rtc-main,return codes>> are supported for the mini-primaries as are for their older siblings.
The framework automatically amalgamates the return codes of the tasks into the single return code of the multitask deployment itself.

The multitask helpers can be employed no more than once per deployment.

[[mltsk-setup]]
=== Setting up a multitask deployment

To assemble a multitask deployment:

* [[mltsk-determinant]]Set the *multitask determinant* — an array named `*D_MLTSK_MAIN*`, each element of which single-handedly defines a task.
The ordinal number of an array element is the *task's number*, and the value of that element is the *task's name*.
+
[source,bash]
----
D_MLTSK_MAIN=( task_one task_two )
----
+
The multitask determinant must be populated _before_ the first multitask helper (`d__mltsk_check`) is called.
+
The determinant array must be continuous (uninterrupted).
* [[mltsk-mini-primaries]]Implement the (optional) *mini-primaries* for the tasks, following the naming pattern (for the task named `*_TASK_*`):
** `*d{us}**__TASK__**{us}check*` — the task-level equivalent of the <<func-dpl-check,`d_dpl_check`>> function.
** `*d{us}**__TASK__**{us}install*` — the task-level equivalent of the <<func-dpl-install,`d_dpl_install`>> function.
** `*d{us}**__TASK__**{us}remove*` — the task-level equivalent of the <<func-dpl-remove,`d_dpl_remove`>> function.
* [[mltsk-helper-primaries]]Call the multitask *helper primaries* as the last commands of the deployment's <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__mltsk_check;   }
d_dpl_install() { d__mltsk_install; }
d_dpl_remove()  { d__mltsk_remove;  }
----

[.note]
[%noheader,cols="<.<a"]
|===
| One difference between the reglar <<func-primaries,primaries>> and the <<mltsk-mini-primaries,mini-primaries>>:

* The regular deployments are treated individually: one is ``check``ed, and then immediately ``install``ed/``remove``d.
* The tasks are treated collectively: all are sequentially ``check``ed, and only then sequentially ``install``ed/``remove``d.
|===

.Example of multitask deployment
[source,bash]
----
# Delegate the primaries to the multitask helper primaries
d_dpl_check()    { assemble_tasks;  d__mltsk_check;   }
d_dpl_install()  {                  d__mltsk_install; }
d_dpl_remove()   {                  d__mltsk_remove;  }

# This function is the recommended way of organizing logic
assemble_tasks() { D_MLTSK_MAIN=( eat pray love ); }

# Implement the (optional) mini-primaries for the tasks

d_eat_check()     { :; }
d_eat_install()   { :; }
d_eat_remove()    { :; }

d_pray_check()    { :; }
d_pray_install()  { :; }
d_pray_remove()   { :; }

d_love_check()    { :; }
d_love_install()  { :; }
d_love_remove()   { :; }
----

[[mltsk-hooks]]
=== Multitask hooks

The framework recognizes a set of specially named functions — *hooks* — that are called at particular junctions of processing a multitask deployment.
The hooks have the power to alter the behavior of the multitask deployment via their return codes and <<mltsk-addst,add-statuses>>.

* [[mltsk-hooks-hlp]]Pre- and post- multitask hooks can do arbitrary work.
** When the multitask check hook returns a non-zero code, the corresponding <<mltsk-helper-primaries,helper primary>> shuts down with the code `3` ('Irrelevant or invalid').
*** `*d_mltsk_pre_check*` — called before the checking of tasks starts.
*** `*d_mltsk_post_check*` — called after the checking of tasks concludes.
** When the multitask install/remove hook returns a non-zero code, the corresponding <<mltsk-helper-primaries,helper primary>> shuts down with the code `2` ('Refused to install/remove').
*** `*d_mltsk_pre_install*` — called before (and if) the installation of tasks starts.
*** `*d_mltsk_post_install*` — called after the installation of tasks concludes.
*** `*d_mltsk_pre_remove*` — called before (and if) the removal of tasks starts.
*** `*d_mltsk_post_remove*` — called after the removal of tasks concludes.
* [[mltsk-hooks-mini]]Pre- and post- task hooks can, too, do arbitrary work.
** When the task check hook returns a non-zero code, the corresponding <<mltsk-mini-primaries,mini-primary>> shuts down with the code `3` ('Irrelevant or invalid').
*** `*d{us}__TASK__{us}pre_check*` — called before the checking of that task starts.
*** `*d{us}__TASK__{us}post_check*` — called after the checking of that task concludes.
** When the task install/remove hook returns a non-zero code, the corresponding <<mltsk-mini-primaries,mini-primary>> shuts down with the code `2` ('Refused to install/remove').
*** `*d{us}__TASK__{us}pre_install*` — called before (and if) the installation of that task starts.
*** `*d{us}__TASK__{us}post_install*` — called after the installation of that task concludes.
*** `*d{us}__TASK__{us}pre_remove*` — called before (and if) the removal of that task starts.
*** `*d{us}__TASK__{us}post_remove*` — called after the removal of that task concludes.

[[mltsk-addst]]
=== Multitask add-statuses

The multitask deployments can take advantage of the deployment-level <<addst-main,add-statuses>>.
On top of that, the framework provides add-statuses that are specific to the multitask deployments.

.Supported multitask add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Add-statuses in <<mltsk-main,multitask>> deployments

| +++<p align="center">+++
`*D_ADDST_MLTSK_HALT*`
+++</p>+++

If set to `true`, forces halting of the current <<mltsk-main,multitask>> deployment.
No further tasks will be processed.

If set during the `check` phase, the `install`/`remove` phase will still commence for the tasks that have been checked before the halting.

| +++<p align="center">+++
`*D_ADDST_MLTSK_IRRELEVANT*`
+++</p>+++

If set to `true` during the `check` phase, stops all further processing of tasks and forces the <<rtc-check,check code>> of `3` ('Irrelevant or invalid').
This add-status does not work during the `install`/`remove` phases.

| +++<p align="center">+++
*Add-statuses of pre- and post- multitask <<mltsk-hooks,hooks>>*
+++<br>+++
`*D_ADDST_MLTSK_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_MLTSK_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_MLTSK_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the <<mltsk-helper-primaries,helper primary>> from either the pre- or post- multitask <<mltsk-hooks-hlp,hook>>.

| +++<p align="center">+++
*Add-statuses of pre- and post- task <<mltsk-hooks,hooks>>*
+++<br>+++
`*D_ADDST_TASK_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_TASK_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_TASK_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the current task from either the pre- or post- task <<mltsk-hooks-mini,hook>>.

| +++<p align="center">+++
[[addst-task-flags]]`*D_ADDST_TASK_FLAGS*`
+++</p>+++

Acts as a vehicle for transporting arbitrary single-character flags between the <<mltsk-hooks,hooks>> and <<mltsk-mini-primaries,mini-primaries>>.
Whatever is assigned to this add-status is appended to the <<indct-task-flags,`*D__TASK_FLAGS*`>> indicator variable.

|===

[[mltsk-indct]]
=== Multitask indicators

The multitask deployments can take advantage of the deployment-level <<indct-main,indicators>>.
On top of that, the framework provides indicators that are specific to the multitask deployments.

.List of multitask indicator variables
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*D{dus}TASK_NUM*`, `*D{dus}TASK_NAME*`
+++</p>+++

These indicators contain the current task's ordinal number (`D{dus}TASK_NUM`, starts at zero) and name (`D{dus}TASK_NAME`).

| +++<p align="center">+++
`*D{dus}TASK_IS_FORCED*`
+++</p>+++

During the `install`/`remove` phase, this indicator reflects whether the current task is being <<opt-force,forced>>.
If set to `true`, this indicator tells that the installation/removal would not have been run if the `--force` option weren't provided.

Possible values: `true` / `false`.

| +++<p align="center">+++
[[indct-task-flags]]`*D{dus}TASK_FLAGS*`
+++</p>+++

This indicator contains whatever flags might have been <<addst-task-flags,assigned>> to the current task.

| +++<p align="center">+++
*Task code indicators*
+++<br>+++
`*D{dus}TASK_CHECK_CODE*`
+++<br>+++
`*D{dus}TASK_INSTALL_CODE*`
+++<br>+++
`*D{dus}TASK_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-main,codes>> returned by the task's <<mltsk-mini-primaries,mini-primaries>>.

Naturally, these indicators are only available after their corresponding mini-primaries have completed their run.

Particularly, the `D{dus}TASK_INSTALL_CODE` and `D{dus}TASK_REMOVE_CODE` indicators are only available to the task's corresponding post- install/remove <<mltsk-hooks-mini,hooks>>.

| +++<p align="center">+++
*Multitask code indicators*
+++<br>+++
`*D{dus}MLTSK_CHECK_CODE*`
+++<br>+++
`*D{dus}MLTSK_INSTALL_CODE*`
+++<br>+++
`*D{dus}MLTSK_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-main,codes>> returned by the task's <<mltsk-helper-primaries,helper primaries>>.

Naturally, these indicators are only available after their corresponding helper primaries have completed their run.

Particularly, the `D{dus}MLTSK_INSTALL_CODE` and `D{dus}MLTSK_REMOVE_CODE` indicators are only available to the deployment's corresponding post- install/remove <<mltsk-hooks-hlp,hooks>>.

|===

[[queue-main]]
== Queues

The *queue helpers* are a set of partly pre-implemented <<func-primaries,primary functions>> for deployments that carry out a series of _similar_ tasks.
(For deployments that deal with a series of _dissimilar_ tasks, the <<mltsk-main,multitask helpers>> should be used.)

The queue helpers provide a way to cram any number of *sub-deployments* (called queue *items*) into a deployment.
All queue items share the same set of *mini-primaries*, which are near-identical in behavior to the <<func-primaries,regular>> primaries.
In particular, the same <<rtc-main,return codes>> are supported for the mini-primaries as are for their older siblings.
The framework automatically amalgamates the return codes of the queue items into the single return code of the queue itself.

The queue helpers may be employed multiple times in a single deployment under the following conditions:

* Each invocation of the queue helpers must be contained in its own task in a <<mltsk-main,multitask>> deployment.
* The queue must be properly <<queue-split,split>> into sections between the tasks.

Partly pre-implemented <<spcqe-main,specialized queues>> are also available:

* <<cpqe-main,*Copy-queue*>> — copies files, with backups and comparison.
* <<lnqe-main,*Link-queue*>> — symlinks files, with backups.
* <<ghqe-main,*Github-queue*>> — retrieves Github repositories, with backups and additional checks.

[[queue-setup]]
=== Setting up a queue

To assemble a generic queue within a deployment (or a <<mltsk-main,task>>):

* [[queue-determinant]]Set the *queue determinant* — an array named `*D_QUEUE_MAIN*`, each element of which single-handedly defines a queue item.
The ordinal number of an array element is the *item's number*, and the value of that element is the *item's name*.
+
[source,bash]
----
D_QUEUE_MAIN=( item_one item_two )
----
+
The queue determinant must be populated _before_ the first queue helper (`d__queue_check`) is called.
The queue array may be automatically populated via the <<queue-mnf,queue>> or <<assets-mnf,asset>> manifests.
+
The determinant array must be continuoue (uninterrupted).
* [[queue-mini-primaries]]Implement the (optional) *mini-primaries* for the queue items:
** `*d_item_check*` — the queue item equivalent of the <<func-dpl-check,`d_dpl_check`>> function.
** `*d_item_install*` — the queue item equivalent of the <<func-dpl-install,`d_dpl_install`>> function.
** `*d_item_remove*` — the queue item equivalent of the <<func-dpl-remove,`d_dpl_remove`>> function.
* [[queue-helper-primaries]]Call the queue *helper primaries* as the last commands of the deployment's (or task's) <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__queue_check;   }
d_dpl_install() { d__queue_install; }
d_dpl_remove()  { d__queue_remove;  }
----

[.note]
[%noheader,cols="<.<a"]
|===
| One difference between the reglar <<func-primaries,primaries>> and the <<queue-mini-primaries,mini-primaries>>:

* The regular deployments are treated individually: one is ``check``ed, and then immediately ``install``ed/``remove``d.
* The queue items are treated collectively: all are sequentially ``check``ed, and only then sequentially ``install``ed/``remove``d.
|===

.Example of queue deployment
[source,bash]
----
# Delegate the primaries to the queue helper primaries
d_dpl_check()    { assemble_items;  d__queue_check;   }
d_dpl_install()  {                  d__queue_install; }
d_dpl_remove()   {                  d__queue_remove;  }

# This function is the recommended way of organizing logic
assemble_items() { D_QUEUE_MAIN=( one two three ); }

# Implement the (optional) mini-primaries for the items

d_item_check()     { :; }
d_item_install()   { :; }
d_item_remove()    { :; }
----

[[queue-mnf]]
=== Queue manifests

The queue items, whatever they are, may be separated from the deployment logic into their own file, the *queue <<mnf-main,manifest>>*.
The framework detects the asset manifest and <<queue-auto,automatically>> assembles the queue <<queue-determinant,determinant>> from it.

The queue manifest is <<indct-dpl-que-dir,looked up>>, by default, at the path of the deployment file, with the `.dpl.sh` suffix exchanged for `.dpl.que`.
Unlike with the <<assets-mnf,asset manifests>>, the deployment is free to customize the location of the queue manifest via an <<addst-queue-mnf,add-status>>.

The queue manifests follow the general <<mnf-syntax,manifest syntax>>, which provides the <<mnf-kv-os,OS>> recognition.
The manifest <<mnf-kv-flags,flags>> are not used.
On top of that, a queue splitting mechanism is supported:

.List of queue manifest key-values
[%noheader,cols="<.<a",stripes=none]
|===

| [[queue-mnf-split]]`(*queue*: *split*)`

This key-value does not affect the actual queue entries, nor does it support any values other than the pre-defined word `split`.

The `(queue: split)` key-value <<queue-split,splits>> the <<queue-main,queue>>.
Such splits occur at the exact positions where the key-value is encountered.

|===

[[queue-hooks]]
=== Queue hooks

The framework recognizes a set of specially named functions — *hooks* — that are called at particular junctions of processing a queue.
The hooks have the power to alter the behavior of the queue via their return codes and <<queue-addst,add-statuses>>.

* [[queue-hooks-hlp]]Pre- and post- queue hooks can do arbitrary work.
** When the queue check hook returns a non-zero code, the corresponding <<queue-helper-primaries,helper primary>> shuts down with the code `3` ('Irrelevant or invalid').
*** `*d_queue_pre_check*` — called before the checking of items starts.
*** `*d_queue_post_check*` — called after the checking of items concludes.
** When the queue install/remove hook returns a non-zero code, the corresponding <<queue-helper-primaries,helper primary>> shuts down with the code `2` ('Refused to install/remove').
*** `*d_queue_pre_install*` — called before (and if) the installation of items starts.
*** `*d_queue_post_install*` — called after the installation of items concludes.
*** `*d_queue_pre_remove*` — called before (and if) the removal of items starts.
*** `*d_queue_post_remove*` — called after the removal of items concludes.
* [[queue-hooks-mini]]Pre- and post- item hooks can, too, do arbitrary work.
** When the item check hook returns a non-zero code, the corresponding <<queue-mini-primaries,mini-primary>> shuts down with the code `3` ('Irrelevant or invalid').
*** `*d_item_pre_check*` — called before the checking of an item starts.
*** `*d_item_post_check*` — called after the checking of an item concludes.
** When the item install/remove hook returns a non-zero code, the corresponding <<queue-mini-primaries,mini-primary>> shuts down with the code `2` ('Refused to install/remove').
*** `*d_item_pre_install*` — called before (and if) the installation of an item starts.
*** `*d_item_post_install*` — called after the installation of an item concludes.
*** `*d_item_pre_remove*` — called before (and if) the removal of an item starts.
*** `*d_item_post_remove*` — called after the removal of an item concludes.

[[queue-addst]]
=== Queue add-statuses

The queues can take advantage of the deployment-level <<addst-main,add-statuses>>.
On top of that, the framework provides add-statuses that are specific to the queues.

.Supported queue add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Add-statuses in <<queue-main,queues>>

| +++<p align="center">+++
[[addst-queue-mnf]]`*D_ADDST_QUEUE_MNF_PATH*`
+++</p>+++

If set to a non-empty value, directs to look for the <<queue-mnf,queue manifest>> at that path.
To be picked up, this add-status must be set at the root of the deployment script.

| +++<p align="center">+++
`*D_ADDST_QUEUE_HALT*`
+++</p>+++

If set to `true`, forces halting of the current <<queues,queue>>.
No further queue items will be processed.

If set during the `check` phase, the `install`/`remove` phase will still commence for the queue items that have been checked before the halting.

| +++<p align="center">+++
`*D_ADDST_QUEUE_IRRELEVANT*`
+++</p>+++

If set to `true` during the `check` phase, stops all further processing of that queue section and forces the <<rtc-check,check code>> of `3` ('Irrelevant or invalid').
This add-status does not work during the `install`/`remove` phases.

| +++<p align="center">+++
*Add-statuses of pre- and post- queue <<queue-hooks,hooks>>*
+++<br>+++
`*D_ADDST_QUEUE_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_QUEUE_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_QUEUE_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the <<queue-helper-primaries,helper primary>> from either the pre- or post- queue <<queue-hooks-hlp,hook>>.

| +++<p align="center">+++
*Add-statuses of pre- and post- item <<queue-hooks,hooks>>*
+++<br>+++
`*D_ADDST_ITEM_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_ITEM_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_ITEM_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the current queue item from either the pre- or post- item <<queue-hooks-mini,hook>>.

| +++<p align="center">+++
[[addst-item-flags]]`*D_ADDST_ITEM_FLAGS*`
+++</p>+++

Acts as a vehicle for transporting arbitrary single-character flags between the <<queue-hooks,hooks>> and <<queue-mini-primaries,mini-primaries>>.
Whatever is assigned to this add-status is appended to the <<indct-item-flags,`*D__ITEM_FLAGS*`>> indicator variable.

|===

[[queue-indct]]
=== Queue indicators

The queues can take advantage of the deployment-level <<indct-main,indicators>>.
On top of that, the framework provides indicators that are specific to the queues.

.List of queue indicator variables
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*D{dus}ITEM_NUM*`, `*D{dus}ITEM_NAME*`
+++</p>+++

These indicators contain the current queue item's ordinal number (`D{dus}ITEM_NUM`, starts at zero) and name (`D{dus}ITEM_NAME`).

| +++<p align="center">+++
`*D{dus}ITEM_IS_FORCED*`
+++</p>+++

During the `install`/`remove` phase, this indicator reflects whether the current queue item is being <<opt-force,forced>>.
If set to `true`, this indicator tells that the installation/removal would not have been run if the `--force` option weren't provided.

Possible values: `true` / `false`.

| +++<p align="center">+++
[[indct-item-flags]]`*D{dus}ITEM_FLAGS*`
+++</p>+++

This indicator contains whatever flags might have been <<addst-item-flags,assigned>> to the current queue item.
Additionally, in the <<queue-auto,auto-queues>>, this indicator is also pre-populated with the <<mnf-kv-flags,flags>> gleaned from the <<assets-mnf,asset>> or <<queue-mnf,queue>> manifest.

| +++<p align="center">+++
*Item code indicators*
+++<br>+++
`*D{dus}ITEM_CHECK_CODE*`
+++<br>+++
`*D{dus}ITEM_INSTALL_CODE*`
+++<br>+++
`*D{dus}ITEM_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-main,codes>> returned by the queue item's <<queue-mini-primaries,mini-primaries>>.

Naturally, these indicators are only available after their corresponding mini-primaries have completed their run.

Particularly, the `D{dus}ITEM_INSTALL_CODE` and `D{dus}ITEM_REMOVE_CODE` indicators are only available to the queue item's corresponding post- install/remove <<queue-hooks-mini,hooks>>.

| +++<p align="center">+++
*Queue code indicators*
+++<br>+++
`*D{dus}QUEUE_CHECK_CODE*`
+++<br>+++
`*D{dus}QUEUE_INSTALL_CODE*`
+++<br>+++
`*D{dus}QUEUE_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-main,codes>> returned by the queue item's <<queue-helper-primaries,helper primaries>>.

Naturally, these indicators are only available after their corresponding helper primaries have completed their run.

Particularly, the `D{dus}QUEUE_INSTALL_CODE` and `D{dus}QUEUE_REMOVE_CODE` indicators are only available to the deployment's corresponding post- install/remove <<queue-hooks-hlp,hooks>>.

|===

[[queue-split]]
=== Multiple queues

The <<queue-main,queue helpers>> can be employed more than once per deployment.
When that happens, all types of queues (<<queue-main,generic>> and the various <<spcqe-main,specialized>> types) share the same internal mechanism and the same <<queue-determinant,determinant>>, `D_QUEUE_MAIN`.
Consequently, when a deployment contains multiple queues, the queue must be split into *queue sections*.

Queue sections are delimited by the ordinal number of their first elements in the queue array (determinant).
Such delimiters are called the *queue splits*.
A section spans from its split until the split of the next section (the latter not inclusive), or until the end of the queue array.
The first section always implicitly starts at the first element of the queue array.
So, the total number of queue sections is the number of splits plus one.
(The word 'first' is used for readability; the underlying Bash numberings start at `0`.)

There are two ways to split a queue:

* In the deployment code, call the `*d__queue_split*` function:
+
[source,bash]
----
D_QUEUE_MAIN=( elem0-0 elem0-1 elem0-2 )  # Initialize with first section

d__queue_split  ## Without arguments, splits at the current right edge of the 
                #. queue array (in this example - position 3)

D_QUEUE_MAIN+=( elem1-0 elem1-1 elem2-0 elem2-1 )  # Append two more sections

d__queue_split 5  ## Manual split after the fact, at position 5, 'elem2-0'
----
* In the <<assets-mnf,asset>> and <<queue-mnf,queue>> manifests, the automatically populated queue array can be split by including the key-value `(*queue*: *split*)` at the desired split position.

The queue <<queue-determinant,determinant>> may be put together incrementally, but a section of it must be fully assembled by the time its first <<queue-helper-primaries,helper primary>> is called.

Whenever a queue section uses multiple arrays to store relevant data (which is true, for instance, for all <<spcqe-main,specialized queues>>), a care must be taken to ensure that all arrays use the same indices for the same queue items.

It is crucial to understand, that the framework *unsets* (deletes) the queue's <<queue-mini-primaries,mini-primaries>>, <<queue-addst,add-statuses>>, and <<queue-hooks,hooks>> as soon as the current queue section has used them fully.
Each subsequent section needs to define and implement its own.

[[queue-auto]]
=== Auto-queues

Regardless of whether the deployment employs the <<queue-main,queues>>, the framework automatically populates the queue <<queue-determinant,determinant>> (and some accompanying arrays) whenever a suitable <<mnf-main, manifest>> is encountered.

Such *auto-queues* are built at two points in processing of a deployment.
The order is significant here, because the queues supersede each other.

. [[queue-auto-amnf]]_Before_ the deployment script is sourced, an auto-queue is built from the deployment's <<assets-mnf,asset manifest>>:
+
--
** <<queue-determinant,`D_QUEUE_MAIN`>> — populated with the relative paths to the assets.
** <<spcqe-main,`D_QUEUE_ASSETS`>> — populated with the absolute versions thereof.
This array is used by the <<cpqe-main,copy-queue>> and the <<lnqe-main,link-queue>> variations.
--
+
This kind of auto-queue can be handily complemented with the <<queue-auto-targeting,auto-targeting>>.
. [[queue-auto-qmnf]]_Immediately after_ the deployment script is sourced (and before any deployment functions are called), an auto-queue is built from the deployment's <<queue-mnf,queue manifest>>:
** <<queue-determinant,`D_QUEUE_MAIN`>> — populated with the manifest entries.

An auto-queue is only built if the corresponding manifest exists.
Both types of auto-queues support <<queue-split,splitting>> the queue (via the manifest syntax).

[[queue-auto-targeting]]
==== Queue auto-targeting

When the queue section operates in the single *target directory*, the `*D_QUEUE_TARGETS*` array — which is used by all <<spcqe-main,specialized queues>> — may be automatically populated.
Such queue *auto-targeting* requires:

* The single target directory for all queue items must be known.
It may not exist yet.
* The queue <<queue-determinant,determinant>> `D_QUEUE_MAIN` must be filled with relative file paths.

(The auto-targeting works well with an <<queue-auto-amnf,auto-queue>> built from the <<assets-mnf,asset manifest>>.)

The *auto-targeting* simply populates the `*D_QUEUE_TARGETS*` array at the given queue section, with relative paths from the `D_QUEUE_MAIN` array, prepended by the target directory path.

The auto-targeting of a queue section must be initiated explicitly by calling the `d__queue_target` function:

[source,bash]
----
D_QUEUE_MAIN=( 'rel/path0' 'rel/path1' 'rel/path2' )  # Initialize the queue

d__queue_target '/target/dir'  # Without options, whole queue is auto-targeted

## This effectively populates the target array as such:
#>  D_QUEUE_TARGETS=( \
#>    /target/dir/rel/path0 \
#>    /target/dir/rel/path1 \
#>    /target/dir/rel/path2 \
#>  )
#
----

The `d__queue_target` function supports the following arguments:

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}queue_target* [-s|--section *_SECTNUM_*] [--] *_TARGET_DIR_*
----

The `*_TARGET_DIR_*` must be non-empty; trailing slashes in it are ignored.
If the `--section` option is given, its `*_SECTNUM_*` argument must the zero-based number of the queue section that is to be auto-targeted.
Without the `--section` option, the whole queue is affected.

[[spcqe-main]]
== Specialized queues

The <<spcqe-main,specialized queues>> are partly pre-implemented <<queue-main,generic queues>>:

* <<cpqe-main,*Copy-queue*>> — copies files, with backups and comparison.
* <<lnqe-main,*Link-queue*>> — symlinks files, with backups.
* <<ghqe-main,*Github-queue*>> — retrieves Github repositories, with backups and additional checks.

All specialized queues use the same underlying mechanism.
A care must be taken when employing <<queue-split,more than one queue>> of any type in a deployment.

[[cpqe-main]]
=== Copy-queues

The *copy-<<queue-main,queue>>* takes a list of <<assets-main,asset>> paths, a list of destination paths, and sequentially copies the former onto the latter.
No overwriting is done, although this can be <<addst-cpqe-queue-exact,influenced>>.
The <<stash-main,stashing>> system is used to track the installations of the copy-queue.

[[cpqe-setup]]
==== Setting up a copy-queue

To assemble a copy-queue within a deployment (or a <<mltsk-main,task>>):

* Set the queue <<queue-determinant,*determinant*>>, `*D_QUEUE_MAIN*`.
Any names may be used for the copy-queue items.
An obvious (and the recommended) choice — is the relative paths to the assets.
* For each index in the determinant array, populate the following special arrays:
** `*D_QUEUE_ASSETS*` — the absolute paths to the assets.
** `*D_QUEUE_TARGETS*` — the absolute paths to the destinations.
* Call the copy-queue helper primaries as the last commands of the deployment's (or task's) <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__copy_queue_check;   }
d_dpl_install() { d__copy_queue_install; }
d_dpl_remove()  { d__copy_queue_remove;  }
----

The assembly of the copy-queue arrays can be <<queue-auto,automated>>, especially when copying <<assets-main,assets>>.

.Assembled copy-queue example
[source,bash]
----
# ~/.grail/dpls/copy-queue-example.dpl.sh

d_dpl_check()   { assemble_queue; d__copy_queue_check;   }
d_dpl_install() {                 d__copy_queue_install; }
d_dpl_remove()  {                 d__copy_queue_remove;  }

assemble_queue()
{
  D_QUEUE_MAIN=( '.hushlogin' )
  D_QUEUE_ASSETS=( "$D__DPL_ASSET_DIR/.hushlogin" )
  D_QUEUE_TARGETS=( "$HOME/.hushlogin" )
}
----

[[cpqe-h-a-i]]
==== Copy-queue hooks, add-statuses, and indicators

The copy-queue supports the equivalent set of <<queue-hooks,hooks>> as the generic queue, with the `d_` prefix exchanged for the `d_copy_` prefix.
(E.g., `d_item_post_install` becomes `d_copy_item_post_install`.)
Other than the name difference, the hooks behave identically.

The copy-queue also supports the same <<queue-addst,add-statuses>> and <<queue-indct,indicators>>, with additions to the former:

.Supported copy-queue add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[addst-cpqe-queue-exact]]`*D_ADDST_COPY_QUEUE_EXACT*`
+++<br>+++
[[addst-cpqe-item-exact]]`*D_ADDST_COPY_ITEM_EXACT*`
+++</p>+++

By default, the copy-queue merely ensures that an asset by the same name exists at the destination, and, if not, does the copying.

If set to `true`, these add-statuses ensure that the _exact_ copy of the provided asset exists at the destination, not just a namesake.
The two add-statuses differ in scope:

* `D_ADDST_COPY_QUEUE_EXACT` — affects the entire copy-queue; must be set before the copy-queue's first helper primary (`d__copy_queue_check`) is called.
* `D_ADDST_COPY_ITEM_EXACT` — affects the current copy-queue item; must be set in that item's pre-check hook (`d_copy_queue_pre_check`).

The same effect can be achieved by setting the `*e*` <<mnf-kv-flags,flag>> for the relevant assets in either the <<assets-mnf,asset>> or <<queue-mnf,queue>> manifests.

|===

[[lnqe-main]]
=== Link-queues

The *link-<<queue-main,queue>>* takes a list of <<assets-main,asset>> paths, a list of destination paths, and sequentially creates symlinks at the latter, pointing to the former.
Any pre-existing files at the symlink locations are <<fmwk-zero-data-loss,backed up>>.
The <<stash-main,stashing>> system is used to track the installations of the link-queue.

[[lnqe-setup]]
==== Setting up a link-queue

To assemble a link-queue within a deployment (or a <<mltsk-main,task>>):

* Set the queue <<queue-determinant,*determinant*>>, `*D_QUEUE_MAIN*`.
Any names may be used for the link-queue items.
An obvious (and the recommended) choice — is the relative paths to the assets.
* For each index in the determinant array, populate the following special arrays:
** `*D_QUEUE_ASSETS*` — the absolute paths to the assets.
** `*D_QUEUE_TARGETS*` — the absolute paths to the symlink locations.
* Call the link-queue helper primaries as the last commands of the deployment's (or task's) <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__link_queue_check;   }
d_dpl_install() { d__link_queue_install; }
d_dpl_remove()  { d__link_queue_remove;  }
----

The assembly of the link-queue arrays can be <<queue-auto,automated>>, especially when symlinking <<assets-main,assets>>.

.Assembled link-queue example
[source,bash]
----
# ~/.grail/dpls/link-queue-example.dpl.sh

d_dpl_check()   { assemble_queue; d__link_queue_check;   }
d_dpl_install() {                 d__link_queue_install; }
d_dpl_remove()  {                 d__link_queue_remove;  }

assemble_queue()
{
  D_QUEUE_MAIN=( '.bashrc' )
  D_QUEUE_ASSETS=( "$D__DPL_ASSET_DIR/.bashrc" )
  D_QUEUE_TARGETS=( "$HOME/.bashrc" )
}
----

[[lnqe-h-a-i]]
==== Link-queue hooks, add-statuses, and indicators

The link-queue supports the equivalent set of <<queue-hooks,hooks>> as the generic queue, with the `d_` prefix exchanged for the `d_link_` prefix.
(E.g., `d_item_pre_remove` becomes `d_link_item_pre_remove`.)
Other than the name difference, the hooks behave identically.

[[ghqe-main]]
=== Github-queues

The *Github-<<queue-main,queue>>* takes a list of https://github.com[Github] repository handles (`username/repository`), a list of destination paths, and sequentially clones/downloads the former into the latter.
The <<stash-main,stashing>> system is used to track the installations of the Github-queue.

[[ghqe-setup]]
==== Setting up a Github-queue

To assemble a Github-queue within a deployment (or a <<mltsk-main,task>>):

* Set the queue <<queue-determinant,*determinant*>>, `*D_QUEUE_MAIN*`.
The names of the Github-queue items must be the Github repository handles (`username/repository`).
* For each index in the determinant array, populate the following special arrays:
** `*D_QUEUE_TARGETS*` — the absolute paths to the repository destinations.
* Call the Github-queue helper primaries as the last commands of the deployment's (or task's) <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__gh_queue_check;   }
d_dpl_install() { d__gh_queue_install; }
d_dpl_remove()  { d__gh_queue_remove;  }
----

The assembly of the Github-queue arrays can be <<queue-auto,automated>>.

.Assembled Github-queue example
[source,bash]
----
# ~/.grail/dpls/github-queue-example.dpl.sh

d_dpl_check()   { assemble_queue; d__gh_queue_check;   }
d_dpl_install() {                 d__gh_queue_install; }
d_dpl_remove()  {                 d__gh_queue_remove;  }

assemble_queue()
{
  D_QUEUE_MAIN=( 'ohmyzsh/ohmyzsh' )
  D_QUEUE_TARGETS=( "$HOME/.oh-my-zsh" )
}
----

[[ghqe-h-a-i]]
==== Github-queue hooks, add-statuses, and indicators

The Github-queue supports the equivalent set of <<queue-hooks,hooks>> as the generic queue, with the `d_` prefix exchanged for the `d_gh_` prefix.
(E.g., `d_item_post_check` becomes `d_gh_item_post_check`.)
Other than the name difference, the hooks behave identically.

== Advanced features

_Divine.dotfiles_ offers mechanisms that facilitate creation of better, stronger, faster deployments.

=== Naming convention

_Divine.dotfiles_ uses a system of prefixes to gradually separate the framework's inner workings.

* The single-underscore prefixes are for entities to be implemented by a deployment:
** `**D{us}**NAME` — the variables to be assigned, e.g., the <<dpls-metadata,metadata>> and the <<addst-main,add-statuses>>.
** `**d{us}**name` — the functions to be implemented, e.g., the <<func-primaries,primary functions>>.
* The double-underscore prefixes are for entities to be accessed by a deployment:
** `**D{dus}**NAME` — the variables to be read, e.g., the <<indct-main,indicators>>.
** `**d{dus}**name` — the functions to be called, e.g., the <<stash-main,`d__stash`>> function.
* The triple-underscore prefixes are for entities that are strictly internal:
** `**d{dus}{us}**name` — the functions that the framework uses for logic encapsulation.

To stay on the safe side, the <<deployments,deployment>> code needs to stay away from identifiers that start with the letter `d`/`D` followed by an underscore, unless a framework mechanism is being employed.

[[wkfl-main]]
=== Divine workflow

====
Divine workflow functions:

[none]
* <<func-context,Function `d{dus}context`>>
* <<func-notify,Function `d{dus}notify`>>
* <<func-prompt,Function `d{dus}prompt`>>
* <<func-fail,Function `d{dus}fail`>>
* <<func-cmd,Function `d{dus}cmd`>>
* <<func-pipe,Function `d{dus}pipe`>>
* <<func-require,Function `d{dus}require`>>
====

The Divine workflow is the recommended way to organize Bash code within deployments.
The framework provides a set of functions that facilitate breaking down Bash code into meaningful blocks.
The goal of the workflow system is to both annotate the code and automatically provide useful debug output.

Central to the idea of the Divine workflow is the concept of *workflow context*.
The workflow context is a stack (similar to the function https://en.wikipedia.org/wiki/Call_stack[call stack]) that at any moment contains the hierarchy of tasks currently being performed.
The context stack can be visualized like this:

.Illustration of the Divine workflow context stack
[source]
----
0. Running `install` routine
1. Installing deployments at priority `4096`
2. Deployment `example`
---
3. Executing a particular task within the deployment
4. Executing a sub-task
----

The context stack starts at the root and grows down to arbitrary depth.
Context items are *pushed* and *popped* from the bottom.
*Notches* — represented by the three hyphens (`---`) in the illustration — delimit the logical stratas.

[[wkfl-guide]]
With the idea of context in mind, the Divine workflow boils down to the following principles:

* The logic should be encapsulated in functions.
* The workflow context tree should be grown by calling the <<func-context,`d{dus}context`>> function:
** `d{dus}context notch` — to place a notch.
** `d{dus}context push` — to push a workflow item onto the stack.
* Whenever a context branch needs to fail:
** Critical commands could be wrapped in the <<func-cmd,`d{dus}cmd`>>, <<func-pipe,`d{dus}pipe`>>, or <<func-require,`d{dus}require`>> calls.
** 'Manual' failures should be orchestrated via the <<func-fail,`d{dus}fail`>> function.
* To interact with the user along the way:
** Non-failure alerts should be delivered via the <<func-notify,`d{dus}notify`>> function.
** Prompts could be initiated via the <<func-prompt,`d{dus}prompt`>> function.
* To finalize successful runs:
** `d{dus}context pop` — to pop a workflow item from the stack.
** `d{dus}context lop` — to slash the context stack up to and including the latest notch.

If a `push` is prepended to every logical unit of code, and then a matching `pop` is appended at the end, a useful pattern of breadcrumbs arises in the debug output.
The Divine workflow functions (<<func-notify,`d{dus}notify`>>, <<func-prompt,`d{dus}prompt`>>, <<func-fail,`d{dus}fail`>>, <<func-cmd,`d{dus}cmd`>>, <<func-pipe,`d{dus}pipe`>>, <<func-require,`d{dus}require`>>) may include the state of the context stack in their output.

.Divine workflow in action
[source,bash]
----
d__dpl_install()
{
  d__context notch
  d__context push 'Installing feature'
  d__context push 'Performing critical work'
  d__cmd perform_critical_work --ARG-- "$some_arg" \
    --else-- 'Nothing was installed' || return 1
  d__context lop
  return 0
}
----

With the default <<opt-verbosity,verbosity>> level, the code above produces no output when successful.
If something goes wrong in the critical task, a message similar to the following will be printed:

[source,subs="verbatim,quotes,attributes"]
----
[.red]#*==>*# *Command failed:* perform_critical_work *ARG*
        *ARG:* 'whetever $some_arg variable contained'
    *Context:* Installing feature
             Performing critical work
    *Result:* Nothing was installed
----

[[func-context]]
==== Function `d{dus}context`

The function `d{dus}context` manipulates the context stack of the Divine <<wkfl-main,workflow>>.
The main <<wkfl-main,section>> ties together the usage of the Divine workflow.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}context* [-!dlnqsvx] [-t *_TITLE_*] [--] *push*|*pop*|*notch*|*lop* *_DESCRIPTION_*|[*_DESCRIPTION_*]
----

The usage per routine is:

* `*push* *_DESCRIPTION_*` — appends the `*_DESCRIPTION_*` item to the bottom of the context stack.
* `*pop* [*_DESCRIPTION_*]` — removes an item from the bottom of the context stack.
+
If given, the optional `*_DESCRIPTION_*` substitutes for the actual description of the popped item.
* `*notch*` — places a notch past the bottom of the context stack.
* `*lop*` — repeatedly executes a `pop` until the latest notch (or root) is reached, and then removes that notch.

All stack manipulations trigger a debug message that honors the <<opt-verbosity,global verbosity level>>.

Any number of notches can be made, as long as they are not duplicated at the same position.
Within the context stack, the latest pushed item is called the *tip*, and all items pushed after the latest notch are collectively called the *head*.

Each item on the context stack must be given a `*_DESCRIPTION_*`.
Stylistically, the `*_DESCRIPTION_*` should be a single sentence (no full stop at the end), worded around either a noun or a https://en.wikipedia.org/wiki/Gerund[gerund] (_yeah, that's important!_).
Repetition of information from the above levels should be minimized.

.Output layout of `d{dus}context`
[source,subs="verbatim,quotes,attributes"]
----
# Pushing an item
==> *Start*: Description of the context item

# Popping an item
==> *End*: Description of the context item

# Making a notch
==> *Notched*: At position _X_

# Removing a notch
==> *De-notched*: At position _X_
----

The return codes are:

* `0` — Stack modified as requested.
* `1` — Stack not modified: no arguments or unrecognized first argument.
* `2` — Stack not modified: pushing without a `*_DESCRIPTION_*`.
* `3` — Stack not modified: popping from an empty stack.
* `4` — Stack not modified: notching at the same position.

.List of `d{dus}context` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*-t* _TITLE_`, `*--title* _TITLE_`
+++</p>+++

Sets a custom title for the debug message.
The title is not a part of the `*_DESCRIPTION_*`.
All operations have default titles (these are shown in the illustration above in *bold*).

| +++<p align="center">+++
`*-n*`, `*--newline*`
+++</p>+++

When this option is given: if the function produces any output, an extra newline is prepended to it.

| +++<p align="center">+++
*Quiet options*
+++<br>+++
`*-q*`, `*--quiet*` _(repeatable)_
+++<br>+++
`*-l*`, `*--loud*`
+++</p>+++

The *quiet options* designate the *quiet level* for the current call.
The function's output is printed only if the <<opt-verbosity,global verbosity level>> is greater than or equal to the quiet level.

When the quiet options are read, left-to-right, the quiet level starts at zero:

* Each `--quiet` option increments the quiet level by one.
* The `--loud` option sets the quiet level to zero.

However, if none of the quiet options are given, the default quiet levels per operation are:

* `*push*` — `2`
* `*pop*` — `3`
* `*notch*` — `4`
* `*lop*` — `4`
+
The default quiet level for the `lop` applies to the underlying ``pop``s.
For the ``pop``s to be performed at a different quiet level, they must be made separately.

| +++<p align="center">+++
*Styling options*
+++<br>+++
`*-d*`, `*--debug*` _(default)_
+++<br>+++
`*-!*`, `*--alert*`
+++<br>+++
`*-v*`, `*--success*`
+++<br>+++
`*-x*`, `*--failure*`
+++<br>+++
`*-s*`, `*--skip*`
+++</p>+++

The *styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

The titles are formatted in *bold*, and on top of that:

* The `--debug` option paints the entire output in cyan.
* The `--alert` option paints the introductory arrow in yellow.
* The `--success` option paints the introductory arrow in green.
* The `--failure` option paints the introductory arrow in red.
* The `--skip` option paints the introductory arrow in white.

These options are not combined and the last option given wins.

|===

[[func-notify]]
==== Function `d{dus}notify`

The `d{dus}notify` function is a debug printer that does not cause any side effects.
The main <<wkfl-main,section>> ties together the usage of the Divine workflow.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}notify* [-!1cdhlnqsuvx] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Whether the output is printed depends on the <<opt-verbosity,global verbosity level>>.

.Output layout of `d{dus}notify` (without any arguments)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*
----

.Output layout of `d{dus}notify` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
----

* `*_TITLE_*` — _(optional)_ a short heading.
* `*_DESCRIPTION_*` — _(optional)_ an elaboration.
* `*_CONTEXT_*` — _(optional)_ some part of the context stack (depending on options).
+
The entire context block is omitted if the context stack is not requested or is empty.

The return codes are:

* `0` — Always.

.List of `d{dus}notify` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*-u*`, `*--sudo*`
+++</p>+++

Directs to print the notification only if the caller lacks the `sudo` privilege.
Automatically makes the notification `--loud`.

With this option, new defaults are in effect:

* `*_TITLE_*` — `Password prompt`.
* `*_DESCRIPTION_*` — `The upcoming command requires sudo privileges`.

| +++<p align="center">+++
`*-t* _TITLE_`, `*--title* _TITLE_`
+++</p>+++

Sets a custom title for the notification.

Without this option, the `*_TITLE_*` defaults to:

** With a `*_DESCRIPTION_*` — omitted.
** Without a `*_DESCRIPTION_*` — `Generic alert`.

| +++<p align="center">+++
`*-n*`, `*--newline*`
+++</p>+++

When this option is given: if the function produces any output, an extra newline is prepended to it.

| +++<p align="center">+++
*Quiet options*
+++<br>+++
`*-q*`, `*--quiet*` _(repeatable)_
+++<br>+++
`*-l*`, `*--loud*`
+++</p>+++

The *quiet options* designate the *quiet level* for the current call.
The function's output is printed only if the <<opt-verbosity,global verbosity level>> is greater than or equal to the quiet level.

When the quiet options are read, left-to-right, the quiet level starts at zero:

* Each `--quiet` option increments the quiet level by one.
* The `--loud` option sets the quiet level to zero.

However, if none of the quiet options are given, the default quiet level is `1`.

| +++<p align="center">+++
*Context options*
+++<br>+++
`*-c*`, `*--context-all*`
+++<br>+++
`*-h*`, `*--context-head*`
+++<br>+++
`*-1*`, `*--context-tip*`
+++</p>+++

Includes the context block in the output with the following content:

* `--context-all` — the entire context stack;
* `--context-head` — the head of the context stack (the items pushed since the last notch);
* `--context-tip` — the tip of the context stack (the last pushed item).

These options are not combined and the last option given wins.

| +++<p align="center">+++
*Styling options*
+++<br>+++
`*-d*`, `*--debug*` _(default)_
+++<br>+++
`*-!*`, `*--alert*`
+++<br>+++
`*-v*`, `*--success*`
+++<br>+++
`*-x*`, `*--failure*`
+++<br>+++
`*-s*`, `*--skip*`
+++</p>+++

The *styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

The titles are formatted in *bold*, and on top of that:

* The `--debug` option paints the entire output in cyan.
* The `--alert` option paints the introductory arrow in yellow.
* The `--success` option paints the introductory arrow in green.
* The `--failure` option paints the introductory arrow in red.
* The `--skip` option paints the introductory arrow in white.

These options are not combined and the last option given wins.

| +++<p align="center">+++
*Special para-options*
+++<br>+++
`*-t-*`
+++<br>+++
`*-n-*`
+++<br>+++
`*-i-*`
+++</p>+++

The *para-options* work only _to the right_ of the option-argument separator (`--`).

The para-options are shorthand for linebreaks, indentation, and bold titles.

* `-t-` — treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
+
The title is styled in bold (if the terminal coloring is available) and is followed by a colon.
* `-n-` — inserts a newline followed by the arrow-width indentation (four spaces).
* `-i-` — similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-prompt]]
==== Function `d{dus}prompt`

The function `d{dus}prompt` is the preferred mechanism for requesting a confirmation from the user.
The main <<wkfl-main,section>> ties together the usage of the Divine workflow.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}prompt* [-!1bchknqsvxy] [-p *_PROMPT_*] [-a *_ANSWER_*] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Two prompting modes are supported:

* The *decision prompt* (yes or no): returns `0` for the affirmative answer and `1` for the negatory answer.
* The *any-key prompt*: returns `0` for any key press.

Both modes support the `--or-quit` option, which adds an additional 'quit' response with the return code of `2`.

.Output layout of `d{dus}prompt` (without any arguments)
[source,subs="verbatim,quotes,attributes"]
----
*_PROMPT_* *_KEYS_*
----

.Output layout of `d{dus}prompt` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
    *_PROMPT_* *_KEYS_*
----

If the prompt contains no optional parts, it is considered a one-liner, and the introductory arrow is omitted.

* `*_PROMPT_*` — a short question.
Defaults to `Proceed?`.
* `*_KEYS_*` — the reference of accepted keys:
** The decision prompt: `[y/n]`
** The decision prompt (with the `--or-quit` option): `[y/n/q]`
** The any-key prompt: `[<any key>]`
** The any-key prompt (with the `--or-quit` option): `[<any key>/q]`
* `*_TITLE_*` — _(optional)_ a short heading.
+
If the `*_DECSRIPTION_*` is empty and if the prompt is not a one-liner, defaults to `User attention required`.
* `*_DESCRIPTION_*` — _(optional)_ an elaboration.
* `*_CONTEXT_*` — _(optional)_ some part of the context stack (depending on options).
+
The entire context block is omitted if the context stack is not requested or is empty.

.List of `d{dus}prompt` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompting modes*
+++<br>+++
`*-y*`, `*--yes-no*` _(default)_
+++<br>+++
`*-k*`, `*--any-key*`
+++</p>+++

The prompting mode:

* `--yes-no` — the decision prompt (yes or no).
* `--any-key` — the any-key prompt.

These options are not combined and the last option given wins.

| +++<p align="center">+++
`*-q*`, `*--or-quit*`
+++</p>+++

In both prompting modes, provides an extra option: 'quit'.
The returned value for the 'quit' option is always `2`.

| +++<p align="center">+++
`*-t* _TITLE_`, `*--title* _TITLE_`
+++</p>+++

Sets a custom title for the leading line.

Without this option, the `*_TITLE_*` defaults to:

** With a `*_DESCRIPTION_*` — omitted.
** Without a `*_DESCRIPTION_*` — `User attention required`.

| +++<p align="center">+++
`*-p* _PROMPT_`, `*--prompt* _PROMPT_`
+++</p>+++

Sets a custom `*_PROMPT_*`.
Without this option, the `*_PROMPT_*` defaults to `Proceed?`.

| +++<p align="center">+++
`*-a* _ANSWER_`, `*--answer* _ANSWER_`
+++</p>+++

In the decision mode:

* If the value of `_ANSWER_` is `true`, returns `0` without prompting.
* If the value of `_ANSWER_` is `false`, returns `1` without prompting.

In the any-key mode:

* If the value of `_ANSWER_` is either `true` or `false`, returns `0` without prompting.

Passing the value of the `$D__OPT_ANSWER` variable into the `--answer` option makes the prompt obey the <<<<opt-answers,answer>> that the user provides to the <<iutil-main,intervention utility>>.

| +++<p align="center">+++
`*-n*`, `*--newline*`
+++</p>+++

When this option is given: if the function produces any output, an extra newline is prepended to it.

| +++<p align="center">+++
*Context options*
+++<br>+++
`*-c*`, `*--context-all*`
+++<br>+++
`*-h*`, `*--context-head*`
+++<br>+++
`*-1*`, `*--context-tip*`
+++</p>+++

Includes the context block in the output with the following content:

* `--context-all` — the entire context stack;
* `--context-head` — the head of the context stack (the items pushed since the last notch);
* `--context-tip` — the tip of the context stack (the last pushed item).

These options are not combined and the last option given wins.

| +++<p align="center">+++
*Styling options*
+++<br>+++
`*-d*`, `*--debug*` _(default)_
+++<br>+++
`*-!*`, `*--alert*`
+++<br>+++
`*-v*`, `*--success*`
+++<br>+++
`*-x*`, `*--failure*`
+++<br>+++
`*-s*`, `*--skip*`
+++<br>+++
`*-b*`, `*--bare*`
+++</p>+++

The *styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

The titles are formatted in *bold*, and on top of that:

* The `--debug` option paints the entire output in cyan.
* The `--alert` option paints the introductory arrow in yellow.
* The `--success` option paints the introductory arrow in green.
* The `--failure` option paints the introductory arrow in red.
* The `--skip` option paints the introductory arrow in white.
* The `--bare` option removes the coloring completely.

These options are not combined and the last option given wins.

| +++<p align="center">+++
*Special para-options*
+++<br>+++
`*-t-*`
+++<br>+++
`*-n-*`
+++<br>+++
`*-i-*`
+++</p>+++

The *para-options* work only _to the right_ of the option-argument separator (`--`).

The para-options are shorthand for linebreaks, indentation, and bold titles.

* `-t-` — treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
+
The title is styled in bold (if the terminal coloring is available) and is followed by a colon.
* `-n-` — inserts a newline followed by the arrow-width indentation (four spaces).
* `-i-` — similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-fail]]
==== Function `d{dus}fail`

The function `d{dus}fail` announces a failure to the user and lops the head of the workflow context stack.
The main <<wkfl-main,section>> ties together the usage of the Divine workflow.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}fail* [-n] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Every call to this function internally calls `<<func-context,d{dus}context>> lop`.
This function should _not_ be used for non-consequential failures that do not affect the workflow context.
(For such things, `<<func-notify,d{dus}notify>> --failure` works nicely.)

The return codes are:

* `0` — Always, as in 'failed successfully'.

.Output layout of `d{dus}fail` (without any arguments and with empty context stack)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*
----

.Output layout of `d{dus}fail` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
----

* `*_TITLE_*` — _(optional)_ a short heading.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the failure.
* `*_CONTEXT_*` — The head of the context stack, which is about to be lopped off.
The entire context block is omitted if the context stack is empty.

.List of `d{dus}fail` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*-t* _TITLE_`, `*--title* _TITLE_`
+++</p>+++

Sets a custom title for the failure message.

Without this option, the `*_TITLE_*` defaults to:

* With a `*_DESCRIPTION_*` — `Failure`.
* Without a `*_DESCRIPTION_*` — `Something went wrong`.

| +++<p align="center">+++
`*-n*`, `*--newline*`
+++</p>+++

When this option is given: if the function produces any output, an extra newline is prepended to it.

| +++<p align="center">+++
*Special para-options*
+++<br>+++
`*-t-*`
+++<br>+++
`*-n-*`
+++<br>+++
`*-i-*`
+++</p>+++

The *para-options* work only _to the right_ of the option-argument separator (`--`).

The para-options are shorthand for linebreaks, indentation, and bold titles.

* `-t-` — treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
+
The title is styled in bold (if the terminal coloring is available) and is followed by a colon.
* `-n-` — inserts a newline followed by the arrow-width indentation (four spaces).
* `-i-` — similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-cmd]]
==== Function `d{dus}cmd`

The function `d{dus}cmd` is a wrapper around a single *simple* Bash command.
The main <<wkfl-main,section>> ties together the usage of the Divine workflow.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}cmd* [_options_] [----] *_CMD_*...
----

The wrapper executes the command `*_CMD_*` as normal, then inspects its return code.
If the return code is non-zero, it prints a failure message (similar to the output of the <<func-fail,`d{dus}fail`>> function in appearance), and then calls `<<func-context,d{dus}context>> lop`.
The output is titled, by default, `Command failed`, and shows the command that has failed, along with the current context stack.

The command `*_CMD_*` must be a single simple command, consisting of any number of ``WORD``s.
Naturally, Bash will parse the call to the wrapper function before the underlying command.
As such, here are some examples of what the `*_CMD_*` can and cannot contain:

* Yes: The simple commands, e.g., `test`, `[`, or `[[`.
* Yes: The variable expansions.
* Yes: The input redirections.
* Maybe: The output redirections.
+
(These will affect the wrapper function, which might just do exactly what is needed.)
* *NO*: The operators `&&` and `||`.
+
The <<func-require,`d{dus}require`>> function provides the support for these.
* *NO*: The pipe operator `|`.
+
The <<func-pipe,`d{dus}pipe`>> function provides the support for this.
* *NO*: The negation operator `!`.
+
The `--neg--` option provides support for this.
* *NO*: The advanced constructs such as `if`, or `case`, or the arithmetic context.

The return codes are:

* `0` — The `*_CMD_*` returned zero (after the optional negation).
* `1` — The `*_CMD_*` returned non-zero (after the optional negation).
* `2` — Called without arguments.

.Output layout of `d{dus}cmd` in case of failure (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_CMD_*
        *_LABEL-0_*: '*_WORD-0_*'
        *_LABEL-1_*: '*_WORD-1_*'
        ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
    Circumstances: *_CRCM_*
    Result: *_RSLT_*
----

* `*_TITLE_*` — A short heading.
* `*_CMD_*` — The command that failed, with labels pasted in.
* `*_LABEL_*` — _(optional)_ The list of labels and their disambiguations.
The labels are created via corresponding options, described below.
* `*_CONTEXT_*` — The head of the context stack, which is about to be lopped off.
The entire context block is omitted if the context stack is empty.
* `*_CRCM_*` — _(optional)_ The description of circumstances of the command call, if provided by the caller.
* `*_RSLT_*` — _(optional)_ The description of consequences of the command failure, if provided by the caller.

.List of `d{dus}cmd` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*----*`
+++</p>+++

Stops processing options for the wrapper function, and reads the rest of the arguments as parts of the `*_CMD_*`.

| +++<p align="center">+++
`*--neg--*`
+++</p>+++

Negates the return code of the `*_CMD_*`, as if it is prepended with the `!` operator.

| +++<p align="center">+++
*Output suppression modes*
+++<br>+++
`*--sn--*` _(default)_
+++<br>+++
`*--so--*`
+++<br>+++
`*--se--*`
+++<br>+++
`*--sb--*`
+++</p>+++

* `--sn--` — suppresses **n**either the `stdout` nor the `stderr` of the `*_CMD_*`, as is default.
* `--so--` — suppresses the `std**o**ut` of the `*_CMD_*`.
* `--se--` — suppresses the `std**e**rr` of the `*_CMD_*`.
* `--sb--` — suppresses **b**oth the `stdout` and the `stderr` of the `*_CMD_*`.

These options are not combined and the last option given wins.

| +++<p align="center">+++
*Quiet options*
+++<br>+++
`*--q--*`, `*--q…--*` _(repeatable)_
+++<br>+++
`*--l--*`
+++</p>+++

The *quiet options* designate the *quiet level* for the current call.
The ``*_CMD_*``'s output (if any occurs and is not suppressed) is printed only if the <<opt-verbosity,global verbosity level>> is greater than or equal to the quiet level.

By default, the quiet level does not affect the appearance of the failure output.

When the quiet options are read, left-to-right, the quiet level starts at zero:

* Each `--q--` option increments the quiet level by one.
+
This particular option can be repeated within the hyphens, e.g., `--qqq--`.
For efficiency, only the first character is checked to be `q`, the others are simply counted.
* The `--l--` option sets the quiet level to zero.

However, if none of the quiet options are given, the default quiet level is `0`.

^.^h| Semantics of failure

| +++<p align="center">+++
`*--opt--*`
+++</p>+++

Makes the `*_CMD_*` optional: if there is a failure, the head of the context stacked is not lopped off, and the failure output is styled less urgently.

When a command is marked optional, its failure output is printed depending on the quiet level.

| +++<p align="center">+++
`*--alrt--* _TITLE_`
+++</p>+++

Sets a custom title for the failure output.

| +++<p align="center">+++
`*--crcm--* _CRCM_`
+++</p>+++

Sets a custom circumstances description for the failure output.

| +++<p align="center">+++
`*--else--* _RSLT_`
+++</p>+++

Sets a custom consequences description for the failure output.

| +++<p align="center">+++
*Label option*
+++<br>+++
`**--**__LABEL__**--**`
+++</p>+++

The `**--**__LABEL__**--**` option must precede a single `WORD` of the `*_CMD_*`.
The `_LABEL_` part should be an alphanumerical word.

Normally the failure output prints the offending `*_CMD_*` in its entirety, which can get quite lengthy.
Labeled ``WORD``s appear in the `*_CMD_*` as their labels, and the labels are spelled out below.

For example, the command `d__cmd [ --ZERO-- 0 -eq --ONE-- 1 ]` will produce the following failure output:

[source,subs="verbatim,quotes,attributes"]
----
==> *Command failed*: [ *ZERO* -eq *ONE* ]
        *ZERO*: '0'
        *ONE*: '1'
----

| +++<p align="center">+++
*Label backreference options*
+++<br>+++
`**--#**__NUM__**--**`
+++</p>+++

A previously assigned label may be re-used if the `WORD` it marks is used multiple times within the `*_CMD_*`.
The labels are automatically numbered, starting from zero.
The backreference consist of a hash/pound symbol (`#`), followed by the number of the previous label.
The framework does _not_ check whether the ``WORD``s marked by the same label are actually identical.

|===

[[func-pipe]]
==== Function `d{dus}pipe`

The `d{dus}pipe` function extends the <<func-cmd,`d{dus}cmd`>> function by adding the possibility to chain up to three commands in a continuous Bash pipe.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}pipe* [_options_] [----] *_CMD_*...
----

The reference for the <<func-cmd,`d{dus}cmd`>> function applies fully wherever not overridden by this section.
The actual pipe operator (`|`) cannot be used directly, because it would be parsed with the wrapper function.
Instead, the special pipe option is added.
When the `d{dus}pipe` function is used without the special options, it becomes functionally identical to the `d{dus}cmd` function.

If the `--so--` or the `--sb--` option is used, the `stdout` is only suppressed for the last command in the pipe.

.List of `d{dus}pipe` options (on top of those in <<func-cmd,`d{dus}cmd`>>)
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Pipe option*
+++<br>+++
`*--p--*`, `*--P--*`, `*--pipe--*`
+++</p>+++

Inserts the Bash's pipe operator (`\|`) at that location.
Only the first two instances of this option are recognized (a hard limit).

| +++<p align="center">+++
`**--ret**__NUM__**--**`
+++</p>+++

Commands in the pipe are numbered starting from zero, left to right.
If this option is given, the `__NUM__` represents the number of the command that represents the success of the whole pipe.

Without this option, the last command in the pipe is used.

|===

[[func-require]]
==== Function `d{dus}require`

The `d{dus}pipe` function extends the <<func-cmd,`d{dus}cmd`>> function by adding the possibility to chain up to three commands with the `&&` and `||` operators.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}require* [_options_] [----] *_CMD_*...
----

The reference for the <<func-cmd,`d{dus}cmd`>> function applies fully wherever not overridden by this section.
The actual `&&` and `||` operators cannot be used directly, because they would be parsed with the wrapper function.
Instead, the special options are added.
When the `d{dus}require` function is used without the special options, it becomes functionally similar to the `d{dus}cmd` function.

The `d{dus}require` function changes semantics a little: while the `d{dus}cmd` function is intended to cause side effects, this version is intended for checks against certain requirements.

The option `--neg--` applies to the individual commands within the and/or chain. It has to be used for every negated requirement, at any time before the start of the next requirement.

.List of `d{dus}require` options (on top of those in `d{dus}cmd`)
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| And/or options (only the first two are recognized)

| +++<p align="center">+++
*And/or options*
+++<br>+++
`*--and--*`, `*--AND--*`
+++<br>+++
`*--or--*`, `*--OR--*`
+++</p>+++

* `--and--` — inserts the `&&` operator at that location.
* `--or--` — inserts the `\|\|` operator at that location.

|===

[[stash-main]]
=== Stash

_Divine.dotfiles_ provides a file-based key-value storage/retrieval system called the *stash*.

[[stash-levels]]
There are three levels of stashing system:

* The *deployment stash* — exclusive to the current deployment on the current machine.
This is the default.
+
Stored in `<<fmwk-state,state>>/stash/*_DPL-NAME_*/.stash.cfg`.
* The *root stash* — shared by all deployments on the current machine.
+
Stored in `<<fmwk-state,state>>/stash/.stash.cfg`.
* The *Grail stash* — shared by all deployments across all machines that use the same <<fmwk-grail,Grail>>.
+
Stored in `~/<<fmwk-grail,.grail>>/.stash.cfg`.

[.note]
[%noheader,cols="<.<a"]
|===
| For the curious:

* The records of attaching third-party bundles are stored in the <<stash-levels,Grail stash>>.
* The records of installing the optional framework dependencies are stored in the <<stash-levels,root stash>>.
|===

The rules of the key-value store are:

* The keys must consist of:
** alphanumeric characters;
** underscores (`_`) and hyphens (`-`).
* The values must not exceed single line of text, but are otherwise unrestricted, and may be empty.
* Multiple instances of a key are allowed, the values may be duplicate.

The stashing system is accessible via the `d{dus}stash` function.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}stash* [-drgq] [--] [ *_CMD_* [ *_KEY_* [*_VALUE_*] ] ]
----

Depending on first argument, usage is as follows.

.Usage patterns of `d{dus}stash`
[%noheader,cols="<.<a",stripes=none]
|===

| `d{dus}stash *has* *_KEY_* [*_VALUE_*]`

* If the `*_VALUE_*` is not given: checks whether the stash contains at least one `*_KEY_*` with any value.
* If the `*_VALUE_*` is given: checks whether the stash contains at least one `*_KEY_*` that is set to that `*_VALUE_*`.

Returns `0` if so, or `1` otherwise.

| `d{dus}stash *set* *_KEY_* [*_VALUE_*]`

Ensures that the stash contains a _single_ instance of the `*_KEY_*`, and that it is set to the `*_VALUE_*`.

Returns `0` on success, or `1` otherwise.

| `d{dus}stash *add* *_KEY_* [*_VALUE_*]`

Adds one instance of the `*_KEY_*` and sets it to the `*_VALUE_*`, regardless of the possibly pre-existing instances of the `*_KEY_*`.

Returns `0` on success, or `1` otherwise.

| `d{dus}stash *get* *_KEY_*`

Prints the value of the first instance of the `*_KEY_*` to the `stdout`.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *list* *_KEY_*`

Prints each value of the `*_KEY_*` on a new line to the `stdout`.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *unset* *_KEY_* [*_VALUE_*]`

* If the `*_VALUE_*` is not given: removes all instances of the `*_KEY_*`.
* If the `*_VALUE_*` is given: removes each instance of the `*_KEY_*` that is set to the `*_VALUE_*`.

Returns `0` on success (even if nothing was removed), or `1` otherwise.

| `d{dus}stash *list-keys*`

Prints each `*_KEY_*` currently in the stash on a new line to the `stdout`.
Possible duplicate keys are _not_ pruned.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *clear*`

Clears all records from this stash.

| If called with an unsupported routine name, the function prints an error and returns `3`.

|===

.List of `d{dus}stash` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*-q*`, `*--quiet*`
+++</p>+++

By default, any inconsistency during stashing triggers a loud error message.
The `--quiet` option directs to instead honor the <<opt-verbosity,global verbosity level>>.

This option is intended for cases when not using the stash is also a viable option.

| +++<p align="center">+++
*Stash <<stash-levels,level>> options*
+++<br>+++
`*--d*`, `*--dpl*` _(default)_
+++<br>+++
`*--r*`, `*--root*`
+++<br>+++
`*--g*`, `*--grail*`
+++</p>+++

These options are not combined and the last option given wins.

* The `--dpl` option directs to work with the <<stash-levels,deployment stash>>.
* The `--root` option directs to work with the <<stash-levels,root stash>>.
* The `--grail` option Directs to work with the <<stash-levels,Grail stash>>.

|===

[[func-md5]]
=== Function `d__md5`

The framework exstensively uses the https://en.wikipedia.org/wiki/MD5[MD5] checksums to indirectly compare files and strings.
The `d{dus}md5` function provides a cross-platform way of calculating an the MD5 checksums.
Under the hood it uses the first utility found: `md5sum`, `md5`, or `openssl`.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}md5* [-s *_STRING_*] | [*_PATH_*]
----

* One checksum is calculated per call.
* Either a string or a path to a file may be given.
* It is up to the caller to ensure that the path exists and is readable.
* The checksum is printed to the `stdout`.

The `d{dus}md5` function returns zero on success and non-zero if something goes wrong.

[[bckp-main]]
=== Backups

The framework adheres to the <<fmwk-zero-data-loss,zero data loss>> and the <<fmwk-reversibility,reversibility>> policies.
To assist in that, the framework provides two functions that facilitate <<func-push-backup,backing up>> and <<func-pop-backup,restoring>> files.

[[func-push-backup]]
==== Function `d__push_backup`

The function `d{dus}push_backup` vacates the given path by pushing whatever exists at it to a backup location.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}push_backup* [--] *_ORIG_PATH_* [*_BACKUP_PATH_*]
----

The emptying of the `*_ORIG_PATH_*` is a priority; if it sits empty, a success code is immediately returned.

For the backup path, the first available strategy is employed:

* If a `*_BACKUP_PATH_*` is given, it is used.
If it turns out unusable, an error code is returned, without attempting other strategies.
* If called from a deployment, the backup path is generated in the <<indct-dpl-backup-dir,`$D__DPL_BACKUP_DIR`>> directory, and named by concatenating:
** the MD5 <<func-md5,checksum>> of the `*_ORIG_PATH_*`;
** the `.bak` suffix.
* If none of the above works, an error code is returned.

If the generated backup path happens to be occupied, it is interpreted as a previously made backup.
Previous backups are never overwritten.
Instead, this function repeatedly appends an incrementing numerical suffix (`-1`, `-2`, etc.) to the backup's name until it finds a path that is not yet occupied.
These numerical suffixes are hard capped at 1000.

The `d{dus}push_backup` function always ensures the existence of the directory that is the immediate parent of the `*_ORIG_PATH_*` and of the generated backup path.

The `d{dus}push_backup` function is intended to be used in conjunction with the <<func-pop-backup,`d{dus}pop_backup`>> function.

The return codes are:

* `0` — The `*_ORIG_PATH_*` has been made empty; and if anything existed there, it has been backed up.
* `1` — The `*_ORIG_PATH_*` exists, but is inaccessible.
* `2` — The backup path, whatever it is, is inaccessible or invalid.
* `3` — Other unexpected error.

.List of `d{dus}push_backup` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*-k*`, `*--keep-original*`
+++</p>+++

Directs to not vacate the `*_ORIG_PATH_*`.
If something exists at that location, it is backed up.
Otherwise, nothing is done.

|===

[[func-pop-backup]]
==== Function `d__pop_backup`

The function `d{dus}pop_backup` restores the latest backup of the given path to its original location.
Whatever pre-exists at the original location is, in turn, backed up by appending the `.bak` suffix in-place.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}pop_backup* [-dep]… [--] *_ORIG_PATH_* [*_BACKUP_PATH_*]
----

If there are no backups at all, nothing is done and a success code is returned.

For the backup path, the first available strategy is employed:

* If a `*_BACKUP_PATH_*` is given, it is used.
If it turns out unusable, an error code is returned, without attempting other strategies.
* If called from a deployment, the backup path is generated in the <<indct-dpl-backup-dir,`$D__DPL_BACKUP_DIR`>> directory, and named by concatenating:
** the MD5 <<func-md5,checksum>> of the `*_ORIG_PATH_*`;
** the `.bak` suffix.
* If none of the above works, an error code is returned.

To find the latest backup, this function first checks the generated backup path, then repeatedly appends an incrementing numerical suffix (`-1`, `-2`, etc.).
As soon as it hits a path that does not exist, the previous path is interpreted as the latest backup.
These numerical suffixes are hard capped at 1000.

To back up whatever pre-exists at the `*_ORIG_PATH_*`, the `.bak` suffix is appended to the `*_ORIG_PATH_*`.
If that path happens to be occupied, the same routine of incrementing numbers is applied.

The `d{dus}pop_backup` function is intended to be used in conjunction with the <<func-push-backup,`d{dus}push_backup`>> function.

The return codes are:

* `0` — The backup has been popped successfully, according to the options.
* `1` — The `*_ORIG_PATH_*` is inaccessible.
* `2` — The backup path, whatever it is, is inaccessible or invalid.
* `3` — Other unexpected error.

.List of `d{dus}pop_backup` options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*-e*`, `*--evict*`
+++</p>+++

This option makes it an additional priority to ensure that anything that pre-exists at the `*_ORIG_PATH_*` is no longer there by the time this function successfully returns.
This means that even if there is no backup to pop, the `*_ORIG_PATH_*` still gets vacated.

| +++<p align="center">+++
`*-d*`, `*--dispose*`
+++</p>+++

With this option, the function treats whatever pre-exists at the `*_ORIG_PATH_*` as disposable.
In this mode, no backups of the `*_ORIG_PATH_*` are made.

| +++<p align="center">+++
`*-p*`, `*--precise*`
+++</p>+++

Directs to skip the motions of looking up the latest backup version by appending the suffixes.
Instead, the backup location is used either precisely or not at all.

|===

[[func-os-pkgmgr]]
=== Function `d__os_pkgmgr`

The `d__os_pkgmgr` function is a thin wrapper around the OS package manager.
The idea is to be able to install universally available system packages on any supported OS.
On OS's that are not yet supported, this function does nothing and returns non-zero.

[source,subs="verbatim,quotes,attributes"]
----
*d__os_pkgmgr* *update*|*has*|*check*|*install*|*remove* [*_PKG-NAME_*]
----

Launches one of the five routines, which are expected of any package manager out there:

* `update` — updates all installed packages (other arguments are ignored).
* `has` — checks whether the `*_PKG-NAME_*` is available from that package manager.
* `check` — checks whether the `*_PKG-NAME_*` is installed; returns zero/non-zero appropriately.
* `install` — installs the `*_PKG-NAME_*`.
* `remove` — uninstalls the `*_PKG-NAME_*`.

The `*_PKG-NAME_*` argument is the name of a single package; it is relayed to the underlying package manager verbatim.
User prompts (except the prompt for sudo password) are suppressed/skipped.

== Ways to contribute

You are welcome to contribute to _Divine.dotfiles_ in any way you deem beneficial.
This section is periodically updated to state the most sought after avenues of improvement.

[[cntrb-os-support]]
=== Contributing OS support

One of the main goals of _Divine.dotfiles_ is *portability*.

In _Divine.dotfiles_, the code that supports a particular OS distribution is concentrated in two locations:

* The detection mechanism in the file at `<<fmwk-lib,lib>>/procedures/detect-os.pcd.sh`.
+
In that file, search for the `\<<CONTRIBUTE HERE>>` line.
* The special files called *adapters*, located at `<<fmwk-lib,lib>>/adapters/`.
+
To start the work on your own adapter, get the template at `<<fmwk-lib,lib>>/templates/adapters/distro.adp.sh`.

Adapters for all OS distributions out there will be welcomed with open arms.

[[bdl-main]]
== Bundles

A *bundle* is a https://github.com[Github] repository containing at least one deployment (or Divinefile).
Nothing more is needed to make a bundle.

[[bdl-tag]]
=== Bundle tag

A bundle may optionally carry a tag: a file in the root of the repository named `*bundle.sh*`.
The bundle tag is the container for the bundle's *metadata*, which is similar to the <<dpls-metadata,deployment metadata>> and pose as Bash variable assignments.
Despite the `.sh` suffix, the bundle tag is never actually sourced by the Bash interpreter.
Instead, the metadata values are extracted using pattern matching.
The same syntax limitations should be adhered as for the deployment <<dpls-metadata-syntax,counterparts>>, except that the bundle metadata may occur anywhere within the tag file.s

Currently, the following metadata are supported:

* `<<bdl-versioning,*D_BUNDLE_VERSION*>>=_MAJOR.MINOR.PATCH_`
+
The current version of the bundle, following the https://semver.org[semantic versioning] pattern.
By default, this version is purely cosmetic, but can play a crucial part in the <<bdl-versioning,bundle versioning>>.

[[bdl-versioning]]
=== Bundle versioning

The framework provides the *transitions* system.
A transition is a Bash script that is sourced by the framework whenever the bundle reaches or supercedes a particular <<bdl-tag,version>>.

Transition scripts may be put into the directory named `*transitions*`, located in the root of the bundle repository.
A transition script must be named as the version of the bundle that it applies to, followed by the `.trs.sh` suffix.
Multiple transitions are applied in the ascending alphanumerical order of their file names.

For example, a transition script `transitions/1.5.0.trs.sh` is sourced in one of two scenarios:

* The bundle is <<rtn-attach,attached>> with its version equal to or newer than `1.5.0`.
* The bundle is <<rtn-update,updated>> from a version older than `1.5.0` (or from an unmarked version) to a version equal to or newer than `1.5.0`.

The framework monitors the return code of the transition script: if it is not zero, the transition is marked as failed.
Whenever a transition fails:

* no further transitions are applied;
* on the next invocation of the <<rtn-update,`update`>> routine the transitions are re-applied starting from the failed one;
* the bundle is excluded from the <<rtn-primaries,primary routines>> until all transitions are applied successfully.

[[divine-bundles]]
== Divine bundles

The *Divine bundles* of deployments are regular bundles that are developed and distributed alongside _Divine.dotfiles_.
Apart from being useful by themselves, they serve as an illustration of the framework's mechanisms put to good use.

The Divine bundles are published to their own Gighub organization, https://github.com/divine-bundles[`*divine-bundles*`].

.List of Divine bundles
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*https://github.com/divine-bundles/essentials[Essentials]*
+++</p>+++

The deployment bundle `essentials` for Divine.dotfiles is a collection of opinionated system set-up scripts. It is intended as a useful starting point for any Unix-like box.

The effects of installing the `essentials` bundle are described on its https://github.com/divine-bundles/essentials[page] and also in the <<fmwk-joy-ride,joy ride>> section.

|===

=== Divine bundles in development

The following bundles are not yet in a satisfactory state for publishing.
Still, these are functional to the described extent.

.List of Divine bundles in development
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*https://github.com/divine-bundles/primers[Application primers]*
+++</p>+++

_(fully functional on macOS, not yet fully documented)_

Automates one-time setting-up of utilities that tend to require it:

* https://www.gnupg.org[GnuPG]: automates adherence to best security practices while handling the secret keys.
* https://en.wikipedia.org/wiki/Secure_Shell[SSH]: automates secure stashing and retrieving of SSH keys.

| +++<p align="center">+++
*https://github.com/divine-bundles/configs[Application configs]*
+++</p>+++

_(fully functional on macOS, not yet fully documented)_

Automates plugging (and unplugging) of the pre-made configuration files for:

* https://code.visualstudio.com[Visual Studio Code].
* https://hyper.is[Hyper] terminal.
* https://transmissionbt.com[Transmission BT].

| +++<p align="center">+++
*https://github.com/divine-bundles/fonts[Fonts collection]*
+++</p>+++

_(fully functional on macOS & Ubuntu, not yet fully documented)_

Maintains a collection of personal font files across machines.

^.^h| macOS-specific deployments

| +++<p align="center">+++
*https://github.com/divine-bundles/mac-tilde-switch[MacBook tilde-switch]*
+++</p>+++

_(fully functional on macOS, not yet fully documented)_

Programmatically switches the keys tilde `~` and plus-minus `±` on a MacBook's built-in physical keyboard.

| +++<p align="center">+++
*https://github.com/divine-bundles/macos-local-server[Local development server]*
+++</p>+++

_(still unstable, not yet fully documented)_

Maintains a local development server on macOS.
For the most part, it automates instructions from https://getgrav.org/blog/macos-mojave-apache-multiple-php-versions[this article].

|===