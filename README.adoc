= Divine.dotfiles
:author: Grove Pyree
:email: grayarea@protonmail.ch
:revdate: 2019.10.31
:revremark: Better set the new example gif in README
:doctype: article
// Visual
:toc:
// Subs:
:hs: #
:dhs: ##
:us: _
:dus: __
:as: *
:das: **

++++
<p align="center">
<em>The Bash framework for dotfiles and everything Bash</em>
</p>
++++

++++
<p align="center">
  <img id="divine-dotfiles-plaque" width="640" src="lib/img/divine-dotfiles-plaque.png" alt="Divine.dotfiles">
</p>
++++

New machine or new OS?
Set it up with a single `*di install --yes*`.

[.note]
[%noheader,cols="<.<a"]
|===
| `di` stands for **d**ivine **i**ntervention.
|===

== In a nutshell

[.note]
[%noheader,cols="<.<a"]
|===
| First-time users are very welcome to take a <<joy-ride,*joy ride*>>.
|===

_Divine.dotfiles_ leverages *deployments*.

A deployment is a Bash script with three specially named functions: one to *check*, another to *install*, third to *remove*.
Return codes are used to communicate status back to the framework.
As such, authoring a deployment is akin to implementing an interface.

The goals of _Divine.dotfiles_ are:

* *Automation* of setting-up any system that runs Bash.
+
The <<intervention-utility,intervention utility>> `di` is a practical tool for handling any number of deployments.
* *Cross-platformness* within the Unix-like airspace.
+
Built-in OS detection mechanisms facilitate writing portable deployments.
* Promotion of *standards* and *best practices*.
+
Deployment ecosystem is designed with distribution and pluggability in mind.

<<divine-deployments,*Divine deployments*>> (distributed separately) strive to exemplify what a good deployment should look like.

=== Example deployment

Say, you install the same command line utility on every machine.
Here's a sample deployment that does a scaled down version of that:

[source,bash,subs="verbatim,attributes"]
----
# grail/dpls/example.dpl.sh

d_dpl_check() {
  [ -e ~/bin/cmd ] && return 1 {vbar}{vbar} return 2
}

d_dpl_install() {
  cat >~/bin/cmd <<<'echo Divine.dotfiles rocks' && chmod +x ~/bin/cmd
}

d_dpl_remove() {
  rm -f -- ~/bin/cmd
}
----

And here is what working with it looks like:

++++
<p align="center">
  <img id="divine-dotfiles-example-1" width="640" src="lib/img/divine-dotfiles-example-1.gif" alt="Divine.dotfiles example 1">
</p>
++++

Dead simple, right?
You wouldn’t need a framework for that.
But wait, there’s [.small]#_(hopefully)_# more.

=== Framework features

.Framework features
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++<<divinefiles,*Divinefile*>>+++</p>+++

Special deployment that maintains a stable set of system packages across machines and OS's.

| +++<p align="center">+++<<grail-directory,*The Grail directory*>>+++</p>+++

Store your deployments and assets (e.g., personal config files) in one place.
On a new machine — <<plug-routine,plug in>> your Grail [.small]#_(heh)_# from a repo or a local dir with one command.

| +++<p align="center">+++<<deployment-priority,*Priorities*>>+++</p>+++

Easily marshal your deployments in order, which is automatically reversed for uninstallation.

| +++<p align="center">+++<<deployment-groups,*Groups*>>+++</p>+++

Split your deployment collection into groups to easily handle selective installations.

| +++<p align="center">+++<<detected-os,*Cross-platformness*>>+++</p>+++

Use built-in OS detection mechanism to perform certain tasks on certain distributions or OS families.

| +++<p align="center">+++<<attach-routine,*Third-party deployments (bundles)*>>+++</p>+++

Attach pre-made bundles of deployments from Github (such as the glorious https://github.com/no-simpler/divine-bundle-essentials[`essentials`] bundle).

| +++<p align="center">+++<<stash,*Stash*>>+++</p>+++

Persistent key-value store for use within your deployments.

| +++<p align="center">+++<<assets,*Assets*>>+++</p>+++

Easily separate your deployments into static logic and dynamic content.

| +++<p align="center">+++<<generic-queue,*Queues*>> and <<multitask,*multitask*>>+++</p>+++

Delegate to built-in mechanisms for deployments that perform a series of tasks.

|===

== Installing and uninstalling the framework

=== System requirements

* https://en.wikipedia.org/wiki/Unix-like[Unix-like OS].
Following OS distributions are openly supported:
+
--
** *Debian*
** *Fedora*
** *FreeBSD*
** *macOS*
** *Ubuntu*
--
+
[.note]
[%noheader,cols="<.<a"]
|===
| This list is incomplete; you can help by <<contributing-os-support,expanding it>>.
|===
+
The framework will work on other operating systems too, but without support for automatic installation of system packages (e.g., <<divinefiles,Divinefiles>> will not work).

* `bash 3.2+` and either `curl` or `wget`
+
[.note]
[%noheader,cols="<.<a"]
|===
| `git` is not a hard requirement, but it is not flaccid either.
You can install _Divine.dotfiles_ without `git`.
But then the framework will bug you with suggestions to auto-install it until you relent.
|===

=== Installing the framework

To install _Divine.dotfiles_ framework, run the following single command in Terminal:

[source,bash]
----
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/install/insta\
ll.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif wget \
--version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> Erro\
r: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || { pr\
intf >&2 \"\n==> Error: failed to download installation script\n\"; rm -f \$TM\
P; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC)) && \
exit 3 || exit 0" bash
----

[.note]
[%noheader,cols="<.<a"]
|===
| Installation is completely safe:

* No files are overwritten.
* This repository is cloned/downloaded.
* One symlink is (optionally) created.

Oh, and you will be prompted for everything.
|===

==== Installation options and overrides

Add flavoring to your installation as such:

.Framework installation options and overrides
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Prepend on the left

| `*D_FMWK_DIR=_DIRPATH_*`

Install framework within `*_DIRPATH_*` instead of default `~/.divine/`

| `*D_SHORTCUT_NAME=_CMD_*`

Name shortcut shell command `*_CMD_*` instead of default `di`

| `*D_SHORTCUT_DIR=_DIRPATH_*`

Install shortcut shell command within `*_DIRPATH_*` instead of the default way: choosing among directories on `$PATH`

^.^h| Append on the right

| `*--yes*`

Install everything without prompts

| `*--no*`

Install absolutely nothing

| `*--framework-yes*`

Install framework without prompt

| `*--framework-no*`

Install absolutely nothing (synonym of `--no`)

| `*--shortcut-yes*`

Install shortcut shell command without prompt

| `*--shortcut-no*`

Skip installing shortcut shell command

| `*--verbose*`

Increase amount of output

| `*--quiet*`

[.gray]##_(default)_## Decrease amount of output

|===

=== Uninstalling the framework

To uninstall _Divine.dotfiles_ framework, run the following single command in Terminal:

[source,bash]
----
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/uninstall/uni\
nstall.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif w\
get --version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> \
Error: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || \
{ printf >&2 \"\n==> Error: failed to download uninstallation script\n\"; rm -\
f \$TMP; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC\
)) && exit 3 || exit 0" bash
----

Uninstallation removes optional dependencies that might have been installed, and then erases framework directory.

One thing it does *_not_* do is uninstall deployments.
*_You have to uninstall your deployments manually!_*

By default, a copy of your usage files (including <<grail-directory,the Grail>>) is retained, so even if you forget to uninstall deployments, there is potentially a way to remedy that.

==== Uninstallation options and overrides

Add flavoring to your uninstallation as such:

.Framework uninstallation options and overrides
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Prepend on the left

| `*D_FMWK_DIR=_DIRPATH_*`

Uninstall framework within `*_DIRPATH_*` instead of default `~/.divine/`

^.^h| Append on the right

| `*--yes*`

Uninstall everything without prompts

| `*--no*`

Uninstall absolutely nothing

| `*--utils-yes*`

Uninstall system packages installed by the framework (e.g., `git`) without prompt

| `*--utils-no*`

Skip uninstalling system packages installed by the framework (e.g., `git`)

| `*--backup-yes*`

[.gray]##_(default)_## Make backup of usage files (including Grail dir) without prompt

| `*--backup-no*`

Skip backing up usage files (including Grail dir)

| `*--framework-yes*`

Erase framework directory without prompt

| `*--framework-no*`

Uninstall absolutely nothing (synonym of `--no`)

| `*--verbose*`

Increase amount of output

| `*--quiet*`

[.gray]##_(default)_## Decrease amount of output

|===

[[joy-ride]]
=== Joy ride

First timer?
Looking for a feel of what _Divine.dotfiles_ offers?
Here’s a safe and fully removable way to acquaint yourself with the framework:

[source,bash]
----
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/install/insta\
ll.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif wget \
--version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> Erro\
r: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || { pr\
intf >&2 \"\n==> Error: failed to download installation script\n\"; rm -f \$TM\
P; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC)) && \
exit 3 || exit 0" bash --yes \
&& ~/.divine/intervene.sh attach essentials --yes \
&& ~/.divine/intervene.sh install --yes
----

This command: installs the framework without prompts; attaches the https://github.com/no-simpler/divine-bundle-essentials[`essentials`] bundle of Divine deployments to your Grail directory; installs the deployments.

Divine deployments *_never overwrite_* pre-existing files on your system without backing them up.
Everything that is backed up is *_automatically restored_* upon uninstallation.

After all installations are successful, *reload your shell/terminal*.
(On macOS, if the default shell has been changed, you have to re-log into the system.)

==== What it does

Once the bundle is fully installed, and the shell reloaded, _voilà_:

* You are greeted by https://sourceforge.net/projects/zsh[Zsh] as the default shell.
* Basic necessities, such as https://git-scm.com[Git], https://www.vim.org[Vim], and https://gnupg.org[GnuPG] are available.
* Both https://ohmyz.sh[oh-my-zsh] and https://github.com/Bash-it/bash-it[Bash-it] frameworks are now installed and loaded.
* A minimalistic theme for both shell frameworks is active.
* Opinionated configs are plugged in for Git, Vim, Bash, and Zsh.
* Overwritten files and installations are safely backed up or re-used.

All of the above is controlled and customized from your <<grail-directory,Grail directory>>:

[source]
----
~/.divine/grail/assets/
----

.Description of asset directories for the bundle `essentials`
[%noheader,cols="<.<a,<.<a",stripes=none]
|===

| `*bash-it*/` *&dagger;*
| Custom assets for https://github.com/Bash-it/bash-it[Bash-it] shell framework

| `*brewfile*/` *&dagger;*
| https://github.com/Homebrew/homebrew-bundle[Brewfile], maintained on macOS

| `*config-git*/`
| Global configuration for Git

| `*config-shell*/`
| Startup scripts (https://en.wikipedia.org/wiki/Run_commands[runcoms]) for Bash and Zsh

| `*config-vim*/`
| Global configuration for Vim

| `*home-dirs*/` *&dagger;*
| File `*home-dirs.cfg*` defines a sub-directory tree, to be maintained under the home directory

| `*oh-my-zsh*/` *&dagger;*
| Custom assets for https://ohmyz.sh[oh-my-zsh] shell framework

| `*portable-bin*/`
| Portable container for personal executables; this directory is maintained on the `$PATH`

|===

[.note]
[%noheader,cols="<.<a"]
|===
| Dagger *&dagger;* mark meaning: in order for the modifications in that asset directory to take effect, the deployment must be (re-)installed.
|===

==== Cleaning up

Yes, all of the above is fully removable.
Below are the separate 'undo' steps, in order:

[source,bash]
----
# Uninstall deployments:
~/.divine/intervene.sh remove --yes

# Detach Divine deployments from your Grail directory:
~/.divine/intervene.sh detach essentials --yes

# Erase the framework:
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/uninstall/uni\
nstall.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif w\
get --version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> \
Error: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || \
{ printf >&2 \"\n==> Error: failed to download uninstallation script\n\"; rm -\
f \$TMP; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC\
)) && exit 3 || exit 0" bash --yes
----

After the three 'undo' steps have successfully run, there is no trace of _Divine.dotfiles_ on your system.
[.small]#_(Sigh.)_#

== Framework structure

_Divine.dotfiles_ is installed, by default, to `~/.divine/`, and is contained entirely in that directory, except:

* Symlink to the framework's main executable is created somewhere on `$PATH`.
* Deployments may affect your system pretty much anywhere.

The framework itself consists of the following main parts:

.Framework structure
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++[#grail-directory]#`~/.divine/*grail*/`#+++</p>+++

*The Grail directory* houses user’s deployments, assets, and persistent settings.

If you settle on using _Divine.dotfiles_, it is recommended to take your Grail directory under version control and syncing it, e.g., via cloud services or Github.

Sub-structured as follows:

* `*assets*/` — Directory for user's assets, such as config files.
* `*dpls*/` — Directory for user's deployments.
* `*.stash.cfg*` — _Grail <<stash,stash>> entries maintained by the framework._
* `*.stash.cfg.md5*` — _Grail <<stash,stash>> integrity checksum maintained by the framework._

| +++<p align="center">+++[#state-directory]#`~/.divine/*state*/`#+++</p>+++

*The state directory* stores data on the current state of deployments on current machine.
_(Entire directory is maintained by the framework.)_

Sub-structured as follows:

* `*backups*/` — _Divine.dotfiles_ provides facilities to back up existing files from the system.
This directory stores such backups.
* `*bundles*/` — _Divine.dotfiles_ provides facilities to <<attach-routine,attach third-party bundles of deployments>> from Github.
This directory stores such deployments.
* `*stash*/` — _Divine.dotfiles_ provides a <<stash,persistent key-value store>> for use within deployments.
This directory houses key-value containers.

| +++<p align="center">+++[#lib-directory]#`~/.divine/*lib*/`#+++</p>+++

Guts of the framework, structured to the best of creator's ability.
_(Entire directory is, naturally, maintained by the framework.)_

| +++<p align="center">+++`~/.divine/*intervene.sh*`+++</p>+++

<<intervention-utility,*Divine intervention utility*>>, the command line interface to the framework.
_(File is maintained by the framework.)_

| +++<p align="center">+++`<a directory on $PATH>/*di*`+++</p>+++

Symlink to the intervention utility, providing an easy access.
This symlink is usually automatically created during framework installation.

|===

== Usage

[[intervention-utility]]
=== Divine intervention utility `di`

_Divine.dotfiles_ provides a command line interface via *Divine intervention utility `di`*.

Intervention utility's functions are:

. <<primary-routines,*Primary routines*>> on <<deployments,deployments>> and <<divinefiles,Divinefiles>>:
.. *Check* whether deployments are installed or not.
.. *Install* deployments.
.. *Remove* (uninstall) deployments.
. <<attach-routine,*Attach/detach*>> third-party bundles of deployments from Github.
. <<plug-routine,*Plug in*>> pre-made Grail directory from a repository or local directory.
. <<update-routine,*Update*>> framework itself, attached bundles, and Grail directory, if it is a cloned repository.

[.note]
[%noheader,cols="<.<a"]
|===
| The term '<<deployments,deployments>>' includes <<divinefiles,Divinefiles>> as a special kind.
|===

[[primary-routines]]
=== Checking/installing/removing deployments

Primary routines — the core of the framework — launch respective functions on deployments.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* *c*[*heck*]    [-ynqvew]  [-b *_BUNDLE_*]… [--] [*_NAME_*]…

$ *di* *i*[*nstall*]  [-ynqvewf] [-b *_BUNDLE_*]… [--] [*_NAME_*]…

$ *di* *r*[*emove*]   [-ynqvewf] [-b *_BUNDLE_*]… [--] [*_NAME_*]…
----

Accepted values of `*_NAME_*` are (case-insensitive):

* Names of <<deployments,deployments>>.
* Reserved synonyms for <<divinefiles,Divinefiles>>: `divinefile`, `dfile`, `df`.
* Single-digit names of <<deployment-groups,deployment groups>>: `0`, `1`, `2`, `3`, `4`, `5`, `6`, `7`, `8`, `9`.

==== Filtering deployments

The intervention utility filters the deployments according to these rules:

* Without any arguments, all deployments are processed.
* By default, deployments are retrieved from two locations (at any depth):
** Directory for user's deployments: `grail/dpls/`.
** Directory for attached bundles of deployments: `state/bundles/`.
* Particular deployments are requested by listing their names or <<deployment-groups,single-digit group names>>, in any combination.
* <<dangerous-deployments,Dangerous>> deployments are ignored unless requested by name (not by single-digit group name), or unless `--with-!`/`-w` option is used.
* Option `--except`/`-e` inverts filtering: all deployments are processed, _except_ those listed.
Note, that without any arguments, this is a no-opt.
+
In this mode, dangerous deployments are still filtered out by default.
* The search can be narrowed down to particular bundles of deployments by listing each with the `--bundle`/`-b` option.

After filtering, deployments and packages from Divinefiles are sorted in order of ascending <<deployment-priority,priority>>.
For uninstallation, that order is fully reversed.

==== Primary routine options

.Primary routine options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-y*`, `*--yes*`

Normally, framework prompts user right before sourcing each deployment script.
Other events — like offering an optional framework dependency — also trigger a prompt.

With this option, affirmative answer is assumed to every non-<<urgent-prompt,urgent>> prompt.

Note, that deployments are free to add any number of custom prompts unaffected by this option.

Access within deployments: `$D__OPT_ANSWER` (`true` / `false` / _empty_).

| `*-n*`, `*--no*`

With this option, negatory answer is assumed to every built-it prompt.
This option is equivalent to a 'dry run' — apart from skip messages, nothing will actually be done.

Access within deployments: `$D__OPT_ANSWER` (`true` / `false` / _empty_).

| [#bundle-option]#`*-b* *_BUNDLE_*`, `*--bundle* *_BUNDLE_*`#

[.gray]##_(repeatable)_## If at least one such option is provided, the search for deployments will be limited to the given <<attach-routine,attached bundles>> of deployments.
Accepted values of `*_BUNDLE_*` are the same as the <<accepted-repo-values,accepted values of `*_REPO_*`>> during attaching of bundles.

| `*-f*`, `*--force*`

By default, the framework does *not*:

* re-install deployments that appear already installed;
* uninstall deployments that appear already not installed;
* process deployments that appear installed by means other than this framework.

This option overrules such considerations.

Access within deployments: `$D__OPT_FORCE` (`true` / `false`).

| `*-e*`, `*--except*`

This option inverts the behavior of deployment filter: instead of processing only listed deployments, all deployments are processed _except_ listed.

Access within deployments: `$D__OPT_INVERSE` (`true` / `false`).

| `*-w*`, `*--with-!*`

By default framework ignores <<dangerous-deployments,dangerous deployments>> unless they are named explicitly.
This option disables such behavior.

Access within deployments: `$D__OPT_EXCLAM` (`true` / `false`).

| [#global-verbosity-level]#`*-v*`, `*--verbose*`#

_(repeatable)_
Gradually increase the amount of output.

Every instance of this option increments by one the *global verbosity level* of the framework.
The debug output in the deployments and the framework components has the *quiet level*.
For a message to be printed, the global verbosity level must be greater than or equal to that message's quiet level.

Currently, the maximum quiet level used across the framework is `4`.
Thus, launching the <<intervention-utility,intervention>> with the `-vvvv` options yields the most complete output.

Access within deployments: `$D__OPT_VERBOSITY` (non-negative integer).

| `*-q*`, `*--quiet*`

_(default)_
Reset the amount of output to the minimal level.

This option reverts the <<global-verbosity-level,global verbosity level>> to its defaul value of zero.

Access within deployments: `$D__OPT_VERBOSITY` (non-negative integer).

|===

[.note]
[%noheader,cols="<.<a"]
|===
| Even though every option above serves a function within the framework, it is also up to deployment authors to honor their semantics.
|===

[[attach-routine]]
=== Attaching third-party deployments

Beside using own deployments, _Divine.dotfiles_ allows you to attach (i.e., import) third-party *bundles* of deployments distributed via Github repositories.
A bundle is understood to group together one or more deployments.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* *a*[*ttach*] [-yn] [--] *_REPO_*…

$ *di* *d*[*etach*] [-yn] [--] *_REPO_*…
----

[#accepted-repo-values]#Accepted values of `*_REPO_*`# are (case-insensitive):

* Github repository in the form: `no-simpler/divine-bundle-essentials`.
* Specifically for Divine deployments, a shorthand is accepted:
+
[source,subs="verbatim,quotes,attributes"]
----
`*_NAME_*`  =>  `no-simpler/divine-bundle-*_NAME_*`
----
+
(To be a shorthand, `*_NAME_*` must match the RegEx pattern `^[0-9A-Za-z_.-]+$`.)

Detaching deployments deletes the copy of their repository, but it is up to you to:

* Uninstall the deployments beforehand (re-attach if you forgot).
* Remove any assets that might have been copied into your <<grail-directory,Grail>> assets directory.

[.note]
[%noheader,cols="<.<a"]
|===
| Attached bundles are cloned/downloaded into your <<state-directory,state directory>>, but _attachment records_ are stored in <<grail-directory,the Grail>>.
On every launch, intervention utility synchronizes Grail records with actual repositories in state directory.

Thus, by synchronizing Grail between machines, you will have the same set of both personal and attached deployments everywhere.
|===

==== Attach/detach routine options

.Attach/detach routine options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-y*`, `*--yes*`

Normally, framework prompts user right before cloning/downloading repository.
Other events — like offering an optional framework dependency — also trigger a prompt.

With this option, affirmative answer is assumed to every built-it prompt.

| `*-n*`, `*--no*`

With this option, negatory answer is assumed to every built-it prompt.
This option is equivalent to a 'dry run' — apart from skip messages, nothing will actually be done.

|===

[[plug-routine]]
=== Plugging the Grail

If you have a copy of your carefully crafted <<grail-directory,Grail directory>> stored somewhere, _Divine.dotfiles_ lets you easily plug it in.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* *p*[*lug*] [-ynl] [--] *_ADDRESS_*
----

Accepted values of `*_ADDRESS_*` are:

* Github repository in the form: `username/repo-name`.
* Path to a generic git repository.
* Path to a local directory.

Repositories are cloned, directories are copied.
Note, that existing Grail directory will be utterly destroyed in the process.

If provided argument can be interpreted in multiple ways, the framework will iterate over possible options in the order they are given above.

==== Plug routine options

.Plug routine options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-y*`, `*--yes*`

Normally, framework prompts user right before overwriting existing Grail directory.
Other events — like offering an optional framework dependency — also trigger a prompt.

With this option, affirmative answer is assumed to every built-it prompt.

If provided argument can be interpreted in multiple ways, the first viable interpretation will be silently settled upon.

| `*-n*`, `*--no*`

With this option, negatory answer is assumed to every built-it prompt.
This option is equivalent to a 'dry run' — apart from skip messages, nothing will actually be done.

| `*-l*`, `*--link*`

With this option, symlink is created to the directory, path to which is given, instead of copying it.
In this mode, given argument is not considered as a repository.

|===

[[update-routine]]
=== Updating framework and deployments

[source,subs="verbatim,quotes,attributes"]
----
$ *di* *u*[*pdate*] [-yn] [--] [*f*[*ramework*]] [*g*[*rail*]] [*d*[*eployments*]]
----

Update routine is three-pronged, and you are free to engage any and all of the prongs:

* `*f*` or `*framework*` — pulls latest revision of _Divine.dotfiles_.
* `*g*` or `*grail*` — pulls latest revision of <<grail-directory,Grail directory>>, _if_ it is a <<plug-routine,plugged>> repository.
* `*d*` or `*deployments*` — pulls latest revision of every <<attach-routine,_attached_>> bundle of deployments.
* Without any arguments, all of the above are performed.

==== Updating routine options

.Updating routine options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-y*`, `*--yes*`

Normally, framework prompts user right before pulling from remote repository.
Other events — like offering an optional framework dependency — also trigger a prompt.

With this option, affirmative answer is assumed to every built-it prompt.

| `*-n*`, `*--no*`

With this option, negatory answer is assumed to every built-it prompt.
This option is equivalent to a 'dry run' — apart from skip messages, nothing will actually be done.

|===

[[deployments]]
== Deployments

A _Divine.dotfiles_ *deployment* is a Bash script named in `*_DPL-NAME_*.dpl.sh` pattern.
`*_DPL_NAME_*` must be non-empty.

To be picked up by the framework, deployments must be located at any depth under two recognized deployment directories:

* `grail/dpls/` — user's deployments.
Create your deployments here.
* `state/bundles/` — attached third-party bundles of deployments.
This one is maintained by the framework.

=== Deployment structure

The minimal valid deployment is an empty file.
As such, it does nothing but appear in framework output.

Deployments are written in Bash syntax (with some limitations on metadata).
Each deployment is sourced by Bash interpreter no more than once per intervention routine.

A deployment is formed by:

* implementing specially named Bash functions (<<primary-functions,*primaries*>>);
* assigning to specially named variables (<<deployment-metadata,*metadata*>>).

[[primary-functions]]
=== Primary functions

*Primary functions*, or *primaries*, correspond to three fundamental actions performed upon a deployment:

* `d_dpl_check()` — checks whether deployment is installed or not.
* `d_dpl_install()` — installs deployment.
* `d_dpl_remove()` — uninstalls (reverses previous installation of) deployment.

This section includes semantic meanings behind primaries and their return codes.
Feel free to stretch semantic guidelines according to your particular use case.

[[func-dpl-check]]
==== Primary function `d_dpl_check()`

If this function is implemented, it will be called:

* During `check` routine — to determine status and show relevant output.
* During `install` routine — to determine whether installation is necessary/possible.
* During `remove` routine — to determine whether uninstallation is necessary/possible.

Return code of `d_dpl_check()` determines current status of the deployment:

.Supported return codes of `d_dpl_check()`
[%noheader,cols="<.<a",stripes=none]
|===

| `*0*`: *Unknown*

Meaning: no reliable way to tell whether this deployment is installed or not.

_This return code is assumed if `d_dpl_check()` is not implemented or if unsupported code is returned._

Routines that will proceed further:

* `install`
* `remove`

| `*1*`: *Installed*

Meaning: as it stands, intended goal of installing this deployment is entirely achieved.

Routines that will proceed further:

* `remove`

| `*2*`: *Not installed*

Meaning: as it stands, intended goal of installing this deployment is entirely not achieved.

Routines that will proceed further:

* `install`

| `*3*`: *Irrelevant*

Meaning: processing this deployment in current environment does not make sense.

This code is appropriate, for example, if current OS is unsupported.

None of the routines will proceed further.

| `*4*`: *Partly installed*

Meaning: as it stands, intended goal of installing this deployment is partly achieved and partly not achieved.

This code differs from 'Unknown' in semantics and output styling.

Routines that will proceed further:

* `install`
* `remove`

|===

[[func-dpl-install]]
==== Primary function `d_dpl_install()`

If this function is implemented, it will be called during `install` routine — to achieve the intended goal of this deployment.

Return code of `d_dpl_install()` determines output of `install` routine:

.Supported return codes of `d_dpl_install()`
[%noheader,cols="<.<a",stripes=none]
|===

| `*0*`: *Successfully installed*

Meaning: intended goal of installing this deployment is entirely achieved.

_This return code is assumed if `d_dpl_install()` is not implemented or if unsupported code is returned._

| `*1*`: *Failed to install*

Meaning: intended goal of installing this deployment is _not entirely_ achieved due to error.

| `*2*`: *Skipped*

Meaning: intended goal of installing this deployment is _entirely not_ achieved because nothing has been done.

| `*100*`: *Reboot needed*

Meaning: same as 'Successfully installed', except:

* Intervention will gracefully shut down without moving past this deployment.
* User will be asked to reboot the machine and resume afterward.

| `*101*`: *User attention needed*

Meaning: same as 'Successfully installed', except:

* Intervention will gracefully shut down without moving past this deployment.
* Deployment is expected to print explanation to `stderr`.

| `*102*`: *Critical failure*

Meaning: same as 'Failed to install', except:

* Intervention will shut down without moving past this deployment.
* Output will mention critical failure.

|===

[[func-dpl-remove]]
==== Primary function `d_dpl_remove()`

If this function is implemented, it will be called during `remove` routine — to reverse the effects of previously installing this deployment.

Return code of `d_dpl_remove()` determines output of `remove` routine:

.Supported return codes of `d_dpl_remove()`
[%noheader,cols="<.<a",stripes=none]
|===

| `*0*`: *Successfully uninstalled*

Meaning: effects of previously installing this deployment are entirely reversed.

_This return code is assumed if `d_dpl_remove()` is not implemented or if unsupported code is returned._

| `*1*`: *Failed to uninstall*

Meaning: effects of previously installing this deployment are _not entirely_ reversed due to error.

| `*2*`: *Skipped*

Meaning: effects of previously installing this deployment are _entirely not_ reversed because nothing has been done.

| `*100*`: *Reboot needed*

Meaning: same as 'Successfully uninstalled', except:

* Intervention will gracefully shut down without moving past this deployment.
* User will be asked to reboot the machine and resume afterward.

| `*101*`: *User attention needed*

Meaning: same as 'Successfully uninstalled', except:

* Intervention will gracefully shut down without moving past this deployment.
* Deployment is expected to print explanation to `stderr`.

| `*102*`: *Critical failure*

Meaning: same as uninstall', excep:

* Intervention will shut down without moving past this deployment.
* Output will mention critical failure.

|===

[.note]
[%noheader,cols="<.<a"]
|===
| It is worth noting that intended semantics of uninstallation are not direct inverse to that of installation.
Ideally, if no installation via the framework has previously occurred, uninstallation should do nothing.

This philosophy is followed by the magnificent https://github.com/no-simpler/divine-bundle-essentials[`essentials`] bundle of Divine deployments.
|===

[[deployment-metadata]]
=== Deployment metadata

*Deployment metadata* (posing as variable assignments) alter deployment's appearance and behavior:

* <<deployment-name-and-desc,`D_DPL_NAME`>> — explicit name for the deployment.
* <<deployment-name-and-desc,`D_DPL_DESC`>> — one-line description of the deployment.
* <<deployment-priority,`D_DPL_PRIORITY`>> — priority of the deployment (non-negative integer).
* <<deployment-flags,`D_DPL_FLAGS`>> — one-character flags, causing special treatment.
* <<deployment-warning,`D_DPL_WARNING`>> — one-line cautionary message about this deployment.

[.note]
[%noheader,cols="<.<a"]
|===
| Although all deployment metadata look like Bash variable assignments, they are in fact extracted from the file _before_ it is interpreted by Bash.

For each reserved 'variable' name, first line that looks like the usual Bash assignment is used.

With that in mind, follow these simple rules for deployment metadata:

* Write one 'assignment' per line, without line continuation.
* Do not use Bash substitutions or comments.
* Avoid leading and trailing whitespace, as well as whitespace around the `=`.
* Matching quotes around the value are allowed (they are stripped in the processing).
|===

[[deployment-name-and-desc]]
==== Deployment name and description

[source,bash]
----
D_DPL_NAME=example
D_DPL_DESC='Simple description that shows in deployment prompts'
----

While *description* is mostly cosmetic, deployment *name* is very important.
It is the single unique identifier for every deployment, and is used to invoke primary routines on it.
As such, the framework forbids having more than one deployment sharing a name.

If deployment name is not provided explicitly, file name is used instead, sans `.dpl.sh` suffix.
Deployment names are case insensitive.

[[deployment-priority]]
==== Deployment priority

[source,bash]
----
D_DPL_PRIORITY=420
----

Priority is the way to impose order on deployment processing.

During `check` and `install` routines, deployments are sorted in ascending order (smaller integer values go first).
During `uninstall` routine, the order is fully reversed.
Order of deployments with the same priority is undefined.

Priority must be a non-negative integer, otherwise it falls back to the default value of `4096`.

[[deployment-flags]]
==== Deployment flags

[source,bash]
----
D_DPL_FLAGS=ci!89
----

Flags alter some of the framework's behavior toward the deployment.

* A flag is a single non-whitespace character.
* Any number of flags can be put together in any order.
* Repeating a flag does not bear any additional significance.
* There is no way to unset a flag, apart from not setting it.
* Unsupported flags are silently ignored.

Below is the exhaustive rundown of supported flags and their effects.

.List of supported deployment flags
[%noheader,cols="<.<a",stripes=none]
|===

| [#deployment-groups]#`*[0-9]*`# _(any single digit)_

Assigns the deployment to one of the ten single-digit *groups*.
Groups of deployments may be processed together by referring to them by that group's digit in place of deployment name.

[.note]
[%noheader,cols="<.<a"]
!===
! A deployment may not have a single-digit name.
The framework guards against using reserved words as deployment names.
!===

| [#dangerous-deployments]#`*!*`# _(an exclamation mark)_

Marks the deployment as *dangerous*.
By default, framework ignores dangerous deployments unless they are listed by name or by name of their group.
Another way to include dangerous deployments is the `--with-!`/`-w` option on intervention utility.

| [#urgent-prompt]#`*[cira]*`# _(any of the four lowercase letters)_

Intervention utility has the `--yes`/`-y` option that effectively skips all normal prompts and confirmations.
It is possible to force the appearance of an *urgent prompt* before the deployment is sourced regardless of said option.
To do so, use any of these flags:

* `*c*` — always prompt during `**c**heck` routine.
* `*i*` — always prompt during `**i**nstall` routine.
* `*r*` — always prompt during `**r**emove` routine.
* `*a*` — **a**ll of the avove.

When a prompt is forced by a flag, it remains urgent even without `--yes` option.
Urgent prompts are styled to stand out a bit more in terminal.

|===

[[deployment-warning]]
==== Deployment warning

[source,bash]
----
D_DPL_WARNING="Warning for 'urgent' prompts forced by a flag"
----

If such warning is provided, it will accompany every <<urgent-prompt,urgent>> prompt enforced by a deployment flag.

[[divinefiles]]
== Divinefiles

A *Divinefile* is a special kind of deployment.
Its purpose is akin to that of https://github.com/Homebrew/homebrew-bundle[Brewfile] or https://bundler.io/gemfile.html[Gemfile].
A Divinefile is a manifest of system packages to be maintained using supported system package managers.

* A Divinefile must be named, well, `Divinefile`.
* There can absolutely be more than one — their contents are effectively merged.
* The framework picks up every Divinefile located at any depth under two recognized deployment directories:
** `grail/dpls/` — user's Divinefiles. Create yours here.
** `state/bundles/` — attached third-party Divinefiles.
* Divinefiles collectively are a deployment.

=== Divinefile usage

Divinefiles are automatically picked up by the framework along with other deployments.

Divinefiles are referred to with synonyms: `divinefile`, `dfile`, or `df`.
As with all deployment names, these are case insensitive.
Divinefiles are processed in their merged entirety or not processed at all.

[.note]
[%noheader,cols="<.<a"]
|===
| Yes, you also cannot name regular deployments `divinefile`, `dfile`, or `df`.
The framework guards against using reserved words as deployment names.
|===

You can assign deployment-style <<deployment-priority,*priorities*>> and <<deployment-flags,*flags*>> to individual packages within Divinefiles.
Packages are intertwined with regular deployments in a shared workflow.

[.note]
[%noheader,cols="<.<a"]
|===
| For more complex system package installations, e.g., involving particular versions or special package manager options, use regular deployments.
|===

=== Divinefile syntax

Divinefiles follow the general <<manifest-syntax,manifest syntax>>.

Every entry is a *list* of whitespace-separated names of packages.
Keys `flags` and `priority` set the respective attributes for the packages.
The priority works identically for packages in the same way as it does for <<deployment-priority,deployments>>.

The following flags are supported for packages.

.List of supported package flags
[%noheader,cols="<.<a",stripes=none]
|===

| [#urgent-prompt]#`*[ir]*`# _(any of the two lowercase letters)_

Intervention utility has the `--yes`/`-y` option that effectively skips all normal prompts and confirmations.
It is possible to force the appearance of an *urgent prompt* before the package is installed/removed regardless of said option.
To do so, use any of these flags:

* `*i*` — always prompt during `**i**nstall` routine.
* `*r*` — always prompt during `**r**emove` routine.

When a prompt is forced by a flag, it remains urgent even without `--yes` option.
Urgent prompts are styled to stand out a bit more in terminal.

|===

Within a line, each vertical bar `|` starts an *alt-list*, which fully overrides the original list for a particular package manager.
Within an alt-list, everything to the left of first colon `:` is read as package manager name; everything to the right — as the alt-list itself.

[.note]
[%noheader,cols="<.<a"]
|===
| Package manager name is matched against <<var-os-pkgmgr,`$D__OS_PKGMGR`>> built-in variable.
|===

.Example of Divinefile
[source]
----
git vim                 # Maintain git and vim with default priority (4096)


(priority:300)          # Set priority to 300 henceforth


(priority:500)  \       # Set priority to 500 for this line only
(r)             \       # Set flag 'prompt before removing' for this line only
node            \       # Maintain node
| apt-get: nodejs npm   # On apt-get, maintain nodejs and npm instead


(os:fedora) \           # Make this line exclusive to Fedora
util-linux-user         # Maintain util-linux-user with priority 300
----

== Advanced features

_Divine.dotfiles_ offers mechanisms that facilitate creation of better, stronger, faster deployments.

=== Deployment guidelines

A deployment file is interpreted by Bash no more than once per intervention.
Sourcing occurs as late as possible, after exhausting excuses to skip it.

A subshell is created for every deployment, shielding other deployments from it.

[.note]
[%noheader,cols="<.<a"]
|===
| Naturally, there is no way to prevent deployments from negatively affecting your system.
Deployments are free-form Bash scripts, and sandboxing them beyond a subshell would defeat their purpose.

If there is a voice of wisdom here, it says, 'Be careful.'
|===

It is good style to isolate all deployment logic within functions and global variables, and then call/use them within <<primary-functions,primary functions>>.

==== Naming convention

_Divine.dotfiles_ uses a naming convention in its own code:

* `*D_*` prefix — for names of global variables;
* `*d_*` prefix — for names of functions.

Whenever the framework does _not_ expect you to reassign a global variable or re-implement a function, the underscore is doubled:

* `*D__*` prefix — for names of read-only internal variables;
* `*d__*` prefix — for names of call-only internal functions.

[[divine-workflow]]
==== Divine workflow

The Divine workflow is the recommended way to organize Bash code within deployments.
The framework provides a set of functions that facilitate breaking down Bash code into meaningful blocks.
The goal here is to both annotate the code and automatically provide useful debug output.

Central to the idea of the Divine workflow is the concept of *workflow context*.
The workflow context is a stack (very similar to the function https://en.wikipedia.org/wiki/Call_stack[call stack]) that at any moment contains the hierarchy of tasks currently being performed.
An example of the context stack would look like this:

.Illustration of the Divine workflow context stack
====
[start=0]
. Running _Divine.dotfiles_ `install` routine.
. Installing deployments at priority `4096`.
. Deployment `example`.
+
---
. Executing a particular task within the deployment.
. Executing a sub-task.
====

The context stack starts at the root and grows down to arbitrary depth.
Context items are pushed and popped from the bottom.
*Notches* (represented by a horizontal line in the illustration) delimit logical layers and provide a way to quickly pop multiple items.

[[divine-workflow-guide]]
With the idea of context in mind, the Divine workflow boils down to the following principles:

* Everything should be written within Bash functions.
* There should be a function for every logical sub-routine.
* The workflow context should be maintained by calling <<func-context,`d{dus}context`>> at specific junctions:
** At the beginning of a <<primary-functions,primary function>> — `d{dus}context notch`.
** At the top of every sub-routine — `d{dus}context push`.
* Whenever a sub-routine needs to fail, two pathways are available:
** Critical commands should be enwrapped in <<func-cmd,`d{dus}cmd`>>, <<func-pipe,`d{dus}pipe`>>, or <<func-require,`d{dus}require`>>.
** 'Manual' failures should be orchestrated via <<func-fail,`d{dus}fail`>>.
* To interact with the user along the way:
** Non-failure alerts should be delivered via <<func-notify,`d{dus}notify`>>.
** Prompts that include information on current workflow context can be initiated via <<func-prompt,`d{dus}prompt`>>.
* <<func-context,`d{dus}context`>> should again be used to wrap things up:
** Before successfully returning from a sub-routine — `d{dus}context pop`.
** Before successfully returning from a <<primary-functions,primary function>> — `d{dus}context lop`.

.Illustration of the Divine workflow
[source,bash]
----
# grail/dpls/example.dpl.sh

d__dpl_install()
{
  d__context notch          # mark beginning of primary
  
  perform_task || return 1  # do the work

  d__context lop            # lop off everything down to and including the notch
  return 0
}

perform_task()
{
  d__context push 'Performing task'

  perform_sub_task || return 1

  d__context pop
  return 0
}

perform_sub_task()
{
  d__context push 'Performing sub-task'

  d__require [ --THIS-- "$this_number" -eq --THAT-- "$that_number" ] \
    --else-- 'Refusing to proceed' \
    || return 1

  d__notify --loud --context-head --title Attention -- 'Sub-task done'

  d__context pop
  return 0
}
----

.Example of success output from the illustration of the Divine workflow above
[source,subs="verbatim,quotes,attributes"]
----
[.yellow]#*==>*# *Attention:* Sub-task done
    *Context:* Performing task
             Performing sub-task
----

.Example of failure output from the illustration of the Divine workflow above
[source,subs="verbatim,quotes,attributes"]
----
[.red]#*==>*# *Command failed:* [ *THIS* -eq *THAT* ]
        *THIS:* '0'
        *THAT:* '1'
    *Context:* Performing task
             Performing sub-task
    *Result:* Refusing to proceed
----

=== Variables available to deployments

.List of variables available/recognized in each deployment
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| <<deployment-metadata,Deployment metadata>>

| `*D_DPL_NAME*`

Explicit name for the deployment.

This variable will be non-empty even if there is no assignment within the file.

| `*D_DPL_DESC*`

One-line description of the deployment.

| `*D_DPL_PRIORITY*`

Priority of the deployment (non-negative integer).

This variable will be non-empty even if there is no assignment within the file.

| `*D_DPL_FLAGS*`

One-character flags, causing special treatment.

| `*D_DPL_WARNING*`

One-line cautionary message about this deployment.

^.^h| Special directory paths

| [#var-dpl-dir]#`*D__DPL_DIR*`#

Absolute path to directory containing `*.dpl.sh` file.

| [#var-dpl-asset-dir]#`*D__DPL_ASSET_DIR*`#

Generated absolute path to directory assigned to hold assets of current deployment.

Located within <<grail-directory,the Grail>>, specifically `grail/assets/*_D_DPL_NAME_*/`.

| [#var-dpl-backup-dir]#`*D__DPL_BACKUP_DIR*`*_`#_*`


Generated absolute path to directory assigned to hold backups of current deployment.
Located within <<state-directory
state directory>>, specifically `stat`/backup
`*`
^.^`| Special file 

| [#var-dpl-sh-path]#`*D_
DPL_SH_PATH*`#

Absolute path `*_to_*` `*.dpl.sh` fil<func-pop-backup,<e`>>.

`

| [#var-dpl-mnf-path]#`*D__DPL_MNF_PATH*`#

Generated absolute path to asset manifest of current deployment.
This path does not necessarily exist.

Same as `*_D__DPL_SH_PATH_*`, but with suffix changed to `*.dpl.mnf`.

[.note]
[%noheader,cols="<.<a"]
!===
! Asset manifests are also processed by routines that don't source deployments.

Thus, path to asset manifest is locked, and this variable is read-only.
!===

| [#var-dpl-que-path]#`*D_DPL_QUE_PATH*`#

Generated absolute path to queue manifest of current deployment.
This path does not necessarily exist.

Same as `*_D__DPL_SH_PATH_*`, but with suffix changed to `*.dpl.que`.

[.note]
[%noheader,cols="<.<a"]
!===
! Queue manifests are processed only after sourcing their deployment file.

Thus, you are free to adjust this path at the top level of deployment script.
!===

^.^h| [#detected-os]#Detected operating system (OS)#

| [#var-os-family]#`*D__OS_FAMILY*`#

Broad description of current OS.

Exhaustive list of possible values:

* `bsd` — https://en.wikipedia.org/wiki/List_of_BSD_operating_systems[BSD descendants]
* `cygwin` — https://en.wikipedia.org/wiki/Cygwin[Cygwin]
* `linux` — https://en.wikipedia.org/wiki/Linux[Linux]
* `macos` — https://en.wikipedia.org/wiki/MacOS[macOS]
* `msys` — https://en.wikipedia.org/wiki/MinGW[Minimalist GNU for Windows]
* `solaris` — https://en.wikipedia.org/wiki/Solaris_(operating_system)[Oracle Solaris]
* `wsl` — https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux[Windows Subsystem for Linux]

[.note]
[%noheader,cols="<.<a"]
!===
! Note that `linux` and `wsl` are separate entries.
Check for both to determine whether currently under modern Linux, e.g.:

[source,bash,subs="verbatim,attributes"]
----
case $D__OS_FAMILY in
  linux{vbar}wsl)   echo linux;;
  *)           echo other;;
esac
----

!===

| [#var-os-distro]#`*D__OS_DISTRO*`#

Best guess on the name of the current OS distribution.

Exhaustive list of possible values:

* `debian`
* `fedora`
* `freebsd`
* `macos`
* `ubuntu`
* _empty_ — failed to reliably detect a supported distribution

[.note]
[%noheader,cols="<.<a"]
!===
! This list is incomplete; you can help by <<contributing-os-support,expanding it>>.
!===

| [#var-os-pkgmgr]#`*D__OS_PKGMGR*`#

Name of supported system package manager available on current system.

Exhaustive list of possible values:

* `apt-get`
* `brew`
* `dnf`
* `pkg`
* `yum`
* _empty_ — failed to reliably detect a supported package manager

[.note]
[%noheader,cols="<.<a"]
!===
! This list is incomplete; you can help by <<contributing-os-support,expanding it>>.
!===

When this variable is non-empty, you also have the built-in <<func-os-pkgmgr,package manager wrapper>>, `d__os_pkgmgr()`, at your disposal.

^.^h| [#marker-vars]#Marker variables in <<func-dpl-check,check>> primary#

| [#var-another-prompt]#`*D_DPL_NEEDS_ANOTHER_PROMPT*`#

Set this variable to `true` to trigger an <<urgent-prompt,urgent prompt>> before the framework proceeds to (un)installation.

_Works only during `install`/`remove` <<primary-routines,routines>> and only if set within <<func-dpl-check,check>> primary._

| [#var-another-warning]#`*D_DPL_NEEDS_ANOTHER_WARNING*`#

If `$D_DPL_NEEDS_ANOTHER_PROMPT` is set to `true` and this variable is non-empty, then its content is shown to the user as textual warning.

_Works only during `install`/`remove` <<primary-routines,routines>> and only if set within <<func-dpl-check,check>> primary._

| [#var-user-or-os]#`*D_DPL_INSTALLED_BY_USER_OR_OS*`#

Set this variable to `true` to signal to the framework: whatever parts of current deployment are installed, have been installed by other methods, not by this framework.

_Works only if set within check primary._
_Value of `true` is preserved into install/remove primaries, even in <<multitask,multitask>> sub-primaries._

This affects behavior of the following return codes of <<func-dpl-check,`d_dpl_check`>>:

* `1` ('installed') — prohibits uninstalling;
* `4` ('partly installed') — prohibits uninstalling.

[.note]
[%noheader,cols="<.<a"]
!===
! This is useful for deployments designed to not interfere with manual tinkering.
!===

^.^h| Check code in <<func-dpl-install,install>>/<<func-dpl-remove,remove>> primaries

| [#var-check-code]#`*D__DPL_CHECK_CODE*`#

Within install/remove primaries, this variable contains the code returned by their respective check primary.
This is also the case within <<multitask,multitask>> sub-primaries.

^.^h| Parameters of current request

| `*D__REQ_ROUTINE*`

Name of <<primary-routines,primary routine>> currently being executed:

* `check`
* `install`
* `remove`

| `*D__OPT_FORCE*`

Whether `-f` / `--force` option is provided:

* `true`
* `false`

| [#var-opt-verbosity]#`*D__OPT_VERBOSITY*`#

Represent the current <<global-verbosity-level,global verbosity level>>.
The value is a non-negative integer, where zero stands for the minimal verbosity.

| `*D__OPT_EXCLAM*`

Whether `-w` / `--with-!` option is provided to process <<dangerous-deployments,dangerous>> deployments:

* `true`
* `false`

| `*D__OPT_ANSWER*`

Which blanket answer is provided last.
This affects all non-<<urgent-prompt,urgent>> built-in prompts.

* `true` — affirmative answer is provided
* `false` — negatory answer is provided
* _empty_ — no blanket answer is provided

|===

=== Functions available to deployments

[[func-context]]
==== Function `d{dus}context`

The function `d{dus}context` manipulates the current Divine <<divine-workflow,workflow>> context stack.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}context* [-lnq] [-t *_TITLE_*] [--] *push*|*pop*|*notch*|*lop* *_DESCRIPTION_*...
----

The `push` and `pop` operations add and remove context items from below, respectively.
The `notch` operation places an invisible mark at the tip of the stack.
The `lop` operation repeatedly executes a `pop` until the next notch (or root) is reached, and then removes that notch.

Any number of notches can be made, as long as they are not duplicated (at the same position).
Within the context stack, the latest pushed item is called the *tip*, and the items pushed after the latest notch are called the *head*.

Most stack manipulations trigger a debug message that honors the <<global-verbosity-level,global verbosity level>>, as stored in <<var-opt-verbosity,`$D{dus}OPT_VERBOSITY`>>.
If a `push` is prepended to every logical unit of code, and then a matching `pop` is appended at the end, a useful pattern of breadcrumbs arises in the debug output.
Other Divine workflow utilities (<<func-notify,`d{dus}notify`>>, <<func-prompt,`d{dus}prompt`>>, <<func-fail,`d{dus}fail`>>, <<func-cmd,`d{dus}cmd`>>, <<func-pipe,`d{dus}pipe`>>, <<func-require,`d{dus}require`>>) may include the state of the context stack in their output.

Each item on the context stack must be given a `*_DESCRIPTION_*`.
As a matter of good style, the `*_DESCRIPTION_*` should be worded around either a noun or a verb in its -ing form (gerund).
Repetition of information from above levels should be minimized.

Returns:

* `0` — Stack modified as requested.
* `1` — Stack not modified: no arguments or unrecognized first argument.
* `2` — Stack not modified: pushing without a `*_DESCRIPTION_*`.
* `3` — Stack not modified: popping from an empty stack.
* `4` — Stack not modified: notching at the same position.

.List of `d{dus}context` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom title for the debug message.
All operations have default titles; these are shown in the illustration below in *bold*:

[source,subs="verbatim,quotes,attributes"]
----
# Pushing an item
==> *Start*: Description of the context item

# Popping an item
==> *End*: Description of the context item

# Making a notch
==> *Notched*: At position X

# Removing a notch
==> *De-notched*: At position X
----

| `*-n*`, `*--newline*`

With this option, if this function produces any output, an extra newline is prepended to it.

^.^h| Quiet options

| *Quiet options* designate the *quiet level* for the current call.
Changes to context are announced only if the <<global-verbosity-level,global verbosity level>> is greater than or equal to the quiet level.

Quiet options are read sequentially, left-to-right, and the quiet level starts at zero.
However, if these options are not given at all, the default quiet levels per operation are:

* `*push*` — `2`
* `*pop*` — `3`
* `*notch*` — `4`
* `*lop*` — `4`
+
The default quiet level for the `lop` operation includes the underlying `pop` operations.
For the pops to be performed at a different quiet level, they must be initiated separately.

| `*-q*`, `*--quiet*`

_(repeatable)_
Increments the quiet level by one.

| `*-l*`, `*--loud*`

Sets the quiet level to zero.

^.^h| Styling options (one active at a time, last option wins)

| *Styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

In all modes titles are formatted in *bold*.

| `*-d*`, `*--debug*`

_(default)_
Colors the entire output in cyan.

| `*-!*`, `*--alert*`

Colors the introductory arrow in yellow.

| `*-v*`, `*--success*`

Colors the introductory arrow in green.

| `*-x*`, `*--failure*`

Colors the introductory arrow in red.

| `*-s*`, `*--skip*`

Colors the introductory arrow in white.

|===

[[func-notify]]
==== Function `d{dus}notify`

The function `d{dus}notify` conveys any information to the user and does not produce any side effects.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}notify* [-!1cdhlnqsuvx] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Whether the output is printed depends on the <<global-verbosity-level,global verbosity level>>, as stored in <<var-opt-verbosity,`$D{dus}OPT_VERBOSITY`>>.

Returns:

* `0` — Always.

.The layout of the output of `d{dus}notify` (without any arguments)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*
----

.The layout of the output of `d{dus}notify` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
----

* `*_TITLE_*` — _(optional)_ Short heading for the notification.
Defaults to:
** Without a `*_DESCRIPTION_*` — omitted.
** With a `*_DESCRIPTION_*` — `Generic alert`.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the notification.
* `*_CONTEXT_*` — _(optional)_ Some part of the context stack, as requested by any of the relevant options.
The entire context block is omitted if the context stack is not requested or is empty.

.List of `d{dus}notify` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-u*`, `*--sudo*`

Print the notification only if the caller lacks the `sudo` privilege.
Automatically makes the notification `--loud`.
Also, automatically sets the `*_TITLE_*` to `Password prompt` and the `*_DESCRIPTION_*` to `The upcoming command requires sudo privileges.`, unless these parts are already set.

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom title for the notification.

Without this option, the `*_TITLE_*` defaults to:

** Without a `*_DESCRIPTION_*` — omitted.
** With a `*_DESCRIPTION_*` — `Generic alert`.

| `*-n*`, `*--newline*`

With this option, if this function produces any output, an extra newline is prepended to it.

^.^h| Quiet options

| *Quiet options* designate the *quiet level* for the current call.
The notification is printed only if the <<global-verbosity-level,global verbosity level>> is greater than or equal to the quiet level.

Quiet options are read sequentially, left-to-right, and the quiet level starts at zero.
However, if these options are not given at all, the default quiet level is `1`.

| `*-q*`, `*--quiet*`

_(repeatable)_
Increments the quiet level by one.

| `*-l*`, `*--loud*`

Sets the quiet level to zero.

^.^h| Context-related options (one active at a time, last option wins)

| `*-c*`, `*--context-all*`

Includes the entire workflow context stack in the output.

| `*-h*`, `*--context-head*`

Includes the head of the workflow context stack (the items pushed since the last notch) in the output.

| `*-1*`, `*--context-tip*`

Includes the tip of the workflow context stack (the last pushed item) in the output.

^.^h| Styling options (one active at a time, last option wins)

| *Styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

In all modes titles are formatted in *bold*.

| `*-d*`, `*--debug*`

_(default)_
Colors the entire output in cyan.

| `*-!*`, `*--alert*`

Colors the introductory arrow in yellow.

| `*-v*`, `*--success*`

Colors the introductory arrow in green.

| `*-x*`, `*--failure*`

Colors the introductory arrow in red.

| `*-s*`, `*--skip*`

Colors the introductory arrow in white.

^.^h| Special formatting para-options (work only after the option-argument separator `--`)

| Para-options are shorthand for things like linebreaks, indentation, and bold titles.

| `*-t-*`

This para-option treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
That `WORD` is then styled as a title and is followed by a colon.

| `*-n-*`

This para-option inserts a newline followed by the arrow-width indentation (four spaces).

| `*-i-*`

This para-option is similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-prompt]]
==== Function `d{dus}prompt`

The function `d{dus}prompt` is the preferred user-prompting mechanism.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}prompt* [-!1bchknqsvxy] [-p *_PROMPT_*] [-a *_ANSWER_*] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Two prompting modes are supported:

* Decision prompt (yes or no): returns `0` for the affirmative answer and `1` for the negatory answer.
* Any key prompt: returns `0` for any key press.

If the option `--or-quit` is used, both modes return `2` whenever the user chooses to quit.

.The layout of the output of `d{dus}prompt` (without any arguments)
[source,subs="verbatim,quotes,attributes"]
----
*_PROMPT_* *_KEYS_*
----

.The layout of the output of `d{dus}prompt` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
    *_PROMPT_* *_KEYS_*
----

If the prompt contains no optional parts, it is considered a one-liner, and the introductory arrow is omitted.

* `*_PROMPT_*` — Short conclusion for the prompt. Defaults to `Proceed?`.
* `*_KEYS_*` — Short explanation of accepted key presses:
** Decision prompt: `[y/n]`
** Decision prompt (with `--or-quit`): `[y/n/q]`
** Any key prompt: `[<any key>]`
** Any key prompt (with `--or-quit`): `[<any key>/q]`
* `*_TITLE_*` — _(optional)_ Short heading for the prompt.
If the `*_DECSRIPTION_*` is empty and if the prompt is not a one-liner, defaults to `User attention required`.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the prompt.
* `*_CONTEXT_*` — _(optional)_ Some part of the context stack, as requested by any of the relevant options.
The entire context block is omitted if the context stack is not requested or is empty.

.List of `d{dus}prompt` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom `*_TITLE_*` for the leading line.

Without this option:

* If the `*_DESCRIPTION_*` is provided, the title is omitted.
* If the `*_DESCRIPTION_*` is not provided, the title defaults to `User attention required`.

| `*-p* *_PROMPT_*`, `*--prompt* *_PROMPT_*`

Sets custom `*_PROMPT_*`.
Without this option, the `*_PROMPT_*` defaults to `Proceed?`.

| `*-a* *_ANSWER_*`, `*--answer* *_ANSWER_*`

Provides an opportunity to skip the prompt if the value of `*_ANSWER_*` is either `true` or `false`.

In the decision mode:

* If `*_ANSWER_*` is `true`, returns 0.
* If `*_ANSWER_*` is `false`, returns 1.
* Otherwise, proceeds with prompting.

In the any-key mode:

* If `*_ANSWER_*` is either `true` or `false`, returns 0.
* Otherwise, proceeds with prompting.

| `*-q*`, `*--or-quit*`

In both prompting modes, provides an extra option: 'quit'.
The returned value for the 'quit' option is always `2`.

^.^h| Prompting modes (one active at a time, last option wins)

| `*-y*`, `*--yes-no*`

_(default)_
Prompts for a yes/no decision.

| `*-k*`, `*--any-key*`

Prompts for any key press.

| `*-n*`, `*--newline*`

With this option, if this function produces any output, an extra newline is prepended to it.

^.^h| Context-related options (one active at a time, last option wins)

| `*-c*`, `*--context-all*`

Includes the entire workflow context stack in the output.

| `*-h*`, `*--context-head*`

Includes the head of the workflow context stack (the items pushed since the last notch) in the output.

| `*-1*`, `*--context-tip*`

Includes the tip of the workflow context stack (the last pushed item) in the output.

^.^h| Styling options (one active at a time, last option wins)

| *Styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

In all modes titles are formatted in *bold*.

| `*-!*`, `*--alert*`

_(default)_
Colors the introductory arrow and the `*_PROMPT_*` in yellow.

| `*-v*`, `*--success*`

Colors the introductory arrow and the `*_PROMPT_*` in green.

| `*-x*`, `*--failure*`

Colors the introductory arrow and the `*_PROMPT_*` in red.

| `*-s*`, `*--skip*`

Colors the introductory arrow and the `*_PROMPT_*` in white.

| `*-b*`, `*--bare*`

Removes coloring completely.

| Para-options are shorthand for things like linebreaks, indentation, and bold titles.

| `*-t-*`

This para-option treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
That `WORD` is then styled as a title and is followed by a colon.

| `*-n-*`

This para-option inserts a newline followed by the arrow-width indentation (four spaces).

| `*-i-*`

This para-option is similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-fail]]
==== Function `d{dus}fail`

The function `d{dus}fail` announces a failure to the user and pops every item in the workflow context down to and including the latest notch (or the root of the stack).
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}fail* [-n] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

As mentioned, every call to this function includes a call to `d{dus}context lop`.
Thus, this function should not be used for non-consequential failures that do not affect the workflow context.
(For such things, `d{dus}notify --failure` works nicely.)

Returns:

* `0` — Always, as in 'failed successfully'.

.The layout of the output of `d{dus}fail` (without any arguments and with empty context stack)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*
----

.The layout of the output of `d{dus}fail` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
----

* `*_TITLE_*` — _(optional)_ Short heading for the failure.
Defaults to:
** Without a `*_DESCRIPTION_*` — `Failure`.
** With a `*_DESCRIPTION_*` — `Something went wrong`.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the failure.
* `*_CONTEXT_*` — The head of the context stack, which is about to be lopped off.
The entire context block is omitted if the context stack is empty.

.List of `d{dus}fail` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom title for the failure.

Without this option, the `*_TITLE_*` defaults to:

* Without a `*_DESCRIPTION_*` — `Failure`.
* With a `*_DESCRIPTION_*` — `Something went wrong`.

| `*-n*`, `*--newline*`

With this option, an extra newline is prepended to all output.

| Para-options are shorthand for things like linebreaks, indentation, and bold titles.

| `*-t-*`

This para-option treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
That `WORD` is then styled as a title and is followed by a colon.

| `*-n-*`

This para-option inserts a newline followed by the arrow-width indentation (four spaces).

| `*-i-*`

This para-option is similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-cmd]]
==== Function `d{dus}cmd`

The function `d{dus}cmd` is a wrapper around a single simple Bash command.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}cmd* [_options_] [----] *_CMD_*...
----

Executes the command `*_CMD_*` as normal, then inspects its return code.
If the return code is non-zero, prints a failure message (similar to the output of <<func-fail,`d__fail`>> in appearance), and then pops every item in the workflow context down to and including the latest notch (or root).
The output is titled, by default, 'Command failed', and shows the command that has failed, along with the current context stack.

The command `*_CMD_*` must be a single simple command, consisting of any number of ``WORD``s.
Naturally, Bash will parse the arguments to this function they trickle down to the underlying command.
As such, here are some examples of what the `*_CMD_*` can and cannot contain:

* Yes: Simple commands, including `test`, `[`, or `[[`.
* Yes: Variable expansions, though keep in mind that they will be expanded before the actual command is interpreted.
* Yes: Input redirections.
* Maybe:  Output redirections. (They will affect this outer function which might just do exactly what is needed.)
* *NO*: Operators `&&` and `||` (use <<func-require,`d__require`>>).
* *NO*: Pipes (use <<func-pipe,`d__pipe`>>).
* *NO*: Negation operator `!` (use the `--neg--` option).
* *NO*: Constructs such as `if` or `case`.
* *NO*: Arithmetic context.

Returns:

* `0` — The `*_CMD_*` returned zero (after optional negation).
* `1` — Otherwise.
* `2` — Called without arguments.

.The layout of the output of `d{dus}cmd` in case of failure (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_CMD_*
        *_LABEL-0_*: *_WORD-0_*
        *_LABEL-1_*: *_WORD-1_*
        ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
    Circumstances: *_CRCM_*
    Result: *_RSLT_*
----

* `*_TITLE_*` — Short heading for the failure.
Defaults to `Command failed`.
* `*_CMD_*` — The command that failed, with labels pasted in.
* `*_LABEL_*` — _(optional)_ The list of labels and their disambiguations.
Labels are created via corresponding options, described below.
* `*_CONTEXT_*` — The head of the context stack, which is about to be lopped off.
The entire context block is omitted if the context stack is empty.
* `*_CRCM_*` — _(optional)_ The description of circumstances of the command call, if provided by the caller.
* `*_RSLT_*` — _(optional)_ The description of consequences of the command failure, if provided by the caller.

.List of `d{dus}cmd` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*----*`

Stops processing options for the 'outer' function, and reads the rest of the arguments as parts of the `*_CMD_*`.

| `*--neg--*`

Negates the return code of the `*_CMD_*`, as if it is prepended with a `!` operator.

^.^h| Output suppression modes (one active at a time, last option wins)

| `*--sn--*`

Suppresses neither `stdout` nor `stderr` of the `*_CMD_*`.

| `*--so--*`

Suppresses `stdout` of the `*_CMD_*`.

| `*--se--*`

_(default)_
Suppresses `stderr` of the `*_CMD_*`.

| `*--sb--*`

Suppresses both `stdout` and `stderr` of the `*_CMD_*`.

^.^h| Quiet options

| *Quiet options* designate the *quiet level* for the current call.
The non-suppressed output of the underlying command is printed only if the <<global-verbosity-level,global verbosity level>> is greater than or equal to the quiet level.

Quiet options are read sequentially, left-to-right, and the quiet level starts at zero.
If these options are not given at all, the default quiet level is also zero.

Normally, the quiet level does not affect the failure output.

| `*--q--*`, `*--q…--*`

_(repeatable)_
Increments the quiet level by one.

This particular option can be repeated within the hyphens, e.g., `--qqq--`.
It should be noted, that only the first character is checked to be 'q', the others are simply counted.

| `*--l--*`

Sets the quiet level to zero.

^.^h| Semantics of failure

| `*--opt--*`

Makes the `*_CMD_*` optional: if there is a failure, the head of the context stacked is not lopped off, and the failure output is styled less urgently.

When a command is marked optional, its failure output is printed depending on the quiet level.

| `*--alrt--* *_TITLE_*`

Sets the custom title for the failure output.

| `*--crcm--* *_CRCM_*`

Sets the custom circumstances description for the failure output.

| `*--else--* *_RSLT_*`

Sets the custom consequences description for the failure output.

^.^h| Label options (each must preceed the single `WORD` of the `*_CMD_*`)

| `*--_LABEL_--*`

Normally d__fail outputs the offending `*_CMD_*` in its entirety, which can get quite lengthy.
When a `WORD` of the `*_CMD_*` is prepended with a label option, the label is shown in the failure output instead of the actual `WORD`.
Then, after `*_CMD_*` is printed, each label is also printed on its own line, accompanied by the `WORD` that it stands for.
This is similar to footnotes.

| `*--#_NUM_--*`

A previously assigned label may be re-used if the `WORD` is repeated within the `*_CMD_*` multiple times.
Labels are automatically numbered, starting from zero: use the label number prepended with a hash/pound `#`` to reference a previous label.
Make sure that you assign such backreferences to ``WORD``s that are actually identical.

|===

[[func-pipe]]
==== Function `d{dus}pipe`

This function extends <<func-cmd,`d{dus}cmd`>>, and thus its reference applies fully wherever not overridden by this section.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}pipe* [_options_] [----] *_CMD_*...
----

The function `d{dus}pipe` extends `d{dus}cmd` by adding the possibility to chain up to three commands in a continuous Bash pipe.
Note, that the actual pipe operator `|` cannot be used directly, because it would affect this function and not get passed down.
Instead, the special pipe option is added.

When this function is used without the special options, `d{dus}pipe` becomes functionally identical to `d{dus}cmd`.
The intention of two different functions is to underscore semantics and to lighten up the load of parsing arguments in `d{dus}cmd`.

All `d{dus}cmd` options are supported.
If the `--so--` or the `--sb--` option is used, `stdout` is only suppressed for the last command in the queue; otherwise it would defeat the pipe's purpose.

.List of `d{dus}pipe` options (on top of those in `d{dus}cmd`)
[%noheader,cols="<.<a",stripes=none]
|===

| `*--p--*`, `*--P--*`, `*--pipe--*`

Inserts Bash's `\|` operator at that location.
Only first two instances of this option are recognized.

| `*--ret__NUM__--*`

Normally, the return code of the last command in the pipe is inspected to make judgement on whether the whole command ran successfully.
To change which command's return code represents the success of the pipe, its number must be provided with this option.
Commands in the pipe are numbered starting from zero, left to right.

|===

[[func-require]]
==== Function `d{dus}require`

This function extends <<func-cmd,`d{dus}cmd`>>, and thus its reference applies fully wherever not overridden by this section.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}require* [_options_] [----] *_CMD_*...
----

Firstly, `d{dus}require` changes semantics a little: while `d{dus}cmd` is intended to be used on commands that perform an action that produces side effects, this version is intended for checks/tests that ensure that certain requirements are met.
As such, `d{dus}require` sets the title of potential `d{dus}fail` message to `Requirement failed` instead of the default `Command failed`.

Secondly, `d{dus}require` extends `d{dus}cmd` by adding the possibility to chain up to three commands with Bash's `&&` and `||` operators.
Note, that the actual and/or operators cannot be used directly, because they would affect this function and not get passed down.
Instead, the special options are added.

Otherwise, `d{dus}require` is functionally identical to `d{dus}cmd`.
The intention of two different functions is to underscore semantics and to lighten up the load of parsing arguments in `d{dus}cmd`.

All `d{dus}cmd` options are supported.
The option `--neg--` applies to individual commands within the and/or chain; it has to be used for every negated requirement at any time before the start of the next requirement.

.List of `d{dus}require` options (on top of those in `d{dus}cmd`)
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| And/or options (only the first two are recognized)

| `*--and--*`, `*--AND--*`

Inserts Bash's `&&` operator at that location.

| `*--or--*`, `*--OR--*`

Inserts Bash's `\|\|` operator at that location.

|===

[[func-dmd5]]
==== `dmd5` function

Function `dmd5` provides a cross-platform way of calculating an md5 checksum of a file or a string.

It relies on at least one of the following utilities being available in the system: `md5sum` or `md5` or `openssl`.

[source,subs="verbatim,quotes,attributes"]
----
*dmd5* [-s *_STRING_*] | [*_PATH_*]
----

* One checksum is calculated per call.
* Either a string or a path to a file may be given.
* It is up to you to ensure that path exists and is readable.
* Checksum is printed to `stdout`.

Returns zero on success and non-zero if something goes wrong.

==== Function `d{dus}stash`

Function `d{dus}stash` is so important that it deserved its <<stash,own section>>.

[[func-push-backup]]
==== Function `d__push_backup`

The function `d{dus}push_backup` vacates the given path by pushing whatever exists at it to a backup location.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}push_backup* [--] *_ORIG_PATH_* [*_BACKUP_PATH_*]
----

This function ensures that the `*_ORIG_PATH_*` becomes empty, and if anything exists there currently, it is backed up.
Thus, if the `*_ORIG_PATH_*` sits empty, a success code is immediately returned.

For the backup path, the first available strategy is employed:

* If a BACKUP_PATH is given, it is used.
If it turns out unusable, further strategies are not tried; an error code is returned instead.
* If called from a deployment, the backup is placed into <<var-dpl-backup-dir,`$D__DPL_BACKUP_DIR`>>, and the backup file name is generated by concatenating two parts:
** the md5 checksum of the `*_ORIG_PATH_*`;
** the suffix `.bak`.
* If none of the above works, an error code is returned.

If the generated backup path happens to be occupied, it is understood to be a previously made backup.
Previous backups are never overwritten.
Instead, this function repeatedly appends an incrementing numerical suffix (`-1`, `-2`, etc.) to the backup file name until it finds a path that is not yet occupied, and that path is then used.
The suffixes are hard capped at 1000.

This function always ensures the existence of the directory that is the immediate parent of the `*_ORIG_PATH_*` and of the generated backup path.

This function is intended to be used in conjunction with <<func-pop-backup,`d__pop_backup`>>.

Returns:

* `0` — The `*_ORIG_PATH_*` has been made empty; and if anything existed there, it has been backed up.
* `1` — The `*_ORIG_PATH_*` exists, but is inaccessible.
* `2` — The backup path, whatever it is, is inaccessible or invalid.
* `3` — Other unexpected error.

The function `d__push_backup` does not have any supported options.

[[func-pop-backup]]
==== Function `d__pop_backup`

The function `d{dus}pop_backup` restores backup of the given path to its original location.
Whatever pre-exists at the original location is, in turn, backed up by appending a suffix.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}pop_backup* [-de]… [--] *_ORIG_PATH_* [*_BACKUP_PATH_*]
----

This function ensures that the latest backup is moved back to the `*_ORIG_PATH_*`, and if anything exists there currently, it is, itself, backed up.
Thus, if there are no backups at all, nothing is done and a success code is returned.

For the backup path, the first available strategy is employed:

* If a `*_BACKUP_PATH_*` is given, it is used.
If it turns out unusable, further strategies are not tried; an error code is returned instead.
* If called from a deployment, the backup is placed into <<var-dpl-backup-dir,`$D__DPL_BACKUP_DIR`>>, and the backup file name is generated by concatenating two parts:
** the md5 checksum of the `*_ORIG_PATH_*`;
** the suffix `.bak`.
* If none of the above works, an error code is returned.

To find the latest backup, this function first checks the generated backup path, then repeatedly appends an incrementing numerical suffix (`-1`, `-2`, etc.) to the backup file name.
As soon as it hits a path that does not exist, the previous path is understood to be the latest backup.
The suffixes are hard capped at 1000.

To back up whatever pre-exists at the `*_ORIG_PATH_*`, the suffix `.bak` is appended to the `*_ORIG_PATH_*`.
If that path happens to be occupied, the same routine of incrementing numbers is applied.

This function always ensures the existence of the directory that is the immediate parent of the `*_ORIG_PATH_*`.

This function is intended to be used in conjunction with <<func-push-backup,`d__push_backup`>>.

Returns:

* `0` — The backup has been popped successfully, according to the options.
* `1` — The `*_ORIG_PATH_*` is inaccessible.
* `2` — The backup path, whatever it is, is inaccessible or invalid.
* `3` — Other unexpected error.

.List of `d{dus}pop_backup` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-e*`, `*--evict*`

This option makes it an additional priority to ensure that anything that pre-exists at the `*_ORIG_PATH_*` is no longer there by the time this function successfully returns.
This means that even if there is no backup to pop, the `*_ORIG_PATH_*` still gets vacated.

| `*-d*`, `*--dispose*`

With this option the function treats whatever pre-exists at the `*_ORIG_PATH_*` as disposable.
In this mode, no backups of the `*_ORIG_PATH_*` are made.

|===

[[func-os-pkgmgr]]
==== Function `d__os_pkgmgr`

Function `d__os_pkgmgr` is a thin wrapper around system package manager.
The idea is to be able to install system packages without checking for current OS.
On OS's that are not yet supported, this function does nothing and returns non-zero.

[source,subs="verbatim,quotes,attributes"]
----
*d__os_pkgmgr* *update*|*check*|*install*|*remove* [*_PKG_NAME_*]
----

Launches one of the four routines, which are expected of any package manager out there.
Second argument (`*_PKG_NAME_*`), the name of single package, is relayed to the underlying package manager verbatim.
User prompts (except sudo password) are suppressed.

The first argument must be one of the four:

* `update` — updates all installed packages (other arguments are ignored).
* `check` — checks whether the provided package is installed.
Returns zero/non-zero appropriately.
* `install` — installs the provided package.
* `remove` — uninstalls the provided package.

[[stash]]
=== Stash

_Divine.dotfiles_ provides a persistent key-value storage/retrieval system.
It is based in the file system, i.e., all data is stored in files.

[#stash-types]#There are three levels of stashing system#:

* *Deployment stash* — exclusive to current deployment on current machine.
This is the default.
+
Stored in `state/stash/*_DPL-NAME_*/.stash.cfg`.
* *Root stash* — shared by all deployments on current machine.
+
Stored in `state/stash/.stash.cfg`.
* *Grail stash* — shared by all deployments across all machines that use the same <<grail-directory,Grail>>.
+
Stored in `grail/.stash.cfg`.

Rules of key-value store are:

* Keys must consist of: alphanumeric characters, underscore (`_`), and hyphen (`-`).
* Values must not exceed single line of text, but are otherwise unrestricted, and may be empty.
* Multiple instances of a key are allowed, values may be duplicate.

Stashing is accessible from within the deployments via the `d{dus}stash` function.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}stash* [-drgsq] [--] [ *_CMD_* [ *_KEY_* [*_VALUE_*] ] ]
----

Depending on first argument, usage is as follows.

.Usage patterns of `d{dus}stash`
[%noheader,cols="<.<a",stripes=none]
|===

| `d{dus}stash *ready*`

(_default task_) Checks whether the stashing system on selected <<stash-types,level>> is primed and ready.
By default, prints loud error messages if something is critically wrong with the stash.

Returns `0` if stash is ready, or `2` if not.

| `d{dus}stash *has* *_KEY_* [*_VALUE_*]`

If `*_VALUE_*` is not given: checks whether the stash contains at least one `*_KEY_*` with any value.

If `*_VALUE_*` is given: checks whether the stash contains at least one `*_KEY_*` that is set to `*_VALUE_*`.

Returns `0` if so, or `1` otherwise.

| `d{dus}stash *set* *_KEY_* [*_VALUE_*]`

Ensures that the stash contains a _single_ instance of `*_KEY_*`, and that it is set to `*_VALUE_*`.

Returns `0` on success, or `1` otherwise.

| `d{dus}stash *add* *_KEY_* [*_VALUE_*]`

Adds one instance of `*_KEY_*` and sets it to `*_VALUE_*`, regardless of possibly pre-existing instances of `*_KEY_*`.

Returns `0` on success, or `1` otherwise.

| `d{dus}stash *get* *_KEY_*`

Prints the value of the first instance of `*_KEY_*` to `stdout`.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *list* *_KEY_*`

Prints the value of each `*_KEY_*` on a new line to `stdout`.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *unset* *_KEY_* [*_VALUE_*]`

If `*_VALUE_*` is not given: removes all instances of `*_KEY_*`.
If `*_VALUE_*` is given: removes each instance of `*_KEY_*` that is set to `*_VALUE_*`.

Returns `0` on success (even if nothing was removed), or `1` otherwise.

| `d{dus}stash *list-keys*`

Prints each `*_KEY_*` currently in the stash on a new line to `stdout`.
Possible duplicate keys are _not_ pruned.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *clear*`

Clears all records from this stash.

| If called with an unsupported routine name, the function returns `3`.

|===

Below is the list of `d{dus}stash` options.

.List of `d{dus}stash` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-s*`, `*--skip-checks*`

Without this option, every invocation of `d{dus}stash` (with any arguments) begins with stash readiness check.
If the function is called multiple times within a deployment, such checks become redundant.
It is recommended that after initial `d{dus}stash ready`, this option is then included with any subsequent invocations, to forego readiness checks.

| `*-q*`, `*--quiet*`

Without this option, any error during the stash readiness checks triggers an error message that always appears.
This option causes such error messages to instead honor the <<global-verbosity-level,global verbosity level>>.
This option is intended to be included with readiness checks in cases where not using stash is also a viable option.

^.^h| Stash <<stash-types,level>> (one active at a time, last option wins)

| `*-d*`, `*--dpl*`

_(default)_ Directs to work with the <<stash-types,deployment stash>>

| `*-r*`, `*--root*`

Directs to work with the <<stash-types,root stash>> instead of default deployment stash.

| `*-g*`, `*--grail*`

Directs to work with the <<stash-types,Grail stash>> instead of default deployment stash.

|===

[.note]
[%noheader,cols="<.<a"]
|===
| Records of attaching third-party bundles are stored in <<stash-types,Grail stash>>.

Records of installing optional framework dependencies are stored in <<stash-types,root stash>>.
|===

=== Manifests

_Divine.dotfiles_ introduces a simple markup language for special files called *manifests*.

There are three types of special files that are manifests:

* <<divinefiles, Divinefiles>>.
* <<asset-manifests, Asset manifests>>.
* <<queue-manifests, Queue manifests>>.

While they differ in purpose and supported features, all types of manifests share basic syntax, as they are internally parsed by the same engine.

[[manifest-syntax]]
==== Manifest syntax

Manifests are processed in terms of lines.
Simplest line contains an *entry* of some kind.

Whitespace rules are fairly permissive.
Any amount of leading and trailing whitespace is allowed and ignored.
Within an entry, whitespace is preserved.

[source]
----
entry1
entry2
entry with whitespace
  indented entry will not contain indentation
----

[[manifest-key-values]]
==== Manifest key-values

Whenever a line starts with an opening parenthesis `(` and contains a closing one `)`, what's between them is interpreted as a *key-value* pair.
Key-values are used to qualify entries and provide additional info.

A key-value is separated into key and value by the first occurrence of `:` (colon) within the parentheses.

There may be more than one key-value per line.
Key-values are recognized only when they occupy their own line or precede an entry.
Key-values that occupy their own line come into effect for the rest of the document, or until overridden.
Key-values that precede an entry affect only that entry.

[source,bash]
----
entry1                  # Regular entry
(color: red) entry2     # Set color to red for this entry only

(color: blue)           # Set color to blue henceforth

entry3                  # Color is blue
(color: green) entry4   # Color is green (overridden)
entry5                  # Color is blue

(color:)                # Unset color henceforth

entry6                  # Regular entry (no color)
entry7                  # Regular entry (no color)
----

[.note]
[%noheader,cols="<.<a"]
|===
| There are a few keys that are universal to all types of manifests.
They are described below.

Particular kinds of manifests support additional keys.
|===

==== OS-specific manifest entries

Key `os` makes entries specific to particular operating systems.
Multiple OS's may be given by separating with vartical bars.
Entire list of OS's may be negated (inverted) by prepending it with a `!`.

[source]
----
(os: debian)          entry1    # Relevant only on Debian

(os: macos|bsd)       entry2    # Relevant only on macOS or BSD

(os: ! linux | wsl)   entry3    # Relevant everywhere except Linux or WSL

(os: all)             entry4    ## Keywords 'all'/'any' are reserved to denote 
                                #. any OS. This is synonymous to empty list.
----

[.note]
[%noheader,cols="<.<a"]
|===
| OS names are matched against <<var-os-family,`$D\__OS_FAMILY`>> and <<var-os-distro,`$D__OS_DISTRO`>> built-in variables.
Single match against any of the two is sufficient.
|===

[[manifest-entry-flags]]
==== Manifest entry flags

Key `flags` adds a string of single-character flags to the entries.

Flags specifically have a *shorthand*: whenever a key-value does not contain a `:` (colon) separator (i.e., there is no key), content of parentheses is interpreted as `flags`.

Flags may be appended to those currently in effect, instead of replacing them, by including the plus sign '+' as the first non-whitespace char of the flags' value.

[source,bash]
----
(flags: i!0)  entry1    # Flags: i, !, 0

(flags: a)
              entry2    # Flags: a
(+b)
(flags: +c)   entry3    # Flags: a, b, c
              entry4    # Flags: a, b
(flags: d)    entry5    # Flags: d
              entry6    # Flags: a, b
----

==== Comments and line continuation in manifests

Hash/pound symbol (`#`) comments out the rest of the line.

A line may be 'glued' to the next by terminating it with a backslash (`\`).
Whitespace and comment are allowed to follow the backslash.

[source,bash]
----
(os: fedora)  \   ## This is a single logical line
lengthy entry \   #. spanning three physical lines
text              #. (yes, even with comments attached like this)
----

==== Escaping in manifests

* To start an entry with a literal opening parenthesis `(`, prepend it with a backslash `\`.
+
_One and only one backslash is always removed from the left edge of an entry._
* To use a literal closing parenthesis `)` within a key-value, prepend it with a backslash `\`.
* To use a literal hash/pound symbol `#` anywhere, prepend it with a backslash.
* To end a line with a literal backslash `\`, double every literal backslash at its right edge.
+
_Odd number of backslashes at the right edge will result in line continuation._

[[assets]]
=== Assets

If you intend to distribute your deployments, you will soon encounter the problem of separating more-or-less static deployment logic from dynamic deployment assets.

Lets study an example deployment that symlinks configuration files into the system.
It would be desirable to copy samples of those configuration files into user's <<grail-directory,Grail directory>>, and then create symlinks to the copies.
The user would then be free to inspect, modify, and synchronize his copies as his personal versions.
At the same time, the deployment logic is better kept within <<state-directory,state directory>>, where it would be easily updated by the framework.

Each deployment has a designated *asset directory*: `grail/assets/*_DPL-NAME_*/`, path to which is readable from a <<var-dpl-asset-dir,variable>>.
The asset directory is the space where user controls the behavior of the deployment by adding/modifying/removing asset files.
Deployments, on their part, are free to provide initial/default versions of some or all assets.

To facilitate handling of assets, _Divine.dotfiles_ offers the mechanism of *asset manifests*.

[[asset-manifests]]
==== Asset manifests

An *asset manifest* is a text file located in the same directory as the deployment file and named the same, except for exchanging `.dpl.sh` suffix for `.dpl.mnf`.
It serves two purposes:

* An asset manifest can ensure that a copy of every asset that you provide is placed into the deployment's <<var-dpl-asset-dir,asset directory>> inside the user's <<grail-directory,Grail>>, _unless_ an asset by that name already exists there.
* An asset manifest can automatically populate <<asset-arrays,global asset arrays>>, making the assets immediately available for processing by <<generic-queue,queues>> of <<link-queue,various>> <<copy-queue,kinds>>.

Entries in an asset manifest describe a set of *assets* (files and directories) by providing relative paths to them.
Relative paths are resolved from:

* <<var-dpl-dir,deployment directory>> (to locate initial versions provided by the author);
* <<var-dpl-asset-dir,asset directory>> (to locate user's versions to be processed by the framework).

[.note]
[%noheader,cols="<.<a"]
|===
| To reiterate, the framework never overwrites assets that are already present in asset directory.
|===

Processing of asset manifests occurs:

* During <<primary-routines,primary routines>>, immediately before sourcing the deployment file.
* During <<attach-routine,attaching of deployments>>, so that the assets of newly introduced deployments are immediately present in <<grail-directory,the Grail>>.

[[asset-manifest-syntax-and-behavior]]
==== Asset manifest syntax and behavior

Asset manifests follow the general <<manifest-syntax,manifest syntax>>.

Every entry is a *relative path*, which is resolved within <<var-dpl-dir,deployment>> and <<var-dpl-asset-dir,asset>> directories.
Two kinds of relative paths are accepted: *concrete paths* and *RegEx patterns*.
Leading and trailing slashes are disregarded in all paths in the asset manifests (including <<asset-manifest-prefix,`prefix`>> sub-paths).

The following <<manifest-entry-flags,*flags*>> are recognized within asset manifests for each asset entry:

.List of asset manifest entry flags
[%header,cols="<.<4,^.<1,<.<4",stripes=none]
|===

^.^| Behavior _without_ the flag (default)
^.^| Asset flag
^.^| Behavior _with_ the flag

| The entry is interpreted as a concrete path to a single asset.
| `*r*`

_**R**egEx_
| The entry is interpreted as a **R**egEx pattern (see <<asset-manifest-regex-note,note>> below), matching any number of assets.

| All matching files and directories within the <<var-dpl-dir,deployment directory>> are copied into the <<var-dpl-asset-dir,asset directory>>, unless the destination already exists.
Afterward, matching files and directories within the <<var-dpl-asset-dir,*asset directory*>> are pushed onto the <<asset-arrays,asset arrays>>.
| [#asset-flag-d]#`*d*`#

_**d**pl-dir-only_
| This asset entry does not leave the <<var-dpl-dir,**d**eployment directory>>.
Matching files and directories are not copied anywhere, and are pushed onto the <<asset-arrays,asset arrays>> from their original location.
This provides a way to conceal assets from user's view.

| Some version of the asset must be provided by the author into the <<var-dpl-dir,deployment directory>>.
(If the entry is a RegEx pattern, it must have at least one matching file/directory.)
Failing that, the entire deployment is not processed at all.
| `*o*`

_**o**ptional_
| The asset entry is considered **o**ptional: its provision by the author is not enforced.

| Files and directories matching the asset entry are pushed onto <<asset-arrays,asset arrays>> for further usage.
| `*n*`

_**n**o-queue_
| Files and directories matching the asset entry are **n**ot pushed onto <<asset-arrays,asset arrays>>.

_Together with the <<asset-flag-d,`d` flag>>, this will cause the asset to be completely ignored._

| All matching files and directories within the <<var-dpl-asset-dir,*asset directory*>> will be pushed onto <<asset-arrays,asset arrays>>.
This opens the door for user to add additional assets.

_Irrelevant when the <<asset-flag-d,`d` flag>> is in effect._
| `*p*`

_**p**rovided-only_
| The asset entry is considered limited to those matching files and directories, versions of which are **p**rovided by the author.

_Irrelevant when the <<asset-flag-d,`d` flag>> is in effect._

| Pre-existing files in the user's <<grail-directory,Grail>> are not overwritten under any circumstances.

| `*f*`

_**f**orce-copy_
| The framework ensures that a byte-by-byte copy of the provided version of an asset is present in the user's <<grail-directory,Grail>>.
If a differing version is found there, it is renamed by appending `-backup` suffix (with optional trailing ordinal for multiple backups), and the proper version is placed instead.
An alert is shown to the user whenever this happens.

*_Use this option sparingly!_*
The user is normally entitled to fully control their own Grail directory.
Replacing files there undermines the trust in your deployment.

This flag, however, is useful for supplying and updating READMEs.
In fact, whenever a file matching the RegEx pattern `README(\.[a-z]+)?` (case-sensitive) is replaced via this flag, the framework does not issue an alert or create a backup.
Naturally, this is designed for convenience, not security.

|===

The following <<manifest-key-values,*key-values*>> are recognized within asset manifests:

.Asset manifest key-values
[%noheader,cols="<.<a",stripes=none]
|===

| [#asset-manifest-prefix]#`(*prefix: _SUBPATH_*)`#

If you — the deployment author — want to contain your assets under some sub-path within the deployment directory, but you don't want that sub-path to be carried over to the asset directory, specify that sub-path in the `prefix` <<manifest-key-values,key>>.

| [#asset-manifest-queue-split]#`(*queue: split*)`#

This key-value does not work like the other key-values.
It does not affect the asset entries in any way.
Instead it creates a <<split-queue,queue split>> point wherever it appears.

|===

[#asset-manifest-regex-note]#Under the hood#, RegEx patterns are fed to the http://man7.org/linux/man-pages/man1/find.1.html[find] utility, using https://en.wikibooks.org/wiki/Regular_Expressions/POSIX-Extended_Regular_Expressions[POSIX Extended Regular Expressions] dialect.
The provided pattern is inserted into a larger one, similarly to the following example: `find -E . -regex "^\./${PATTERN}$"`.
As a consequence, the patterns should not include `^` and `$` meta-characters.

Order of entries in the asset manifest is guaranteed to correspond to the order of elements in the resulting <<asset-arrays,asset arrays>>.
However, order of files/directories matching a songle RegEx entry is not guaranteed.

Relative paths from a manifest are simply appended to their respective parent directory.
Paths like `.`, `..`, `../..`, etc. will work.
Keep in mind, tha asset manifests are designed for convenience, not security: with free-form Bash code within deployments, security is pretty much a moot point.

.Example of asset manifest
[source]
----
file1.txt           ## These files will be copied from deployment directory
file2.txt           #. into the root of asset directory.

(r) configs/\       ## Any .cfg files will be copied into 'configs/' directory. 
[a-z]+\.cfg         #. (Line continuation is part of manifest syntax.)

(prefix: images)
img1.jpg            ## These two files will be grabbed from 'images/' directory 
img2.jpg            #. and copied into the root of asset directory.
----

[[asset-arrays]]
==== Asset arrays

Whenever the framework processes an asset manifest, it automatically populates two global arrays:

* `*D_DPL_ASSET_PATHS*` — this array is filled with absolute paths to the assets within <<var-dpl-asset-dir,deployment's asset directory>> (contained in <<grail-directory,the Grail>>).
* `*D_QUEUE_MAIN*` — for each path in the previous array, this one will contain some relative version of that path at the same index.
Relative paths are resolved against <<var-dpl-asset-dir,deployment's asset directory>>.

You may notice, that these arrays coincide with those used in the <<generic-queue,queues>> (including <<link-queue,link>> and <<copy-queue,copy>> queue variations).
The reasoning there is that assets are perfect candidates to be handled by a queue.
You are, of course, free to override these automatically populated arrays.

[[generic-queue]]
=== Generic queue

Whenever your deployment performs a series of similar actions, — e.g., symlinks a bunch of files — you are faced with several routine tasks:

* Write iteration logic.
* Tie the return codes of subtasks into a single informative code.

_Divine.dotfiles_ offers a mechanism called *queue*, which relieves such pain.
To use it:

. Populate a specially named array with one string for each queue item.
. Implement logic to be applied to a single item.
. Delegate your deployment's <<primary-functions,primaries>> to built-in helpers.

This kind of deployment is best demonstrated with an example:

.Deployment template for generic queue
[source,bash]
----
# Delegate primaries to queue helpers. Make sure helper is called last.
d_dpl_check()    { populate_queue;  d__queue_check;    }
d_dpl_install()  {                  d__queue_install;  }
d_dpl_remove()   {                  d__queue_remove;   }

# This function is not built-in, but is the recommended way of organizing logic
populate_queue() { D_QUEUE_MAIN=( alpha bravo charlie ); }

# Implement mini-primaries for a single queue item
d_item_check()    { :; }
d_item_install()  { :; }
d_item_remove()   { :; }
----

==== Generic queue set-up

Following Bash arrays should be populated before any of the built-in helpers are called:

.Variables required to set up generic queue
[%noheader,cols="<.<a",stripes=none]
|===

| [#var-queue-main]#`*D_QUEUE_MAIN*`#

Each member of this array defines a queue item.

Members of this array are simple strings.
In generic queues, the framework uses the strings themselves only for debug messages.

|===

The queue arrays must be consecutive.
Failing that, the queue will fail utterly and miserably.
You have been warned.

==== Generic queue hooks

Following built-in functions may be implemented to provide queue logic (all are optional).
The framework unsets every queue hook as soon as it is used up.

.Generic queue hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Mini-primaries

| [#func-queue-item-check]#`*d_item_check*`#

This function is called once for every queue item.
It is similar to its <<func-dpl-check,deployment-level cousin>>, `d_dpl_check`.

Supported return codes:

* `*0*` — *'Unknown'*: [.gray]##_(default)_## no reliable way to tell whether this queue item is installed or not.
* `*1*` — *'Installed'*: as it stands, intended goal of installing this queue item is entirely achieved.
* `*2*` — *'Not installed'*: as it stands, intended goal of installing this queue item is entirely not achieved.
* `*3*` — *'Invalid'*: input for this queue item prevents it from being processed correctly.

| [#func-queue-item-install]#`*d_item_install*`#

This function is called no more than once for every queue item.
It is similar to its <<func-dpl-install,deployment-level cousin>>, `d_dpl_install`.

Supported return codes:

* `*0*` — *'Installed successfully'*: [.gray]##_(default)_## intended goal of installing this queue item is entirely achieved.
* `*1*` — *'Failed to install'*: intended goal of installing this deployment is not entirely achieved due to error.
* `*2*` — *'Item turned out to be invalid'*: input for this queue item prevents it from being installed correctly.
* `*3*` — *'Installed successfully'* and also abort further queue installation.
* `*4*` — *'Failed to install'* and also abort further queue installation.

| [#func-queue-item-remove]#`*d_item_remove*`#

This function is called no more than once for every queue item.
It is similar to its <<func-dpl-remove,deployment-level cousin>>, `d_dpl_remove`.

Supported return codes:

* `*0*` — *'Uninstalled successfully'*: [.gray]##_(default)_## effects of previously installing this queue item are entirely reversed.
* `*1*` — *'Failed to uninstall'*: effects of previously installing this queue item are not entirely reversed due to error.
* `*2*` — *'Item turned out to be invalid'*: input for this queue item prevents it from being uninstalled correctly.
* `*3*` — *'Uninstalled successfully'* and also abort further queue uninstallation.
* `*4*` — *'Failed to uninstall'* and also abort further queue uninstallation.

^.^h| Other queue hooks

| `*d_queue_pre_check*`

This function is called once, before the queue is checked.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this check code without checking'*

| `*d_queue_post_check*`

This function is called once, after the queue is entirelly checked.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(combined check code of the queue is ignored)_

| `*d_queue_pre_install*`

This function is called once, before the queue is installed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this install code without installing'*

| `*d_queue_post_install*`

This function is called once, after the queue is entirelly installed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(combined install code of the queue is ignored)_

| `*d_queue_pre_remove*`

This function is called once, before the queue is removed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this remove code without removing'*

| `*d_queue_post_remove*`

This function is called once, after the queue is entirelly removed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(combined remove code of the queue is ignored)_

|===

==== Generic queue special variables

Following built-in variables are available/recognized during processing of each queue item:

.Generic queue special variables
[%noheader,cols="<.<a",stripes=none]
|===

| `*D{dus}ITEM_NUM*`

Index of current item in `*D_QUEUE_MAIN*`.
This index is helpful if you keep multiple arrays of related queue data.

| `*D{dus}ITEM_TITLE*`

Content of `*D_QUEUE_MAIN*` for current item.

| `*D{dus}ITEM_IS_FORCED*`

By default, the framework does *not*:

* re-install queue items that appear already installed;
* uninstall queue items that appear already not installed;
* process queue items that appear installed by means other than this framework.

The `--force` option of the intervention utility overrules such considerations.

This variable is set to `true` if installation/removal is being forced, i.e., it would not have been initiated if not for the `--force` option.
You are left to decide on whether to treat such cases specially.

| `*D{dus}ITEM_STASH_KEY*`

`*D{dus}ITEM_STASH_VALUE*`

`*D{dus}ITEM_STASH_FLAG*`

Stash key and stash value for current item.
The third variable is `true` if stash record exists, `false` if stash record does not exist, and not set if stash is not used for this item.

[.note]
[%noheader,cols="<.<a"]
!===
! Queue mechanism uses stash to keep persistent records of (un)installing queue items.
Ideally, there is no reason for you to know this or use these variables.
!===

| `*D{dus}QUEUE_RETURN_CODE*`

Within queue post-processing hooks, this variable is populated with the code that is set to be returned by the corresponding <<primary-functions,primary>>.
Changing this variable has no effect — use the hook's return code instead.

| `*D{dus}ITEM_RETURN_CODE*`

This variable is only relevant for <<link-queue,link>> and <<copy-queue,copy>> queue variations.
Within queue _item_ post-processing hooks, this variable is populated with the code that is set to be returned by the corresponding mini-primary.
Changing this variable has no effect — use the hook's return code instead.

|===

[[queue-manifests]]
==== Queue manifests

<<var-queue-main,Contents>> of the queue, whatever they are, sound like a perfect candidate for separation from deployment logic.
Queue manifests to the resqueue.

A *queue manifest* is a text file, which is — by default — located in the same directory as the deployment file and named the same, except for exchanging `.dpl.sh` suffix for `.dpl.que`.
Unlike with <<asset-manifests,asset manifests>>, you are free to customize the location/name of your queue manifest by re-assigning <<var-dpl-que-path,`D_DPL_QUE_PATH`>> variable *at the top level* of your deployment.

Queue manifests follow the general <<manifest-syntax,manifest syntax>>.
Only the key `os` is recognized within queue manifests.

[.note]
[%noheader,cols="<.<a"]
|===
| A suggested way of using queue manifests is:

. Provide a sample queue manifest of some entries in whatever form.
. Declare the queue manifest an asset, by listing it in your <<asset-manifests,asset manifest>>.
. Within the deployment, customize the <<var-dpl-que-path,`D_DPL_QUE_PATH`>> variable to point to asset copy within <<grail-directory,the Grail>>, e.g.:
+
[source,bash]
----
D_DPL_QUE_PATH="$D__DPL_ASSET_DIR/$D_DPL_NAME.dpl.que"
----
|===

[[link-queue]]
=== Link queue

A common use case of queues is creating symlinks that point to deployment's assets.
For example, one might want to:

* create symlinks located at `~/.bashrc` and `~/.zshrc`;
* point them at custom assets stored in <<grail-directory,the Grail>>;
* store original files as backups and restore them upon uninstallation.

For such purposes, _Divine.dotfiles_ provides a partially implemented version of <<generic-queue,generic queue>> called *link queue*.
To use it:

. Populate a few specially named arrays with necessary paths.
. Delegate your deployment's <<primary-functions,primaries>> to built-in helpers.

This kind of deployment is best demonstrated with an example:

.Deployment template for link queue
[source,bash]
----
# Delegate primaries to link queue helpers. Make sure helper is called last.
d_dpl_check()    { populate_link_queue; d__link_queue_check;    }
d_dpl_install()  {                      d__link_queue_install;  }
d_dpl_remove()   {                      d__link_queue_remove;   }

# This function is not built-in, but is the recommended way of organizing logic
populate_link_queue() {
  local src="$D__DPL_ASSET_DIR" dst=~
  D_QUEUE_MAIN=(            .bashrc        .zshrc )
  D_DPL_ASSET_PATHS=( "$src/.bashrc" "$src/.zshrc" )
  D_DPL_TARGET_PATHS=( $dst/.bashrc   $dst/.zshrc  )
}
----

==== Link queue set-up

Following Bash arrays should be populated before any of the built-in helpers are called.
Note, that you can <<link-queue-asset-automation,automate>> this process.

.Variables required to set up link queue
[%noheader,cols="<.<a",stripes=none]
|===

| `*D_QUEUE_MAIN*`

This variable is still the main definition of the queue.
In the context of link queue, for each absolute path in `*D_DPL_ASSET_PATHS*`, this array must contain a shortened relative version, resolvable from the asset directory.

| `*D_DPL_ASSET_PATHS*`

Each member of this array is an absolute path to which a symlink should be maintained.

| `*D_DPL_TARGET_PATHS*`

For each path in `*D_DPL_ASSET_PATHS*`, this array must contain the intended absolute path to a symlink, which will point to the respective asset.

|===

The queue arrays must be consecutive and have the same number of elements.
Failing that, the queue will fail utterly and miserably.
You have been warned.

==== Link queue hooks

Following built-in functions may be implemented to provide queue logic (all are optional).
The framework unsets every link queue hook as soon as it is used up.

.Link queue hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Mini-primary hooks

| `*d_link_item_pre_check*`

This function is called once, before the symlink is <<func-queue-item-check,checked>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item check code without checking'*

| `*d_link_item_post_check*`

This function is called once, after the symlink is <<func-queue-item-check,checked>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this item check code instead'* _(check code of the link queue item is ignored)_

| `*d_link_item_pre_install*`

This function is called once, before the symlink is <<func-queue-item-install,installed>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item install code without installing'*

| `*d_link_item_post_install*`

This function is called once, after the symlink is <<func-queue-item-install,installed>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this item install code instead'* _(install code of the link queue item is ignored)_

| `*d_link_item_pre_remove*`

This function is called once, before the symlink is <<func-queue-item-remove,uninstalled>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item remove code without removing'*

| `*d_link_item_post_remove*`

This function is called once, after the symlink is <<func-queue-item-remove,uninstalled>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this item remove code instead'* _(remove code of the link queue item is ignored)_

^.^h| Overall queue hooks

| `*d_link_queue_pre_check*`

This function is called once, before the link queue is checked.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this check code without checking'*

| `*d_link_queue_post_check*`

This function is called once, after the link queue is entirelly checked.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(combined check code of the link queue is ignored)_

| `*d_link_queue_pre_install*`

This function is called once, before the link queue is installed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this install code without installing'*

| `*d_link_queue_post_install*`

This function is called once, after the link queue is entirelly installed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(combined install code of the link queue is ignored)_

| `*d_link_queue_pre_remove*`

This function is called once, before the link queue is removed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this remove code without removing'*

| `*d_link_queue_post_remove*`

This function is called once, after the link queue is entirelly removed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(combined remove code of the link queue is ignored)_

|===

[[link-queue-asset-automation]]
==== Link queue asset automation

So, you have your list of assets in a <<asset-manifests,manifest>>, and you know where to symlink them to.
Why bother with manually populating arrays?

No need.

_Divine.dotfiles_ provides two major automation avenues for link queue arrays:

* Arrays `*D_QUEUE_MAIN*` and `*D_DPL_ASSET_PATHS*` are both <<asset-arrays,automatically populated>> when the <<asset-manifests,asset manifest>> is processed, which happens immediately before your deployment file is sourced.
* Array `*D_DPL_TARGET_PATHS*` can be automatically populated if all your assets are intended to go into one target directory.
+
For that to occur, put the target directory into `*D_DPL_TARGET_DIR*` variable before any of the built-in helpers are called.
All your assets will be symlinked into the target directory, with relative paths preserved.
+
Keep in mind that this does rely on `*D_QUEUE_MAIN*` to contain relative paths, as is the requirement for link queues.

[[link-queue-cross-platform-overrides]]
==== Link queue cross-platform overrides

Cross-platformness, you say?
Your assets go into different target directories on different platforms?
No worries.

In _Divine.dotfiles_, every OS adapter carries an override mechanism for both `*D_DPL_TARGET_DIR*` and `*D_DPL_TARGET_PATHS*`.
The rules are simple: append the handle of the supported OS to the variable name in all capitals like this:

[source,bash]
----
D_DPL_TARGET_DIR=/generic/path
D_DPL_TARGET_DIR_MACOS=/path/on/macos
D_DPL_TARGET_DIR_FEDORA=/path/on/fedora
D_DPL_TARGET_DIR_WSL=/path/on/wsl
----

[.note]
[%noheader,cols="<.<a"]
|===
| The OS handles are matched against both  <<var-os-family,`$D\__OS_FAMILY`>> and <<var-os-distro,`$D__OS_DISTRO`>> built-in variables.
A match against distro overrules a match against family, because such is life.
|===

[[copy-queue]]
=== Copy queue

Another common use case of queues is copying files into the system.
For example, one might want to:

* copy an assortment of font files into the system's font directory;
* not overwrite existing files.

For such purposes, _Divine.dotfiles_ provides a partially implemented version of <<generic-queue,generic queue>> called *copy queue*.
To use it:

. Populate a few specially named arrays with necessary paths.
. Delegate your deployment's <<primary-functions,primaries>> to built-in helpers.

[.note]
[%noheader,cols="<.<a"]
|===
| Copy queue does not touch pre-existing files:

* If a file by that name already exists at destination — no copying is done.
* Upon uninstallation, a file is only erased if there is a record of it previously being copied into that location.

If you want to actually substitute existing files (while backing them up), prefer the <<link-queue,link queue>>.
|===

This kind of deployment is best demonstrated with an example:

.Deployment template for copy queue
[source,bash]
----
# Delegate primaries to copy queue helpers. Make sure helper is called last.
d_dpl_check()    { populate_copy_queue; d__copy_queue_check;    }
d_dpl_install()  {                      d__copy_queue_install;  }
d_dpl_remove()   {                      d__copy_queue_remove;   }

# This function is not built-in, but is the recommended way of organizing logic
populate_copy_queue() {
  local src="$D__DPL_ASSET_DIR" dst=/usr/share/fonts
  D_QUEUE_MAIN=(            font1.ttf        font2.ttf  )
  D_DPL_ASSET_PATHS=( "$src/font1.ttf" "$src/font2.ttf" )
  D_DPL_TARGET_PATHS=( $dst/font1.ttf   $dst/font2.ttf  )
}
----

==== Copy queue set-up

Following Bash arrays should be populated before any of the built-in helpers are called.
Note, that you can <<copy-queue-asset-automation,automate>> this process.

.Variables required to set up copy queue
[%noheader,cols="<.<a",stripes=none]
|===

| `*D_QUEUE_MAIN*`

This variable is still the main definition of the queue.
In the context of copy queue, for each absolute path in `*D_DPL_ASSET_PATHS*`, this array must contain a shortened relative version, resolvable from the asset directory.

| `*D_DPL_ASSET_PATHS*`

Each member of this array is an absolute path to file that is to be copied.

| `*D_DPL_TARGET_PATHS*`

For each path in `*D_DPL_ASSET_PATHS*`, this array must contain the destination absolute path for copying.

|===

The queue arrays must be consecutive and have the same number of elements.
Failing that, the queue will fail utterly and miserably.
You have been warned.

==== Copy queue hooks

Following built-in functions may be implemented to provide queue logic (all are optional).
The framework unsets every copy queue hook as soon as it is used up.

.Copy queue hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Mini-primary hooks

| `*d_copy_item_pre_check*`

This function is called once, before the copy is <<func-queue-item-check,checked>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item check code without checking'*

| `*d_copy_item_post_check*`

This function is called once, after the copy is <<func-queue-item-check,checked>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(check code of the copy queue item is ignored)_

| `*d_copy_item_pre_install*`

This function is called once, before the copy is <<func-queue-item-install,installed>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item install code without installing'*

| `*d_copy_item_post_install*`

This function is called once, after the copy is <<func-queue-item-install,installed>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(install code of the copy queue item is ignored)_

| `*d_copy_item_pre_remove*`

This function is called once, before the copy is <<func-queue-item-remove,uninstalled>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item remove code without removing'*

| `*d_copy_item_post_remove*`

This function is called once, after the copy is <<func-queue-item-remove,uninstalled>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(remove code of the copy queue item is ignored)_

^.^h| Overall queue hooks

| `*d_copy_queue_pre_check*`

This function is called once, before the copy queue is checked.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this check code without checking'*

| `*d_copy_queue_post_check*`

This function is called once, after the copy queue is entirelly checked.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(combined check code of the copy queue is ignored)_

| `*d_copy_queue_pre_install*`

This function is called once, before the copy queue is installed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this install code without installing'*

| `*d_copy_queue_post_install*`

This function is called once, after the copy queue is entirelly installed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(combined install code of the copy queue is ignored)_

| `*d_copy_queue_pre_remove*`

This function is called once, before the copy queue is removed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this remove code without removing'*

| `*d_copy_queue_post_remove*`

This function is called once, after the copy queue is entirelly removed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(combined remove code of the copy queue is ignored)_

|===

[[copy-queue-asset-automation]]
==== Copy queue asset automation

So, you have your list of assets in a <<asset-manifests,manifest>>, and you know where to copy them to.
Why bother with manually populating arrays?

No need.

_Divine.dotfiles_ provides two major automation avenues for copy queue arrays:

* Arrays `*D_QUEUE_MAIN*` and `*D_DPL_ASSET_PATHS*` are both <<asset-arrays,automatically populated>> when the <<asset-manifests,asset manifest>> is processed, which happens immediately before your deployment file is sourced.
* Array `*D_DPL_TARGET_PATHS*` can be automatically populated if all your assets are intended to go into one target directory.
+
For that to occur, put the target directory into `*D_DPL_TARGET_DIR*` variable before any of the built-in helpers are called.
All your assets will be copied into the target directory, with relative paths preserved.
+
Keep in mind that this does rely on `*D_QUEUE_MAIN*` to contain relative paths, as is the requirement for copy queues.

[[copy-queue-cross-platform-overrides]]
==== Copy queue cross-platform overrides

Cross-platformness, you say?
Your assets go into different target directories on different platforms?
No worries.

In _Divine.dotfiles_, every OS adapter carries an override mechanism for both `*D_DPL_TARGET_DIR*` and `*D_DPL_TARGET_PATHS*`.
The rules are simple: append the handle of the supported OS to the variable name in all capitals like this:

[source,bash]
----
D_DPL_TARGET_DIR=/generic/path
D_DPL_TARGET_DIR_MACOS=/path/on/macos
D_DPL_TARGET_DIR_FEDORA=/path/on/fedora
D_DPL_TARGET_DIR_WSL=/path/on/wsl
----

[.note]
[%noheader,cols="<.<a"]
|===
| The OS handles are matched against both  <<var-os-family,`$D\__OS_FAMILY`>> and <<var-os-distro,`$D__OS_DISTRO`>> built-in variables.
A match against distro overrules a match against family, because such is life.
|===

[[multitask]]
=== Multitask

What if a deployment carries out an assortment of _dissimilar_ tasks?
Tying up various return codes to integrate with _Divine.dotfiles_ would be tedious.

*Multitask* helpers will take up that task.
To use them:

. Populate a specially named array with one string for each task.
. Implement sub-primaries for the tasks, as if each one was a deployment of its own.
. Delegate your deployment's <<primary-functions,primaries>> to built-in helpers.

This kind of deployment is best demonstrated with an example:

.Deployment template for multitasking
[source,bash]
----
# Delegate primaries to multitask helpers. Make sure helper is called last.
d_dpl_check()    { assemble_tasks;  d__mltsk_check;   }
d_dpl_install()  {                  d__mltsk_install; }
d_dpl_remove()   {                  d__mltsk_remove;  }

# This function is not built-in, but is the recommended way of organizing logic
assemble_tasks() {  D_MLTSK_MAIN=( eat pray love );  }

# Implement sub-primaries for each task, following guidelines for primaries

d_eat_check()     { :; }
d_eat_install()   { :; }
d_eat_remove()    { :; }

d_pray_check()    { :; }
d_pray_install()  { :; }
d_pray_remove()   { :; }

d_love_check()    { :; }
d_love_install()  { :; }
d_love_remove()   { :; }
----

==== Multitask set-up

Following Bash arrays should be populated before any of the built-in helpers are called:

.Variables required to set up multitask deployment
[%noheader,cols="<.<a",stripes=none]
|===

| [#var-multitask-names]#`*D_MLTSK_MAIN*`#

Each member of this array defines a task.

Members of this array are strings, and are used in forming names of sub-primaries, which you then have to implement:

[source,subs="verbatim,quotes,attributes"]
----
          d{us}**__TASK__**{us}check
*_TASK_*  =>  d{us}**__TASK__**{us}install
          d{us}**__TASK__**{us}remove
----

|===

The multitask array must be consecutive.
Failing that, the deployment will fail utterly and miserably.
You have been warned.

==== Multitask hooks

Following built-in functions may be implemented to provide task logic (all are optional):

.Multitask hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Sub-primaries

| [#func-task-check]#`*d{us}__TASK__{us}check*`#

See the guidelines to the <<func-dpl-check,deployment-level sibling>>, `d_dpl_check`.

| [#func-task-install]#`*d{us}__TASK__{us}install*`#

See the guidelines to the <<func-dpl-install,deployment-level sibling>>, `d_dpl_install`.

| [#func-task-remove]#`*d{us}__TASK__{us}remove*`#

See the guidelines to the <<func-dpl-remove,deployment-level sibling>>, `d_dpl_remove`.

|===

[[split-queue]]
==== Split queue

Eventually, you will want to include more than one queue in your multitask deployment.
And therein lies a _gotcha_.

All queues share the same internal mechanism.
Care must be taken to employ this mechanism multiple times within single deployment.
Specifically, the queue must be *split* by calling internal function `*d__queue_split*`.

This is best illustrated with an example:

.Deployment template for multitasking with split queue
[source,bash,subs="verbatim,quotes,attributes"]
----
# Delegate primaries to multitask helpers. Make sure helper is called last.
d_dpl_check()    { assemble_tasks;  d{dus}mltsk_check;   }
d_dpl_install()  {                  d{dus}mltsk_install; }
d_dpl_remove()   {                  d{dus}mltsk_remove;  }

# This function is not built-in, but is the recommended way of organizing logic
assemble_tasks() {  D_MLTSK_MAIN=( queue1 queue2 queue3 ); }

# In this case all three tasks contain a queue

d_queue1_check()    { populate_copy_queue;    d{dus}copy_queue_check;    }
d_queue1_install()  {                         d{dus}copy_queue_install;  }
d_queue1_remove()   {                         d{dus}copy_queue_remove;   }

d_queue2_check()    { populate_link_queue;    d{dus}link_queue_check;    }
d_queue2_install()  {                         d{dus}link_queue_install;  }
d_queue2_remove()   {                         d{dus}link_queue_remove;   }

d_queue3_check()    { populate_generic_queue; d{dus}queue_check;         }
d_queue3_install()  {                         d{dus}queue_install;       }
d_queue3_remove()   {                         d{dus}queue_remove;        }


populate_copy_queue() {
  # Populate the first queue normally (arrays specific to copy queue omitted)
  D_QUEUE_MAIN=( some copy tasks )
}

populate_link_queue() {
  # In subsequent queues, call this built-in function first
  d{dus}queue_split

  # Then {as}append{as} to the queue array (arrays specific to link queue omitted)
  D_QUEUE_MAIN+=( add link jobs )
}

populate_generic_queue() {
  d{dus}queue_split

  D_QUEUE_MAIN+=( generic queue work )
}
----

[.note]
[%noheader,cols="<.<a"]
|===
| If you use <<asset-manifests,asset manifests>>, you may <<asset-manifest-queue-split,split your queue>> directly within the asset manifest file.
|===

== Ways to contribute

You are free to contribute to _Divine.dotfiles_ in any way you deem beneficial.
This section is periodically updated to state the most sought after avenues of improvement.

[[contributing-os-support]]
=== Contributing OS support

One of the main goals of this framework is *portability*.

In _Divine.dotfiles_, the code that supports particular operating systems is isolated within special files called *adapters*.
An OS distribution adapter allows the framework to interact with that OS and with its built-in package manager.

* An adapter is a Bash script with special functions implemented.
* Adapter template and guidelines are located in `lib/templates/adapters/distro.add.sh`.
* Active adapters are put into `lib/adapters/distro/`.

Adapters for all OS distributions out there will be welcomed with open arms.

== Divine deployments

Divine deployments are deployments developed and distributed along with _Divine.dotfiles_.
Apart from being useful by themselves, they serve as an illustration of the framework's mechanisms put to good use.

.List of Divine deployments
[%noheader,cols="<.<a",stripes=none]
|===

| https://github.com/no-simpler/divine-bundle-essentials[Essentials] _(fully functional and documented)_

A bundle of core deployments, mostly centered around 'classic' dotfiles.

| https://github.com/no-simpler/divine-bundle-gpg-primer[GnuPG best practices] _(fully functional on macOS, not yet fully documented)_

Automates adherence to best security practices in regards to https://www.gnupg.org[GnuPG].

| https://github.com/no-simpler/divine-bundle-ssh-primer[SSH key handling] _(fully functional on macOS, not yet fully documented)_

Automates secure stashing and retrieval of SSH secret keys.

| https://github.com/no-simpler/divine-bundle-fonts[Fonts collection] _(fully functional on macOS & Ubuntu, not yet fully documented)_

Maintains a collection of personal font files across machines.

^.^h| macOS-specific deployments

| https://github.com/no-simpler/divine-bundle-macos-local-server[Local development server] _(fully functional on macOS, not yet fully documented)_

Maintains a local development server on macOS.
For the most part, it automates instructions from https://getgrav.org/blog/macos-mojave-apache-multiple-php-versions[this article].

| https://github.com/no-simpler/divine-bundle-macos-tilde-switch[Tilde-switch] _(fully functional on macOS, not yet fully documented)_

Programmatically switches keys tilde `~` and plus-minus `±` on a MacBook’s built-in physical keyboard.

^.^h| App-specific configuration deployments

| https://github.com/no-simpler/divine-bundle-config-vscode[Visual Studio Code] _(fully functional on macOS, not yet fully documented)_

Maintains configuration for https://code.visualstudio.com[VS Code].

| https://github.com/no-simpler/divine-bundle-config-hyperjs[Hyper.js] _(fully functional on macOS, not yet fully documented)_

Maintains configuration for https://hyper.is[Hyper] terminal.

| https://github.com/no-simpler/divine-bundle-config-transmissionbt[Transmission BT] _(fully functional on macOS, not yet fully documented)_

Maintains configuration for https://transmissionbt.com[Transmission].

|===