= Divine.dotfiles
:author: Grove Pyree
:email: grayarea@protonmail.ch
:revdate: 2019.11.06
:revremark: Update readme for D.d v2, pt. 6
:doctype: article
// Visual
:toc: macro
// Subs:
:hs: #
:dhs: ##
:us: _
:dus: __
:as: *
:das: **
:lsb: [
:rsb: ]

++++
<p align="center">
<em>The Bash framework for dotfiles and everything Bash</em>
</p>
++++

++++
<p align="center">
  <img id="divine-dotfiles-plaque" width="640" src="lib/img/divine-dotfiles-plaque.png" alt="Divine.dotfiles">
</p>
++++

New machine or new OS?
Set it up with a single `*di install --yes*`.

[.note]
[%noheader,cols="<.<a"]
|===
| `di` stands for **d**ivine **i**ntervention.
|===

toc::[]

[[fmwk-main]]
== In a nutshell

[.note]
[%noheader,cols="<.<a"]
|===
| First-time users are very welcome to take a <<fmwk-joy-ride,*joy ride*>>.
|===

_Divine.dotfiles_ leverages *deployments*.

A deployment is a Bash script with three specially named functions: one to *check*, another to *install*, third to *remove*.
No assumptions are made about what a deployment does for a living.
Return codes are used to communicate status back to the framework.
As such, authoring a deployment is akin to implementing an interface.

The goals of _Divine.dotfiles_ are:

* *Automation* of setting-up any system that runs Bash.
+
The <<iutil-main,intervention utility>> `di` is a practical tool for handling any number of deployments.
* *Cross-platformness* within the Unix-like airspace.
+
Built-in OS detection mechanisms facilitate writing portable deployments.
* Promotion of *standards* and *best practices*.
+
Ecosystem of deployments is designed with distribution and pluggability in mind.

<<divine-bundles,*Divine bundles*>> of deployments (distributed separately) strive to exemplify what a good deployment should look like.

=== Example deployment

Say, there is a need to maintain a certain command line utility on every machine.
Below is a sample deployment that does a scaled down version of that:

[source,bash,subs="verbatim,attributes"]
----
# grail/dpls/example.dpl.sh

d_dpl_check() {
  [ -e ~/bin/cmd ] && return 1 {vbar}{vbar} return 2
}

d_dpl_install() {
  cat >~/bin/cmd <<<'echo Divine.dotfiles rocks' && chmod +x ~/bin/cmd
}

d_dpl_remove() {
  rm -f -- ~/bin/cmd
}
----

And here is what working with it looks like:

++++
<p align="center">
  <img id="divine-dotfiles-example-1" width="640" src="lib/img/divine-dotfiles-example-1.gif" alt="Divine.dotfiles example 1">
</p>
++++

Dead simple, right?
One wouldn't need a framework for that.
But wait, there's [.small]#_(hopefully)_# more.

[[fmwk-features]]
=== Framework features

.Framework features
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++<<dfls-main,*Divinefiles*>>+++</p>+++

A special kind of deployments, the <<dfls-main,*Divinefiles*>> maintain a stable set of packages across machines and OS's.

| +++<p align="center">+++<<fmwk-grail,*The Grail directory*>>+++</p>+++

A centralized storage for personal deployments and assets (e.g., config files).
On a new machine — the Grail can be <<rtn-plug,plugged in>> from a repo or a local dir with one command.

| +++<p align="center">+++<<mtdt-priority,*Priorities*>>+++</p>+++

Deployments are always ordered by their numerical priority, and the order is automatically reversed for removal.

| +++<p align="center">+++<<mtdt-groups,*Groups*>>+++</p>+++

Deployments support basic grouping via single-character <<mtdt-flags,flags>>.

| +++<p align="center">+++<<indct-os,*Cross-platformness*>>+++</p>+++

Built-in OS detection mechanism allows to adapt to a growing <<fmwk-os-support,list>> of supported OS distributions and families.

| +++<p align="center">+++<<rtn-attach,*Third-party deployments (bundles)*>>+++</p>+++

Github repositories containing deployments are treated as bundles that can be attached with one command.
One example is the https://github.com/no-simpler/divine-bundle-essentials[`essentials`] bundle.

| +++<p align="center">+++<<stash,*Stash*>>+++</p>+++

Deployments have access to a persistent key-value store, which can be used to remember statuses between invocations.

| +++<p align="center">+++<<assets,*Assets*>>+++</p>+++

The notion of assets provides a way to separate static logic from dynamic content.

| +++<p align="center">+++<<helpers,*Helper functions*>>+++</p>+++

An assortment of helper functions streamline basic tasks, such as queues and multitasking.

|===

[[fmwk-design]]
=== Framework design

The _Divine.dotfiles_ framework is written in pure Bash.
This is a conscious decision, intended to maximize portability.

At its very core, this framework is a sequential launcher of user-defined Bash code.

[[fmwk-security]]
Since the deployments are essentially unrestricted Bash scripts, *absolutely no illusion of security should be assumed*.
The framework creates a subshell for every sourced deployment, but security-wise that is pretty much it.
Guarantees described in this section cover only the built-in mechanisms of the framework and the associated <<divine-bundles,Divine bundles>> of deployments.

[[fmwk-interactivity]]
==== Interactivity

_Divine.dotfiles_ is intended for interactive use, and no guarantee of unattended access is offered.
The framework tends to prompt for user's confirmation before major junctions in logic.

[[fmwk-upmt]]
The <<opt-yes,`--yes`>> option is provided to auto-accept the more trivial framework prompts.
The so-called *urgent prompts* — saved for potentially messy situations — ignore the `--yes` option and always interject.

[[fmwk-zero-data-loss]]
==== Zero data loss

All framework components avoid deleting or clobbering any data that is not proven as recoverable.
Instead, whenever files need to be replaced or removed, they are pushed to a backup location.

For the deployment-specific overwrites, the backups are sent into the <<fmwk-state,state directory>>.
Other backups are created in place, by appending the `.bak` suffix.
Whenever multiple backups stack up, an incrementing counter is added, e.g., `_NAME_.bak-17`.

The <<opt-obliterate,`--obliterate`>> option is available to suppress this behavior.

[[fmwk-non-interference]]
==== Non-interference

The framework does its best to *not*:

* re-install something that appears already installed;
* remove something that appears already not installed;
* remove something that appears installed by means other than this framework;
* touch anything that appears to have been manually tinkered with.

Alerts are printed whenever such cases are encountered.

The <<opt-force,`--force`>> option opens path to overcome these restrictions.
However, even with force applied, the zero data loss <<fmwk-zero-data-loss,policy>> still applies, and an <<fmwk-upmt,urgent prompt>> is issued for every instance of forced behavior.

[[fmwk-reversibility]]
==== Reversibility

Where feasible, the built-in mechanisms that introduce changes to the system are paired with the reversal counterparts.

To give an example, any backups created when installing a <<copy-queue,copy-queue>> are restored to their original locations when that queue is removed.
Another example is the introductory <<fmwk-joy-ride,joy ride>>: if taken reasonably, it will leave the system in largely the same state as before installing the framework.

A glaring exception to this principle is the upgrading of the local package repositories through the system package manager (e.g., `sudo dnf upgrade -y`), which is deemed safe enough to overlook.

[[fmwk-structure]]
=== Framework structure

_Divine.dotfiles_ is installed, by default, into the `~/.divine/` directory, and is contained entirely in that directory, *except*:

* A symlink to the framework's main script, `intervene.sh`, is created somewhere on `$PATH`.
* Deployments may affect the system pretty much <<fmwk-security,anywhere>>.

The installed framework consists of the following main parts:

.Framework structure
[%noheader,cols="<.<a",stripes=none]
|===

| [[fmwk-grail]]+++<p align="center">+++#`~/.divine/*grail*/`#+++</p>+++

*The Grail directory* (or simply, *the Grail*) houses user's deployments, assets, and persistent settings.

The Grail is designed to contain just enough data to replicate the current set of deployments, bundles, and assets on any system that runs _Divine.dotfiles_.
Naturally, it is recommended to take the Grail under version control and sync it, e.g., via a cloud service or Github.

The Grail is sub-structured as follows:

* `*assets*/` — The directory for user's assets, such as config files.
* `*dpls*/` — The directory for user's custom deployments.
* `*.stash.cfg*` — _The Grail-level <<stash,stash>> container, maintained by the framework._
* `*.stash.cfg.md5*` — _The stash integrity checksum, maintained by the framework._

| [[fmwk-state]]+++<p align="center">+++#`~/.divine/*state*/`#+++</p>+++

*The state directory* stores the current state of deployment installations on current system.
_(The entire state directory is maintained by the framework.)_

As this directory is automated and is specific to the machine it is maintained on, it is normally not needed to dive into it manually or version-control it.
Still, this directory might come in handy in some emergency situations.

The state directory is sub-structured as follows:

* `*backups*/` — The directory for the deployment-level <<fmwk-zero-data-loss,backups>>.
* `*bundles*/` — The directory for the copies of <<rtn-attach,attached>> bundles of deployments.
* `*stash*/` — The directory for the key-value containers of the root-level and deployment-level <<stash,stashing>> system.

| [[fmwk-lib]]+++<p align="center">+++#`~/.divine/*lib*/`#+++</p>+++

This directory holds the guts of the framework.
_(The entire directory is, naturally, maintained by the framework.)_

| [[fmwk-script]]+++<p align="center">+++#`~/.divine/*intervene.sh*`#+++</p>+++

The <<iutil-main,*Divine intervention utility*>>.
This script is the command line interface to the framework.
_(The script file is, of course, maintained by the framework.)_

| [[fmwk-shortcut]]+++<p align="center">+++#`_A{us}DIR{us}ON{us}$PATH_/*di*`#+++</p>+++

The shortcut command: a symlink to the framework's <<fmwk-script,main script>>.
This symlink is normally created automatically, during the framework installation.

|===

== Installing and uninstalling the framework

=== System requirements

[[fmwk-os-support]]
* https://en.wikipedia.org/wiki/Unix-like[Unix-like OS].
Following OS distributions are openly supported:
+
--
** *Debian*
** *Fedora*
** *FreeBSD*
** *macOS*
** *Ubuntu*
--
+
[.note]
[%noheader,cols="<.<a"]
|===
| This list is incomplete; you can help by <<cntrb-os-support,expanding it>>.
|===
+
The framework will work on other operating systems too, but without the support for packages (e.g., the <<dfls-main,Divinefiles>> will not work).

* Bash 3.2+ and either `curl` or `wget`.
+
[.note]
[%noheader,cols="<.<a"]
|===
| Git is not a hard requirement, but it is not flaccid either.
_Divine.dotfiles_ can be installed without Git.
However, the framework will then proceed to vex the user with suggestions to auto-install it, until some day the `y` key is finally pressed.
|===

[[fmwk-install]]
=== Installing the framework

The following single shell command installs the _Divine.dotfiles_ framework:

[source,bash]
----
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/install/insta\
ll.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif wget \
--version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> Erro\
r: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || { pr\
intf >&2 \"\n==> Error: failed to download installation script\n\"; rm -f \$TM\
P; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC)) && \
exit 3 || exit 0" bash
----

Equivalently, the framework can be installed from a local copy of this repository (located outside of the installation path) by running this command:

[source,bash]
----
./intervene.sh fmwk-install
----

[.note]
[%noheader,cols="<.<a"]
|===
| The framework installation does nothing too spectacular:

* Optional dependencies — such as Git — will be offered, unless installed already.
* This repository will be cloned/downloaded.
* Optionally, one symlink (<<fmwk-shortcut,`di`>>) to the framework's main script will be created on `$PATH`.
* The zero data loss <<fmwk-zero-data-loss,policy>> will be in effect, as normal.

The script will <<fmwk-interactivity,prompt>> for every major life decision.
|===

The documentation assumes that the framework has been installed with the optional shortcut command <<fmwk-shortcut,`di`>>.
Still, all invocations of the `di` command are equivalent to executing the `./intervene.sh` script in the root of the installation directory.

[[fmwk-install-opts]]
==== Installation options and overrides

.Framework installation options and overrides
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Prepend on the left

| `*D_DIR*=_DIRPATH_`

By default, the framework is installed into the `~/.divine/` directory.
This directs to instead install it into the `_DIRPATH_` directory.

| `*D_SHCT_NAME*=_CMD_`

By default, the <<fmwk-shortcut,shortcut command>> for the framework is named `di`.
This directs to name it `_CMD_` instead.

| `*D_SHCT_DIR*=_DIRPATH_`

By default, the <<fmwk-shortcut,shortcut command>> for the framework is installed into one of the usual `/{das}/bin/` directories on `$PATH`.
This directs to instead install it into the `_DIRPATH_` directory.

^.^h| Append on the right

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the prompts about installing the framework and all optional parts.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
*Framework prompt options*
+++<br>+++
`*-d*`, `*--fmwk-yes*`
+++<br>+++
`*-D*`, `*--fmwk-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about installing the framework.

Other options notwithstanding, *the* `*--fmwk-no*` *option guarantees a 'dry run'*, because no optional parts are installed without the framework itself.

| +++<p align="center">+++
*Shortcut prompt options*
+++<br>+++
`*-s*`, `*--shct-yes*`
+++<br>+++
`*-S*`, `*--shct-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about installing the <<fmwk-shortcut,shortcut command>>.

| +++<p align="center">+++
`*-f*`, `*--force*`
+++</p>+++

The framework adheres to the non-interference <<fmwk-non-interference, policy>>.

If the destination path for the framework already exists and is not an empty directory, the installation unconditionally backs off with an alert.

The `--force` option directs to instead <<fmwk-upmt,urgently>> prompt the user and, if given permission, to displace the pre-existing destination to a backup location.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of installation output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

Note, that no combination of options guarantees an unattended installation of the framework.
For example, when installing the optional Git dependency, the underlying package manager may interact with the user in ways that are outside of the script's control.
As established before, _Divine.dotfiles_ is intended as an <<fmwk-interactivity,interactive>> tool.

[[fmwk-uninstall]]
=== Uninstalling the framework

The following single shell command uninstalls the _Divine.dotfiles_ framework:

[source,bash]
----
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/uninstall/uni\
nstall.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif w\
get --version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> \
Error: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || \
{ printf >&2 \"\n==> Error: failed to download uninstallation script\n\"; rm -\
f \$TMP; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC\
)) && exit 3 || exit 0" bash
----

Equivalently, the framework can be uninstalled from a local copy of this repository (located anywhere) by running this command:

[source,bash]
----
./intervene.sh fmwk-uninstall
----

Also, an existing installation of _Divine.dotfiles_ may be directed to uninstall itself:

[source,bash]
----
di fmwk-uninstall
----

[.note]
[%noheader,cols="<.<a"]
|===
| The framework uninstallation plays out like this:

* Optional dependencies that have been installed will be offered for removal.
* The installation directory will be displaced (backed up) according to the zero data loss <<fmwk-zero-data-loss,policy>>.
* The optional symlink (<<iutil-main,`di`>>) will be erased.

The script will <<fmwk-interactivity,prompt>> for every major life decision.
|===

One thing that framework uninstallation does *_not_* do is uninstall deployments.
Any deployments that might have been installed *_must be removed manually_* before uninstalling Divine.dotfiles. 

[[fmwk-uninstall-opts]]
==== Uninstallation options and overrides

.Framework uninstallation options and overrides
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Prepend on the left

| `*D_DIR*=_DIRPATH_`

By default, the framework is uninstalled from the `~/.divine/` directory.
This directs to instead uninstall it from the `_DIRPATH_` directory.

^.^h| Append on the right

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the prompts about uninstalling the framework and all optional parts.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
*Framework prompt options*
+++<br>+++
`*-d*`, `*--fmwk-yes*`
+++<br>+++
`*-D*`, `*--fmwk-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about uninstalling the framework.

Other options notwithstanding, *the* `*--fmwk-no*` *option guarantees a 'dry run'*, because no optional parts are uninstalled without the framework itself.

| +++<p align="center">+++
*Optional dependency prompt options*
+++<br>+++
`*-u*`, `*--util-yes*`
+++<br>+++
`*-U*`, `*--util-no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer specifically to the prompt about uninstalling the optional dependencies that might have been installed.

| +++<p align="center">+++
`*-f*`, `*--force*`
+++</p>+++

The framework adheres to the reversibility <<fmwk-reversibility, policy>>.

If the script fails to uninstall any of the optional dependencies, the installation unconditionally backs off with an alert.

The `--force` option directs to instead <<fmwk-upmt,urgently>> prompt the user and, if given permission, to ignore the debacle and uninstall the framework anyway.

| +++<p align="center">+++
`*-o*`, `*--obliterate*`
+++</p>+++

The framework adheres to the zero data loss <<fmwk-zero-data-loss, policy>>.

Accordingly, during the uninstallation of the framework, its directory is displaced into a backup location.

The `--obliterate` option directs to instead erase the framework directory.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of uninstallation output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

Note, that no combination of options guarantees an unattended uninstallation of the framework.
As established before, _Divine.dotfiles_ is intended as an <<fmwk-interactivity,interactive>> tool.

[[fmwk-joy-ride]]
=== Joy ride

The following single shell command provides a removable introductory experience of the framework and deployments.

[source,bash]
----
bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/install/insta\
ll.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif wget \
--version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> Erro\
r: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || { pr\
intf >&2 \"\n==> Error: failed to download installation script\n\"; rm -f \$TM\
P; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC)) && \
exit 3 || exit 0" bash --yes \
&& ~/.divine/intervene.sh attach essentials --yes \
&& ~/.divine/intervene.sh install --yes
----

[.note]
[%noheader,cols="<.<a"]
|===
| The joy-ride command is three-pronged:

* The framework will be <<fmwk-install,installed>>.
* The https://github.com/no-simpler/divine-bundle-essentials[`essentials`] bundle of Divine deployments will be attached to the freshly minted <<fmwk-grail,Grail directory>>.
* All bundled deployments will be installed.

No framework <<fmwk-interactivity,prompts>> will be issued.
|===

As stated before, both the Divine framework and deployments <<fmwk-zero-data-loss,do not overwrite>> pre-existing files on the system without backing them up.
Everything that is backed up is <<fmwk-reversibility,automatically restored>> upon the removal of deployments.

After all installations are successful, it is necessary to *reload the shell/terminal* (or re-log into the system on macOS).

==== What it does

Once the bundle is fully installed, and the shell reloaded, _voilà_:

* https://sourceforge.net/projects/zsh[Zsh] is the default shell.
* Zsh is supercharged with https://github.com/zsh-users/zsh-completions[completions], https://github.com/zsh-users/zsh-syntax-highlighting[syntax highlighting], and https://github.com/zsh-users/zsh-autosuggestions[auto-suggestions].
* Basic necessities, such as https://git-scm.com[Git], https://www.vim.org[Vim], and https://gnupg.org[GnuPG] are available.
* Both https://ohmyz.sh[oh-my-zsh] and https://github.com/Bash-it/bash-it[Bash-it] frameworks are installed and loaded.
* A minimalistic theme for both shell frameworks is active.
* Opinionated configs are plugged in for Git, Vim, Bash, and Zsh.
* Pre-existing files and installations are safely backed up or re-used.

All of the above is controlled and customized through key configuration files located in the <<fmwk-grail,Grail directory>> at `~/.divine/grail/assets/`.

.Overview of asset directories for the bundle `essentials`
[%noheader,cols="<.<a,<.<a",stripes=none]
|===

| `*bash-it*/` *&dagger;*
| Custom assets for the https://github.com/Bash-it/bash-it[Bash-it] shell framework.

| `*brewfile*/` *&dagger;*
| The https://github.com/Homebrew/homebrew-bundle[Brewfile], maintained on macOS.

| `*config-git*/`
| Global configuration for Git.

| `*config-shell*/`
| Startup scripts (https://en.wikipedia.org/wiki/Run_commands[runcoms]) for Bash and Zsh.

| `*config-vim*/`
| Global configuration for Vim.

| `*home-dirs*/` *&dagger;*
| The file `*home-dirs.cfg*` defines a sub-directory tree, to be maintained under the home directory.

| `*oh-my-zsh*/` *&dagger;*
| Custom assets for the https://ohmyz.sh[oh-my-zsh] shell framework.

| `*portable-bin*/`
| Container for personal executables (maintained on `$PATH`).

|===

[.note]
[%noheader,cols="<.<a"]
|===
| The dagger *&dagger;* mark meaning: in order for the modifications in that asset directory to take effect, the deployment must be (re-)installed.
|===

==== Cleaning up

The following single shell command methodically undoes all of the <<fmwk-joy-ride,joy ride>> installation:

[source,bash]
----
~/.divine/intervene.sh remove --yes --obliterate \
&& ~/.divine/intervene.sh detach essentials --yes \
&& bash -c "TMP=\$(mktemp); \
URL=https://raw.github.com/no-simpler/divine-dotfiles/master/lib/uninstall/uni\
nstall.sh; if curl --version &>/dev/null; then curl -fsSL \$URL >\$TMP; elif w\
get --version &>/dev/null; then wget -qO \$TMP \$URL; else printf >&2 \"\n==> \
Error: failed to detect neither curl nor wget\n\"; rm -f \$TMP; exit 1; fi || \
{ printf >&2 \"\n==> Error: failed to download uninstallation script\n\"; rm -\
f \$TMP; exit 2; }; chmod +x \$TMP && \$TMP \"\$@\"; RC=\$?; rm -f \$TMP; ((RC\
)) && exit 3 || exit 0" bash --yes --obliterate
----

[.note]
[%noheader,cols="<.<a"]
|===
| The reverse joy-ride command is also three-pronged:

* All bundled deployments will be uninstalled, without keeping backups of their assets.
* The https://github.com/no-simpler/divine-bundle-essentials[`essentials`] bundle of Divine deployments will be detached (deleted).
* The framework will be <<fmwk-uninstall,uninstalled>>, without keeping a backup copy.

No framework <<fmwk-interactivity,prompts>> will be issued.
|===

After the 'undo' steps have successfully run, there is no trace of _Divine.dotfiles_ on the system.
[.small]#_(Sigh.)_#

== Usage

[[iutil-main]]
=== Divine intervention utility `di`

_Divine.dotfiles_ provides a command line interface via *Divine intervention utility `di`*.
(Invoking the shortcut <<fmwk-shortcut,`di`>> is equivalent to executing the framework's main script, <<fmwk-script,`intervene.sh`>>.)

[source,subs="verbatim,quotes,attributes"]
----
*di* [-efhlnoqvwy]… [-version] [-b *_BUNDLE_*]… [--] *_ROUTINE_* [*_ARG_*]…
----

The first non-option argument, `*_ROUTINE_*`, can be any of the following:

.List of the intervention utility's routines
[%noheader,cols="<.<a",stripes=none]
|===

| The <<rtn-primaries,*primary routines*>>, operating on deployments:

* `*c*{vbar}<<rtn-check,*check*>>` — checks whether deployments are installed or not;
* `*i*{vbar}<<rtn-install,*install*>>` — checks, then, if not installed, installs;
* `*r*{vbar}<<rtn-remove,*remove*>>` — checks, then, if installed, removes.

| The <<rtn-bundles,*bundle routines*>>, operating on Github repositories:

* `*a*{vbar}<<rtn-attach,*attach*>>` — imports Github repositories that contain deployments.
* `*d*{vbar}<<rtn-detach,*detach*>>` — erases previously attached Github repositories.

| The routine that wrangles the <<fmwk-grail,Grail directory>>:

* `*p*{vbar}<<rtn-plug,*plug*>>` — replaces the current Grail directory with the one provided.

| The routine that brings what it can up to date:

* `*u*{vbar}<<rtn-update,*update*>>` — updates the framework itself, the Grail directory (if it is a cloned repository), and the attached bundles.

|===

[.note]
[%noheader,cols="<.<a"]
|===
| The term '<<dpls-main,deployments>>' includes <<dfls-main,Divinefiles>> as a special kind.
|===

[[iutil-arg-parsing]]
=== Options and arguments

The intervention routines, and the _Divine.dotfiles_ overall, use a familiar set of rules for taking options and arguments:

* The options and arguments are read left-to-right, word by word, separated by any unescaped whitespace.
+
Whenever options override each other, the last option given wins.
In the documentation, the overriding options have their descriptions grouped.
* Most options have single-character and long versions, which are equivalent.
* The single-character options can be combined (`-_CHARS_`).
+
Words that start with one hyphen are interpreted as combined options.
* Words that start with two hyphens (`--_WORD_`) are interpreted as long options.
* The arguments and options can be freely mixed; all words after the optional separator (`*--*`) are interpreted as arguments.
* The two special options take priority over all other arguments/options:
** `*-h*`, `*--help*` — outputs the help summary for the intervention utility.
** `*--version*` — prints the version of the framework.

[[rtn-primaries]]
=== Primary routines (`check`, `install`, `remove`)

The three primary routines somewhat correspond to the three fundamental actions (functions) that the framework recognizes for any deployment:

* checking whether something is installed;
* installing it;
* and removing it.

The correspondence is not strictly one-to-one because all three primary routines do the checking part.
The <<rtn-check,`check`>> routine stops there, but the <<rtn-install,`install`>> and <<rtn-remove,`remove`>> routines proceed based on the `check` result.

[[rtn-check]]
==== `check` routine

The `check` routine iterates over deployments (and Divinefile packages), ordered by *ascending* <<dpls-metadata,priority>> (smaller numbers first).
The routine checks whether each item is installed or not, then prints the appropriate plaque.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-efhnoqvwy] [-b *_BUNDLE_*]… [--] *c*|*check* [*_NAME_*]…
----

The meaning of the optional `*_NAME_*` <<rtn-primaries-args,arguments>> and the <<rtn-primaries-opts,options>> is near identical for all three primary routines.
Their description is grouped below.

For each deployment, the `check` routine calls the <<func-dpl-check,`d_dpl_check`>> primary function, and deduces the current status from the return code.

[[rtn-install]]
==== `install` routine

The `install` routine iterates over deployments (and Divinefile packages), ordered by *ascending* <<dpls-metadata,priority>> (smaller numbers first).
The routine checks whether each item is installed or not.
If the item is not (fully) installed, the routine installs it, and prints the appropriate plaque.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-efhnoqvwy] [-b *_BUNDLE_*]… [--] *i*|*install* [*_NAME_*]…
----

The meaning of the optional `*_NAME_*` <<rtn-primaries-args,arguments>> and the <<rtn-primaries-opts,options>> is near identical for all three primary routines.
Their description is grouped below.

For each deployment, the `install` routine calls the <<func-dpl-check,`d_dpl_check`>> primary function, and deduces the current status from the return code.
Depending on that, the routine either returns immediately, or calls the <<func-dpl-install,`d_dpl_install`>> primary function.
The return code of the latter is taken to indicate whether the installation succeeded.

[[rtn-remove]]
==== `remove` routine

The `remove` routine iterates over deployments (and Divinefile packages), ordered by *descending* <<dpls-metadata,priority>> (larger numbers first).
The routine checks whether each item is installed or not.
If the item is (at least in some part) previously installed, the routine removes it, and prints the appropriate plaque.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-efhnoqvwy] [-b *_BUNDLE_*]… [--] *r*|*remove* [*_NAME_*]…
----

The meaning of the optional `*_NAME_*` <<rtn-primaries-args,arguments>> and the <<rtn-primaries-opts,options>> is near identical for all three primary routines.
Their description is grouped below.

For each deployment, the `remove` routine calls the <<func-dpl-check,`d_dpl_check`>> primary function, and deduces the current status from the return code.
Depending on that, the routine either returns immediately, or calls the <<func-dpl-remove,`d_dpl_remove`>> primary function.
The return code of the latter is taken to indicate whether the removal succeeded.

[[rtn-primaries-args]]
==== Specifying deployments

For the optional `*_NAME_*` arguments, the following (case-insensitive) values are accepted:

* <<dpls-metadata,Names>> of <<dpls-main,deployments>>.
* Reserved synonyms for <<dfls-main,Divinefiles>>: `divinefile`, `dfile`, `df`.
* Single-digit names of <<mtdt-groups,deployment groups>>: `0`, `1`, `2`, `3`, `4`, `5`, `6`, `7`, `8`, `9`.

The primary routines filter the deployments according to these rules:

* Without any `*_NAME_*` arguments, all deployments are processed.
* With at least one `*_NAME_*` argument, some form of filtering is applied:
** In the *normal filtering*, a deployment is processed if and only if it is requested by name or by name of its <<mtdt-groups,single-digit group>>.
** The <<opt-except,`--except`>> option makes the filtering *inverted*: all deployments are processed, *unless* requested by name or by name of its <<mtdt-groups,single-digit group>>.
+
Note, that without any `*_NAME_*` arguments, the <<opt-except,`--except`>> option is a no-opt.

<<mtdt-exclam,Dangerous>> deployments are treated specially:

* A dangerous deployment is ignored by both filtering modes, *unless* it is requested by name in the normal filtering.
+
Note, that requesting by name of the <<mtdt-groups,single-digit group>> does not work for dangerous deployments.
* The <<opt-with-exclam,`--with-!`>> option prevents any special treatment of dangerous deployments.

Deployments are retrieved from two directories (at any depth):

* The directory for user's deployments: `<<fmwk-grail,grail>>/dpls/`.
* The directory for attached bundles of deployments: `<<fmwk-state,state>>/bundles/`.

The search can be narrowed down to particular bundles of deployments by including any number of the <<opt-bundle,`--bundle`>> options.

[[rtn-primaries-opts]]
==== Primary routine options

The run-time state of all options can be inspected within the deployment code through their corresponding read-only global variables.

The Divine <<divine-bundles,bundles>> of deployments follow the given interpretation of the options, as well as the framework's <<fmwk-design,design>> in general.
A 'good' deployment is expected to follow suit.

.Primary routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[opt-answers]][[opt-yes]][[opt-no]]*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before sourcing (reading and interpreting) each deployment script.
* A confirmation before installing an optional framework dependency.

Examples of the <<fmwk-upmt,urgent>> prompts, which are *not* affected by the prompt options:

* A confirmation before undertaking a <<opt-force,forced>> action.
* Any prompt in the user-defined deployment code, unless it is specifically made to honor this option.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no user code will be sourced, and no changes to the system will be introduced.

The status of the prompt options is reflected in the value of the `$*D__OPT_ANSWER*` variable:

* `true` — the `--yes` option is active;
* `false` — the `--no` option is active;
* _empty_ — none of the prompt options have been given.

| +++<p align="center">+++
[[opt-obliterate]]`*-o*`, `*--obliterate*`
+++</p>+++

The framework adheres to the zero data loss <<fmwk-zero-data-loss, policy>>.

Whenever a built-in framework mechanism is not sure whether a particular piece of data is recoverable, it chooses to displace it to a backup location instead of deleting it.

The `--obliterate` option directs to instead erase such data.

The presence of the `--obliterate` option is reflected in the value of the `$*D__OPT_OBLITERATE*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-force]]`*-f*`, `*--force*`
+++</p>+++

The framework adheres to the non-interference <<fmwk-non-interference, policy>>.

During the <<rtn-install,`install`>> and <<rtn-remove,`remove`>> routines, if the `check` <<rtc-check,code>> speaks to a clash with something done by the user or the operating system (e.g., a previously installed file is nowhere to be found), the framework unconditionally backs off with an alert.

The `--force` option directs to instead <<fmwk-upmt,urgently>> prompt the user and, if given permission, carry out the installation/removal anyway.

The presence of the `--force` option is reflected in the value of the `$*D__OPT_FORCE*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-bundle]]`*-b* _BUNDLE_`, `*--bundle* _BUNDLE_` _(repeatable)_
+++</p>+++

If at least one such option is included, the search for deployments will be limited to the given <<rtn-attach,attached>> bundles of deployments.

The same values are accepted for the `_BUNDLE_` arguments as are for the <<rtn-bundles-args,`_REPO_`>> arguments during the <<rtn-bundles,bundle routines>>.

The list of requested bundles (if any) is reflected in the items of the `${*D__REQ_BUNDLES*[@]}` array.

| +++<p align="center">+++
[[opt-except]]`*-e*`, `*--except*`
+++</p>+++

The primary routines <<rtn-primaries-args,interpret>> the optional `*_NAME_*` arguments as a list of deployments to process.
The `--except` option directs to instead interpret the arguments as the list of deployments to exclude from processing.

The presence of the `--except` option is reflected in the value of the `$*D__OPT_INVERSE*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-with-exclam]]`*-w*`, `*--with-!*`
+++</p>+++

The primary routines <<rtn-primaries-args,interpret>> the <<mtdt-exclam,dangerous>> deployments (marked with the `!` flag) specially by making them harder to accidentally process.
The `--with-!` option directs to instead give them no special treatment at all.

The presence of the `--with-!` option is reflected in the value of the `$*D__OPT_EXCLAM*` variable:

* `true` — the option is given;
* `false` — the option is not given.

| +++<p align="center">+++
[[opt-verbosity]][[opt-verbose]][[opt-quiet]]*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.

Every instance of the `--verbose` option increments by one the *global verbosity level* of the framework.
On the other hand, the framework's printing functions have the comparable *quiet level*.
For a message to be printed, the global verbosity level must be greater than or equal to that message's quiet level.

The `--quiet` option reverts the global verbosity level to its default value of zero.

The amount of output per the verbosity level can be described as such:

* `-q` — prints just the essentials and the critical alerts;
* `-v` — allows some non-critical alerts here and there;
* `-vv` — also, announces the internal context switches;
* `-vvv` — enters into the serious debugging mode;
* `-vvvv` — just floods the user with everything it has.
+
Further verbosity levels are yet unused by the framework.

The global verbosity level is reflected in the value of the `$*D__OPT_VERBOSITY*` variable, which is a non-negative integer.

|===

[[rtn-bundles]]
=== Bundle routines (`attach`, `detach`)

The framework treats any Github repository containing <<dpls-main,deployments>> as *bundles* of deployments.

When a bundle is *attached* to the particular <<fmwk-grail,Grail directory>>, its address is stored in the Grail <<stash,stash>>, while a copy of the repository is pulled into the <<fmwk-state,state directory>>.
This way, the attached deployments are treated as if they are in the Grail, but the directory itself is not unnecessarily bloated.

On every invocation, the <<iutil-main, intervention utility>> synchronizes the stashed list of attached bundles with the copies in the state directory.
Thus, transfering the Grail directory alone to another machine is enough to fully re-create the set of deployments.

The two bundle routines do what one might expect:

* <<rtn-attach,attaching>> a bundle;
* <<rtn-detach,detaching>> the previously attached bundle.

[[rtn-attach]]
==== `attach` routine

The `attach` routine takes any number of repository handles, ensures that they correspond to existing Github repositories containing deployments, and attaches each that does.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-yn]… [--] *a*|*attach* [*_REPO_*]…
----

The meaning of the optional `*_REPO_*` <<rtn-bundles-args,arguments>> and the <<rtn-bundles-opts,options>> is identical for both bundle routines.
Their description is grouped below.

[[rtn-detach]]
==== `detach` routine

The `detach` routine takes any number of repository handles, ensures that they are currently attached to the Grail directory, and detaches those that are.
Both the 

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-yn]… [--] *d*|*detach* [*_REPO_*]…
----

The meaning of the optional `*_REPO_*` <<rtn-bundles-args,arguments>> and the <<rtn-bundles-opts,options>> is identical for both bundle routines.
Their description is grouped below.

Detaching a bundle deletes the copy of its repository, as well as the stash record.
However, it is left to the user to:

* Uninstall the deployments.
+
(If a lapse occurred, re-attaching and uninstalling should work fine.)
* Remove any assets that might have been copied into the <<fmwk-grail,Grail>>'s asset directory.

[[rtn-bundles-args]]
==== Specifying bundles

For the optional `*_REPO_*` arguments, the following (case-insensitive) values are accepted:

* A Github repository in the form: `username/repository`.
* Specifically for the <<divine-bundles,Divine bundles>>, a shorthand is accepted:
+
[source,subs="verbatim,quotes,attributes"]
----
*_REPO_*  =>  no-simpler/divine-bundle-*_REPO_*
----
+
(`*_REPO_*` must match the RegEx pattern `^[0-9A-Za-z_.-]+$`.)

[[rtn-bundles-opts]]
==== Bundle routine options

.Bundle routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before attaching or detaching a bundle.
* A confirmation before installing an optional framework dependency.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

[[rtn-plug]]
=== `plug` routine

The <<fmwk-grail,Grail directory>> is the central hub for all user content.
As such, it is the obvious target for version controlling and syncing.

The `plug` routine, unsurprisingly, imports an externally saved Grail directory, replacing the currently existing one.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-ynl] [--] *p*|*plug* *_ADDRESS_*
----

For the `*_ADDRESS_*` argument, the following (case-insensitive) values are accepted:

* A Github repository in the form: `username/repository`.
* A path to a Git repository.
* A path to a local directory.

The framework iterates over possible interpretations of the argument and prompts the user for confirmation.

The repositories are cloned, the directories are copied.
The pre-existing Grail directory is backed up in-place by appending the `.bak` suffix.

==== `plug` routine options

.`plug` routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before interpreting the `*_ADDRESS_*` argument in a particular way.
* A confirmation before installing an optional framework dependency.

With the `--yes` option active, the first viable interpretation of the `*_ADDRESS_*` argument will be silently settled upon.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
`*-o*`, `*--obliterate*`
+++</p>+++

The framework adheres to the zero data loss <<fmwk-zero-data-loss, policy>>.

Accordingly, during the `plug` routine the pre-existing Grail directory is displaced into a backup location.

The `--obliterate` option directs to instead erase the pre-existing Grail.

| +++<p align="center">+++
`*-l*`, `*--link*`
+++</p>+++

Normally, the `plug` routine retrieves a copy of the Grail at the given `*_ADDRESS_*`.

The `--obliterate` option directs to instead create a symlink to it.
Consequently, when the `--obliterate` option is active, the `*_ADDRESS_*` is interpreted only as a local directory.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

[[rtn-update]]
=== `update` routine

There are three parts of a _Divine.dotfiles_ installation that are potentially cloned Git repositories:

* The framework https://github.com/no-simpler/divine-dotfiles[itself].
* The Grail directory (if <<rtn-plug,plugged>> from a repository).
* The <<rtn-bundles,attached>> bundles of deployments.

The update routine is a convenient tool that pulls the latest updates from the remote `master` branches of such repositories.

[source,subs="verbatim,quotes,attributes"]
----
$ *di* [-yn] [--] *u*|*update* [*f*|*framework*] [*g*|*grail*] [*b*|*bundles*]
----

The `update` routine is three-pronged, and the user is free to choose which prongs to engage by providing or not providing arguments:

* `*f*|*framework*` updates the framework.
* `*g*|*grail*` — updates the cloned <<fmwk-grail,Grail directory>>.
* `*b*|*bundles*` — updates all <<rtn-bundles,attached>> bundles of deployments.
* Without any arguments, all three types of updates are performed.

==== `update` routine options

.`update` routine options
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
*Prompt options*
+++<br>+++
`*-y*`, `*--yes*`
+++<br>+++
`*-n*`, `*--no*`
+++</p>+++

Assumes an affirmative (`--yes`) or negatory (`--no`) answer to the non-<<fmwk-upmt,urgent>> framework prompts, e.g.:

* A confirmation before pulling from a remote repository.
* A confirmation before installing an optional framework dependency.

Other options notwithstanding, *the* `*--no*` *option guarantees a 'dry run'*: no changes to the system will be introduced.

| +++<p align="center">+++
`*-b* _BUNDLE_`, `*--bundle* _BUNDLE_` _(repeatable)_
+++</p>+++

If at least one such option is included:

* the presence of `*bundles*` argument is implicitly assumed;
* only the given bundles (if currently <<rtn-attach,attached>>) are updated.

The same values are accepted for the `_BUNDLE_` arguments as are for the <<rtn-bundles-args,`_REPO_`>> arguments during the <<rtn-bundles,bundle routines>>.

| +++<p align="center">+++
*Verbosity options*
+++<br>+++
`*-v*`, `*--verbose*` _(repeatable)_
+++<br>+++
`*-q*`, `*--quiet*`
+++</p>+++

Gradually increases (`--verbose`), or resets to the default minimal level (`--quiet`), the amount of framework output.
This affects the same <<opt-verbosity,global verbosity level>> as is used by the primary routines of the framework.

|===

[[dpls-main]]
== Deployments

A _Divine.dotfiles_ *deployment* is a Bash script with the file name consisting of a non-empty name and the `.dpl.sh` suffix.
No other parts of a deployment are mandatory.

To be picked up by the framework, the deployments must be located at any depth under the two recognized deployment locations:

* `<<fmwk-grail,grail>>/dpls/` — the user's deployments;
* `<<fmwk-state,state>>/bundles/` — the <<rtn-bundles,attached>> bundles of deployments.

=== Deployment structure

The minimal valid deployment is an empty file.
As such, it does nothing but appear in the framework output.

Deployments are written in Bash syntax, with some syntax limitations on the <<dpls-metadata,metadata>>.
Each deployment is sourced by the Bash interpreter no more than once per <<rtn-primaries,primary routine>>.

To be useful, a deployment may contain:

* Implementations of any or all of the <<func-primaries,*primary functions*>>.
* Assignments to the special pseudo-variables — the <<dpls-metadata,*metadata*>>.

It is highly recommended to *not* include any non-trivial Bash code outside of functions.
Nothing will prevent things from going off the rails.
There are <<fmwk-security,*no*>> safety nets.
Unless the intention is very well thought-out, _Divine.dotfiles_ is only useful while the guidelines are followed.

[[func-primaries]]
=== Primary functions (`d_dpl_check`, `d_dpl_install`, `d_dpl_remove`)

The *primary functions*, or *primaries*, correspond to the three fundamental actions performed by a deployment:

* `<<func-dpl-check,*d_dpl_check*>>` — checks whether the deployment is installed or not.
* `<<func-dpl-install,*d_dpl_install*>>` — installs the deployment.
* `<<func-dpl-remove,*d_dpl_remove*>>` — removes (reverses the previous installation of) the deployment.

The primary functions have the following ways of interacting with the framework:

* To 'talk' to the framework:
** The *return* <<rtc-overview,*codes*>> are the main vehicles of indicating status.
** The <<addst-overview,*add-statuses*>> (specially named global variables) are available to tweak the behavior in some places.
* To 'hear' from the framework:
** The <<indct-main,*indicator*>> *variables* are populated by the framework with the relevant run-time data.

[[func-dpl-check]]
==== Primary function `d_dpl_check`

If this function is implemented, it will be called:

* During the <<rtn-check,`check`>> routine — to determine the status and to show the relevant output.
* During the <<rtn-install,`install`>> routine — to determine whether the installation is warranted.
* During the <<rtn-remove,`remove`>> routine — to determine whether the removal is warranted.

The return code of the `d_dpl_check` function determines the current status of the deployment.
(The following summary of the recognized codes is expanded upon in the relevant <<rtc-check,section>>.)

* Basic codes:
** `*0*` — _'Truly unknown'_
+
This code is assumed if the `d_dpl_check` function is not implemented.
** `*1*` — _'Fully installed'_.
** `*2*` — _'Fully not installed'_.
** `*3*` — _'Irrelevant or invalid'_.
* Extended codes:
** `*4*` — _'Partly installed'_.
** `*5*` — _'Likely installed (unknown)'_.
** `*6*` — _'Manually removed (tinkered with)'_.
** `*7*` — _'Fully installed by user or OS'_.
** `*8*` — _'Partly installed by user or OS'_.
** `*9*` — _'Likely not installed (unknown)'_.

Some additional instructions can be passed to the framework via the <<addst-overview,add-status>> variables and the deployment <<dpls-metadata,metadata>>.

[[func-dpl-install]]
==== Primary function `d_dpl_install`

If this function is implemented, it will be called:

* During the <<rtn-install,`install`>> routine — to install the deployment.

The return code of the `d_dpl_install` function describes the outcome of the installation.
(The following summary of the recognized codes is expanded upon in the relevant <<rtc-install,section>>.)

* `*0*` — _'Successfully installed'_
+
This code is assumed if the `d_dpl_install` function is not implemented.
* `*1*` — _'Failed to install'_.
* `*2*` — _'Refused to install'_.
* `*3*` — _'Partly installed'_.

Some additional instructions can be passed to the framework via the <<addst-overview,add-status>> variables and the deployment <<dpls-metadata,metadata>>.

[[func-dpl-remove]]
==== Primary function `d_dpl_remove`

If this function is implemented, it will be called:

* During the <<rtn-remove,`remove`>> routine — to remove the deployment.

The return code of the `d_dpl_remove` function describes the outcome of the removal.
(The following summary of the recognized codes is expanded upon in the relevant <<rtc-remove,section>>.)

* `*0*` — _'Successfully removed'_
+
This code is assumed if the `d_dpl_remove` function is not implemented.
* `*1*` — _'Failed to remove'_.
* `*2*` — _'Refused to remove'_.
* `*3*` — _'Partly removed'_.

Some additional instructions can be passed to the framework via the <<addst-overview,add-status>> variables and the deployment <<dpls-metadata,metadata>>.

[[dpls-metadata]]
=== Deployment metadata

*Deployment metadata* pose as definitions of Bash global variables and alter deployment's appearance and behavior.
In reality, the metadata 'assignments' are read from the file _before_ the Bash interpreter sources it.
In the interests of optimization, *the metadata must be contained in the first 20 non-empty lines of the deployment script*.

* `<<mtdt-name-and-desc,*D_DPL_NAME*>>=_NAME_`
+
The explicit name for the deployment.
The implicit fallback name is the name of the deployment file sans the `.dpl.sh` suffix.
* `<<mtdt-name-and-desc,*D_DPL_DESC*>>="_DESCRIPTION TEXT_"`
+
The one-line description of the deployment.
For the user's eyes only.
* `<<mtdt-priority,*D_DPL_PRIORITY*>>=_PRIORITY_`
+
The priority of the deployment (a non-negative integer).
* `<<mtdt-flags,*D_DPL_FLAGS*>>=_FLAGS_`
+
The single-character flags that cause special treatment.
* `<<mtdt-warning,*D_DPL_WARNING*>>='_WARNING TEXT_'`
+
The one-line cautionary message about this deployment.
This message is printed to the user if and only if the <<mtdt-aa,always-prompt>> flag causes the appearance of an <<fmwk-upmt,urgent>> prompt.

Below is an example of metadata in the head of a deployment script:

[source,subs="verbatim,quotes,attributes"]
----
D_DPL_NAME=example
D_DPL_DESC='An example deployment'
D_DPL_PRIORITY=777
D_DPL_FLAGS=ci!89
D_DPL_WARNING="A warning message"
----

The following syntax limitations are imposed upon metadata:

* As mentioned above, only the first 20 lines of the deployment script are scanned for metadata.
* No more than one 'assignment' must be written per line, without line continuation.
* Bash substitutions, as well as comments, should be avoided.
* In keeping with the Bash syntax, no whitespace is allowed around the `=`.
* A pair of matching quotes around the value is allowed.
Such pair of quotes us stripped in processing.

[[mtdt-name-and-desc]]
==== Deployment name and description

[source,bash]
----
D_DPL_NAME=example
D_DPL_DESC='An example deployment'
----

While the *description* is mostly cosmetic, the *name* of a deployment is very important.
The name is the single unique identifier of every deployment.
If the deployment name is not provided explicitly, the name of the script file is used instead, sans the `.dpl.sh` suffix.

Deployment names are case insensitive.

The following restrictions are imposed upon the deployment names:

* A deployment may not be named `divinefile`, `dfile`, or `df`.
* A deployment name may not be a single digit or a single `!` symbol.
* No two deployments across the deployment directories may share a name.

If any of the naming rules is broken, the framework halts with an alert, even before a <<rtn-primaries,primary routine>> starts.

[[mtdt-priority]]
==== Deployment priority

[source,bash]
----
D_DPL_PRIORITY=777
----

The priority is the way to order the deployments for processing:

* The <<rtn-check,`check`>> and <<rtn-install,`install`>> routines order the deployments by *ascending* priority (smaller numbers first).
* The <<rtn-remove,`remove`>> routine orders the deployments by *descending* <<dpls-metadata,priority>> (larger numbers first).
* The order of deployments with the same priority is undefined.

The priority must be a non-negative integer, otherwise it falls back to *the default value of* `*4096*`.

[[mtdt-flags]]
==== Deployment flags

[source,bash]
----
D_DPL_FLAGS=ci!89
----

The flags alter some of the framework's behavior toward the deployment.

* A flag is a single non-whitespace character.
* Any number of flags can be combined in any order.
* Repeating a flag does not bear any additional significance.
* There is no way to unset a flag, apart from not setting it.
* Unsupported flags are silently ignored.

Below is the exhaustive rundown of supported flags and their effects.

.List of supported deployment flags
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[mtdt-groups]]`*[0-9]*` _(any single digit)_
+++</p>+++

Assigns the deployment to one of the ten single-digit *groups*.
When invoking a <<rtn-primaries,primary routine>>, a group of deployments may be <<rtn-primaries-args,referred>> to by that group's digit, instead of listing the deployment names.

| +++<p align="center">+++
[[mtdt-exclam]]`*!*` _(an exclamation mark)_
+++</p>+++

Marks the deployment as *dangerous*.
The framework ignores dangerous deployments, unless explicitly <<rtn-primaries-args,told>> not to.

| +++<p align="center">+++
[[mtdt-aa]]`*[cira]*` _(any of the four lowercase letters)_
+++</p>+++

These flags engage the *always-prompt* mode for particular <<rtn-primaries,primary routines>>.
An <<fmwk-upmt,urgent>> prompt will appear on the chosen routines, before the deployment script is sourced.

* `*c*` — always prompt during the <<rtn-check,`**c**heck`>> routine.
* `*i*` — always prompt during the <<rtn-install,`**i**nstall`>> routine.
* `*r*` — always prompt during the <<rtn-remove,`**r**emove`>> routine.
* `*a*` — **a**ll of the avove.

|===

[[mtdt-warning]]
==== Deployment warning

[source,bash]
----
D_DPL_WARNING="Warning for 'urgent' prompts forced by a flag"
----

If a deployment has a warning, and the <<mtdt-aa,always-prompt>> mode is engaged, then the warning is printed alongside the <<fmwk-upmt,urgent>> prompt.

[[rtc-overview]]
=== Return codes

The return codes are the main vehicle for communicating to the framework the result of running a <<func-primaries,primary function>>.

The supported return codes have semantic meanings, which affect the human-readable output.
In the case of the <<func-dpl-check,`d_dpl_check`>> function, the `check` code also determines whether the <<rtn-install,`install`>> and <<rtn-remove,`remove`>> routines proceed with their task.
Guidelines are provided for how to interpret the various `check` codes in the user-defined deployment code.

Finally, most of the extended `check` codes represent an unusual situation which causes the framework to unconditionally back off from the deployment, with an alert.
This is in keeping with the framework's non-interference <<fmwk-non-interference,policy>>.
The <<opt-force,`--force`>> option may be used to compel the framework.

[[rtc-check]]
==== `check` codes

The four <<rtc-check-basic,basic>> `check` codes are the bread & butter that can satisfy most deployment needs.
A set of <<rtc-check-extended,`extended`>> `check` codes is provided for those deployments that use the <<stash,stashing>> system to 'remember' the status of the installation between interventions.

.Supported return codes of the `d_dpl_check` function
[%noheader.stretch,cols="5*^.^a,4*<.^a",stripes=none]
|===

1.3+^.^h| `check` code
1.3+^.^h| Meaning
3.1+^.^h| Sub-statuses
4.1+^.^h| Actions during the <<rtn-primaries,primary routines>>
1.2+^.^h| Relevant?
1.2+^.^h| <<stash,Stash>> record?
1.2+^.^h| Appears installed?
2.1+^.^h| <<rtn-install,`*install*`>>
2.1+^.^h| <<rtn-remove,`*remove*`>>
^.^h| Regular
^.^h| <<opt-force,Forced>>
^.^h| Regular
^.^h| <<opt-force,Forced>>

9.1+h| [[rtc-check-basic]]Basic codes

| `*0*`
| 'Truly unknown'
| *Yes*
| _unused_
| _unknown_
2.1+| * Push backup
* Install
2.1+| * Uninstall
* Pop backup

| `*1*`
| 'Fully installed'
| *Yes*
| *Yes*
/
_unused_
| *Yes*
^.^h| _blocked_
| * Push backup
* Install anew

+++<p align=center>+++_— or —_+++</p>+++

* Bring up to date
2.1+| * Uninstall
* Pop backup
* Clear stash

| `*2*`
| 'Fully not installed'
| *Yes*
| No
/
_unused_
| No
2.1+| * Push backup
* Install
* Set stash
^.^h| _blocked_
| * Pop backup

| `*3*`
| 'Irrelevant or invalid'
| No
2.1+^.^h| _n/a_
4.1+^.^h| _blocked_

9.1+h| [[rtc-check-extended]]Extended codes

| `*4*`
| 'Partly installed'
| *Yes*
| *Yes*
/
_unused_
| **Par**tly
| * Make us whole
| * Push backup
* Install anew
2.1+| * Uninstall
* Pop backup
* Clear stash

| `*5*`
| 'Likely installed (unknown)'
| *Yes*
| *Yes*
| _unknown_
^.^h| _blocked_
| * Push backup
* Install anew

+++<p align=center>+++_— or —_+++</p>+++

* Bring up to date
^.^h| _blocked_
| * Uninstall
* Pop backup
* Clear stash

| `*6*`
| 'Manually removed (tinkered with)'
| *Yes*
| *Yes*
| No
^.^h| _blocked_
| * Push backup
* Install anew
^.^h| _blocked_
| * Clear stash

| `*7*`
| 'Fully installed by user or OS'
| *Yes*
| No
| *Yes*
^.^h| _blocked_
| * Push backup
* Install anew
* Set stash
^.^h| _blocked_
| * Uninstall
* Pop backup

| `*8*`
| 'Partly installed by user or OS'
| *Yes*
| No
| **Par**tly
| * Make whole
* Set stash
| * Push backup
* Install anew
* Set stash
^.^h| _blocked_
| * Uninstall
* Pop backup

| `*9*`
| 'Likely not installed (unknown)'
| *Yes*
| No
| _unknown_
^.^h| _blocked_
| * Push backup
* Install
* Set stash
^.^h| _blocked_
| * Pop backup

|===

[[rtc-install]]
==== `install` codes

The `install` codes are much less diversified than the <<rtc-check,`check` codes>> because no major internal decisions are made based on the result of the installation.

.Supported return codes of the `d_dpl_install` function
[%noheader.stretch,cols="2*^.^a,1*<.^a",stripes=none]
|===

^.^h| `install` code
^.^h| Meaning
^.^h| Elaboration

| `*0*`
| 'Successfully installed'
| The function has run without any errors.

| `*1*`
| 'Failed to install'
| There has been at least one error, which potentially created an inconsistent state.

| `*2*`
| 'Refused to install'
| The function has returned before proceeding to the installation proper.

| `*3*`
| 'Partly installed'
| The function has returned midway (because of an error), but has avoided creating an inconsistent state.

|===

[[rtc-remove]]
==== `remove` codes

The `remove` codes are much less diversified than the <<rtc-check,`check` codes>> because no major internal decisions are made based on the result of the removal.

.Supported return codes of the `d_dpl_remove` function
[%noheader.stretch,cols="2*^.^a,1*<.^a",stripes=none]
|===

^.^h| `remove` code
^.^h| Meaning
^.^h| Elaboration

| `*0*`
| 'Successfully removed'
| The function has run without any errors.

| `*1*`
| 'Failed to remove'
| There has been at least one error, which potentially created an inconsistent state.

| `*2*`
| 'Refused to remove'
| The function has returned before proceeding to the removeation proper.

| `*3*`
| 'Partly removed'
| The function has returned midway (because of an error), but has avoided creating an inconsistent state.

|===

[[addst-overview]]
=== Add-statuses

The *add-statuses* are the specially named global variables.
The framework clears the add-statuses before running a <<func-primaries,primary function>>, and after running it — checks if the add-statuses contain (supported) values.
The value assigned to an add-status changes the behavior of the framework.

.Supported add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Add-statuses in <<func-primaries,primary functions>>

| +++<p align="center">+++
`*D_ADDST_PROMPT*`
+++</p>+++

If set to `true`, forces an <<fmwk-upmt,urgent>> prompt before installation/removal.

Naturally, this add-status only makes sense when set in the <<func-dpl-check,`d_dpl_check`>> function during the <<rtn-install,`install`>> or <<rtn-remove,`remove`>> routines.

| +++<p align="center">+++
`*D_ADDST_HALT*`
+++</p>+++

If set to `true`, forces halting of the current <<rtn-primaries,primary routine>>.
No further deployments will be processed.

| +++<p align="center">+++
*Output add-statuses*
+++<br>+++
`*D_ADDST_ATTENTION*`, `*D_ADDST_HELP*`,
+++<br>+++
`*D_ADDST_WARNING*`, `*D_ADDST_CRITICAL*`
+++</p>+++

The following output add-statuses may be set to a string or array thereof.
If set, their messages will be printed to the user with appropriate styling.

* `*D_ADDST_ATTENTION*` — non-critical alerts to the user.
* `*D_ADDST_HELP*` — calls for user's involvement (e.g., requests to reboot the machine).
* `*D_ADDST_WARNING*` — grave warnings to the user.
* `*D_ADDST_CRITICAL*` — critical failures.

Other than printing the styled message, these add-statuses do nothing.

|===

[[indct-main]]
=== Indicator variables

An *indicator variable* (or simply an *indicator*) is a global variable that is populated by the framework at run-time with the intention of providing potentially useful information to the deployment code.

The indicator variables are read-only in spirit.
However, due to practical limitations, they are not always protected from writing using the Bash's `readonly` mechanism.
Please, enjoy responsibly.

.List of indicator variables
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
[[indct-dpl-check-code]]*Deployment check code indicator*
+++<br>+++
`*D{dus}DPL_CHECK_CODE*`
+++</p>+++

This indicator contains the integer check <<rtc-check,code>> returned by the <<func-dpl-check,`d_dpl_check`>> primary function.
Naturally, this indicator is only available to the <<func-dpl-install,`d_dpl_install`>> and <<func-dpl-remove,`d_dpl_remove`>> primary functions.

| +++<p align="center">+++
[[indct-dpl-is-forced]]`*D{dus}DPL_IS_FORCED*`
+++</p>+++

In the <<func-dpl-install,`install`>> and <<func-dpl-remove,`remove`>> primary functions, this indicator reflects whether the current deployment is being <<opt-force,forced>>.
If set to `true`, this indicator tells that the installation/removal would not have been run if the `--force` option weren't provided.

Possible values: `true` / `false`.

| +++<p align="center">+++
[[indct-os]][[indct-os-family]][[indct-os-distro]][[indct-os-pkgmgr]]*Current OS indicators*
+++<br>+++
`*D{dus}OS_FAMILY*`
+++<br>+++
`*D{dus}OS_DISTRO*`
+++<br>+++
`*D{dus}OS_PKGMGR*`
+++</p>+++

These indicators describe the current operating system as detected by the built-in framework mechanisms.
All are declared `readonly`.

* `*D__OS_FAMILY*` — the broad description of the current OS family.
+
The framework does not start up unless it detects one of the following OS families:
+
--
** `bsd` — https://en.wikipedia.org/wiki/List_of_BSD_operating_systems[BSD descendants]
** `cygwin` — https://en.wikipedia.org/wiki/Cygwin[Cygwin]
** `linux` — https://en.wikipedia.org/wiki/Linux[Linux]
** `macos` — https://en.wikipedia.org/wiki/MacOS[macOS]
** `msys` — https://en.wikipedia.org/wiki/MinGW[Minimalist GNU for Windows]
** `solaris` — https://en.wikipedia.org/wiki/Solaris_(operating_system)[Oracle Solaris]
** `wsl` — https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux[Windows Subsystem for Linux]
--
+
It should be noted, that `linux` and `wsl` are separate entries.
* `*D__OS_DISTRO*` — the best guess on the name of the current OS distribution:
+
--
** `debian`
** `fedora`
** `freebsd`
** `macos`
** `ubuntu`
** _empty_ — failed to reliably detect a supported distribution
--
+
The <<fmwk-os-support,system requirements>> always show the list of supported operating systems and ways to <<cntrb-os-support,expand it>>.
* `*D__OS_PKGMGR*` — the name of the supported package manager on the current OS:
+
--
** `apt-get`
** `brew`
** `dnf`
** `pkg`
** `yum`
** _empty_ — failed to reliably detect a supported package manager
--
+
Whenever this variable is not empty, the built-in package manager wrapper, <<func-os-pkgmgr,`d__os_pkgmgr`>>, is available.

| +++<p align="center">+++
[[indct-dpl-dir]][[indct-dpl-asset-dir]][[indct-dpl-backup-dir]]*Special directory indicators*
+++<br>+++
`*D{dus}DPL_DIR*`
+++<br>+++
`*D{dus}DPL_ASSET_DIR*`
+++<br>+++
`*D{dus}DPL_BACKUP_DIR*`
+++</p>+++

These indicators contain the absolute paths to the deployment's special directories.
All are declared `readonly`.

* `*D__DPL_DIR*` — the directory containing the deployment file.
* `*D__DPL_ASSET_DIR*` — the directory generated for the deployment's assets.
+
Located at: `<<fmwk-grail,grail>>/assets/<<mtdt-name-and-desc,_DPL-NAME_>>/`
* `*D__DPL_BACKUP_DIR*` — the directory generated for the deployment's backups.
+
Located at: `<<fmwk-state,state>>/backups/<<mtdt-name-and-desc,_DPL-NAME_>>/`

| +++<p align="center">+++
[[indct-dpl-path]][[indct-dpl-mnf-path]][[indct-dpl-que-dir]]*Special path indicators*
+++<br>+++
`*D{dus}DPL_SH_PATH*`
+++<br>+++
`*D{dus}DPL_MNF_PATH*`
+++<br>+++
`*D{dus}DPL_QUE_PATH*`
+++</p>+++

These indicators contain the absolute paths to the deployment's special files.
All are declared `readonly`.

* `*D__DPL_SH_PATH*` — the deployment file itself.
* `*D__DPL_MNF_PATH*` — the path where the deployment's <<asset-manifests,asset manifest>> will be looked up.
+
The same as the deployment's filepath, with the `.dpl.sh` suffix changed to `.dpl.mnf`.
* `*D__DPL_QUE_PATH*` — the path where the deployment's <<queue-manifests,queue manifest>> will be looked up.
+
The same as the deployment's filepath, with the `.dpl.sh` suffix changed to `.dpl.que`.
+
This path in particular can be overridden with an <<addst-queue-mnf,add-status>>.
However, the override will _not_ be reflected in the indicator.

| +++<p align="center">+++
*Deployment <<dpls-metadata,metadata>> indicators*
+++<br>+++
`*D{dus}DPL_NAME*`, `*D{dus}DPL_DESC*`, `*D{dus}DPL_PRIORITY*`, 
+++<br>+++
`*D{dus}DPL_FLAGS*`, `*D{dus}DPL_WARNING*`
+++</p>+++

Since the deployment <<dpls-metadata,metadata>> 'assignments' are technically Bash assignments too, they are available to the deployment code.

| +++<p align="center">+++
*Option indicators*
+++<br>+++
`*D{dus}OPT_ANSWER*`, `*D{dus}OPT_OBLITERATE*`, `*D{dus}OPT_FORCE*`, 
+++<br>+++
`*D{dus}OPT_INVERSE*`, `*D{dus}OPT_EXCLAM*`, `*D{dus}OPT_VERBOSITY*`
+++</p>+++

The *option indicators* reflect the run-time state of the <<rtn-primaries-opts,options>>, provided to the <<rtn-primaries,primary routine>>.

The option indicators are declared `readonly` with the following possible values:

* `*D__OPT_ANSWER*` — `true` / `false` / _empty_.
* `*D__OPT_OBLITERATE*` — `true` / `false`.
* `*D__OPT_FORCE*` — `true` / `false`.
* `*D__OPT_INVERSE*` — `true` / `false`.
* `*D__OPT_EXCLAM*` — `true` / `false`.
* `*D__OPT_VERBOSITY*` — _non-negative integer_.

| +++<p align="center">+++
*Request indicators*
+++<br>+++
`*D{dus}REQ_ROUTINE*`, `*D{dus}REQ_ARGS*`, `*D{dus}REQ_GROUPS*`, 
+++<br>+++
`*D{dus}REQ_BUNDLES*`, `*D{dus}REQ_PKGS*`
+++</p>+++

The *request indicators* reflect the parameters of the current request to the <<rtn-primaries,primary routine>>.

The request indicators are declared `readonly` with the following possible values:

* `*D__REQ_ROUTINE*` — `check` / `install` / `remove`.
* `*D__REQ_ARGS*` — _array of non-<<rtn-primaries-opts,option>> non-<<mtdt-groups,group>> arguments_.
* `*D__REQ_GROUPS*` — _array of <<mtdt-groups,group>> arguments_.
* `*D__REQ_BUNDLES*` — _array of <<opt-bundle,bundles>> requested_.
* `*D__REQ_PKGS*` — `true` / `false` (whether the <<dfls-main,Divinefiles>> are requested).

|===

[[mnf-main]]
== Manifests

_Divine.dotfiles_ introduces a simple markup language for special files called *manifests*.

There are three types of special files that are manifests:

* <<dfls-main, Divinefiles>>.
* <<asset-manifests, Asset manifests>>.
* <<queue-manifests, Queue manifests>>.

While they differ in purpose and supported features, all types of manifests share basic syntax and are internally parsed by the same engine.

[[mnf-syntax]]
=== Manifest syntax

Manifests are processed in terms of lines.
A simplest line represents an *entry* of some kind.

The whitespace rules are fairly permissive.
Any amount of leading and trailing whitespace is allowed and ignored.
Within an entry, the whitespace is preserved.

.Example of manifest with four entries
[source]
----
entry1
entry2
entry with whitespace
  indented entry will not include indentation
----

[[mnf-kv]]
=== Key-values

Whenever a line starts with an opening parenthesis `(` and contains a closing one `)`, what's between them is interpreted as a *key-value* pair.
There may be more than one key-value per line.
The key-values are used to qualify entries and provide additional information.

A key-value is separated into key and value by the first occurrence of the `:` symbol (colon).

Key-values may:

* occupy their own line;
* precede an entry.

Key-values that occupy their own line come into effect for the rest of the document, or until overridden.
Key-values that precede an entry affect only that entry.

.Example of key-values in manifest
[source,bash]
----
entry1                  # Regular entry
(color: red) entry2     # Set color to red for this entry only

(color: blue)           # Set color to blue henceforth

entry3                  # Color is blue
(color: green) entry4   # Color is green (overridden)
entry5                  # Color is blue

(color:)                # Unset color henceforth

entry6                  # No color
entry7                  # No color
----

The two keys — <<mnf-kv-os,`os`>> and <<mnf-kv-flags,`flags`>> — are universal to all types of manifests, and are described below.
Particular kinds of manifests support additional keys.

[[mnf-kv-os]]
==== Key-value `os`

The key `os` makes entries specific to particular operating systems.
Multiple OS names may be given by separating them with whitespace.
The entire list of OS's may be negated by prepending it with the `!` symbol.

.Example of `os` key-values in manifest
[source]
----
(os: debian)          entry1    # Relevant only on Debian

(os: macos bsd)       entry2    # Relevant only on macOS or BSD

(os: ! linux wsl)     entry3    # Relevant everywhere except Linux or WSL

(os: all)             entry4    ## Keywords 'all'/'any' are reserved to denote 
                                #. any OS. This is synonymous to empty list.
----

The OS names are matched against the <<indct-os-family,`$D\__OS_FAMILY`>> and <<indct-os-distro,`$D__OS_DISTRO`>> variables.
A match against any of the two is sufficient.

[[mnf-kv-flags]]
==== Key-value `flags`

The key `flags` adds a string of single-character flags to an entry.

A *shorthand* is provided: whenever a <<mnf-kv,key-value>> does not contain the `:` separator (i.e., there is no key), the `flags` key is assumed.

Flags may be appended to those currently in effect (instead of replacing them) by prepending the value with the `+` symbol.

.Example of `flags` key-values in manifest
[source,bash]
----
(flags: i!0)  entry1    # Flags: i, !, 0

(flags: a)
              entry2    # Flags: a
(+b)
(flags: +c)   entry3    # Flags: a, b, c
              entry4    # Flags: a, b
(flags: d)    entry5    # Flags: d
              entry6    # Flags: a, b
----

[[mnf-misc]]
=== Comments, line continuation, and escaping

The hash/pound symbol (`#`) comments out the rest of the line.

A line may be 'glued' to the next by terminating it with a backslash (`\`).
Whitespace and comments are allowed to follow the backslash.

.Example of line continuation in manifests
[source,bash]
----
(os: fedora)  \   ## This is a single logical line
lengthy entry \   #. spanning three physical lines
text              #. (yes, even with comments attached like this)
----

The escaping rules are as follows:

* To start an entry with a literal opening parenthesis `(`, prepend it with a backslash `\`.
+
_One and only one backslash is always removed from the left edge of an entry._
* To use a literal closing parenthesis `)` within a key-value, prepend it with a backslash.
* To use a literal hash/pound symbol `#` anywhere, prepend it with a backslash.
* To end a line with a literal backslash `\`, double every literal backslash at the line's right edge.
+
_An odd number of backslashes at the right edge of a line will be reduced to a single backslash and will result in line continuation._

[[dfls-main]]
== Divinefiles

A *Divinefile* is a special kind of <<dpls-main,deployment>>.
Its purpose is akin to that of the https://github.com/Homebrew/homebrew-bundle[Brewfile] or the https://bundler.io/gemfile.html[Gemfile].
Quite simply, a Divinefile is a <<mnf-main,manifest>> of packages to be maintained using the supported system package manager.

* A Divinefile must be named, well, `Divinefile`.
* There can absolutely be more than one — their contents are effectively merged.
* The framework picks up every Divinefile located at any depth under two recognized deployment directories:
** `<<fmwk-grail,grail>>/dpls/` — the user's Divinefiles.
** `<<fmwk-state,state>>/bundles/` — the <<rtn-bundles,attached>> third-party Divinefiles.
* The Divinefiles collectively act as a deployment.

[[dfls-usage]]
=== Divinefile usage

The Divinefiles are automatically picked up by the framework along with the other deployments.
Divinefiles are processed in their merged entirety or not processed at all.

The Divinefiles are referred to with synonyms: `divinefile`, `dfile`, or `df`.
As with all deployment names, these are case insensitive.

The deployment-style <<mtdt-priority,*priorities*>> and <<mtdt-flags,*flags*>> can be assigned to the individual packages within the Divinefiles.
The packages are then intertwined with the regular deployments in a shared workflow.

The Divinefiles do *not* support the advanced features of the system package managers.
For the more complex package installations — e.g., involving particular versions or special package manager options — the regular <<dpls-main,deployments>> should be used instead.

[[dfls-syntax]]
=== Divinefile syntax

The Divinefiles follow the general <<mnf-main,manifest>> syntax.

Every Divinefile entry is a *list* of whitespace-separated package names.
The keys `flags` and `priority` set the respective attributes for the packages.
The priority works for packages in the same way as it does for the <<mtdt-priority,deployments>>.

The following flags are supported for packages.

.List of supported package flags in Divinefiles
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*[ir]*` _(any of the two lowercase letters)_
+++</p>+++

These flags engage the *always-prompt* mode for particular <<rtn-primaries,primary routines>>.
An <<fmwk-upmt,urgent>> prompt will appear on the chosen routines, before the package is processed.

* `*i*` — always prompt during the <<rtn-install,`**i**nstall`>> routine.
* `*r*` — always prompt during the <<rtn-remove,`**r**emove`>> routine.

|===

Within a line, each vertical bar `|` starts an *alt-list*, which fully overrides the original list for a particular package manager.
Within an alt-list, everything to the left of the first `:` symbol (colon) is read as the package manager's name; everything to the right — as the alt-list of packages.
The package manager's name is matched against the <<indct-os-pkgmgr,`$D__OS_PKGMGR`>> variable.

.Example of Divinefile
[source]
----
git vim                 # Maintain git and vim with default priority (4096)


(priority:300)          # Set priority to 300 henceforth


(priority:500)  \       # Set priority to 500 for this line only
(r)             \       # Set flag 'prompt before removing' for this line only
node            \       # Maintain node
| apt-get: nodejs npm   # On apt-get, maintain nodejs and npm instead


(os:fedora) \           # Make this line exclusive to Fedora
util-linux-user         # Maintain util-linux-user with priority 300
----

[[mltsk-main]]
== Multitask helpers

The *multitask helpers* are a set of partly pre-implemented <<func-primaries,primary functions>> for deployments that carry out a series of _dissimilar_ tasks.
(For deployments that deal with a series of _similar_ tasks, the <<queues,queue helpers>> should be used.)

The multitask helpers provide a way to cram any number of *sub-deployments* (called *tasks*) into a multitask deployment.
Each task can have its own set of *mini-primaries*, which are near-identical in behavior to the <<func-primaries,regular>> primaries.
In particular, the same <<rtc-overview,return codes>> are supported for the mini-primaries as are for their older siblings.
The framework automatically amalgamates the return codes of the tasks into the single return code of the multitask deployment itself.

The multitask helpers can be employed no more than once per deployment.

[[mltsk-setup]]
=== Setting up a multitask deployment

To assemble a multitask deployment:

* Populate the `*D_MLTSK_MAIN*` variable with an array of task names, e.g.:
+
[source,bash]
----
D_MLTSK_MAIN=( task_one task_two )
----
+
The `D_MLTSK_MAIN` variable must be populated _before_ the first multitask helper (`d__mltsk_check`) is called.
+
The multitask array must be uninterrupted.
* Implement the (optional) mini-primaries for the tasks, following the naming pattern:
+
[source,subs="verbatim,quotes,attributes"]
----
          d{us}**_TASK_**{us}check
*_TASK_*  =>  d{us}**_TASK_**{us}install
          d{us}**_TASK_**{us}remove
----
* Call the multitask *helper primaries* as the last commands of the deployment's <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__mltsk_check;   }
d_dpl_install() { d__mltsk_install; }
d_dpl_remove()  { d__mltsk_remove;  }
----

.Example of multitask deployment
[source,bash]
----
# Delegate the primaries to the multitask helper primaries
d_dpl_check()    { assemble_tasks;  d__mltsk_check;   }
d_dpl_install()  {                  d__mltsk_install; }
d_dpl_remove()   {                  d__mltsk_remove;  }

# This function is the recommended way of organizing logic
assemble_tasks() { D_MLTSK_MAIN=( eat pray love ); }

# Implement the (optional) mini-primaries for the tasks

d_eat_check()     { :; }
d_eat_install()   { :; }
d_eat_remove()    { :; }

d_pray_check()    { :; }
d_pray_install()  { :; }
d_pray_remove()   { :; }

d_love_check()    { :; }
d_love_install()  { :; }
d_love_remove()   { :; }
----

[[mltsk-hooks]]
=== Multitask hooks

The framework recognizes a set of specially named functions — *hooks* — that are called at particular junctions of processing a multitask deployment.
The hooks have the power to alter the behavior of the multitask deployment via their return codes and <<mltsk-addst,add-statuses>>.

* Pre- and post- multitask hooks can do arbitrary work.
** When the multitask check hook returns a non-zero code, the corresponding helper primary shuts down with the code `3` ('Irrelevant or invalid').
*** `*d_mltsk_pre_check*` — called before the checking of tasks starts.
*** `*d_mltsk_post_check*` — called after the checking of tasks completes.
** When the multitask install/remove hook returns a non-zero code, the corresponding helper primary shuts down with the code `2` ('Refused to install/remove').
*** `*d_mltsk_pre_install*` — called before (and if) the installation of tasks starts.
*** `*d_mltsk_post_install*` — called after the installation of tasks completes.
*** `*d_mltsk_pre_remove*` — called before (and if) the removal of tasks starts.
*** `*d_mltsk_post_remove*` — called after the removal of tasks completes.
* Pre- and post- task hooks can, too, do arbitrary work.
** When the task check hook returns a non-zero code, the corresponding mini-primary shuts down with the code `3` ('Irrelevant or invalid').
*** `*d{us}__TASK__{us}pre_check*` — called before the checking of that task starts.
*** `*d{us}__TASK__{us}post_check*` — called after the checking of that task completes.
** When the task install/remove hook returns a non-zero code, the corresponding mini-primary shuts down with the code `2` ('Refused to install/remove').
*** `*d{us}__TASK__{us}pre_install*` — called before (and if) the installation of that task starts.
*** `*d{us}__TASK__{us}post_install*` — called after the installation of that task completes.
*** `*d{us}__TASK__{us}pre_remove*` — called before (and if) the removal of that task starts.
*** `*d{us}__TASK__{us}post_remove*` — called after the removal of that task completes.

[[mltsk-addst]]
=== Multitask add-statuses

The multitask deployments can take advantage of the deployment-level <<addst-overview,add-statuses>>.
On top of that, the framework provides add-statuses that are specific to the multitask deployments.

.Supported multitask add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Add-statuses in <<mltsk-main,multitask>>

| +++<p align="center">+++
`*D_ADDST_MLTSK_HALT*`
+++</p>+++

If set to `true`, forces halting of the current <<mltsk-main,multitask>> deployment.
No further tasks will be processed.

If set during the `check` phase, the `install`/`remove` phase will still commence for the tasks that have been checked before the halting.

| +++<p align="center">+++
*Add-statuses of pre- and post- multitask <<mltsk-hooks,hooks>>*
+++<br>+++
`*D_ADDST_MLTSK_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_MLTSK_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_MLTSK_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the entire multitask deployment from either the pre- or post- multitask <<mltsk-hooks,hook>>.

| +++<p align="center">+++
*Add-statuses of pre- and post- task <<mltsk-hooks,hooks>>*
+++<br>+++
`*D_ADDST_TASK_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_TASK_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_TASK_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the current task from either the pre- or post- task <<mltsk-hooks,hook>>.

| +++<p align="center">+++
[[addst-task-flags]]`*D_ADDST_TASK_FLAGS*`
+++</p>+++

Acts as a vehicle for transporting arbitrary single-character flags between the `check` and the `install`/`remove` mini-primaries.
Whatever is assigned to this add-status during the `check` phase (including the task's pre- and post- <<mltsk-hooks,hooks>>), will be made available to the mini-primaries at the `install`/`remove` phase within the <<indct-task-flags,`*D__TASK_FLAGS*`>> indicator variable.

The assignments by different functions to the `D_ADDST_TASK_FLAGS` variable are concatenated by the framwwork.

|===

[[mltsk-indct]]
=== Multitask indicators

The multitask deployments can take advantage of the deployment-level <<indct-main,indicators>>.
On top of that, the framework provides indicators that are specific to the multitask deployments.

.List of multitask indicator variables
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*D{dus}TASK_NUM*`, `*D{dus}TASK_NAME*`
+++</p>+++

These indicators contain the current task's ordinal number (`D{dus}TASK_NUM`, starts at zero) and name (`D{dus}TASK_NAME`).

| +++<p align="center">+++
`*D{dus}TASK_IS_FORCED*`
+++</p>+++

During the `install`/`remove` phase, this indicator reflects whether the current task is being <<opt-force,forced>>.
If set to `true`, this indicator tells that the installation/removal would not have been run if the `--force` option weren't provided.

Possible values: `true` / `false`.

| +++<p align="center">+++
[[indct-task-flags]]`*D{dus}TASK_FLAGS*`
+++</p>+++

This indicator contains whatever flags might have been <<addst-task-flags,assigned>> to the current task during the `check` phase.

Naturally, this indicator is only available during the `install`/`remove` phases.

| +++<p align="center">+++
*Task code indicators*
+++<br>+++
`*D{dus}TASK_CHECK_CODE*`
+++<br>+++
`*D{dus}TASK_INSTALL_CODE*`
+++<br>+++
`*D{dus}TASK_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-overview,codes>> returned by the task's mini-primaries.

Naturally, these indicators are only available after their corresponding mini-primaries have completed their run.

Particularly, the `D{dus}TASK_INSTALL_CODE` and `D{dus}TASK_REMOVE_CODE` indicators are only available to the task's corresponding post- install/remove <<mltsk-hooks,hooks>>.

| +++<p align="center">+++
*Multitask code indicators*
+++<br>+++
`*D{dus}MLTSK_CHECK_CODE*`
+++<br>+++
`*D{dus}MLTSK_INSTALL_CODE*`
+++<br>+++
`*D{dus}MLTSK_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-overview,codes>> returned by the task's helper primaries.

Naturally, these indicators are only available after their corresponding helper primaries have completed their run.

Particularly, the `D{dus}MLTSK_INSTALL_CODE` and `D{dus}MLTSK_REMOVE_CODE` indicators are only available to the deployment's corresponding post- install/remove <<mltsk-hooks,hooks>>.

|===

[[queue-main]]
== Queue helpers

The *queue helpers* are a set of partly pre-implemented <<func-primaries,primary functions>> for deployments that carry out a series of _similar_ tasks.
(For deployments that deal with a series of _dissimilar_ tasks, the <<mltsk-main,multitask helpers>> should be used.)

The queue helpers provide a way to cram any number of *sub-deployments* (called queue *items*) into a deployment.
All queue items share the same set of *mini-primaries*, which are near-identical in behavior to the <<func-primaries,regular>> primaries.
In particular, the same <<rtc-overview,return codes>> are supported for the mini-primaries as are for their older siblings.
The framework automatically amalgamates the return codes of the queue items into the single return code of the queue itself.

The queue helpers may be employed multiple times in a single deployment under the following conditions:

* Each invocation of the queue helpers must be contained in its own task in a <<mltsk-main,multitask>> deployment.
* The queue must be properly <<queue-split,split>> into sections between the tasks.

[[queue-setup]]
=== Setting up a queue

To assemble a generic queue within a deployment (or <<mltsk-main,task>>):

* Populate the `*D_QUEUE_MAIN*` variable with an array of queue item names, e.g.:
+
[source,bash]
----
D_QUEUE_MAIN=( item_one item_two )
----
+
For the generic queue, the `D_QUEUE_MAIN` variable must be populated _before_ the first queue helper (`d__queue_check`) is called.
Alternatively, the queue array may be populated via the <<queue-manifests,queue>> or <<asset-manifest,asset>> manifests.
+
The queue array must be uninterrupted.
* Implement the (optional) mini-primaries for the queue:
** `*d_item_check*`
** `*d_item_install*`
** `*d_item_remove*`
* Call the queue *helper primaries* as the last commands of the deployment's <<func-primaries,primary functions>>, e.g.:
+
[source,bash]
----
d_dpl_check()   { d__queue_check;   }
d_dpl_install() { d__queue_install; }
d_dpl_remove()  { d__queue_remove;  }
----

.Example of queue deployment
[source,bash]
----
# Delegate the primaries to the queue helper primaries
d_dpl_check()    { assemble_items;  d__queue_check;   }
d_dpl_install()  {                  d__queue_install; }
d_dpl_remove()   {                  d__queue_remove;  }

# This function is the recommended way of organizing logic
assemble_items() { D_QUEUE_MAIN=( one two three ); }

# Implement the (optional) mini-primaries for the items

d_item_check()     { :; }
d_item_install()   { :; }
d_item_remove()    { :; }
----

[[queue-manifests]]
=== Queue manifests

The queue items, whatever they are, may be separated from the deployment logic into their own files, the *queue <<mnf-main,manifest>>*.

A queue manifest is located, by default, in the same directory as the deployment file and named the same, except for exchanging `.dpl.sh` suffix for `.dpl.que`.
Unlike with <<asset-manifests,asset manifests>>, you are free to customize the location/name of your queue manifest by re-assigning <<indct-dpl-que-path,`D__DPL_QUE_PATH`>> variable *at the top level* of your deployment.

Queue manifests follow the general <<mnf-syntax,manifest syntax>>.
Only the key `os` is recognized within queue manifests.

[.note]
[%noheader,cols="<.<a"]
|===
| A suggested way of using queue manifests is:

. Provide a sample queue manifest of some entries in whatever form.
. Declare the queue manifest an asset, by listing it in your <<asset-manifests,asset manifest>>.
. Within the deployment, customize the <<indct-dpl-que-path,`D__DPL_QUE_PATH`>> variable to point to asset copy within <<fmwk-grail,the Grail>>, e.g.:
+
[source,bash]
----
D__DPL_QUE_PATH="$D__DPL_ASSET_DIR/$D_DPL_NAME.dpl.que"
----
|===

[[queue-hooks]]
=== Queue hooks

The framework recognizes a set of specially named functions — *hooks* — that are called at particular junctions of processing a queue deployment.
The hooks have the power to alter the behavior of the queue deployment via their return codes and <<queue-addst,add-statuses>>.

* Pre- and post- queue hooks can do arbitrary work.
** When the queue check hook returns a non-zero code, the corresponding helper primary shuts down with the code `3` ('Irrelevant or invalid').
*** `*d_queue_pre_check*` — called before the checking of items starts.
*** `*d_queue_post_check*` — called after the checking of items completes.
** When the queue install/remove hook returns a non-zero code, the corresponding helper primary shuts down with the code `2` ('Refused to install/remove').
*** `*d_queue_pre_install*` — called before (and if) the installation of items starts.
*** `*d_queue_post_install*` — called after the installation of items completes.
*** `*d_queue_pre_remove*` — called before (and if) the removal of items starts.
*** `*d_queue_post_remove*` — called after the removal of items completes.
* Pre- and post- item hooks can, too, do arbitrary work.
** When the item check hook returns a non-zero code, the corresponding mini-primary shuts down with the code `3` ('Irrelevant or invalid').
*** `*d_item_pre_check*` — called before the checking of an item starts.
*** `*d_item_post_check*` — called after the checking of an item completes.
** When the item install/remove hook returns a non-zero code, the corresponding mini-primary shuts down with the code `2` ('Refused to install/remove').
*** `*d_item_pre_install*` — called before (and if) the installation of an item starts.
*** `*d_item_post_install*` — called after the installation of an item completes.
*** `*d_item_pre_remove*` — called before (and if) the removal of an item starts.
*** `*d_item_post_remove*` — called after the removal of an item completes.

[[queue-addst]]
=== Queue add-statuses

The queues can take advantage of the deployment-level <<addst-overview,add-statuses>>.
On top of that, the framework provides add-statuses that are specific to the queues.

.Supported queue add-statuses
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Add-statuses in <<queue-main,queues>>

| +++<p align="center">+++
[[addst-queue-mnf]]`*D_ADDST_QUEUE_MNF_PATH*`
+++</p>+++

If set to a non-empty value, directs to look for the <<queue-manifests,queue manifest>> at that path.
To be picked up, this add-status must be set at the root of the deployment script.

| +++<p align="center">+++
`*D_ADDST_QUEUE_HALT*`
+++</p>+++

If set to `true`, forces halting of the current <<queues,queue>>.
No further queue items will be processed.

If set during the `check` phase, the `install`/`remove` phase will still commence for the queue items that have been checked before the halting.

| +++<p align="center">+++
*Add-statuses of pre- and post- queue <<queue-hooks,hooks>>*
+++<br>+++
`*D_ADDST_QUEUE_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_QUEUE_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_QUEUE_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the entire queue from either the pre- or post- queue <<queue-hooks,hook>>.

| +++<p align="center">+++
*Add-statuses of pre- and post- item <<queue-hooks,hooks>>*
+++<br>+++
`*D_ADDST_ITEM_CHECK_CODE*`,
+++<br>+++
`*D_ADDST_ITEM_INSTALL_CODE*`,
+++<br>+++
`*D_ADDST_ITEM_REMOVE_CODE*`
+++</p>+++

These add-statuses allow to override the corresponding code of the current queue item from either the pre- or post- item <<queue-hooks,hook>>.

| +++<p align="center">+++
[[addst-item-flags]]`*D_ADDST_ITEM_FLAGS*`
+++</p>+++

Acts as a vehicle for transporting arbitrary single-character flags between the `check` and the `install`/`remove` mini-primaries.
Whatever is assigned to this add-status during the `check` phase (including the item's pre- and post- <<queue-hooks,hooks>>), will be made available to the mini-primaries at the `install`/`remove` phase within the <<indct-item-flags,`*D__ITEM_FLAGS*`>> indicator variable.

The assignments by different functions to the `D_ADDST_ITEM_FLAGS` variable are concatenated by the framwwork.

|===

[[queue-indct]]
=== Queue indicators

The queues can take advantage of the deployment-level <<indct-main,indicators>>.
On top of that, the framework provides indicators that are specific to the queues.

.List of queue indicator variables
[%noheader,cols="<.<a",stripes=none]
|===

| +++<p align="center">+++
`*D{dus}ITEM_NUM*`, `*D{dus}ITEM_NAME*`
+++</p>+++

These indicators contain the current queue item's ordinal number (`D{dus}ITEM_NUM`, starts at zero) and name (`D{dus}ITEM_NAME`).

| +++<p align="center">+++
`*D{dus}ITEM_IS_FORCED*`
+++</p>+++

During the `install`/`remove` phase, this indicator reflects whether the current queue item is being <<opt-force,forced>>.
If set to `true`, this indicator tells that the installation/removal would not have been run if the `--force` option weren't provided.

Possible values: `true` / `false`.

| +++<p align="center">+++
[[indct-item-flags]]`*D{dus}ITEM_FLAGS*`
+++</p>+++

This indicator contains whatever flags might have been <<addst-item-flags,assigned>> to the current queue item during the `check` phase.

Naturally, this indicator is only available during the `install`/`remove` phases.

| +++<p align="center">+++
*Item code indicators*
+++<br>+++
`*D{dus}ITEM_CHECK_CODE*`
+++<br>+++
`*D{dus}ITEM_INSTALL_CODE*`
+++<br>+++
`*D{dus}ITEM_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-overview,codes>> returned by the queue item's mini-primaries.

Naturally, these indicators are only available after their corresponding mini-primaries have completed their run.

Particularly, the `D{dus}ITEM_INSTALL_CODE` and `D{dus}ITEM_REMOVE_CODE` indicators are only available to the queue item's corresponding post- install/remove <<queue-hooks,hooks>>.

| +++<p align="center">+++
*Queue code indicators*
+++<br>+++
`*D{dus}QUEUE_CHECK_CODE*`
+++<br>+++
`*D{dus}QUEUE_INSTALL_CODE*`
+++<br>+++
`*D{dus}QUEUE_REMOVE_CODE*`
+++</p>+++

These indicators contain the integer <<rtc-overview,codes>> returned by the queue item's helper primaries.

Naturally, these indicators are only available after their corresponding helper primaries have completed their run.

Particularly, the `D{dus}QUEUE_INSTALL_CODE` and `D{dus}QUEUE_REMOVE_CODE` indicators are only available to the deployment's corresponding post- install/remove <<queue-hooks,hooks>>.

|===

[[queue-split]]
=== Splitting queue

The <<queue-main,queue helperss>> can be employed more than once per deployment.
When that happens, all types of queues (<<queue-main,generic>> and the various <<spcqe-main,specialized>> types) share the same internal mechanism and the same queue array, `D_QUEUE_MAIN`.
Consequently, in case of multiple queues in a deployment, the queue array must be split into *queue sections*.

Whenever more than one queue is used in a deployment (the generic queues)

[[spcqe-main]]
== Specialized queues

// TODO

[[cpqe-main]]
=== Copy-queues

// TODO

[[lnqe-main]]
=== Link-queues

// TODO

[[ghqe-main]]
=== Github-queues

// TODO

== Advanced features

_Divine.dotfiles_ offers mechanisms that facilitate creation of better, stronger, faster deployments.

=== Naming convention

_Divine.dotfiles_ uses a system of prefixes to gradually separate the framework's inner workings.

* The single-underscore prefixes are for entities to be implemented by the user:
** `**D{us}**NAME` — variables to be assigned by the user (e.g., the <<dpls-metadata,metadata>> or the <<addst-overview,add-statuses>>).
** `**d{us}**name` — functions to be implemented by the user (e.g., the <<func-primaries,primary functions>>).
* The double-underscore prefixes are for entities to be accessed by the user:
** `**D{dus}**NAME` — variables to be read by the user.
** `**d{dus}**name` — functions to be called by the user.
* The triple-underscore prefixes are for entities that are strictly internal:
** `**d{dus}{us}**name` — functions to be called internally.

[[divine-workflow]]
=== Divine workflow

The Divine workflow is the recommended way to organize Bash code within deployments.
The framework provides a set of functions that facilitate breaking down Bash code into meaningful blocks.
The goal here is to both annotate the code and automatically provide useful debug output.

Central to the idea of the Divine workflow is the concept of *workflow context*.
The workflow context is a stack (very similar to the function https://en.wikipedia.org/wiki/Call_stack[call stack]) that at any moment contains the hierarchy of tasks currently being performed.
An example of the context stack would look like this:

.Illustration of the Divine workflow context stack
====
[start=0]
. Running _Divine.dotfiles_ `install` routine.
. Installing deployments at priority `4096`.
. Deployment `example`.
+
---
. Executing a particular task within the deployment.
. Executing a sub-task.
====

The context stack starts at the root and grows down to arbitrary depth.
Context items are pushed and popped from the bottom.
*Notches* (represented by a horizontal line in the illustration) delimit logical layers and provide a way to quickly pop multiple items.

[[divine-workflow-guide]]
With the idea of context in mind, the Divine workflow boils down to the following principles:

* Everything should be written within Bash functions.
* There should be a function for every logical sub-routine.
* The workflow context should be maintained by calling <<func-context,`d{dus}context`>> at specific junctions:
** At the beginning of a <<func-primaries,primary function>> — `d{dus}context notch`.
** At the top of every sub-routine — `d{dus}context push`.
* Whenever a sub-routine needs to fail, two pathways are available:
** Critical commands should be enwrapped in <<func-cmd,`d{dus}cmd`>>, <<func-pipe,`d{dus}pipe`>>, or <<func-require,`d{dus}require`>>.
** 'Manual' failures should be orchestrated via <<func-fail,`d{dus}fail`>>.
* To interact with the user along the way:
** Non-failure alerts should be delivered via <<func-notify,`d{dus}notify`>>.
** Prompts that include information on current workflow context can be initiated via <<func-prompt,`d{dus}prompt`>>.
* <<func-context,`d{dus}context`>> should again be used to wrap things up:
** Before successfully returning from a sub-routine — `d{dus}context pop`.
** Before successfully returning from a <<func-primaries,primary function>> — `d{dus}context lop`.

.Illustration of the Divine workflow
[source,bash]
----
# grail/dpls/example.dpl.sh

d__dpl_install()
{
  d__context notch          # mark beginning of primary
  
  perform_task || return 1  # do the work

  d__context lop            # lop off everything down to and including the notch
  return 0
}

perform_task()
{
  d__context push 'Performing task'

  perform_sub_task || return 1

  d__context pop
  return 0
}

perform_sub_task()
{
  d__context push 'Performing sub-task'

  d__require [ --THIS-- "$this_number" -eq --THAT-- "$that_number" ] \
    --else-- 'Refusing to proceed' \
    || return 1

  d__notify --loud --context-head --title Attention -- 'Sub-task done'

  d__context pop
  return 0
}
----

.Example of success output from the illustration of the Divine workflow above
[source,subs="verbatim,quotes,attributes"]
----
[.yellow]#*==>*# *Attention:* Sub-task done
    *Context:* Performing task
             Performing sub-task
----

.Example of failure output from the illustration of the Divine workflow above
[source,subs="verbatim,quotes,attributes"]
----
[.red]#*==>*# *Command failed:* [ *THIS* -eq *THAT* ]
        *THIS:* '0'
        *THAT:* '1'
    *Context:* Performing task
             Performing sub-task
    *Result:* Refusing to proceed
----

=== Variables available to deployments

.List of variables available/recognized in each deployment
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| <<dpls-metadata,Deployment metadata>>

| `*D_DPL_NAME*`

Explicit name for the deployment.

This variable will be non-empty even if there is no assignment within the file.

| `*D_DPL_DESC*`

One-line description of the deployment.

| `*D_DPL_PRIORITY*`

Priority of the deployment (non-negative integer).

This variable will be non-empty even if there is no assignment within the file.

| `*D_DPL_FLAGS*`

One-character flags, causing special treatment.

| `*D_DPL_WARNING*`

One-line cautionary message about this deployment.

^.^h| Special directory paths

| [#ind-dpl-dir]#`*D__DPL_DIR*`#

Absolute path to directory containing `*.dpl.sh` file.

| [#ind-dpl-asset-dir]#`*D__DPL_ASSET_DIR*`#

Generated absolute path to directory assigned to hold assets of current deployment.

Located within <<fmwk-grail,the Grail>>, specifically `grail/assets/*_D_DPL_NAME_*/`.

| [#ind-dpl-backup-dir]#`*D__DPL_BACKUP_DIR*`*_`#_*`


Generated absolute path to directory assigned to hold backups of current deployment.
Located within <<state-directory
state directory>>, specifically `stat`/backup
`*`
^.^`| Special file 

| [#var-dpl-sh-path]#`*D_
DPL_SH_PATH*`#

Absolute path `*_to_*` `*.dpl.sh` fil<func-pop-backup,<e`>>.

`

| [#ind-dpl-mnf-path]#`*D__DPL_MNF_PATH*`#

Generated absolute path to asset manifest of current deployment.
This path does not necessarily exist.

Same as `*_D__DPL_SH_PATH_*`, but with suffix changed to `*.dpl.mnf`.

[.note]
[%noheader,cols="<.<a"]
!===
! Asset manifests are also processed by routines that don't source deployments.

Thus, path to asset manifest is locked, and this variable is read-only.
!===

| [#ind-dpl-que-path]#`*D__DPL_QUE_PATH*`#

Generated absolute path to queue manifest of current deployment.
This path does not necessarily exist.

Same as `*_D__DPL_SH_PATH_*`, but with suffix changed to `*.dpl.que`.

[.note]
[%noheader,cols="<.<a"]
!===
! Queue manifests are processed only after sourcing their deployment file.

Thus, you are free to adjust this path at the top level of deployment script.
!===

^.^h| [#ind-os]#Detected operating system (OS)#

| [#ind-os-family]#`*D__OS_FAMILY*`#

Broad description of current OS.

Exhaustive list of possible values:

* `bsd` — https://en.wikipedia.org/wiki/List_of_BSD_operating_systems[BSD descendants]
* `cygwin` — https://en.wikipedia.org/wiki/Cygwin[Cygwin]
* `linux` — https://en.wikipedia.org/wiki/Linux[Linux]
* `macos` — https://en.wikipedia.org/wiki/MacOS[macOS]
* `msys` — https://en.wikipedia.org/wiki/MinGW[Minimalist GNU for Windows]
* `solaris` — https://en.wikipedia.org/wiki/Solaris_(operating_system)[Oracle Solaris]
* `wsl` — https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux[Windows Subsystem for Linux]

[.note]
[%noheader,cols="<.<a"]
!===
! Note that `linux` and `wsl` are separate entries.
Check for both to determine whether currently under modern Linux, e.g.:

[source,bash,subs="verbatim,attributes"]
----
case $D__OS_FAMILY in
  linux{vbar}wsl)   echo linux;;
  *)           echo other;;
esac
----

!===

| [#ind-os-distro]#`*D__OS_DISTRO*`#

Best guess on the name of the current OS distribution.

Exhaustive list of possible values:

* `debian`
* `fedora`
* `freebsd`
* `macos`
* `ubuntu`
* _empty_ — failed to reliably detect a supported distribution

[.note]
[%noheader,cols="<.<a"]
!===
! This list is incomplete; you can help by <<cntrb-os-support,expanding it>>.
!===

| [#ind-os-pkgmgr]#`*D__OS_PKGMGR*`#

Name of supported system package manager available on current system.

Exhaustive list of possible values:

* `apt-get`
* `brew`
* `dnf`
* `pkg`
* `yum`
* _empty_ — failed to reliably detect a supported package manager

[.note]
[%noheader,cols="<.<a"]
!===
! This list is incomplete; you can help by <<cntrb-os-support,expanding it>>.
!===

When this variable is non-empty, you also have the built-in <<func-os-pkgmgr,package manager wrapper>>, `d__os_pkgmgr()`, at your disposal.

^.^h| [#marker-vars]#Marker variables in <<func-dpl-check,check>> primary#

| [#var-another-prompt]#`*D_DPL_NEEDS_ANOTHER_PROMPT*`#

Set this variable to `true` to trigger an <<mtdt-aa,urgent prompt>> before the framework proceeds to (un)installation.

_Works only during `install`/`remove` <<rtn-primaries,routines>> and only if set within <<func-dpl-check,check>> primary._

| [#var-another-warning]#`*D_DPL_NEEDS_ANOTHER_WARNING*`#

If `$D_DPL_NEEDS_ANOTHER_PROMPT` is set to `true` and this variable is non-empty, then its content is shown to the user as textual warning.

_Works only during `install`/`remove` <<rtn-primaries,routines>> and only if set within <<func-dpl-check,check>> primary._

| [#var-user-or-os]#`*D_DPL_INSTALLED_BY_USER_OR_OS*`#

Set this variable to `true` to signal to the framework: whatever parts of current deployment are installed, have been installed by other methods, not by this framework.

_Works only if set within check primary._
_Value of `true` is preserved into install/remove primaries, even in <<mltsk-main,multitask>> sub-primaries._

This affects behavior of the following return codes of <<func-dpl-check,`d_dpl_check`>>:

* `1` ('installed') — prohibits uninstalling;
* `4` ('partly installed') — prohibits uninstalling.

[.note]
[%noheader,cols="<.<a"]
!===
! This is useful for deployments designed to not interfere with manual tinkering.
!===

^.^h| Check code in <<func-dpl-install,install>>/<<func-dpl-remove,remove>> primaries

| [#ind-dpl-check-code]#`*D__DPL_CHECK_CODE*`#

Within install/remove primaries, this variable contains the code returned by their respective check primary.
This is also the case within <<mltsk-main,multitask>> sub-primaries.

^.^h| Parameters of current request

| `*D__REQ_ROUTINE*`

Name of <<rtn-primaries,primary routine>> currently being executed:

* `check`
* `install`
* `remove`

| `*D__OPT_FORCE*`

Whether `-f` / `--force` option is provided:

* `true`
* `false`

| [#var-opt-verbosity]#`*D__OPT_VERBOSITY*`#

Represent the current <<opt-verbose,global verbosity level>>.
The value is a non-negative integer, where zero stands for the minimal verbosity.

| `*D__OPT_EXCLAM*`

Whether `-w` / `--with-!` option is provided to process <<mtdt-exclam,dangerous>> deployments:

* `true`
* `false`

| `*D__OPT_ANSWER*`

Which blanket answer is provided last.
This affects all non-<<mtdt-aa,urgent>> built-in prompts.

* `true` — affirmative answer is provided
* `false` — negatory answer is provided
* _empty_ — no blanket answer is provided

|===

=== Functions available to deployments

[[func-context]]
==== Function `d{dus}context`

The function `d{dus}context` manipulates the current Divine <<divine-workflow,workflow>> context stack.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}context* [-lnq] [-t *_TITLE_*] [--] *push*|*pop*|*notch*|*lop* *_DESCRIPTION_*...
----

The `push` and `pop` operations add and remove context items from below, respectively.
The `notch` operation places an invisible mark at the tip of the stack.
The `lop` operation repeatedly executes a `pop` until the next notch (or root) is reached, and then removes that notch.

Any number of notches can be made, as long as they are not duplicated (at the same position).
Within the context stack, the latest pushed item is called the *tip*, and the items pushed after the latest notch are called the *head*.

Most stack manipulations trigger a debug message that honors the <<opt-verbose,global verbosity level>>, as stored in <<var-opt-verbosity,`$D{dus}OPT_VERBOSITY`>>.
If a `push` is prepended to every logical unit of code, and then a matching `pop` is appended at the end, a useful pattern of breadcrumbs arises in the debug output.
Other Divine workflow utilities (<<func-notify,`d{dus}notify`>>, <<func-prompt,`d{dus}prompt`>>, <<func-fail,`d{dus}fail`>>, <<func-cmd,`d{dus}cmd`>>, <<func-pipe,`d{dus}pipe`>>, <<func-require,`d{dus}require`>>) may include the state of the context stack in their output.

Each item on the context stack must be given a `*_DESCRIPTION_*`.
As a matter of good style, the `*_DESCRIPTION_*` should be worded around either a noun or a verb in its -ing form (gerund).
Repetition of information from above levels should be minimized.

Returns:

* `0` — Stack modified as requested.
* `1` — Stack not modified: no arguments or unrecognized first argument.
* `2` — Stack not modified: pushing without a `*_DESCRIPTION_*`.
* `3` — Stack not modified: popping from an empty stack.
* `4` — Stack not modified: notching at the same position.

.List of `d{dus}context` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom title for the debug message.
All operations have default titles; these are shown in the illustration below in *bold*:

[source,subs="verbatim,quotes,attributes"]
----
# Pushing an item
==> *Start*: Description of the context item

# Popping an item
==> *End*: Description of the context item

# Making a notch
==> *Notched*: At position X

# Removing a notch
==> *De-notched*: At position X
----

| `*-n*`, `*--newline*`

With this option, if this function produces any output, an extra newline is prepended to it.

^.^h| Quiet options

| *Quiet options* designate the *quiet level* for the current call.
Changes to context are announced only if the <<opt-verbose,global verbosity level>> is greater than or equal to the quiet level.

Quiet options are read sequentially, left-to-right, and the quiet level starts at zero.
However, if these options are not given at all, the default quiet levels per operation are:

* `*push*` — `2`
* `*pop*` — `3`
* `*notch*` — `4`
* `*lop*` — `4`
+
The default quiet level for the `lop` operation includes the underlying `pop` operations.
For the pops to be performed at a different quiet level, they must be initiated separately.

| `*-q*`, `*--quiet*`

_(repeatable)_
Increments the quiet level by one.

| `*-l*`, `*--loud*`

Sets the quiet level to zero.

^.^h| Styling options (one active at a time, last option wins)

| *Styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

In all modes titles are formatted in *bold*.

| `*-d*`, `*--debug*`

_(default)_
Colors the entire output in cyan.

| `*-!*`, `*--alert*`

Colors the introductory arrow in yellow.

| `*-v*`, `*--success*`

Colors the introductory arrow in green.

| `*-x*`, `*--failure*`

Colors the introductory arrow in red.

| `*-s*`, `*--skip*`

Colors the introductory arrow in white.

|===

[[func-notify]]
==== Function `d{dus}notify`

The function `d{dus}notify` conveys any information to the user and does not produce any side effects.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}notify* [-!1cdhlnqsuvx] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Whether the output is printed depends on the <<opt-verbose,global verbosity level>>, as stored in <<var-opt-verbosity,`$D{dus}OPT_VERBOSITY`>>.

Returns:

* `0` — Always.

.The layout of the output of `d{dus}notify` (without any arguments)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*
----

.The layout of the output of `d{dus}notify` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
----

* `*_TITLE_*` — _(optional)_ Short heading for the notification.
Defaults to:
** Without a `*_DESCRIPTION_*` — omitted.
** With a `*_DESCRIPTION_*` — `Generic alert`.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the notification.
* `*_CONTEXT_*` — _(optional)_ Some part of the context stack, as requested by any of the relevant options.
The entire context block is omitted if the context stack is not requested or is empty.

.List of `d{dus}notify` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-u*`, `*--sudo*`

Print the notification only if the caller lacks the `sudo` privilege.
Automatically makes the notification `--loud`.
Also, automatically sets the `*_TITLE_*` to `Password prompt` and the `*_DESCRIPTION_*` to `The upcoming command requires sudo privileges.`, unless these parts are already set.

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom title for the notification.

Without this option, the `*_TITLE_*` defaults to:

** Without a `*_DESCRIPTION_*` — omitted.
** With a `*_DESCRIPTION_*` — `Generic alert`.

| `*-n*`, `*--newline*`

With this option, if this function produces any output, an extra newline is prepended to it.

^.^h| Quiet options

| *Quiet options* designate the *quiet level* for the current call.
The notification is printed only if the <<opt-verbose,global verbosity level>> is greater than or equal to the quiet level.

Quiet options are read sequentially, left-to-right, and the quiet level starts at zero.
However, if these options are not given at all, the default quiet level is `1`.

| `*-q*`, `*--quiet*`

_(repeatable)_
Increments the quiet level by one.

| `*-l*`, `*--loud*`

Sets the quiet level to zero.

^.^h| Context-related options (one active at a time, last option wins)

| `*-c*`, `*--context-all*`

Includes the entire workflow context stack in the output.

| `*-h*`, `*--context-head*`

Includes the head of the workflow context stack (the items pushed since the last notch) in the output.

| `*-1*`, `*--context-tip*`

Includes the tip of the workflow context stack (the last pushed item) in the output.

^.^h| Styling options (one active at a time, last option wins)

| *Styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

In all modes titles are formatted in *bold*.

| `*-d*`, `*--debug*`

_(default)_
Colors the entire output in cyan.

| `*-!*`, `*--alert*`

Colors the introductory arrow in yellow.

| `*-v*`, `*--success*`

Colors the introductory arrow in green.

| `*-x*`, `*--failure*`

Colors the introductory arrow in red.

| `*-s*`, `*--skip*`

Colors the introductory arrow in white.

^.^h| Special formatting para-options (work only after the option-argument separator `--`)

| Para-options are shorthand for things like linebreaks, indentation, and bold titles.

| `*-t-*`

This para-option treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
That `WORD` is then styled as a title and is followed by a colon.

| `*-n-*`

This para-option inserts a newline followed by the arrow-width indentation (four spaces).

| `*-i-*`

This para-option is similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-prompt]]
==== Function `d{dus}prompt`

The function `d{dus}prompt` is the preferred user-prompting mechanism.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}prompt* [-!1bchknqsvxy] [-p *_PROMPT_*] [-a *_ANSWER_*] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

Two prompting modes are supported:

* Decision prompt (yes or no): returns `0` for the affirmative answer and `1` for the negatory answer.
* Any key prompt: returns `0` for any key press.

If the option `--or-quit` is used, both modes return `2` whenever the user chooses to quit.

.The layout of the output of `d{dus}prompt` (without any arguments)
[source,subs="verbatim,quotes,attributes"]
----
*_PROMPT_* *_KEYS_*
----

.The layout of the output of `d{dus}prompt` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
    *_PROMPT_* *_KEYS_*
----

If the prompt contains no optional parts, it is considered a one-liner, and the introductory arrow is omitted.

* `*_PROMPT_*` — Short conclusion for the prompt. Defaults to `Proceed?`.
* `*_KEYS_*` — Short explanation of accepted key presses:
** Decision prompt: `[y/n]`
** Decision prompt (with `--or-quit`): `[y/n/q]`
** Any key prompt: `[<any key>]`
** Any key prompt (with `--or-quit`): `[<any key>/q]`
* `*_TITLE_*` — _(optional)_ Short heading for the prompt.
If the `*_DECSRIPTION_*` is empty and if the prompt is not a one-liner, defaults to `User attention required`.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the prompt.
* `*_CONTEXT_*` — _(optional)_ Some part of the context stack, as requested by any of the relevant options.
The entire context block is omitted if the context stack is not requested or is empty.

.List of `d{dus}prompt` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom `*_TITLE_*` for the leading line.

Without this option:

* If the `*_DESCRIPTION_*` is provided, the title is omitted.
* If the `*_DESCRIPTION_*` is not provided, the title defaults to `User attention required`.

| `*-p* *_PROMPT_*`, `*--prompt* *_PROMPT_*`

Sets custom `*_PROMPT_*`.
Without this option, the `*_PROMPT_*` defaults to `Proceed?`.

| `*-a* *_ANSWER_*`, `*--answer* *_ANSWER_*`

Provides an opportunity to skip the prompt if the value of `*_ANSWER_*` is either `true` or `false`.

In the decision mode:

* If `*_ANSWER_*` is `true`, returns 0.
* If `*_ANSWER_*` is `false`, returns 1.
* Otherwise, proceeds with prompting.

In the any-key mode:

* If `*_ANSWER_*` is either `true` or `false`, returns 0.
* Otherwise, proceeds with prompting.

| `*-q*`, `*--or-quit*`

In both prompting modes, provides an extra option: 'quit'.
The returned value for the 'quit' option is always `2`.

^.^h| Prompting modes (one active at a time, last option wins)

| `*-y*`, `*--yes-no*`

_(default)_
Prompts for a yes/no decision.

| `*-k*`, `*--any-key*`

Prompts for any key press.

| `*-n*`, `*--newline*`

With this option, if this function produces any output, an extra newline is prepended to it.

^.^h| Context-related options (one active at a time, last option wins)

| `*-c*`, `*--context-all*`

Includes the entire workflow context stack in the output.

| `*-h*`, `*--context-head*`

Includes the head of the workflow context stack (the items pushed since the last notch) in the output.

| `*-1*`, `*--context-tip*`

Includes the tip of the workflow context stack (the last pushed item) in the output.

^.^h| Styling options (one active at a time, last option wins)

| *Styling options* are only relevant if the terminal coloring is available.
Otherwise, they do nothing.

In all modes titles are formatted in *bold*.

| `*-!*`, `*--alert*`

_(default)_
Colors the introductory arrow and the `*_PROMPT_*` in yellow.

| `*-v*`, `*--success*`

Colors the introductory arrow and the `*_PROMPT_*` in green.

| `*-x*`, `*--failure*`

Colors the introductory arrow and the `*_PROMPT_*` in red.

| `*-s*`, `*--skip*`

Colors the introductory arrow and the `*_PROMPT_*` in white.

| `*-b*`, `*--bare*`

Removes coloring completely.

| Para-options are shorthand for things like linebreaks, indentation, and bold titles.

| `*-t-*`

This para-option treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
That `WORD` is then styled as a title and is followed by a colon.

| `*-n-*`

This para-option inserts a newline followed by the arrow-width indentation (four spaces).

| `*-i-*`

This para-option is similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-fail]]
==== Function `d{dus}fail`

The function `d{dus}fail` announces a failure to the user and pops every item in the workflow context down to and including the latest notch (or the root of the stack).
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}fail* [-n] [-t *_TITLE_*] [--] [*_DESCRIPTION_*...]
----

As mentioned, every call to this function includes a call to `d{dus}context lop`.
Thus, this function should not be used for non-consequential failures that do not affect the workflow context.
(For such things, `d{dus}notify --failure` works nicely.)

Returns:

* `0` — Always, as in 'failed successfully'.

.The layout of the output of `d{dus}fail` (without any arguments and with empty context stack)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*
----

.The layout of the output of `d{dus}fail` (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_DESCRIPTION-0_*
    *_DESCRIPTION-1_*
    ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
----

* `*_TITLE_*` — _(optional)_ Short heading for the failure.
Defaults to:
** Without a `*_DESCRIPTION_*` — `Failure`.
** With a `*_DESCRIPTION_*` — `Something went wrong`.
* `*_DESCRIPTION_*` — _(optional)_ Short elaboration on the failure.
* `*_CONTEXT_*` — The head of the context stack, which is about to be lopped off.
The entire context block is omitted if the context stack is empty.

.List of `d{dus}fail` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-t* *_TITLE_*`, `*--title* *_TITLE_*`

Sets custom title for the failure.

Without this option, the `*_TITLE_*` defaults to:

* Without a `*_DESCRIPTION_*` — `Failure`.
* With a `*_DESCRIPTION_*` — `Something went wrong`.

| `*-n*`, `*--newline*`

With this option, an extra newline is prepended to all output.

| Para-options are shorthand for things like linebreaks, indentation, and bold titles.

| `*-t-*`

This para-option treats the next `WORD` in the `*_DESCRIPTION_*` as a title.
That `WORD` is then styled as a title and is followed by a colon.

| `*-n-*`

This para-option inserts a newline followed by the arrow-width indentation (four spaces).

| `*-i-*`

This para-option is similar to the `-n-` para-option, but the indentation is doubled.

|===

[[func-cmd]]
==== Function `d{dus}cmd`

The function `d{dus}cmd` is a wrapper around a single simple Bash command.
For notes on usage within the Divine workflow, see the workflow <<divine-workflow-guide,guidelines>>.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}cmd* [_options_] [----] *_CMD_*...
----

Executes the command `*_CMD_*` as normal, then inspects its return code.
If the return code is non-zero, prints a failure message (similar to the output of <<func-fail,`d__fail`>> in appearance), and then pops every item in the workflow context down to and including the latest notch (or root).
The output is titled, by default, 'Command failed', and shows the command that has failed, along with the current context stack.

The command `*_CMD_*` must be a single simple command, consisting of any number of ``WORD``s.
Naturally, Bash will parse the arguments to this function they trickle down to the underlying command.
As such, here are some examples of what the `*_CMD_*` can and cannot contain:

* Yes: Simple commands, including `test`, `[`, or `[[`.
* Yes: Variable expansions, though keep in mind that they will be expanded before the actual command is interpreted.
* Yes: Input redirections.
* Maybe:  Output redirections. (They will affect this outer function which might just do exactly what is needed.)
* *NO*: Operators `&&` and `||` (use <<func-require,`d__require`>>).
* *NO*: Pipes (use <<func-pipe,`d__pipe`>>).
* *NO*: Negation operator `!` (use the `--neg--` option).
* *NO*: Constructs such as `if` or `case`.
* *NO*: Arithmetic context.

Returns:

* `0` — The `*_CMD_*` returned zero (after optional negation).
* `1` — Otherwise.
* `2` — Called without arguments.

.The layout of the output of `d{dus}cmd` in case of failure (all optional parts included)
[source,subs="verbatim,quotes,attributes"]
----
==> *_TITLE_*: *_CMD_*
        *_LABEL-0_*: *_WORD-0_*
        *_LABEL-1_*: *_WORD-1_*
        ...
    Context: *_CONTEXT-0_*
             *_CONTEXT-1_*
             ...
    Circumstances: *_CRCM_*
    Result: *_RSLT_*
----

* `*_TITLE_*` — Short heading for the failure.
Defaults to `Command failed`.
* `*_CMD_*` — The command that failed, with labels pasted in.
* `*_LABEL_*` — _(optional)_ The list of labels and their disambiguations.
Labels are created via corresponding options, described below.
* `*_CONTEXT_*` — The head of the context stack, which is about to be lopped off.
The entire context block is omitted if the context stack is empty.
* `*_CRCM_*` — _(optional)_ The description of circumstances of the command call, if provided by the caller.
* `*_RSLT_*` — _(optional)_ The description of consequences of the command failure, if provided by the caller.

.List of `d{dus}cmd` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*----*`

Stops processing options for the 'outer' function, and reads the rest of the arguments as parts of the `*_CMD_*`.

| `*--neg--*`

Negates the return code of the `*_CMD_*`, as if it is prepended with a `!` operator.

^.^h| Output suppression modes (one active at a time, last option wins)

| `*--sn--*`

Suppresses neither `stdout` nor `stderr` of the `*_CMD_*`.

| `*--so--*`

Suppresses `stdout` of the `*_CMD_*`.

| `*--se--*`

_(default)_
Suppresses `stderr` of the `*_CMD_*`.

| `*--sb--*`

Suppresses both `stdout` and `stderr` of the `*_CMD_*`.

^.^h| Quiet options

| *Quiet options* designate the *quiet level* for the current call.
The non-suppressed output of the underlying command is printed only if the <<opt-verbose,global verbosity level>> is greater than or equal to the quiet level.

Quiet options are read sequentially, left-to-right, and the quiet level starts at zero.
If these options are not given at all, the default quiet level is also zero.

Normally, the quiet level does not affect the failure output.

| `*--q--*`, `*--q…--*`

_(repeatable)_
Increments the quiet level by one.

This particular option can be repeated within the hyphens, e.g., `--qqq--`.
It should be noted, that only the first character is checked to be 'q', the others are simply counted.

| `*--l--*`

Sets the quiet level to zero.

^.^h| Semantics of failure

| `*--opt--*`

Makes the `*_CMD_*` optional: if there is a failure, the head of the context stacked is not lopped off, and the failure output is styled less urgently.

When a command is marked optional, its failure output is printed depending on the quiet level.

| `*--alrt--* *_TITLE_*`

Sets the custom title for the failure output.

| `*--crcm--* *_CRCM_*`

Sets the custom circumstances description for the failure output.

| `*--else--* *_RSLT_*`

Sets the custom consequences description for the failure output.

^.^h| Label options (each must preceed the single `WORD` of the `*_CMD_*`)

| `*--_LABEL_--*`

Normally d__fail outputs the offending `*_CMD_*` in its entirety, which can get quite lengthy.
When a `WORD` of the `*_CMD_*` is prepended with a label option, the label is shown in the failure output instead of the actual `WORD`.
Then, after `*_CMD_*` is printed, each label is also printed on its own line, accompanied by the `WORD` that it stands for.
This is similar to footnotes.

| `*--#_NUM_--*`

A previously assigned label may be re-used if the `WORD` is repeated within the `*_CMD_*` multiple times.
Labels are automatically numbered, starting from zero: use the label number prepended with a hash/pound `#`` to reference a previous label.
Make sure that you assign such backreferences to ``WORD``s that are actually identical.

|===

[[func-pipe]]
==== Function `d{dus}pipe`

This function extends <<func-cmd,`d{dus}cmd`>>, and thus its reference applies fully wherever not overridden by this section.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}pipe* [_options_] [----] *_CMD_*...
----

The function `d{dus}pipe` extends `d{dus}cmd` by adding the possibility to chain up to three commands in a continuous Bash pipe.
Note, that the actual pipe operator `|` cannot be used directly, because it would affect this function and not get passed down.
Instead, the special pipe option is added.

When this function is used without the special options, `d{dus}pipe` becomes functionally identical to `d{dus}cmd`.
The intention of two different functions is to underscore semantics and to lighten up the load of parsing arguments in `d{dus}cmd`.

All `d{dus}cmd` options are supported.
If the `--so--` or the `--sb--` option is used, `stdout` is only suppressed for the last command in the queue; otherwise it would defeat the pipe's purpose.

.List of `d{dus}pipe` options (on top of those in `d{dus}cmd`)
[%noheader,cols="<.<a",stripes=none]
|===

| `*--p--*`, `*--P--*`, `*--pipe--*`

Inserts Bash's `\|` operator at that location.
Only first two instances of this option are recognized.

| `*--ret__NUM__--*`

Normally, the return code of the last command in the pipe is inspected to make judgement on whether the whole command ran successfully.
To change which command's return code represents the success of the pipe, its number must be provided with this option.
Commands in the pipe are numbered starting from zero, left to right.

|===

[[func-require]]
==== Function `d{dus}require`

This function extends <<func-cmd,`d{dus}cmd`>>, and thus its reference applies fully wherever not overridden by this section.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}require* [_options_] [----] *_CMD_*...
----

Firstly, `d{dus}require` changes semantics a little: while `d{dus}cmd` is intended to be used on commands that perform an action that produces side effects, this version is intended for checks/tests that ensure that certain requirements are met.
As such, `d{dus}require` sets the title of potential `d{dus}fail` message to `Requirement failed` instead of the default `Command failed`.

Secondly, `d{dus}require` extends `d{dus}cmd` by adding the possibility to chain up to three commands with Bash's `&&` and `||` operators.
Note, that the actual and/or operators cannot be used directly, because they would affect this function and not get passed down.
Instead, the special options are added.

Otherwise, `d{dus}require` is functionally identical to `d{dus}cmd`.
The intention of two different functions is to underscore semantics and to lighten up the load of parsing arguments in `d{dus}cmd`.

All `d{dus}cmd` options are supported.
The option `--neg--` applies to individual commands within the and/or chain; it has to be used for every negated requirement at any time before the start of the next requirement.

.List of `d{dus}require` options (on top of those in `d{dus}cmd`)
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| And/or options (only the first two are recognized)

| `*--and--*`, `*--AND--*`

Inserts Bash's `&&` operator at that location.

| `*--or--*`, `*--OR--*`

Inserts Bash's `\|\|` operator at that location.

|===

[[func-dmd5]]
==== `dmd5` function

Function `dmd5` provides a cross-platform way of calculating an md5 checksum of a file or a string.

It relies on at least one of the following utilities being available in the system: `md5sum` or `md5` or `openssl`.

[source,subs="verbatim,quotes,attributes"]
----
*dmd5* [-s *_STRING_*] | [*_PATH_*]
----

* One checksum is calculated per call.
* Either a string or a path to a file may be given.
* It is up to you to ensure that path exists and is readable.
* Checksum is printed to `stdout`.

Returns zero on success and non-zero if something goes wrong.

==== Function `d{dus}stash`

Function `d{dus}stash` is so important that it deserved its <<stash,own section>>.

[[func-push-backup]]
==== Function `d__push_backup`

The function `d{dus}push_backup` vacates the given path by pushing whatever exists at it to a backup location.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}push_backup* [--] *_ORIG_PATH_* [*_BACKUP_PATH_*]
----

This function ensures that the `*_ORIG_PATH_*` becomes empty, and if anything exists there currently, it is backed up.
Thus, if the `*_ORIG_PATH_*` sits empty, a success code is immediately returned.

For the backup path, the first available strategy is employed:

* If a BACKUP_PATH is given, it is used.
If it turns out unusable, further strategies are not tried; an error code is returned instead.
* If called from a deployment, the backup is placed into <<indct-dpl-backup-dir,`$D__DPL_BACKUP_DIR`>>, and the backup file name is generated by concatenating two parts:
** the md5 checksum of the `*_ORIG_PATH_*`;
** the suffix `.bak`.
* If none of the above works, an error code is returned.

If the generated backup path happens to be occupied, it is understood to be a previously made backup.
Previous backups are never overwritten.
Instead, this function repeatedly appends an incrementing numerical suffix (`-1`, `-2`, etc.) to the backup file name until it finds a path that is not yet occupied, and that path is then used.
The suffixes are hard capped at 1000.

This function always ensures the existence of the directory that is the immediate parent of the `*_ORIG_PATH_*` and of the generated backup path.

This function is intended to be used in conjunction with <<func-pop-backup,`d__pop_backup`>>.

Returns:

* `0` — The `*_ORIG_PATH_*` has been made empty; and if anything existed there, it has been backed up.
* `1` — The `*_ORIG_PATH_*` exists, but is inaccessible.
* `2` — The backup path, whatever it is, is inaccessible or invalid.
* `3` — Other unexpected error.

The function `d__push_backup` does not have any supported options.

[[func-pop-backup]]
==== Function `d__pop_backup`

The function `d{dus}pop_backup` restores backup of the given path to its original location.
Whatever pre-exists at the original location is, in turn, backed up by appending a suffix.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}pop_backup* [-de]… [--] *_ORIG_PATH_* [*_BACKUP_PATH_*]
----

This function ensures that the latest backup is moved back to the `*_ORIG_PATH_*`, and if anything exists there currently, it is, itself, backed up.
Thus, if there are no backups at all, nothing is done and a success code is returned.

For the backup path, the first available strategy is employed:

* If a `*_BACKUP_PATH_*` is given, it is used.
If it turns out unusable, further strategies are not tried; an error code is returned instead.
* If called from a deployment, the backup is placed into <<indct-dpl-backup-dir,`$D__DPL_BACKUP_DIR`>>, and the backup file name is generated by concatenating two parts:
** the md5 checksum of the `*_ORIG_PATH_*`;
** the suffix `.bak`.
* If none of the above works, an error code is returned.

To find the latest backup, this function first checks the generated backup path, then repeatedly appends an incrementing numerical suffix (`-1`, `-2`, etc.) to the backup file name.
As soon as it hits a path that does not exist, the previous path is understood to be the latest backup.
The suffixes are hard capped at 1000.

To back up whatever pre-exists at the `*_ORIG_PATH_*`, the suffix `.bak` is appended to the `*_ORIG_PATH_*`.
If that path happens to be occupied, the same routine of incrementing numbers is applied.

This function always ensures the existence of the directory that is the immediate parent of the `*_ORIG_PATH_*`.

This function is intended to be used in conjunction with <<func-push-backup,`d__push_backup`>>.

Returns:

* `0` — The backup has been popped successfully, according to the options.
* `1` — The `*_ORIG_PATH_*` is inaccessible.
* `2` — The backup path, whatever it is, is inaccessible or invalid.
* `3` — Other unexpected error.

.List of `d{dus}pop_backup` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-e*`, `*--evict*`

This option makes it an additional priority to ensure that anything that pre-exists at the `*_ORIG_PATH_*` is no longer there by the time this function successfully returns.
This means that even if there is no backup to pop, the `*_ORIG_PATH_*` still gets vacated.

| `*-d*`, `*--dispose*`

With this option the function treats whatever pre-exists at the `*_ORIG_PATH_*` as disposable.
In this mode, no backups of the `*_ORIG_PATH_*` are made.

|===

[[func-os-pkgmgr]]
==== Function `d__os_pkgmgr`

Function `d__os_pkgmgr` is a thin wrapper around system package manager.
The idea is to be able to install system packages without checking for current OS.
On OS's that are not yet supported, this function does nothing and returns non-zero.

[source,subs="verbatim,quotes,attributes"]
----
*d__os_pkgmgr* *update*|*check*|*install*|*remove* [*_PKG_NAME_*]
----

Launches one of the four routines, which are expected of any package manager out there.
Second argument (`*_PKG_NAME_*`), the name of single package, is relayed to the underlying package manager verbatim.
User prompts (except sudo password) are suppressed.

The first argument must be one of the four:

* `update` — updates all installed packages (other arguments are ignored).
* `check` — checks whether the provided package is installed.
Returns zero/non-zero appropriately.
* `install` — installs the provided package.
* `remove` — uninstalls the provided package.

[[stash]]
=== Stash

_Divine.dotfiles_ provides a persistent key-value storage/retrieval system.
It is based in the file system, i.e., all data is stored in files.

[#stash-types]#There are three levels of stashing system#:

* *Deployment stash* — exclusive to current deployment on current machine.
This is the default.
+
Stored in `state/stash/*_DPL-NAME_*/.stash.cfg`.
* *Root stash* — shared by all deployments on current machine.
+
Stored in `state/stash/.stash.cfg`.
* *Grail stash* — shared by all deployments across all machines that use the same <<fmwk-grail,Grail>>.
+
Stored in `grail/.stash.cfg`.

Rules of key-value store are:

* Keys must consist of: alphanumeric characters, underscore (`_`), and hyphen (`-`).
* Values must not exceed single line of text, but are otherwise unrestricted, and may be empty.
* Multiple instances of a key are allowed, values may be duplicate.

Stashing is accessible from within the deployments via the `d{dus}stash` function.

[source,subs="verbatim,quotes,attributes"]
----
*d{dus}stash* [-drgsq] [--] [ *_CMD_* [ *_KEY_* [*_VALUE_*] ] ]
----

Depending on first argument, usage is as follows.

.Usage patterns of `d{dus}stash`
[%noheader,cols="<.<a",stripes=none]
|===

| `d{dus}stash *ready*`

(_default task_) Checks whether the stashing system on selected <<stash-types,level>> is primed and ready.
By default, prints loud error messages if something is critically wrong with the stash.

Returns `0` if stash is ready, or `2` if not.

| `d{dus}stash *has* *_KEY_* [*_VALUE_*]`

If `*_VALUE_*` is not given: checks whether the stash contains at least one `*_KEY_*` with any value.

If `*_VALUE_*` is given: checks whether the stash contains at least one `*_KEY_*` that is set to `*_VALUE_*`.

Returns `0` if so, or `1` otherwise.

| `d{dus}stash *set* *_KEY_* [*_VALUE_*]`

Ensures that the stash contains a _single_ instance of `*_KEY_*`, and that it is set to `*_VALUE_*`.

Returns `0` on success, or `1` otherwise.

| `d{dus}stash *add* *_KEY_* [*_VALUE_*]`

Adds one instance of `*_KEY_*` and sets it to `*_VALUE_*`, regardless of possibly pre-existing instances of `*_KEY_*`.

Returns `0` on success, or `1` otherwise.

| `d{dus}stash *get* *_KEY_*`

Prints the value of the first instance of `*_KEY_*` to `stdout`.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *list* *_KEY_*`

Prints the value of each `*_KEY_*` on a new line to `stdout`.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *unset* *_KEY_* [*_VALUE_*]`

If `*_VALUE_*` is not given: removes all instances of `*_KEY_*`.
If `*_VALUE_*` is given: removes each instance of `*_KEY_*` that is set to `*_VALUE_*`.

Returns `0` on success (even if nothing was removed), or `1` otherwise.

| `d{dus}stash *list-keys*`

Prints each `*_KEY_*` currently in the stash on a new line to `stdout`.
Possible duplicate keys are _not_ pruned.

Returns `0` on success (even if nothing was printed), or `1` otherwise.

| `d{dus}stash *clear*`

Clears all records from this stash.

| If called with an unsupported routine name, the function returns `3`.

|===

Below is the list of `d{dus}stash` options.

.List of `d{dus}stash` options
[%noheader,cols="<.<a",stripes=none]
|===

| `*-s*`, `*--skip-checks*`

Without this option, every invocation of `d{dus}stash` (with any arguments) begins with stash readiness check.
If the function is called multiple times within a deployment, such checks become redundant.
It is recommended that after initial `d{dus}stash ready`, this option is then included with any subsequent invocations, to forego readiness checks.

| `*-q*`, `*--quiet*`

Without this option, any error during the stash readiness checks triggers an error message that always appears.
This option causes such error messages to instead honor the <<opt-verbose,global verbosity level>>.
This option is intended to be included with readiness checks in cases where not using stash is also a viable option.

^.^h| Stash <<stash-types,level>> (one active at a time, last option wins)

| `*-d*`, `*--dpl*`

_(default)_ Directs to work with the <<stash-types,deployment stash>>

| `*-r*`, `*--root*`

Directs to work with the <<stash-types,root stash>> instead of default deployment stash.

| `*-g*`, `*--grail*`

Directs to work with the <<stash-types,Grail stash>> instead of default deployment stash.

|===

[.note]
[%noheader,cols="<.<a"]
|===
| Records of attaching third-party bundles are stored in <<stash-types,Grail stash>>.

Records of installing optional framework dependencies are stored in <<stash-types,root stash>>.
|===

[[assets]]
=== Assets

If you intend to distribute your deployments, you will soon encounter the problem of separating more-or-less static deployment logic from dynamic deployment assets.

Lets study an example deployment that symlinks configuration files into the system.
It would be desirable to copy samples of those configuration files into user's <<fmwk-grail,Grail directory>>, and then create symlinks to the copies.
The user would then be free to inspect, modify, and synchronize his copies as his personal versions.
At the same time, the deployment logic is better kept within <<fmwk-state,state directory>>, where it would be easily updated by the framework.

Each deployment has a designated *asset directory*: `grail/assets/*_DPL-NAME_*/`, path to which is readable from a <<indct-dpl-asset-dir,variable>>.
The asset directory is the space where user controls the behavior of the deployment by adding/modifying/removing asset files.
Deployments, on their part, are free to provide initial/default versions of some or all assets.

To facilitate handling of assets, _Divine.dotfiles_ offers the mechanism of *asset manifests*.

[[asset-manifests]]
==== Asset manifests

An *asset manifest* is a text file located in the same directory as the deployment file and named the same, except for exchanging `.dpl.sh` suffix for `.dpl.mnf`.
It serves two purposes:

* An asset manifest can ensure that a copy of every asset that you provide is placed into the deployment's <<indct-dpl-asset-dir,asset directory>> inside the user's <<fmwk-grail,Grail>>, _unless_ an asset by that name already exists there.
* An asset manifest can automatically populate <<asset-arrays,global asset arrays>>, making the assets immediately available for processing by <<queue-main,queues>> of <<link-queue,various>> <<copy-queue,kinds>>.

Entries in an asset manifest describe a set of *assets* (files and directories) by providing relative paths to them.
Relative paths are resolved from:

* <<indct-dpl-dir,deployment directory>> (to locate initial versions provided by the author);
* <<indct-dpl-asset-dir,asset directory>> (to locate user's versions to be processed by the framework).

[.note]
[%noheader,cols="<.<a"]
|===
| To reiterate, the framework never overwrites assets that are already present in asset directory.
|===

Processing of asset manifests occurs:

* During <<rtn-primaries,primary routines>>, immediately before sourcing the deployment file.
* During <<rtn-attach,attaching of deployments>>, so that the assets of newly introduced deployments are immediately present in <<fmwk-grail,the Grail>>.

[[asset-mnf-syntax-and-behavior]]
==== Asset manifest syntax and behavior

Asset manifests follow the general <<mnf-syntax,manifest syntax>>.

Every entry is a *relative path*, which is resolved within <<indct-dpl-dir,deployment>> and <<indct-dpl-asset-dir,asset>> directories.
Two kinds of relative paths are accepted: *concrete paths* and *RegEx patterns*.
Leading and trailing slashes are disregarded in all paths in the asset manifests (including <<asset-manifest-prefix,`prefix`>> sub-paths).

The following <<mnf-kv-flags,*flags*>> are recognized within asset manifests for each asset entry:

.List of asset manifest entry flags
[%header,cols="<.<4,^.<1,<.<4",stripes=none]
|===

^.^| Behavior _without_ the flag (default)
^.^| Asset flag
^.^| Behavior _with_ the flag

| The entry is interpreted as a concrete path to a single asset.
| `*r*`

_**R**egEx_
| The entry is interpreted as a **R**egEx pattern (see <<asset-manifest-regex-note,note>> below), matching any number of assets.

| All matching files and directories within the <<indct-dpl-dir,deployment directory>> are copied into the <<indct-dpl-asset-dir,asset directory>>, unless the destination already exists.
Afterward, matching files and directories within the <<indct-dpl-asset-dir,*asset directory*>> are pushed onto the <<asset-arrays,asset arrays>>.
| [#asset-flag-d]#`*d*`#

_**d**pl-dir-only_
| This asset entry does not leave the <<indct-dpl-dir,**d**eployment directory>>.
Matching files and directories are not copied anywhere, and are pushed onto the <<asset-arrays,asset arrays>> from their original location.
This provides a way to conceal assets from user's view.

| Some version of the asset must be provided by the author into the <<indct-dpl-dir,deployment directory>>.
(If the entry is a RegEx pattern, it must have at least one matching file/directory.)
Failing that, the entire deployment is not processed at all.
| `*o*`

_**o**ptional_
| The asset entry is considered **o**ptional: its provision by the author is not enforced.

| Files and directories matching the asset entry are pushed onto <<asset-arrays,asset arrays>> for further usage.
| `*n*`

_**n**o-queue_
| Files and directories matching the asset entry are **n**ot pushed onto <<asset-arrays,asset arrays>>.

_Together with the <<asset-flag-d,`d` flag>>, this will cause the asset to be completely ignored._

| All matching files and directories within the <<indct-dpl-asset-dir,*asset directory*>> will be pushed onto <<asset-arrays,asset arrays>>.
This opens the door for user to add additional assets.

_Irrelevant when the <<asset-flag-d,`d` flag>> is in effect._
| `*p*`

_**p**rovided-only_
| The asset entry is considered limited to those matching files and directories, versions of which are **p**rovided by the author.

_Irrelevant when the <<asset-flag-d,`d` flag>> is in effect._

| Pre-existing files in the user's <<fmwk-grail,Grail>> are not overwritten under any circumstances.

| `*f*`

_**f**orce-copy_
| The framework ensures that a byte-by-byte copy of the provided version of an asset is present in the user's <<fmwk-grail,Grail>>.
If a differing version is found there, it is renamed by appending `-backup` suffix (with optional trailing ordinal for multiple backups), and the proper version is placed instead.
An alert is shown to the user whenever this happens.

*_Use this option sparingly!_*
The user is normally entitled to fully control their own Grail directory.
Replacing files there undermines the trust in your deployment.

This flag, however, is useful for supplying and updating READMEs.
In fact, whenever a file matching the RegEx pattern `README(\.[a-z]+)?` (case-sensitive) is replaced via this flag, the framework does not issue an alert or create a backup.
Naturally, this is designed for convenience, not security.

|===

The following <<mnf-kv,*key-values*>> are recognized within asset manifests:

.Asset manifest key-values
[%noheader,cols="<.<a",stripes=none]
|===

| [#asset-manifest-prefix]#`(*prefix: _SUBPATH_*)`#

If you — the deployment author — want to contain your assets under some sub-path within the deployment directory, but you don't want that sub-path to be carried over to the asset directory, specify that sub-path in the `prefix` <<mnf-kv,key>>.

| [#asset-manifest-queue-split]#`(*queue: split*)`#

This key-value does not work like the other key-values.
It does not affect the asset entries in any way.
Instead it creates a <<queue-split,queue split>> point wherever it appears.

|===

[#asset-manifest-regex-note]#Under the hood#, RegEx patterns are fed to the http://man7.org/linux/man-pages/man1/find.1.html[find] utility, using https://en.wikibooks.org/wiki/Regular_Expressions/POSIX-Extended_Regular_Expressions[POSIX Extended Regular Expressions] dialect.
The provided pattern is inserted into a larger one, similarly to the following example: `find -E . -regex "^\./${PATTERN}$"`.
As a consequence, the patterns should not include `^` and `$` meta-characters.

Order of entries in the asset manifest is guaranteed to correspond to the order of elements in the resulting <<asset-arrays,asset arrays>>.
However, order of files/directories matching a songle RegEx entry is not guaranteed.

Relative paths from a manifest are simply appended to their respective parent directory.
Paths like `.`, `..`, `../..`, etc. will work.
Keep in mind, tha asset manifests are designed for convenience, not security: with free-form Bash code within deployments, security is pretty much a moot point.

.Example of asset manifest
[source]
----
file1.txt           ## These files will be copied from deployment directory
file2.txt           #. into the root of asset directory.

(r) configs/\       ## Any .cfg files will be copied into 'configs/' directory. 
[a-z]+\.cfg         #. (Line continuation is part of manifest syntax.)

(prefix: images)
img1.jpg            ## These two files will be grabbed from 'images/' directory 
img2.jpg            #. and copied into the root of asset directory.
----

[[asset-arrays]]
==== Asset arrays

Whenever the framework processes an asset manifest, it automatically populates two global arrays:

* `*D_DPL_ASSET_PATHS*` — this array is filled with absolute paths to the assets within <<indct-dpl-asset-dir,deployment's asset directory>> (contained in <<fmwk-grail,the Grail>>).
* `*D_QUEUE_MAIN*` — for each path in the previous array, this one will contain some relative version of that path at the same index.
Relative paths are resolved against <<indct-dpl-asset-dir,deployment's asset directory>>.

You may notice, that these arrays coincide with those used in the <<queue-main,queues>> (including <<link-queue,link>> and <<copy-queue,copy>> queue variations).
The reasoning there is that assets are perfect candidates to be handled by a queue.
You are, of course, free to override these automatically populated arrays.

[[generic-queue]]
=== Generic queue

Whenever your deployment performs a series of similar actions, — e.g., symlinks a bunch of files — you are faced with several routine tasks:

* Write iteration logic.
* Tie the return codes of subtasks into a single informative code.

_Divine.dotfiles_ offers a mechanism called *queue*, which relieves such pain.
To use it:

. Populate a specially named array with one string for each queue item.
. Implement logic to be applied to a single item.
. Delegate your deployment's <<func-primaries,primaries>> to built-in helpers.

This kind of deployment is best demonstrated with an example:

.Deployment template for generic queue
[source,bash]
----
# Delegate primaries to queue helpers. Make sure helper is called last.
d_dpl_check()    { populate_queue;  d__queue_check;    }
d_dpl_install()  {                  d__queue_install;  }
d_dpl_remove()   {                  d__queue_remove;   }

# This function is not built-in, but is the recommended way of organizing logic
populate_queue() { D_QUEUE_MAIN=( alpha bravo charlie ); }

# Implement mini-primaries for a single queue item
d_item_check()    { :; }
d_item_install()  { :; }
d_item_remove()   { :; }
----

==== Generic queue set-up

Following Bash arrays should be populated before any of the built-in helpers are called:

.Variables required to set up generic queue
[%noheader,cols="<.<a",stripes=none]
|===

| [#var-queue-main]#`*D_QUEUE_MAIN*`#

Each member of this array defines a queue item.

Members of this array are simple strings.
In generic queues, the framework uses the strings themselves only for debug messages.

|===

The queue arrays must be uninterrupted.
Failing that, the queue will fail utterly and miserably.
You have been warned.

==== Generic queue hooks

Following built-in functions may be implemented to provide queue logic (all are optional).
The framework unsets every queue hook as soon as it is used up.

.Generic queue hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Mini-primaries

| [#func-queue-item-check]#`*d_item_check*`#

This function is called once for every queue item.
It is similar to its <<func-dpl-check,deployment-level cousin>>, `d_dpl_check`.

Supported return codes:

* `*0*` — *'Unknown'*: [.gray]##_(default)_## no reliable way to tell whether this queue item is installed or not.
* `*1*` — *'Installed'*: as it stands, intended goal of installing this queue item is entirely achieved.
* `*2*` — *'Not installed'*: as it stands, intended goal of installing this queue item is entirely not achieved.
* `*3*` — *'Invalid'*: input for this queue item prevents it from being processed correctly.

| [#func-queue-item-install]#`*d_item_install*`#

This function is called no more than once for every queue item.
It is similar to its <<func-dpl-install,deployment-level cousin>>, `d_dpl_install`.

Supported return codes:

* `*0*` — *'Installed successfully'*: [.gray]##_(default)_## intended goal of installing this queue item is entirely achieved.
* `*1*` — *'Failed to install'*: intended goal of installing this deployment is not entirely achieved due to error.
* `*2*` — *'Item turned out to be invalid'*: input for this queue item prevents it from being installed correctly.
* `*3*` — *'Installed successfully'* and also abort further queue installation.
* `*4*` — *'Failed to install'* and also abort further queue installation.

| [#func-queue-item-remove]#`*d_item_remove*`#

This function is called no more than once for every queue item.
It is similar to its <<func-dpl-remove,deployment-level cousin>>, `d_dpl_remove`.

Supported return codes:

* `*0*` — *'Uninstalled successfully'*: [.gray]##_(default)_## effects of previously installing this queue item are entirely reversed.
* `*1*` — *'Failed to uninstall'*: effects of previously installing this queue item are not entirely reversed due to error.
* `*2*` — *'Item turned out to be invalid'*: input for this queue item prevents it from being uninstalled correctly.
* `*3*` — *'Uninstalled successfully'* and also abort further queue uninstallation.
* `*4*` — *'Failed to uninstall'* and also abort further queue uninstallation.

^.^h| Other queue hooks

| `*d_queue_pre_check*`

This function is called once, before the queue is checked.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this check code without checking'*

| `*d_queue_post_check*`

This function is called once, after the queue is entirelly checked.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(combined check code of the queue is ignored)_

| `*d_queue_pre_install*`

This function is called once, before the queue is installed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this install code without installing'*

| `*d_queue_post_install*`

This function is called once, after the queue is entirelly installed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(combined install code of the queue is ignored)_

| `*d_queue_pre_remove*`

This function is called once, before the queue is removed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this remove code without removing'*

| `*d_queue_post_remove*`

This function is called once, after the queue is entirelly removed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(combined remove code of the queue is ignored)_

|===

==== Generic queue special variables

Following built-in variables are available/recognized during processing of each queue item:

.Generic queue special variables
[%noheader,cols="<.<a",stripes=none]
|===

| `*D{dus}ITEM_NUM*`

Index of current item in `*D_QUEUE_MAIN*`.
This index is helpful if you keep multiple arrays of related queue data.

| `*D{dus}ITEM_TITLE*`

Content of `*D_QUEUE_MAIN*` for current item.

| `*D{dus}ITEM_IS_FORCED*`

By default, the framework does *not*:

* re-install queue items that appear already installed;
* uninstall queue items that appear already not installed;
* process queue items that appear installed by means other than this framework.

The `--force` option of the intervention utility overrules such considerations.

This variable is set to `true` if installation/removal is being forced, i.e., it would not have been initiated if not for the `--force` option.
You are left to decide on whether to treat such cases specially.

| `*D{dus}ITEM_STASH_KEY*`

`*D{dus}ITEM_STASH_VALUE*`

`*D{dus}ITEM_STASH_FLAG*`

Stash key and stash value for current item.
The third variable is `true` if stash record exists, `false` if stash record does not exist, and not set if stash is not used for this item.

[.note]
[%noheader,cols="<.<a"]
!===
! Queue mechanism uses stash to keep persistent records of (un)installing queue items.
Ideally, there is no reason for you to know this or use these variables.
!===

| `*D{dus}QUEUE_RETURN_CODE*`

Within queue post-processing hooks, this variable is populated with the code that is set to be returned by the corresponding <<func-primaries,primary>>.
Changing this variable has no effect — use the hook's return code instead.

| `*D{dus}ITEM_RETURN_CODE*`

This variable is only relevant for <<link-queue,link>> and <<copy-queue,copy>> queue variations.
Within queue _item_ post-processing hooks, this variable is populated with the code that is set to be returned by the corresponding mini-primary.
Changing this variable has no effect — use the hook's return code instead.

|===

[[queue-manifests]]
==== Queue manifests

<<var-queue-main,Contents>> of the queue, whatever they are, sound like a perfect candidate for separation from deployment logic.
Queue manifests to the resqueue.

A *queue manifest* is a text file, which is — by default — located in the same directory as the deployment file and named the same, except for exchanging `.dpl.sh` suffix for `.dpl.que`.
Unlike with <<asset-manifests,asset manifests>>, you are free to customize the location/name of your queue manifest by re-assigning <<indct-dpl-que-path,`D__DPL_QUE_PATH`>> variable *at the top level* of your deployment.

Queue manifests follow the general <<mnf-syntax,manifest syntax>>.
Only the key `os` is recognized within queue manifests.

[.note]
[%noheader,cols="<.<a"]
|===
| A suggested way of using queue manifests is:

. Provide a sample queue manifest of some entries in whatever form.
. Declare the queue manifest an asset, by listing it in your <<asset-manifests,asset manifest>>.
. Within the deployment, customize the <<indct-dpl-que-path,`D__DPL_QUE_PATH`>> variable to point to asset copy within <<fmwk-grail,the Grail>>, e.g.:
+
[source,bash]
----
D__DPL_QUE_PATH="$D__DPL_ASSET_DIR/$D_DPL_NAME.dpl.que"
----
|===

[[link-queue]]
=== Link queue

A common use case of queues is creating symlinks that point to deployment's assets.
For example, one might want to:

* create symlinks located at `~/.bashrc` and `~/.zshrc`;
* point them at custom assets stored in <<fmwk-grail,the Grail>>;
* store original files as backups and restore them upon uninstallation.

For such purposes, _Divine.dotfiles_ provides a partially implemented version of <<queue-main,generic queue>> called *link queue*.
To use it:

. Populate a few specially named arrays with necessary paths.
. Delegate your deployment's <<func-primaries,primaries>> to built-in helpers.

This kind of deployment is best demonstrated with an example:

.Deployment template for link queue
[source,bash]
----
# Delegate primaries to link queue helpers. Make sure helper is called last.
d_dpl_check()    { populate_link_queue; d__link_queue_check;    }
d_dpl_install()  {                      d__link_queue_install;  }
d_dpl_remove()   {                      d__link_queue_remove;   }

# This function is not built-in, but is the recommended way of organizing logic
populate_link_queue() {
  local src="$D__DPL_ASSET_DIR" dst=~
  D_QUEUE_MAIN=(            .bashrc        .zshrc )
  D_DPL_ASSET_PATHS=( "$src/.bashrc" "$src/.zshrc" )
  D_DPL_TARGET_PATHS=( $dst/.bashrc   $dst/.zshrc  )
}
----

==== Link queue set-up

Following Bash arrays should be populated before any of the built-in helpers are called.
Note, that you can <<link-queue-asset-automation,automate>> this process.

.Variables required to set up link queue
[%noheader,cols="<.<a",stripes=none]
|===

| `*D_QUEUE_MAIN*`

This variable is still the main definition of the queue.
In the context of link queue, for each absolute path in `*D_DPL_ASSET_PATHS*`, this array must contain a shortened relative version, resolvable from the asset directory.

| `*D_DPL_ASSET_PATHS*`

Each member of this array is an absolute path to which a symlink should be maintained.

| `*D_DPL_TARGET_PATHS*`

For each path in `*D_DPL_ASSET_PATHS*`, this array must contain the intended absolute path to a symlink, which will point to the respective asset.

|===

The queue arrays must be uninterrupted and have the same number of elements.
Failing that, the queue will fail utterly and miserably.
You have been warned.

==== Link queue hooks

Following built-in functions may be implemented to provide queue logic (all are optional).
The framework unsets every link queue hook as soon as it is used up.

.Link queue hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Mini-primary hooks

| `*d_link_item_pre_check*`

This function is called once, before the symlink is <<func-queue-item-check,checked>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item check code without checking'*

| `*d_link_item_post_check*`

This function is called once, after the symlink is <<func-queue-item-check,checked>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this item check code instead'* _(check code of the link queue item is ignored)_

| `*d_link_item_pre_install*`

This function is called once, before the symlink is <<func-queue-item-install,installed>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item install code without installing'*

| `*d_link_item_post_install*`

This function is called once, after the symlink is <<func-queue-item-install,installed>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this item install code instead'* _(install code of the link queue item is ignored)_

| `*d_link_item_pre_remove*`

This function is called once, before the symlink is <<func-queue-item-remove,uninstalled>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item remove code without removing'*

| `*d_link_item_post_remove*`

This function is called once, after the symlink is <<func-queue-item-remove,uninstalled>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this item remove code instead'* _(remove code of the link queue item is ignored)_

^.^h| Overall queue hooks

| `*d_link_queue_pre_check*`

This function is called once, before the link queue is checked.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this check code without checking'*

| `*d_link_queue_post_check*`

This function is called once, after the link queue is entirelly checked.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(combined check code of the link queue is ignored)_

| `*d_link_queue_pre_install*`

This function is called once, before the link queue is installed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this install code without installing'*

| `*d_link_queue_post_install*`

This function is called once, after the link queue is entirelly installed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(combined install code of the link queue is ignored)_

| `*d_link_queue_pre_remove*`

This function is called once, before the link queue is removed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this remove code without removing'*

| `*d_link_queue_post_remove*`

This function is called once, after the link queue is entirelly removed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(combined remove code of the link queue is ignored)_

|===

[[link-queue-asset-automation]]
==== Link queue asset automation

So, you have your list of assets in a <<asset-manifests,manifest>>, and you know where to symlink them to.
Why bother with manually populating arrays?

No need.

_Divine.dotfiles_ provides two major automation avenues for link queue arrays:

* Arrays `*D_QUEUE_MAIN*` and `*D_DPL_ASSET_PATHS*` are both <<asset-arrays,automatically populated>> when the <<asset-manifests,asset manifest>> is processed, which happens immediately before your deployment file is sourced.
* Array `*D_DPL_TARGET_PATHS*` can be automatically populated if all your assets are intended to go into one target directory.
+
For that to occur, put the target directory into `*D_DPL_TARGET_DIR*` variable before any of the built-in helpers are called.
All your assets will be symlinked into the target directory, with relative paths preserved.
+
Keep in mind that this does rely on `*D_QUEUE_MAIN*` to contain relative paths, as is the requirement for link queues.

[[link-queue-cross-platform-overrides]]
==== Link queue cross-platform overrides

Cross-platformness, you say?
Your assets go into different target directories on different platforms?
No worries.

In _Divine.dotfiles_, every OS adapter carries an override mechanism for both `*D_DPL_TARGET_DIR*` and `*D_DPL_TARGET_PATHS*`.
The rules are simple: append the handle of the supported OS to the variable name in all capitals like this:

[source,bash]
----
D_DPL_TARGET_DIR=/generic/path
D_DPL_TARGET_DIR_MACOS=/path/on/macos
D_DPL_TARGET_DIR_FEDORA=/path/on/fedora
D_DPL_TARGET_DIR_WSL=/path/on/wsl
----

[.note]
[%noheader,cols="<.<a"]
|===
| The OS handles are matched against both  <<indct-os-family,`$D\__OS_FAMILY`>> and <<indct-os-distro,`$D__OS_DISTRO`>> built-in variables.
A match against distro overrules a match against family, because such is life.
|===

[[copy-queue]]
=== Copy queue

Another common use case of queues is copying files into the system.
For example, one might want to:

* copy an assortment of font files into the system's font directory;
* not overwrite existing files.

For such purposes, _Divine.dotfiles_ provides a partially implemented version of <<queue-main,generic queue>> called *copy queue*.
To use it:

. Populate a few specially named arrays with necessary paths.
. Delegate your deployment's <<func-primaries,primaries>> to built-in helpers.

[.note]
[%noheader,cols="<.<a"]
|===
| Copy queue does not touch pre-existing files:

* If a file by that name already exists at destination — no copying is done.
* Upon uninstallation, a file is only erased if there is a record of it previously being copied into that location.

If you want to actually substitute existing files (while backing them up), prefer the <<link-queue,link queue>>.
|===

This kind of deployment is best demonstrated with an example:

.Deployment template for copy queue
[source,bash]
----
# Delegate primaries to copy queue helpers. Make sure helper is called last.
d_dpl_check()    { populate_copy_queue; d__copy_queue_check;    }
d_dpl_install()  {                      d__copy_queue_install;  }
d_dpl_remove()   {                      d__copy_queue_remove;   }

# This function is not built-in, but is the recommended way of organizing logic
populate_copy_queue() {
  local src="$D__DPL_ASSET_DIR" dst=/usr/share/fonts
  D_QUEUE_MAIN=(            font1.ttf        font2.ttf  )
  D_DPL_ASSET_PATHS=( "$src/font1.ttf" "$src/font2.ttf" )
  D_DPL_TARGET_PATHS=( $dst/font1.ttf   $dst/font2.ttf  )
}
----

==== Copy queue set-up

Following Bash arrays should be populated before any of the built-in helpers are called.
Note, that you can <<copy-queue-asset-automation,automate>> this process.

.Variables required to set up copy queue
[%noheader,cols="<.<a",stripes=none]
|===

| `*D_QUEUE_MAIN*`

This variable is still the main definition of the queue.
In the context of copy queue, for each absolute path in `*D_DPL_ASSET_PATHS*`, this array must contain a shortened relative version, resolvable from the asset directory.

| `*D_DPL_ASSET_PATHS*`

Each member of this array is an absolute path to file that is to be copied.

| `*D_DPL_TARGET_PATHS*`

For each path in `*D_DPL_ASSET_PATHS*`, this array must contain the destination absolute path for copying.

|===

The queue arrays must be uninterrupted and have the same number of elements.
Failing that, the queue will fail utterly and miserably.
You have been warned.

==== Copy queue hooks

Following built-in functions may be implemented to provide queue logic (all are optional).
The framework unsets every copy queue hook as soon as it is used up.

.Copy queue hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Mini-primary hooks

| `*d_copy_item_pre_check*`

This function is called once, before the copy is <<func-queue-item-check,checked>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item check code without checking'*

| `*d_copy_item_post_check*`

This function is called once, after the copy is <<func-queue-item-check,checked>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(check code of the copy queue item is ignored)_

| `*d_copy_item_pre_install*`

This function is called once, before the copy is <<func-queue-item-install,installed>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item install code without installing'*

| `*d_copy_item_post_install*`

This function is called once, after the copy is <<func-queue-item-install,installed>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(install code of the copy queue item is ignored)_

| `*d_copy_item_pre_remove*`

This function is called once, before the copy is <<func-queue-item-remove,uninstalled>>.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this item remove code without removing'*

| `*d_copy_item_post_remove*`

This function is called once, after the copy is <<func-queue-item-remove,uninstalled>>.
Expect `$D{dus}ITEM_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove mini-primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(remove code of the copy queue item is ignored)_

^.^h| Overall queue hooks

| `*d_copy_queue_pre_check*`

This function is called once, before the copy queue is checked.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this check code without checking'*

| `*d_copy_queue_post_check*`

This function is called once, after the copy queue is entirelly checked.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the check primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this check code instead'* _(combined check code of the copy queue is ignored)_

| `*d_copy_queue_pre_install*`

This function is called once, before the copy queue is installed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this install code without installing'*

| `*d_copy_queue_post_install*`

This function is called once, after the copy queue is entirelly installed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the install primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this install code instead'* _(combined install code of the copy queue is ignored)_

| `*d_copy_queue_pre_remove*`

This function is called once, before the copy queue is removed.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* `*_other_*` — *'Return this remove code without removing'*

| `*d_copy_queue_post_remove*`

This function is called once, after the copy queue is entirelly removed.
Expect `$D{dus}QUEUE_RETURN_CODE` variable to be populated with the code that is currently set to be returned by the remove primary.
Supported return codes:

* `*0*` — *'Proceed as normal'*
* *_other_* — *'Return this remove code instead'* _(combined remove code of the copy queue is ignored)_

|===

[[copy-queue-asset-automation]]
==== Copy queue asset automation

So, you have your list of assets in a <<asset-manifests,manifest>>, and you know where to copy them to.
Why bother with manually populating arrays?

No need.

_Divine.dotfiles_ provides two major automation avenues for copy queue arrays:

* Arrays `*D_QUEUE_MAIN*` and `*D_DPL_ASSET_PATHS*` are both <<asset-arrays,automatically populated>> when the <<asset-manifests,asset manifest>> is processed, which happens immediately before your deployment file is sourced.
* Array `*D_DPL_TARGET_PATHS*` can be automatically populated if all your assets are intended to go into one target directory.
+
For that to occur, put the target directory into `*D_DPL_TARGET_DIR*` variable before any of the built-in helpers are called.
All your assets will be copied into the target directory, with relative paths preserved.
+
Keep in mind that this does rely on `*D_QUEUE_MAIN*` to contain relative paths, as is the requirement for copy queues.

[[copy-queue-cross-platform-overrides]]
==== Copy queue cross-platform overrides

Cross-platformness, you say?
Your assets go into different target directories on different platforms?
No worries.

In _Divine.dotfiles_, every OS adapter carries an override mechanism for both `*D_DPL_TARGET_DIR*` and `*D_DPL_TARGET_PATHS*`.
The rules are simple: append the handle of the supported OS to the variable name in all capitals like this:

[source,bash]
----
D_DPL_TARGET_DIR=/generic/path
D_DPL_TARGET_DIR_MACOS=/path/on/macos
D_DPL_TARGET_DIR_FEDORA=/path/on/fedora
D_DPL_TARGET_DIR_WSL=/path/on/wsl
----

[.note]
[%noheader,cols="<.<a"]
|===
| The OS handles are matched against both  <<indct-os-family,`$D\__OS_FAMILY`>> and <<indct-os-distro,`$D__OS_DISTRO`>> built-in variables.
A match against distro overrules a match against family, because such is life.
|===

[[mltsk-main]]
=== Multitask

What if a deployment carries out an assortment of _dissimilar_ tasks?
Tying up various return codes to integrate with _Divine.dotfiles_ would be tedious.

*Multitask* helpers will take up that task.
To use them:

. Populate a specially named array with one string for each task.
. Implement sub-primaries for the tasks, as if each one was a deployment of its own.
. Delegate your deployment's <<func-primaries,primaries>> to built-in helpers.

This kind of deployment is best demonstrated with an example:

.Deployment template for multitasking
[source,bash]
----
# Delegate primaries to multitask helpers. Make sure helper is called last.
d_dpl_check()    { assemble_tasks;  d__mltsk_check;   }
d_dpl_install()  {                  d__mltsk_install; }
d_dpl_remove()   {                  d__mltsk_remove;  }

# This function is not built-in, but is the recommended way of organizing logic
assemble_tasks() {  D_MLTSK_MAIN=( eat pray love );  }

# Implement sub-primaries for each task, following guidelines for primaries

d_eat_check()     { :; }
d_eat_install()   { :; }
d_eat_remove()    { :; }

d_pray_check()    { :; }
d_pray_install()  { :; }
d_pray_remove()   { :; }

d_love_check()    { :; }
d_love_install()  { :; }
d_love_remove()   { :; }
----

==== Multitask set-up

Following Bash arrays should be populated before any of the built-in helpers are called:

.Variables required to set up multitask deployment
[%noheader,cols="<.<a",stripes=none]
|===

| [#var-multitask-names]#`*D_MLTSK_MAIN*`#

Each member of this array defines a task.

Members of this array are strings, and are used in forming names of sub-primaries, which you then have to implement:

[source,subs="verbatim,quotes,attributes"]
----
          d{us}**__TASK__**{us}check
*_TASK_*  =>  d{us}**__TASK__**{us}install
          d{us}**__TASK__**{us}remove
----

|===

The multitask array must be uninterrupted.
Failing that, the deployment will fail utterly and miserably.
You have been warned.

==== Multitask hooks

Following built-in functions may be implemented to provide task logic (all are optional):

.Multitask hooks
[%noheader,cols="<.<a",stripes=none]
|===

^.^h| Sub-primaries

| [#func-task-check]#`*d{us}__TASK__{us}check*`#

See the guidelines to the <<func-dpl-check,deployment-level sibling>>, `d_dpl_check`.

| [#func-task-install]#`*d{us}__TASK__{us}install*`#

See the guidelines to the <<func-dpl-install,deployment-level sibling>>, `d_dpl_install`.

| [#func-task-remove]#`*d{us}__TASK__{us}remove*`#

See the guidelines to the <<func-dpl-remove,deployment-level sibling>>, `d_dpl_remove`.

|===

[[queue-split]]
==== Split queue

Eventually, you will want to include more than one queue in your multitask deployment.
And therein lies a _gotcha_.

All queues share the same internal mechanism.
Care must be taken to employ this mechanism multiple times within single deployment.
Specifically, the queue must be *split* by calling internal function `*d__queue_split*`.

This is best illustrated with an example:

.Deployment template for multitasking with split queue
[source,bash,subs="verbatim,quotes,attributes"]
----
# Delegate primaries to multitask helpers. Make sure helper is called last.
d_dpl_check()    { assemble_tasks;  d{dus}mltsk_check;   }
d_dpl_install()  {                  d{dus}mltsk_install; }
d_dpl_remove()   {                  d{dus}mltsk_remove;  }

# This function is not built-in, but is the recommended way of organizing logic
assemble_tasks() {  D_MLTSK_MAIN=( queue1 queue2 queue3 ); }

# In this case all three tasks contain a queue

d_queue1_check()    { populate_copy_queue;    d{dus}copy_queue_check;    }
d_queue1_install()  {                         d{dus}copy_queue_install;  }
d_queue1_remove()   {                         d{dus}copy_queue_remove;   }

d_queue2_check()    { populate_link_queue;    d{dus}link_queue_check;    }
d_queue2_install()  {                         d{dus}link_queue_install;  }
d_queue2_remove()   {                         d{dus}link_queue_remove;   }

d_queue3_check()    { populate_generic_queue; d{dus}queue_check;         }
d_queue3_install()  {                         d{dus}queue_install;       }
d_queue3_remove()   {                         d{dus}queue_remove;        }


populate_copy_queue() {
  # Populate the first queue normally (arrays specific to copy queue omitted)
  D_QUEUE_MAIN=( some copy tasks )
}

populate_link_queue() {
  # In subsequent queues, call this built-in function first
  d{dus}queue_split

  # Then {as}append{as} to the queue array (arrays specific to link queue omitted)
  D_QUEUE_MAIN+=( add link jobs )
}

populate_generic_queue() {
  d{dus}queue_split

  D_QUEUE_MAIN+=( generic queue work )
}
----

[.note]
[%noheader,cols="<.<a"]
|===
| If you use <<asset-manifests,asset manifests>>, you may <<asset-manifest-queue-split,split your queue>> directly within the asset manifest file.
|===

== Ways to contribute

You are free to contribute to _Divine.dotfiles_ in any way you deem beneficial.
This section is periodically updated to state the most sought after avenues of improvement.

[[cntrb-os-support]]
=== Contributing OS support

One of the main goals of this framework is *portability*.

In _Divine.dotfiles_, the code that supports particular operating systems is isolated within special files called *adapters*.
An OS distribution adapter allows the framework to interact with that OS and with its built-in package manager.

* An adapter is a Bash script with special functions implemented.
* Adapter template and guidelines are located in `lib/templates/adapters/distro.add.sh`.
* Active adapters are put into `lib/adapters/distro/`.

Adapters for all OS distributions out there will be welcomed with open arms.

[[divine-bundles]]
== Divine bundles

Divine deployments are deployments developed and distributed along with _Divine.dotfiles_.
Apart from being useful by themselves, they serve as an illustration of the framework's mechanisms put to good use.

.List of Divine deployments
[%noheader,cols="<.<a",stripes=none]
|===

| https://github.com/no-simpler/divine-bundle-essentials[Essentials] _(fully functional and documented)_

A bundle of core deployments, mostly centered around 'classic' dotfiles.

| https://github.com/no-simpler/divine-bundle-gpg-primer[GnuPG best practices] _(fully functional on macOS, not yet fully documented)_

Automates adherence to best security practices in regards to https://www.gnupg.org[GnuPG].

| https://github.com/no-simpler/divine-bundle-ssh-primer[SSH key handling] _(fully functional on macOS, not yet fully documented)_

Automates secure stashing and retrieval of SSH secret keys.

| https://github.com/no-simpler/divine-bundle-fonts[Fonts collection] _(fully functional on macOS & Ubuntu, not yet fully documented)_

Maintains a collection of personal font files across machines.

^.^h| macOS-specific deployments

| https://github.com/no-simpler/divine-bundle-macos-local-server[Local development server] _(fully functional on macOS, not yet fully documented)_

Maintains a local development server on macOS.
For the most part, it automates instructions from https://getgrav.org/blog/macos-mojave-apache-multiple-php-versions[this article].

| https://github.com/no-simpler/divine-bundle-macos-tilde-switch[Tilde-switch] _(fully functional on macOS, not yet fully documented)_

Programmatically switches keys tilde `~` and plus-minus `±` on a MacBook's built-in physical keyboard.

^.^h| App-specific configuration deployments

| https://github.com/no-simpler/divine-bundle-config-vscode[Visual Studio Code] _(fully functional on macOS, not yet fully documented)_

Maintains configuration for https://code.visualstudio.com[VS Code].

| https://github.com/no-simpler/divine-bundle-config-hyperjs[Hyper.js] _(fully functional on macOS, not yet fully documented)_

Maintains configuration for https://hyper.is[Hyper] terminal.

| https://github.com/no-simpler/divine-bundle-config-transmissionbt[Transmission BT] _(fully functional on macOS, not yet fully documented)_

Maintains configuration for https://transmissionbt.com[Transmission].

|===